attribute vec4 vertex; 
varying vec2 TexCoords;

uniform mat4 model;
uniform mat4 projection;

void main()
{
    TexCoords = vertex.zw;
    gl_Position = projection * model * vec4(vertex.xy, 0.0, 1.0);
}


#if __VERSION__ < 110
precision mediump float;
#endif

varying vec2 TexCoords;

uniform sampler2D sprite;
uniform vec3 spriteColor;

void main()
{
    gl_FragColor = vec4(spriteColor, 1.0) * texture2D(sprite, TexCoords);
}


package.path = package.path .. ";./lua/?.lua;./lua/?/init.lua"

require("utils.strict")
require("utils.table_save")

local palette_data = require("core.data.palette_data")
yapre.palette = palette_data

local background_color = palette_data.background_color
yapre.SetClearColor(background_color.r, background_color.g, background_color.b, background_color.a)

local app = require("app")
yapre.app = app

function Init(str)
    return app:Init()
end

function Update(delta_ms)
    app:Update(delta_ms)
end

function Deinit()
    app:Deinit()
end
local splash_screen = {}

local core = require("core")
local yecs = core.yecs


function splash_screen:Show(callback)
    local world = yecs.World:New("splash_world")
    world:AddSystems({"sprite", "tick"})

    local image = yecs.EntityFactory:Make("image")

    local image_size = 1

    while image_size < yapre.render_height / 2 do
        image_size = image_size * 2
    end
    
    local image_w = image_size * 2
    local image_h = image_size
    local image_x = yapre.render_width / 2 - image_w / 2
    local image_y = yapre.render_height / 2 - image_h / 2
    
    image:SetTexture("./image/splash.png")
    image:SetTextureSize(image_w, image_h)
    image:SetBorderEnabled(false)
    image.position = {x=image_x, y=image_y, z=1}
    
    world:AddEntity(image)

    image:AddComponent("tick")
    image.tick:AddTimer("timer", 2000, 
    function()
        world:Destroy()
        local c = yapre.palette.background_color
        yapre.SetClearColor(c.r, c.g, c.b, c.a)
        if callback then callback() end
    end
    )
    
    for idx=1, 16, 1 do
        image.tick:AddTimer("timer_" .. idx, 100*idx, 
        function()
            local c = yapre.palette.colors[idx]
            yapre.SetClearColor(c.r, c.g, c.b, c.a)
        end
        )
    end

    return world
end

return splash_screen
local systems = {}
local yecs = require("core.yecs")
local emscripten_keycode_mapping = require("core.data.emscripten_keycode_mapping")

-- dummy system
local dummy_system = {}
dummy_system.update_order = 0
function dummy_system:Init()
    print("dummy Init")
end

function dummy_system:Deinit()
    print("dummy Deinit")
end

function dummy_system:Update(delta_ms)
    print("dummy Update ", delta_ms)
end
yecs.System:Register("dummy", dummy_system)


-- sprite system
local sprite_system = {}
sprite_system.update_order = 2048
sprite_system.update_when_paused = true
function sprite_system:Update(delta_ms)
    local tree_system = self.world.systems["tree"]
    local sprite_entities = self.world:GetEntities(function(entity) return entity.sprite end)
    for _, entity in pairs(sprite_entities) do
        local position = entity.position
        if tree_system then
            position = tree_system:GetPosition(entity)
        end
        position = position or {x=0, y=0, z=0}

        for _, sprite_data in pairs(entity.sprite.sprites) do
            local offset = sprite_data.offset
            local size = sprite_data.size
            local color = sprite_data.color
            yapre.DrawSprite(
            sprite_data.texture, 
            position.x + offset.x, position.y + offset.y, position.z + offset.z, 
            size.width, size.height, 
            0., 
            color.r, color.g, color.b 
            ) 
        end
    end
end
yecs.System:Register("sprite", sprite_system)

-- input system
local input_system = { _key_events={}, _mouse_events={} }

function input_system:Update(delta_ms)
    local input_entities = self.world:GetEntities(function(entity) return entity.input end)
    local tree_system = self.world.systems["tree"]

    for _, mouse_event in ipairs(self._mouse_events) do
        if mouse_event.button ~= 1 then
            goto continue0
        end

        for _, entity in pairs(input_entities) do
            local einput = entity.input

            if mouse_event.state==1 then
                local size = einput.touch_size or entity.size
                if size == nil then goto continue1 end

                local position = nil
                if tree_system then
                    position = tree_system:GetPosition(entity)
                end

                position = position or entity.position
                if position == nil then goto continue1 end
                local x = position.x
                local y = position.y
                local w = size.width
                local h = size.height

                if  mouse_event.x > x and mouse_event.x < x + w and
                    mouse_event.y > y and mouse_event.y < y + h then
                    if einput:_OnTouchBegan(mouse_event.x, mouse_event.y) then
                        einput.touched = true
                        if not einput.transparent then
                            break 
                        end
                    end
                end
            elseif mouse_event.state==2 then
                if einput.touched then 
                    einput:_OnTouchEnded(mouse_event.x, mouse_event.y)
                    einput.touched = false
                end
            elseif mouse_event.state==4 then
                if einput.touched then 
                    einput:_OnTouchMoved(mouse_event.x, mouse_event.y)
                end
            end
            ::continue1::
        end
        ::continue0::
    end

    self._key_events={}
    self._mouse_events={}
end

function input_system:Init()
    local function OnKey(timestamp, state, multi, keycode)
        if yapre.platform == "emscripten" then
            keycode = emscripten_keycode_mapping:GetKeyCode(keycode)
        end
        print(string.format("%s-[OnKey] %i:%i:%i:%i", self.world, timestamp, state, multi, keycode))
        table.insert(self._key_events, {timestamp=timestamp, state=state, multi=multi, keycode=keycode})
        if self.OnKey then
            self:OnKey(timestamp, state, multi, keycode)
        end
    end

    local function OnMouse(timestamp, state, button, x, y)
        print(string.format("%s-:[OnMouse] %i:%i:%i:(%i,%i)", self.world, timestamp, state, button, x, y))
        table.insert(self._mouse_events, {timestamp=timestamp, state=state, button=button, x=x, y=y})
        if self.OnMouse then
            self:OnMouse(timestamp, state, button, x, y)
        end
    end

    yapre.BindKeyboardInputCallback(string.format("%s-OnKey", self.world), OnKey)
    yapre.BindMouseInputCallback(string.format("%s-OnMouse", self.world), OnMouse)
end

function input_system:Deinit()
    yapre.UnbindKeyboardInputCallback(string.format("%s-OnKey", self.world))
    yapre.UnbindMouseInputCallback(string.format("%s-OnMouse", self.world))
end

yecs.System:Register("input", input_system)

-- tree_system
local tree_system = {}
tree_system.update_order = sprite_system.update_order - 1
tree_system.global_position = {}

function tree_system:_UpdateTreeNodePos(node, parent_pos)
    local pos = node.position
    local node_pos = {
        x=pos.x+parent_pos.x, 
        y=pos.y+parent_pos.y, 
        z=pos.z+parent_pos.z, 
    }
    self.global_position[node.key] = node_pos

    for _, c in pairs(node.tree.children) do
        self:_UpdateTreeNodePos(c, node_pos)
    end
end

function tree_system:Update(delta_ms)
    self.global_position = {}
    local world = self.world
    local tree_entities = self.world:GetEntities(function(entity) return entity.tree end)
    for _, entity in pairs(tree_entities) do
        local parent = entity.tree.parent
        if parent == nil then
            self:_UpdateTreeNodePos(entity, {x=0, y=0, z=0})
        else
            if world.entities[parent.key] == nil then
                world:RemoveEntity(entity)
            end
        end
    end
end

function tree_system:Init()
end

function tree_system:Deinit()
end

function tree_system:GetPosition(entity)
    local position = self.global_position[entity.key]
    if position then 
        return position 
    else
        return entity.position
    end
end

yecs.System:Register("tree", tree_system)

-- tick system
local tick_system = {}
tick_system.update_order = 0
function tick_system:Init()
end

function tick_system:Deinit()
end

function tick_system:Update(delta_ms)
    local world = self.world
    local tick_entities = self.world:GetEntities(function(entity) return entity.tick end)
    local g_tick_callbacks = {}
    local g_timer_callbacks = {}
    for _, entity in pairs(tick_entities) do
        local etick = entity.tick
        local timer_callbacks = etick._timer_callbacks
        local tick_callbacks = etick._tick_callbacks
        local timer_to_remove = {}

        for timer_key, callback in pairs(timer_callbacks) do
            callback.time_ms = callback.time_ms - delta_ms
            if callback.time_ms <= 0 then
                table.insert(timer_to_remove, timer_key)
                table.insert(g_timer_callbacks, callback)
            end
        end

        for _, timer_key in ipairs(timer_to_remove) do
            timer_callbacks[timer_key] = nil
        end

        for _, callback in pairs(tick_callbacks) do
            table.insert(g_tick_callbacks, callback)
        end
    end

    table.sort(
    g_timer_callbacks, 
    function(t1, t2)
        if t1.time_ms < t2.time_ms then
            return true
        end
    end
    )

    table.sort(
    g_tick_callbacks, 
    function(t1, t2)
        if t1.tick_order < t2.tick_order then
            return true
        elseif t1.tick_order > t2.tick_order  then
            return false
        else
            return false 
        end
    end
    )

    for _, callback in ipairs(g_timer_callbacks) do
        callback.callback(-callback.time_ms)
    end
    
    for _, callback in ipairs(g_tick_callbacks) do
        callback.callback(delta_ms)
    end

end

yecs.System:Register("tick", tick_system)


return systems
local components = {}
local yecs = require("core.yecs")
local palette_data = require("core.data.palette_data")
local copy = require("utils.copy")

local deep_copy = copy.deep_copy


yecs.Component:Register("data", {})
yecs.Component:Register("tags", {})

yecs.Component:Register("position", {x=0, y=0, z=0})
yecs.Component:Register("size", {width=0, height=0})
yecs.Component:Register("sprite", 
{
    sprites={}, 
    _operations={
        AddSprite=function(self, key, texture, params)
            params = params or {}
            self.sprites[key] = {
                texture = texture or "./image/sprite16.png", 
                color = deep_copy(params.color) or {r=1,g=1,b=1}, 
                size = deep_copy(params.size) or {width=-1, height=-1}, 
                offset = deep_copy(params.offset) or {x=0, y=0, z=0},
            }
        end,
        RemoveSprite=function(self, key)
            self.sprites[key] = nil
        end,
    },
})

yecs.Component:Register("input", 
{
    touch_size=nil,
    touched=false,
    transparent=false,
    _operations={
        _OnTouchBegan=function(self, x, y)
            print("_OnTouchBegan")
            return self:OnTouchBegan(x, y)
        end,
        _OnTouchMoved=function(self, x, y)
            print("_OnTouchMoved")
            self:OnTouchMoved(x, y)
        end,
        _OnTouchEnded=function(self, x, y)
            print("_OnTouchEnded")
            self:OnTouchEnded(x, y)
            self:OnClicked(x, y)
        end,

        OnClicked=function(self, x, y)
            print("OnClicked")
        end,
        OnTouchBegan=function(self, x, y)
            print("OnTouchBegan")
        end,
        OnTouchMoved=function(self, x, y)
            print("OnTouchMoved")
        end,
        OnTouchEnded=function(self, x, y)
            print("OnTouchEnded")
        end
    },
})

yecs.Component:Register("tree", 
{
    parent=nil, 
    children={},
    _operations={
        AddChild=function(self, c)
            if c.tree == nil then return end
            local c_parent = c.tree.parent
            if c_parent then
                c_parent.tree:RemoveChild(c)
            end

            c.tree.parent = self.entity
            self.children[c.key] = c
        end,
        RemoveChild=function(self, c)
            local c_tree = c.tree
            if c_tree == nil then return end
            if c_tree.parent ~= self.entity then return end

            c_tree.parent = nil
            self.children[c.key] = nil
        end,
        Serialize=function(self)
            local children = {}
            local data = {
                parent=self.parent and self.parent.key,
                children=children,
            }
            
            for c_key, _ in pairs(self.children) do
                table.insert(children, c_key)
            end
            return data
        end,
        Deserialize=function(self, data)
            local world_entities = self.entity.world.entities
            self.parent = world_entities[data.parent]
            
            for _, c_key in ipairs(data.children) do
                self.children[c_key] = world_entities[c_key]
            end
        end,
    },
})

local font_data = require("core.data.font_data")
yecs.Component:Register("text", 
{
    text="",
    size=1,
    max_width=0,
    max_height=0,

    _operations={
        SetText=function(self, new_text)
            self.text = new_text
            self:Format()
        end,
        GetText=function(self)
            return self.text
        end,
        Format=function(self)
            local sprite = self.entity.sprite
            if sprite == nil then return end

            local new_sprites = {}
            local pos_x = 0
            local pos_y = 0
            local pos_z = 1
            local size = self.size
            self.text:gsub(".", function(c)
                if c == "\n" then
                    pos_y = pos_y + font_data.height + 1
                    pos_x = 0
                    return
                end

                local c_n = string.byte(c)
                local width = font_data.width[c_n]
                if width == nil then 
                    c_n = -1
                    width = font_data[-1] 
                end

                if self.max_width > 0 and (pos_x + width) * size > self.max_width then
                    pos_y = pos_y + font_data.height + 1
                    pos_x = 0
                end

                if self.max_height > 0 and pos_y + font_data.height > self.max_height then 
                    return 
                end

                local texture = {
                    texture=string.format("./image/font/%d.png", c_n), 
                    color=palette_data.foreground_color, 
                    size={width=font_data.size*size, height=font_data.size*size}, 
                    offset={x=pos_x*size, y=pos_y*size, z=pos_z},
                }
                table.insert(new_sprites, texture)
                pos_x = pos_x + width
                pos_z = pos_z + 1
            end)

            sprite.sprites = new_sprites
        end,
        SetMaxSize=function(self, w, h)
            self.max_width = w
            self.max_height = h
            self:Format()
        end,
        SetFontSize=function(self, v)
            self.size = v
            self:Format()
        end
    },

})

local default_tick_order = 1
yecs.Component:Register("tick", 
{
    _tick_callbacks={}, -- callback(delta_ms)
    _timer_callbacks={}, -- callback(timeover_ms)
    _operations={
        AddTick=function(self, key, callback, tick_order)
            self._tick_callbacks[key] = {
                tick_order=tick_order or default_tick_order,
                callback=callback,
                entity=self.entity,
            }
        end,
        RemoveTick=function(self, key)
            self._tick_callbacks[key] = nil
        end,
        AddTimer=function(self, key, time_ms, callback)
            self._timer_callbacks[key] = {
                time_ms=time_ms,
                callback=callback,
                entity=self.entity,
            }
        end,
        RemoveTimer=function(self, key)
            self._timer_callbacks[key] = nil
        end,

    },
})

local animation_frame_rate = 12
local animation_callback_key = 1
yecs.Component:Register("animation", 
{
    frame_rate=animation_frame_rate,
    waiting_timer=false,
    next_idx={},
    animations={},

    _callback=function(self)
        self.waiting_timer = false
        local entity = self.entity
        local sprite = entity.sprite
        if not sprite then
            self.next_idx = {}
            return 
        end

        local next_timer = false
        local next_idx = {}
        for k, idx in pairs(self.next_idx) do
            local a = self.animations[k]
            if a then 
                local s = sprite.sprites[a.sprite_key]
                if s then 
                    s.texture = string.format(a.texture_format, idx)
                    if idx + 1 <= a.end_idx then
                        next_idx[k] = idx + 1
                        next_timer = true
                    elseif a.loop then
                        next_idx[k] = a.start_idx
                        next_timer = true
                    end
                end
            end
        end

        if next_timer then
            entity.tick:AddTimer("animation", 1000//self.frame_rate, function() self:_callback() end)
            self.waiting_timer = true
        end

        self.next_idx = next_idx 
    end,

    _operations={
        AddState=function(self, key, sprite_key, texture_format, start_idx, end_idx, loop)
            self.animations[key] = {
                sprite_key=sprite_key,
                texture_format=texture_format,
                start_idx=start_idx,
                end_idx=end_idx,
                loop=loop,
            }
        end,
        RemoveState=function(self, key)
            animations[key] = nil
        end,
        Play=function(self, key)
            local a = self.animations[key]
            if not a then return end

            local s = self.entity.sprite.sprites[a.sprite_key]
            if not s then return end

            self.next_idx[key] = a.start_idx

            if not self.waiting_timer then
                self.entity.tick:AddTimer("animation", 1000//self.frame_rate, function() self:_callback() end)
                self.waiting_timer = true
            end
        end,
        Stop=function(self, key)
            self.next_idx[key] = nil
        end,
        StopAll=function(self)
            self.next_idx = {}
        end,
        Deserialize=function(self, data)
            yecs.Component.Deserialize(self, data)
            self.entity.tick:AddTimer("animation", 1000//self.frame_rate, function() self:_callback() end)
        end,

    },
})

return components
local serialization = {}
local yecs = require("core.yecs")
local copy = require("utils.copy")


function serialization:DumpWorld(world)
    local world_data = {}

    world_data.paused = world.paused
    world_data.update_delta = world.update_delta
    world_data.key = world.key

    local systems = {}
    for system_key, _ in pairs(world.systems) do
        table.insert(systems, system_key)
    end
    world_data.systems = systems 
    
    local entities_data = {}
    for entity_key, entity in pairs(world.entities) do
        entities_data[entity_key] = entity:Serialize()
    end

    world_data.entities = entities_data

    return world_data
end


function serialization:LoadWorld(world_data)
    local world = yecs.World:New(world_data.key)
    world:AddSystems(world_data.systems)
    
    world.paused = world_data.paused
    world.update_delta = world_data.update_delta

    local entities_data = world_data.entities
    local entities = self:MakeEntities(entities_data)

    for _, entity in pairs(entities) do
        world:AddEntity(entity)
    end
    
    for e_key, entity in pairs(entities) do
        entity:Deserialize(entities_data[e_key])
    end

    return world
end


function serialization:MakeEntities(entities_data)
    local entities = {}

    for entity_key, entity_data in pairs(entities_data) do
        local components = {}
        for c_key, _ in pairs(entity_data.components) do
            table.insert(components, c_key)
        end
        
        local entity = yecs.Entity:New(components, entity_data.behavior_keys)
        if entity.Init then
            entity:Init()
        end
        if entity.OnInit then
            entity:OnInit()
        end

        entity.key = entity_key 
        entities[entity_key] = entity 
    end

    return entities
end

function serialization:DumpData(obj, seen)
    if type(obj) ~= "table" then 
        if type(obj) == "function" then
            print("unable to dump function")
            return nil
        end
        return obj
    end
	
    if seen and seen[obj] then return seen[obj] end
        
	local s = seen or {}
    local data = {}
    s[obj] = data
     
    for k, v in pairs(obj) do
        if type(k) == "string" and string.sub(k, 1, 1) ~= "_" or
            type(k) == "number" then
            data[k] = self:DumpData(v, s)
        end
    end

    return data
end

return serialization
local yecs = {}
local copy = require("utils.copy")
local uuid = require("utils.uuid")
local deep_copy = copy.deep_copy

-- world
yecs.worlds = {}

local World = {
    __metatable = 'WorldMeta',
    __tostring = function(self) return string.format('<yecs-world: %s>', self.key) end,
}
World.__index = World

function World:New(key)
    local world = yecs.worlds[key]
    if world then return world end

    world = setmetatable(
    {
        paused=false,
        update_delta=0,
        key=key,
        entities={},
        systems={},
        system_update_queue=setmetatable({}, {__mode='v'}),
    },
    self 
    )
    
    yecs.worlds[key] = world
    return world
end

function World:Destroy()
   yecs.worlds[self.key] = nil 
   for _, system in pairs(self.systems) do
       system:Deinit()
   end
   self.entities = {}
   self.systems = {}
   self.system_update_queue = {}
end

function World:Update(delta_ms)
    self.update_delta = self.update_delta + delta_ms

    if self.paused then
        for _, system in ipairs(self.system_update_queue) do
            if system.update_when_paused then
                system:Update(0)
            end
        end
    else
        for _, system in ipairs(self.system_update_queue) do
            system:Update(self.update_delta)
        end
        self.update_delta = 0
    end
end

function World:UpdateAllWorlds(delta_ms)
    local worlds = {}
    
    for _, world in pairs(yecs.worlds) do
       table.insert(worlds, world)
    end

    for _, world in pairs(worlds) do
        world:Update(delta_ms)
    end
end


function World:Pause()
    self.paused = true 
end

function World:Resume()
    self.paused = false
end

function World:AddEntity(entity)
    self.entities[entity.key] = entity
    entity.world = self
end

function World:RemoveEntity(entity)
    local entity_key = nil
    if getmetatable(entity) == "EntityMeta" then
        entity_key = entity.key
    else
        entity_key = entity
        entity = self.entities[entity_key]
    end
    
    if entity and entity.world == self then
        entity.world = nil
        self.entities[entity_key] = nil
    end
end

function World:AddSystem(system)  
    if getmetatable(system) ~= "SystemMeta" then
        system = yecs.System:New(system)
    end

    if system == nil or self.systems[system.key] ~= nil then return end
    
    system.world = self
    self.systems[system.key] = system
    table.insert(self.system_update_queue, system)
    table.sort(self.system_update_queue, function(s1, s2) return s1.update_order < s2.update_order end)

    system:Init()
end

function World:AddSystems(systems)
    for _, system in pairs(systems) do
        self:AddSystem(system)
    end
end

function World:RemoveSystem(system)
    if getmetatable(system) ~= "SystemMeta" then
        system = self.systems[system]
    end 

    if system == nil or system.world ~= self then
        return 
    end

    system.world = nil
    self.systems[system.key] = nil 
    system:Deinit()
    collectgarbage()
    
    system.system_update_queue = {}
    for _, system in pairs(self.systems) do
        table.insert(self.system_update_queue, system)
    end
    table.sort(self.system_update_queue, function(s1, s2) return s1.update_order < s2.update_order end)
end

function World:GetEntities(condition)
    local entities = {}

    for _, entity in pairs(self.entities) do
        if (not condition) or condition(entity) then
            table.insert(entities, entity)
        end
    end

    return entities
end

function World:GetEntity(condition)
    for _, entity in pairs(self.entities) do
        if (not condition) or condition(entity) then
            return entity
        end
    end

    return nil
end

function World:GetEntitiesByTags(tags)
    return self:GetEntities(
    function(entity)
        if entity.tags == nil then return false end
        for _, tag in pairs(tags) do
            if entity.tags[tag] then return true end
        end
    end
    )
end

function World:GetEntityByTags(tags)
    return self:GetEntity(
    function(entity)
        if entity.tags == nil then return false end
        for _, tag in pairs(tags) do
            if entity.tags[tag] then return true end
        end
    end
    )
end


-- behavior
local Behavior = {
    behaviors={},
}

function Behavior:Register(key, behavior)
	if type(behavior) ~= 'table' then return end
    self.behaviors[key] = behavior
end

function Behavior:Get(key)
    if not key then return {} end
    return self.behaviors[key] or {}
end


-- entity
local Entity = {
    key = "",
    __metatable = "EntityMeta",
    __tostring = function(self) return string.format("<yecs-entity: %s>", self.key) end,
}
Entity.__index = function(self, k) return Entity[k] or self._behavior[k] or self.components[k] end
Entity.__newindex = function(self, k, v)
    if k == "world" then
        rawset(self, k, v)
    elseif self.components[k] == nil then
        print("can not add property to entity")
        -- rawset(self, k, v)
    elseif type(v) == "table" then
        local component = self.components[k]
        for ck, cv in pairs(v) do
            component[ck] = cv
        end
    end
end

function Entity:New(components, behavior_keys)
    components = components or {}
    local component_data = {}
    local _behavior = {} 
    for _, bk in ipairs(behavior_keys) do
        for k, v in pairs(Behavior:Get(bk)) do
            _behavior[k] = v
        end
    end

    local entity = setmetatable(
    {
        key = uuid.new(),
        components = component_data,
        behavior_keys = copy.copy(behavior_keys),
        _behavior = _behavior,
    },
    self 
    )

    for k, v in pairs(components) do
        if getmetatable(v) ~= "ComponentMeta" then
            v = yecs.Component:New(v) 
        end

        if v ~= nil then 
            v.entity = entity
            component_data[v.key] = v 
        end
    end

    return entity
end

function Entity:AddComponent(component)
    if getmetatable(component) ~= "ComponentMeta" then
        component = yecs.Component:New(component)
    end
     
    if component and self.components[component.key] == nil then
        self.components[component.key] = component
    end
end

function Entity:AddBehavior(behavior_key)
    for k, v in pairs(Behavior:Get(behavior_key)) do
        self._behavior[k] = v
    end
    table.insert(self.behavior_keys, behavior_key)
end

function Entity:Serialize()
    local data = {}
    data.key = self.key

    local components = {}
    for c_k, c in pairs(self.components) do
        components[c_k] = c:Serialize()
    end

    data.components = components
    data.behavior_keys = copy.copy(self.behavior_keys)
    return data
end

function Entity:Deserialize(data)
    self.key = data.key
    for c_k, c_v in pairs(data.components) do
        self.components[c_k]:Deserialize(c_v)
    end
end


-- component
local component_templates = {}

local Component = {
    key = "",
    _operations = {},
    __metatable = "ComponentMeta",
    __tostring = function(self) return string.format("<yecs-component: %s>", self.key) end,
}
Component.__index = function(self, k) return self._operations[k] or Component[k] end
Component.__newindex = function(self, k, v) 
    if type(v) ~= 'function' then
        rawset(self, k, v)
    else
        self._operations[k] = v
    end
end

function Component:Register(key, data)
	if component_templates[key] ~= nil then return end
	if type(data) ~= 'table' then return end
    
    data["key"] = key
    if data._operations == nil then
        data._operations = {}
    end

    component_templates[key] = data
end

function Component:New(key)
    local component_data = component_templates[key]
    if component_data == nil then return nil end
    
    local component = setmetatable
    (
       deep_copy(component_data),
       self
    )
    return component
end

function Component:Serialize()
    local data = {}

    for k, v in pairs(self) do
        if type(k) == "string" and string.sub(k, 1, 1) ~= "_" and k ~= "entity"  then
            data[k] = v
        end
    end

    return deep_copy(data)
end

function Component:Deserialize(data)
    for k, v in pairs(data) do
        self[k] = v
    end
end

-- system
local system_templates = {}
local System = {
    key = "",
    update_order = 1024,
    update_when_paused = false,
    __metatable = "SystemMeta",
    __tostring = function(self) return string.format("<yecs-system: %s>", self.key) end,
}
System.__index = System

function System:Register(key, data)
	if type(data) ~= 'table' then return end
    data["key"] = key
    system_templates[key] = data
end

function System:New(key)
    local system_data = system_templates[key]
    if system_data == nil then return nil end

    local system = setmetatable
    (
       deep_copy(system_data),
       self
    )
    return system
end

function System:Update(delta_ms)
    print(self, "Update", delta_ms)
end

function System:Init()
end

function System:Deinit()
end


-- EntityFactory
local EntityFactory = {
    entity_models={},
}

function EntityFactory:Make(entity_type, ex_behavior_keys)
    local data = self.entity_models[entity_type]
    if not data then return nil end

    local components = data.components
    local behavior_keys = data.behavior_keys

    local entity = yecs.Entity:New(components, behavior_keys)
    if not entity then return nil end
    
    if ex_behavior_keys then
        for _, behavior_key in pairs(ex_behavior_keys) do
            entity:AddBehavior(behavior_key)
        end
    end
    
    if entity.Init then
        entity:Init()
    end

    if entity.OnInit then
        entity:OnInit()
    end

    return entity
end

function EntityFactory:Register(entity_type, components, behavior_keys)
    self.entity_models[entity_type] = {components=components, behavior_keys=behavior_keys}
end

yecs.World = World
yecs.Entity = Entity
yecs.Component = Component 
yecs.System = System
yecs.EntityFactory = EntityFactory
yecs.Behavior = Behavior


return yecs
local components = require("core.components")
local systems = require("core.systems")
local entities = require("core.entities")

local core = {}
core.yecs = require("core.yecs")

return core
local font_data = {}
font_data.size=8
font_data.height=7 
font_data.width={
    [-1]=7,
    [32]=4,
    [33]=2,
    [34]=4,
    [35]=6,
    [36]=5,
    [37]=6,
    [38]=6,
    [39]=3,
    [40]=3,
    [41]=3,
    [42]=6,
    [43]=6,
    [44]=2,
    [45]=4,
    [46]=2,
    [47]=4,
    [48]=5,
    [49]=3,
    [50]=5,
    [51]=5,
    [52]=5,
    [53]=5,
    [54]=5,
    [55]=5,
    [56]=5,
    [57]=5,
    [58]=2,
    [59]=2,
    [60]=4,
    [61]=5,
    [62]=4,
    [63]=4,
    [64]=9,
    [65]=5,
    [66]=5,
    [67]=5,
    [68]=5,
    [69]=5,
    [70]=5,
    [71]=5,
    [72]=5,
    [73]=2,
    [74]=3,
    [75]=5,
    [76]=5,
    [77]=6,
    [78]=5,
    [79]=6,
    [80]=5,
    [81]=6,
    [82]=5,
    [83]=5,
    [84]=6,
    [85]=5,
    [86]=6,
    [87]=8,
    [88]=6,
    [89]=6,
    [90]=5,
    [91]=3,
    [92]=4,
    [93]=3,
    [94]=6,
    [95]=6,
    [96]=3,
    [97]=5,
    [98]=5,
    [99]=5,
    [100]=5,
    [101]=5,
    [102]=4,
    [103]=5,
    [104]=5,
    [105]=2,
    [106]=3,
    [107]=5,
    [108]=2,
    [109]=8,
    [110]=5,
    [111]=5,
    [112]=5,
    [113]=5,
    [114]=4,
    [115]=4,
    [116]=3,
    [117]=5,
    [118]=5,
    [119]=6,
    [120]=6,
    [121]=5,
    [122]=5,
    [123]=4,
    [124]=2,
    [125]=4,
    [126]=5,
    [127]=6,
}

return font_data
local palette_data = {}

local GetColorFromHexStr = function(str)
    local color = {a=0, r=0, g=0, b=0}
    local tmp = {}
    for cc in string.gmatch(str, "..") do
        table.insert(tmp, tonumber(cc, 16))
    end
    color.a = tmp[1] / 255
    color.r = tmp[2] / 255
    color.g = tmp[3] / 255
    color.b = tmp[4] / 255
    return color
end

-- https://lospec.com/palette-list/summers-past-16
local _colors = {
    'FF320011',
    'FF5f3a60',
    'FF876672',
    'FFb7a39d',
    'FFece8c2',
    'FF6db7c3',
    'FF5e80b2',
    'FF627057',
    'FF8da24e',
    'FFd2cb3e',
    'FFf7d554',
    'FFe8bf92',
    'FFe78c5b',
    'FFc66f5e',
    'FFc33846',
    'FF933942',
}

local colors = {}
for _, c in ipairs(_colors) do 
    table.insert(colors, GetColorFromHexStr(c))
end

palette_data.colors = colors
palette_data.black = colors[1]
palette_data.white = colors[5]
palette_data.blue = colors[6]
palette_data.green = colors[10]
palette_data.red = colors[14]

palette_data.main_colors = {
    palette_data.black,
    palette_data.white, 
    palette_data.blue, 
    palette_data.green, 
    palette_data.red, 
}

palette_data.foreground_color = colors[5]
palette_data.background_color = colors[16]
palette_data.border_color = colors[1]

return palette_data

local emscripten_keycode_mapping ={} 

emscripten_keycode_mapping.keycode_mapping = 
{
    [53]=96,
    [30]=49,
    [31]=50,
    [32]=51,
    [33]=52,
    [34]=53,
    [35]=54,
    [36]=55,
    [37]=56,
    [38]=57,
    [39]=48,
    [46]=61,
    [42]=8,
    [43]=9,
    [20]=113,
    [26]=119,
    [8]=101,
    [21]=114,
    [23]=116,
    [28]=121,
    [24]=117,
    [12]=105,
    [18]=111,
    [19]=112,
    [47]=91,
    [48]=93,
    [49]=92,
    [4]=97,
    [22]=115,
    [7]=100,
    [9]=102,
    [10]=103,
    [11]=104,
    [13]=106,
    [14]=107,
    [15]=108,
    [51]=59,
    [52]=39,
    [40]=13,
    [29]=122,
    [27]=120,
    [6]=99,
    [25]=118,
    [5]=98,
    [17]=110,
    [16]=109,
    [54]=44,
    [55]=46,
    [56]=47,
    [44]=32,
    [101]=231,
}

function emscripten_keycode_mapping:GetKeyCode(key_code)
    n_key_code = self.keycode_mapping[key_code] or key_code 
    return n_key_code
end

return emscripten_keycode_mapping
local entities = {}

local palette_data = yapre.palette
local yecs = require("core.yecs")

-- ui
-- button
local button_behavior = {}
yecs.Behavior:Register("button", button_behavior)
function button_behavior:Init()
    self.sprite:AddSprite(
    "button", 
    "./image/ui/button16/1.png", 
    {size={width=32, height=32}})

    self.size.width = 32
    self.size.height = 32

    self.animation:AddState("normal", "button",  "./image/ui/button16/%d.png", 1, 1)
    self.animation:AddState("pressed", "button",  "./image/ui/button16/%d.png", 2, 2)
    self.animation:AddState("disabled", "button",  "./image/ui/button16/%d.png", 3, 3)
    function self.input:OnTouchBegan(x, y)
        self.entity.animation:StopAll()
        self.entity.animation:Play("pressed")
        local on_touch_began_func = self.entity.OnTouchBegan
        if on_touch_began_func then on_touch_began_func(self.entity, x, y) end
        return true
    end
    function self.input:OnTouchMoved(x, y)
        local on_touch_moved_func = self.entity.OnTouchMoved
        if on_touch_moved_func then on_touch_moved_func(self.entity, x, y) end
        return true
    end
    function self.input:OnTouchEnded(x, y)
        self.entity.animation:StopAll()
        self.entity.animation:Play("normal")
        local on_clicked_func = self.entity.OnClicked
        if on_clicked_func then on_clicked_func(self.entity, x, y) end
    end

    return self
end

function button_behavior:SetState(state)
    local animation = self.animation
    animation:Stop("normal")
    animation:Stop("pressed")
    animation:Stop("disabled")
    animation:Play(state)
end

function button_behavior:SetButtonSize(width, height)
    local image_sprite = self.sprite.sprites["button"]
    if image_sprite then
        image_sprite.size = {width=width, height=height}
    end
    self.size = {width=width, height=height}
end

yecs.EntityFactory:Register(
"button",
{"position", "sprite", "tree", "size", "input", "tick", "animation"},
{"button"}
)

-- label
local label_behavior = {}
yecs.Behavior:Register("label", label_behavior)
function label_behavior:SetText(text)
    self.text:SetText(text)
end
function label_behavior:SetMaxSize(width, height)
    self.text:SetMaxSize(width, height)
end
function label_behavior:SetFontSize(size)
    self.text:SetFontSize(size)
end

yecs.EntityFactory:Register(
"label",
{"position", "sprite", "tree", "size", "text"},
{"label"})

-- image
local image_behavior = {}
yecs.Behavior:Register("image", image_behavior)
function image_behavior:Init()
    local default_image_size = {width=32, height=32}
    local default_border_size = {width=36, height=36}
    local default_image_offset = {x=2, y=2, z=1}
    local border_color = palette_data.border_color 
    self.sprite:AddSprite(
    "image_border", 
    "./image/ui/blank2.png", 
    {size=default_border_size, color=border_color})

    self.sprite:AddSprite(
    "image", 
    "./image/ui/blank2.png", 
    {size=default_image_size, offset=default_image_offset})

    return self
end

function image_behavior:SetTexture(texture)
    local image_sprite = self.sprite.sprites["image"]
    image_sprite.texture = texture
end

function image_behavior:SetTextureSize(width, height)
    local image_sprite = self.sprite.sprites["image"]
    if image_sprite then
        image_sprite.size = {width=width, height=height}
    end

    local border_sprite = self.sprite.sprites["image_border"]
    if border_sprite then
        border_sprite.size = {width=width+4, height=height+4}
    end
end

function image_behavior:SetBorderEnabled(enable)
    if not enable then 
        self.sprite:RemoveSprite("image_border")
        return
    end
    local image_sprite = self.sprite.sprites["image"]
    if not image_sprite then
        local size = default_border_size
    else
        local image_sprite_size = image_sprite.size
        if image_sprite_size.width == -1 or image_sprite_size.height == -1 then
            local size = self.size
        else
            local size = {width=image_sprite_size.width+4, height=image_sprite_size.height+4}
        end
    end

    self.sprite:AddSprite(
    "image_border", 
    "./image/ui/blank2.png", 
    {size=size, color=border_color})
end

function image_behavior:AddAnimationState(key, texture_format, start_idx, end_idx, loop)
    self.animation:AddState(key, "image", texture_format, start_idx, end_idx, loop)
end
function image_behavior:RemoveAnimationState(key)
    self.animation:RemoveState(key)
end
function image_behavior:PlayAnimation(key)
    self.animation:StopAll() 
    self.animation:Play(key)
end
function image_behavior:StopAnimation(key)
    self.animation:Stop(key) 
end

yecs.EntityFactory:Register(
"image",
{"position", "sprite", "size", "tick", "animation"},
{"image"})


--progress
local progress_behavior = {}
yecs.Behavior:Register("progress", progress_behavior)
function progress_behavior:Init()
    local default_size = {width=64, height=4}
    local default_border_size = {width=68, height=8}
    local border_color = palette_data.border_color 
    local background_color = palette_data.background_color
    local progress_color = palette_data.red

    self.sprite:AddSprite(
    "progress_border", 
    "./image/ui/blank2.png", 
    {size=default_border_size, color=border_color})

    self.sprite:AddSprite(
    "progress_backgroud", 
    "./image/ui/blank2.png", 
    {size=default_size, offset={x=2, y=2, z=1}, color=background_color})

    self.sprite:AddSprite(
    "progress", 
    "./image/ui/blank2.png", 
    {size=default_size, offset={x=2, y=2, z=2}, color=progress_color})

    self:SetPercent(100)
    return self
end

function progress_behavior:SetPercent(percent)
    self.data.percent = percent
    local sprites = self.sprite.sprites
    local full_width = sprites["progress_backgroud"].size.width
    if percent < 0 then percent = 0 end
    if percent > 100 then percent = 100 end
    sprites["progress"].size.width = percent * full_width // 100
end

function progress_behavior:GetPercent()
    return self.data.percent
end


yecs.EntityFactory:Register(
"progress",
{"position", "sprite", "tree", "size", "data"},
{"progress"}
)

--panel
local panel_behavior = {}
yecs.Behavior:Register("panel", panel_behavior)
function panel_behavior:Init()
    local panel_size = {width=64, height=64}
    local panel_color = palette_data.colors[2] 

    self.sprite:AddSprite(
    "panel", 
    "./image/ui/blank2.png", 
    {size=panel_size, color=panel_color})
    self.size = {width=64, height=64}

    return self
end

function panel_behavior:SetSize(width, height)
    self.size.width = width
    self.size.height = height
    local sprites = self.sprite.sprites
    local sprite_size = sprites["panel"].size
    sprite_size.width = width
    sprite_size.height = height
end

yecs.EntityFactory:Register(
"panel",
{"position", "sprite", "tree", "size"},
{"panel"}
)

-- palette
local palette_behavior = {}
yecs.Behavior:Register("palette", palette_behavior)
function palette_behavior:Init()
    local palette_size = 4
    local offset_x = 0
    for i, color in ipairs(palette_data.colors) do
        self.sprite:AddSprite(
        "palette"..i, 
        "./image/ui/blank2.png", 
        {size={width=palette_size, height=palette_size}, color=color, offset={x=offset_x, y=0, z=1}})
        offset_x = offset_x + palette_size
    end
end

yecs.EntityFactory:Register(
"palette",
{"position", "sprite", "tree", "size"},
{"palette"}
)

-- palette
local progress_selector_behavior = {}
yecs.Behavior:Register("progress_selector", progress_selector_behavior)
function progress_selector_behavior:Init()
    local block_width = 2
    local block_interval = 1 
    local block_height = 2
    local block_height_selected = 4
    local block_num = 100
    local color = palette_data.white

    self.data.block_height = block_height
    self.data.block_height_selected = block_height_selected
    self.data.block_num = block_num

    local offset_x = block_interval
    for idx = 1, block_num, 1 do
        self.sprite:AddSprite(
        "progress_selector_block"..idx, 
        "./image/ui/blank2.png", 
        {size={width=block_width, height=block_height}, color=color, offset={x=offset_x, y=0, z=1}})
        offset_x = offset_x + block_interval + block_width 
    end

    self:SetCurrent(1)
end

function progress_selector_behavior:SetCurrent(cur_idx)
    local sprite = nil
    local block_height = self.data.block_height
    local block_height_selected = self.data.block_height_selected
    self.data.current_idx = cur_idx

    for idx = 1, self.data.block_num, 1 do
        sprite = self.sprite.sprites["progress_selector_block"..idx]
        if sprite then
            sprite.size.height = block_height
        end
    end

    sprite = self.sprite.sprites["progress_selector_block"..cur_idx]
    if sprite then
        sprite.size.height = block_height_selected
    end
end

function progress_selector_behavior:GetCurrent()
    return self.data.current_idx 
end

function progress_selector_behavior:GetMax()
    return self.data.block_num
end

yecs.EntityFactory:Register(
"progress_selector",
{"position", "sprite", "tree", "size", "data"},
{"progress_selector"}
)

return entities
local ui_entities = require("core.entities.ui_entities")

--[[
Save Table to File
Load Table from File
v 1.0

Lua 5.2 compatible

Only Saves Tables, Numbers and Strings
Insides Table References are saved
Does not save Userdata, Metatables, Functions and indices of these
----------------------------------------------------
table.save( table , filename )

on failure: returns an error msg

----------------------------------------------------
table.load( filename or stringtable )

Loads a table that has been saved via the table.save function

on success: returns a previously saved table
on failure: returns as second argument an error msg
----------------------------------------------------

Licensed under the same terms as Lua itself.
]]--
do
    -- declare local variables
    --// exportstring( string )
    --// returns a "Lua" portable version of the string
    local function exportstring( s )
        return string.format("%q", s)
    end

    --// The Save Function
    function table.save(  tbl,filename )
        local charS,charE = "   ","\n"
        local file,err = io.open( filename, "wb" )
        if err then return err end

        -- initiate variables for save procedure
        local tables,lookup = { tbl },{ [tbl] = 1 }
        file:write( "return {"..charE )

        for idx,t in ipairs( tables ) do
            file:write( "-- Table: {"..idx.."}"..charE )
            file:write( "{"..charE )
            local thandled = {}

            for i,v in ipairs( t ) do
                thandled[i] = true
                local stype = type( v )
                -- only handle value
                if stype == "table" then
                    if not lookup[v] then
                        table.insert( tables, v )
                        lookup[v] = #tables
                    end
                    file:write( charS.."{"..lookup[v].."},"..charE )
                elseif stype == "string" then
                    file:write(  charS..exportstring( v )..","..charE )
                elseif stype == "number" then
                    file:write(  charS..tostring( v )..","..charE )
                end
            end

            for i,v in pairs( t ) do
                -- escape handled values
                if (not thandled[i]) then

                    local str = ""
                    local stype = type( i )
                    -- handle index
                    if stype == "table" then
                        if not lookup[i] then
                            table.insert( tables,i )
                            lookup[i] = #tables
                        end
                        str = charS.."[{"..lookup[i].."}]="
                    elseif stype == "string" then
                        str = charS.."["..exportstring( i ).."]="
                    elseif stype == "number" then
                        str = charS.."["..tostring( i ).."]="
                    end

                    if str ~= "" then
                        stype = type( v )
                        -- handle value
                        if stype == "table" then
                            if not lookup[v] then
                                table.insert( tables,v )
                                lookup[v] = #tables
                            end
                            file:write( str.."{"..lookup[v].."},"..charE )
                        elseif stype == "string" then
                            file:write( str..exportstring( v )..","..charE )
                        elseif stype == "number" then
                            file:write( str..tostring( v )..","..charE )
                        elseif stype == "boolean" then
                            file:write( str..tostring( v )..","..charE )
                        end
                    end
                end
            end
            file:write( "},"..charE )
        end
        file:write( "}" )
        file:close()
    end

    --// The Load Function
    function table.load( sfile )
        local ftables,err = loadfile( sfile )
        if err then return _,err end
        local tables = ftables()
        for idx = 1,#tables do
            local tolinki = {}
            for i,v in pairs( tables[idx] ) do
                if type( v ) == "table" then
                    tables[idx][i] = tables[v[1]]
                end
                if type( i ) == "table" and tables[i[1]] then
                    table.insert( tolinki,{ i,tables[i[1]] } )
                end
            end
            -- link indices
            for _,v in ipairs( tolinki ) do
                tables[idx][v[2]],tables[idx][v[1]] =  tables[idx][v[1]],nil
            end
        end
        return tables[1]
    end
    -- close do
end

-- ChillCode
local copy_module = {}

local function deep_copy(obj, seen)
	-- Handle non-tables and previously-seen tables.
	if type(obj) ~= 'table' then return obj end
	if seen and seen[obj] then return seen[obj] end

	-- New table; mark it as seen an copy recursively.
	local s = seen or {}
	local res = {}
	s[obj] = res
	for k, v in next, obj do res[deep_copy(k, s)] = deep_copy(v, s) end
	return setmetatable(res, getmetatable(obj))
end

local function copy(obj)
	if type(obj) ~= 'table' then return obj end
    local c = {}
	for k, v in next, obj do c[k] = v end
	return setmetatable(c, getmetatable(obj))
end

copy_module.deep_copy = deep_copy 
copy_module.copy = copy

return copy_module
local uuid = {}
local random = math.random

local function new()
    local template ='xxxxxxxx'
    return string.gsub(template, '[xy]', function (c)
        local v = (c == 'x') and random(0, 0xf) or random(8, 0xb)
        return string.format('%x', v)
    end)
end
uuid.new = new

return uuid
local reload = {}

function reload.Reload(module_name)  
    package.loaded[module_name] = nil  
    require(module_name)  
end

function reload.ReloadAll()
    local loaded_modules = {}
    for module_name, _ in pairs(package.loaded) do
        table.insert(loaded_modules, module_name)
    end
    for _, module_name in pairs(loaded_modules) do
        package.loaded[module_name] = nil  
    end
    for _, module_name in pairs(loaded_modules) do
        require(module_name)  
    end
end

return reload

local IGNORED_WRITES = {
    Init=true,
    Deinit=true,
    Update=true,
}
local IGNORED_READS = {}

-- Raises an error when an undeclared variable is read.
local function guardGlobals()
    assert(getmetatable(_G) == nil, "another global metatable exists")

    -- The detecting of undeclared vars is discussed on:
    -- http://www.lua.org/pil/14.2.html
    -- http://lua-users.org/wiki/DetectingUndefinedVariables
    setmetatable(_G, {
        __newindex = function (table, key, value)
            if not IGNORED_WRITES[key] then
                local info = debug.getinfo(2, "Sl")
                io.stderr:write(string.format(
                    "strict: %s:%s: write to undeclared variable: %s\n",
                    tostring(info.short_src), tostring(info.currentline), key))
            end
            rawset(table, key, value)
        end,
        __index = function (table, key)
            if IGNORED_READS[key] then
                return
            end
            error("attempt to read undeclared variable "..key, 2)
        end,
    })

    local origRequire = require
    function require(modname)
        IGNORED_WRITES[modname] = true
        return origRequire(modname)
    end
end

guardGlobals()
local mario_music = {}

mario_music.data = {
    {0, 659, 125},
    {125, 659, 125},
    {375, 659, 125},
    {667, 523, 125},
    {792, 659, 125},
    {1042, 784, 125},
    {1542, 392, 125},
    {2042, 523, 125},
    {2417, 392, 125},
    {2792, 330, 125},
    {3167, 440, 125},
    {3417, 494, 125},
    {3667, 466, 125},
    {3834, 440, 125},
    {4084, 392, 125},
    {4334, 659, 125},
    {4584, 784, 125},
    {4834, 880, 125},
    {5084, 698, 125},
    {5209, 784, 125},
    {5459, 659, 125},
    {5709, 523, 125},
    {5959, 587, 125},
    {6084, 494, 125},
    {6334, 523, 125},
    {6709, 392, 125},
    {7084, 330, 125},
    {7459, 440, 125},
    {7709, 494, 125},
    {7959, 466, 125},
    {8126, 440, 125},
    {8376, 392, 125},
    {8626, 659, 125},
    {8876, 784, 125},
    {9126, 880, 125},
    {9376, 698, 125},
    {9501, 784, 125},
    {9751, 659, 125},
    {10001, 523, 125},
    {10251, 587, 125},
    {10376, 494, 125},
    {10876, 784, 125},
    {11001, 740, 125},
    {11126, 698, 125},
    {11293, 622, 125},
    {11543, 659, 125},
    {11835, 415, 125},
    {11960, 440, 125},
    {12085, 523, 125},
    {12335, 440, 125},
    {12460, 523, 125},
    {12585, 587, 125},
    {12960, 784, 125},
    {13085, 740, 125},
    {13210, 698, 125},
    {13377, 622, 125},
    {13627, 659, 125},
    {13919, 698, 125},
    {14169, 698, 125},
    {14294, 698, 125},
    {15044, 784, 125},
    {15169, 740, 125},
    {15294, 698, 125},
    {15461, 622, 125},
    {15711, 659, 125},
    {16003, 415, 125},
    {16128, 440, 125},
    {16253, 523, 125},
    {16503, 440, 125},
    {16628, 523, 125},
    {16753, 587, 125},
    {17128, 622, 125},
    {17503, 587, 125},
    {17878, 523, 125},
    {19128, 784, 125},
    {19253, 740, 125},
    {19378, 698, 125},
    {19545, 622, 125},
    {19795, 659, 125},
    {20087, 415, 125},
    {20212, 440, 125},
    {20337, 523, 125},
    {20587, 440, 125},
    {20712, 523, 125},
    {20837, 587, 125},
    {21212, 784, 125},
    {21337, 740, 125},
    {21462, 698, 125},
    {21629, 622, 125},
    {21879, 659, 125},
    {22171, 698, 125},
    {22421, 698, 125},
    {22546, 698, 125},
    {23296, 784, 125},
    {23421, 740, 125},
    {23546, 698, 125},
    {23713, 622, 125},
    {23963, 659, 125},
    {24255, 415, 125},
    {24380, 440, 125},
    {24505, 523, 125},
    {24755, 440, 125},
    {24880, 523, 125},
    {25005, 587, 125},
    {25380, 622, 125},
    {25755, 587, 125},
    {26130, 523, 125},
}

function mario_music.play_music()
    for index, value in ipairs(mario_music.data) do
        yapre.AddTimer(value[1], function() yapre.Beep(value[2], value[3]) end)
    end
end

return mario_music
local app = {}

local core = require("core")
local yecs = core.yecs

local splash_screen = require("core.splash_screen")
local game = require("app.game")

function app:Init()
    yapre.SetRenderSize(320, 240)
    splash_screen:Show(function() game:Init() end)
    return true
end

function app:Update(delta_ms)
    yecs.World:UpdateAllWorlds(delta_ms)
end

function app:Deinit()
end


return app
local rewind_controller = {}

local core = require("core")
local yecs = core.yecs

local serialization = require("core.serialization")

rewind_controller.dump_data = {}
rewind_controller.dump_data_cur_idx = 1
rewind_controller.dump_data_max_num = 100

function rewind_controller:OnKey(timestamp, state, multi, keycode)
    if state == 1 then
        keycode = string.char(keycode)
        if keycode == "\t" then
            self:PauseOrResume()
            return
        end
        
        if not self.paused then return end

        if keycode == "s" then
            self:Save()
            return 
        end
        
        local delta = 1
        if keycode == "a" then 
            delta = -1 
        elseif keycode == "d" then
            delta = 1
        else
            return
        end

        local ps = self.progress_selector

        local cur_idx = ps:GetCurrent()
        local max_idx = ps:GetMax()

        cur_idx = cur_idx + delta
        if cur_idx > max_idx then 
            cur_idx = max_idx
        elseif cur_idx < 1 then
            cur_idx = 1
        end
       
        local r_idx = self.dump_data_cur_idx - 1 - ps:GetMax() + cur_idx
        if r_idx < 1 then 
            cur_idx = cur_idx - r_idx + 1 
            r_idx = 1
        end

        ps:SetCurrent(cur_idx)
        self:Load(r_idx)
    end
end

function rewind_controller:Make(game_worlds)
    local world = yecs.World:New("rewind_controller")
    world:AddSystems({"sprite", "input", "tree", "tick"})
    world.systems["input"].OnKey = function(input_system, timestamp, state, multi, keycode)
        self:OnKey(timestamp, state, multi, keycode)
    end

    
    local control_panel = yecs.EntityFactory:Make("panel")
    world:AddEntity(control_panel)
    control_panel:SetSize(yapre.render_width, 30)
    control_panel.position.z = 1024

    local progress_selector = yecs.EntityFactory:Make("progress_selector")
    world:AddEntity(progress_selector)
    control_panel.tree:AddChild(progress_selector)

    local label = yecs.EntityFactory:Make("label")
    world:AddEntity(label)
    label.text.size = 2
    label:SetText("PAUSED!")
    label.position.x = 10
    label.position.y = 10
    control_panel.tree:AddChild(label)
    
    self.game_worlds = game_worlds
    self.progress_selector = progress_selector
    self.control_panel = control_panel
    self.world = world
    
    self:ShowControlPanel(false)
    self:AddTimer()
    return world
end

function rewind_controller:Dump() 
    local game_worlds = self.game_worlds
    
    local data = {}
    for game_world_key, game_world in pairs(game_worlds) do
        data[game_world_key] = serialization:DumpWorld(game_world)
    end
    
    local idx = self.dump_data_cur_idx
    idx = idx % self.dump_data_max_num
    self.dump_data[idx] = data
    self.dump_data_cur_idx = self.dump_data_cur_idx + 1
end

function rewind_controller:Load(idx)
    idx = idx % self.dump_data_max_num
    local data = self.dump_data[idx]
    if not data then return end 
    
    local game_worlds = self.game_worlds
    for game_world_key, game_world in pairs(game_worlds) do
        game_world:Destroy()
    end

    for game_world_key, game_world_data in pairs(data) do
        local game_world = serialization:LoadWorld(game_world_data)
        game_world:Pause()
        game_worlds[game_world_key] = game_world
    end
end

function rewind_controller:PauseOrResume()
    local game_worlds = self.game_worlds
    if self.paused then
        self.paused = false
        for _, game_world in pairs(game_worlds) do
            game_world:Resume()
        end
        self.dump_data_cur_idx = self.dump_data_cur_idx - 1
        self.progress_selector:SetCurrent(-1)
        self:ShowControlPanel(false)
    else
        self.paused = true
        for _, game_world in pairs(game_worlds) do
            game_world:Pause()
        end
        self:Dump()
        self.progress_selector:SetCurrent(self.progress_selector:GetMax())
        self:ShowControlPanel(true)
    end
end

function rewind_controller:ShowControlPanel(v)
    if v then 
        self.control_panel.position.y = 0
    else
        self.control_panel.position.y = -yapre.render_height
    end
end

function rewind_controller:AddTimer()
    yapre.AddTimer(250, function()
        if not self.paused then self:Dump() end
        self:AddTimer()
    end)
end

function rewind_controller:Save()
    if not self.paused then return end
    local data = self.dump_data[self.dump_data_cur_idx-1] 
    data = serialization:DumpWorld(self.world)
    table.save(data, "./dump.lua")
end


return rewind_controller
local test_world = {}

local core = require("core")
local yecs = core.yecs

yecs.Behavior:Register("increase_progress_behavior", {
    OnInit=function(self)
        self:AddComponent("tick")
        local progress_delta = 1
        self.tick:AddTick("increase_progress", 
        function() 
            local percent = self:GetPercent()
            if percent == 100 then 
                progress_delta = -1
            elseif percent == 0 then
                progress_delta = 1
            end
            self:SetPercent(percent+progress_delta)
        end)
    end,
})

yecs.Behavior:Register("button1_behavior", {
    OnClicked=function(self, x, y)
        self.world:GetEntityByTags({"image"}):PlayAnimation("die")
        self.world:GetEntityByTags({"button2"}):SetState("normal")
        self:SetState("disabled")
    end,
    OnInit=function(self)
        self:AddComponent("tags")
        self.tags["button1"] = true
    end
})

yecs.Behavior:Register("button2_behavior", {
    OnClicked=function(self, x, y)
        self.world:GetEntityByTags({"image"}):PlayAnimation("live")
        self.world:GetEntityByTags({"button1"}):SetState("normal")
        self:SetState("disabled")
    end,
    OnInit=function(self)
        self:AddComponent("tags")
        self.tags["button2"] = true
    end
})

yecs.Behavior:Register("image_behavior", {
    OnInit=function(self)
        self:AddComponent("tags")
        self.tags["image"] = true
    end
})

function test_world:Make()
    local world = yecs.World:New("test_world")
    world:AddSystems({"sprite", "input", "tree", "tick"})

    local button1 = yecs.EntityFactory:Make("button", {"button1_behavior"})
    local button2 = yecs.EntityFactory:Make("button", {"button2_behavior"})

    local image = yecs.EntityFactory:Make("image", {"image_behavior"})

    local label = yecs.EntityFactory:Make("label")
    local progress = yecs.EntityFactory:Make("progress", {"increase_progress_behavior"})
    local panel = yecs.EntityFactory:Make("panel")
    local palette = yecs.EntityFactory:Make("palette")

    panel:SetSize(320, 128)
    panel.position = {x=0, y=0, z=0}

    progress.position = {x=80, y=8, z=1}
    progress:SetPercent(10)

    image:SetTextureSize(128,128)
    image:SetTexture("./image/animation/blood/1.png")

    image.position = {x=8, y=yapre.render_height-8-128, z=1}
    image:AddAnimationState("die", "./image/animation/blood/%d.png", 1, 20)
    image:AddAnimationState("live", "./image/animation/blood/%d.png", 1, 1)

    label:SetText("O wonder! \nHow many goodly creatures are there here!\nHow beauteous mankind is!\nO brave new world,\nThat has such people in't.")
    label:SetMaxSize(64, -1)
    label.position = {x=8, y=8, z=1}

    button1.position = {x=yapre.render_width-8-32, y=yapre.render_height-8-32, z=1}
    button2.position = {x=yapre.render_width-8-32-32, y=yapre.render_height-8-32, z=1}

    button1:SetState("normal")
    button2:SetState("disabled")

    world:AddEntity(button1)
    world:AddEntity(button2)
    world:AddEntity(label)
    world:AddEntity(image)
    world:AddEntity(progress)
    -- world:AddEntity(panel)
    world:AddEntity(palette)

    return world 
end

return test_world
local app = require("app.app")
return app
local world_mario_music = {}

local core = require("core")
local yecs = core.yecs

world_mario_music.data = {
    {0, 659, 125},
    {125, 659, 125},
    {375, 659, 125},
    {667, 523, 125},
    {792, 659, 125},
    {1042, 784, 125},
    {1542, 392, 125},
    {2042, 523, 125},
    {2417, 392, 125},
    {2792, 330, 125},
    {3167, 440, 125},
    {3417, 494, 125},
    {3667, 466, 125},
    {3834, 440, 125},
    {4084, 392, 125},
    {4334, 659, 125},
    {4584, 784, 125},
    {4834, 880, 125},
    {5084, 698, 125},
    {5209, 784, 125},
    {5459, 659, 125},
    {5709, 523, 125},
    {5959, 587, 125},
    {6084, 494, 125},
    {6334, 523, 125},
    {6709, 392, 125},
    {7084, 330, 125},
    {7459, 440, 125},
    {7709, 494, 125},
    {7959, 466, 125},
    {8126, 440, 125},
    {8376, 392, 125},
    {8626, 659, 125},
    {8876, 784, 125},
    {9126, 880, 125},
    {9376, 698, 125},
    {9501, 784, 125},
    {9751, 659, 125},
    {10001, 523, 125},
    {10251, 587, 125},
    {10376, 494, 125},
    {10876, 784, 125},
    {11001, 740, 125},
    {11126, 698, 125},
    {11293, 622, 125},
    {11543, 659, 125},
    {11835, 415, 125},
    {11960, 440, 125},
    {12085, 523, 125},
    {12335, 440, 125},
    {12460, 523, 125},
    {12585, 587, 125},
    {12960, 784, 125},
    {13085, 740, 125},
    {13210, 698, 125},
    {13377, 622, 125},
    {13627, 659, 125},
    {13919, 698, 125},
    {14169, 698, 125},
    {14294, 698, 125},
    {15044, 784, 125},
    {15169, 740, 125},
    {15294, 698, 125},
    {15461, 622, 125},
    {15711, 659, 125},
    {16003, 415, 125},
    {16128, 440, 125},
    {16253, 523, 125},
    {16503, 440, 125},
    {16628, 523, 125},
    {16753, 587, 125},
    {17128, 622, 125},
    {17503, 587, 125},
    {17878, 523, 125},
    {19128, 784, 125},
    {19253, 740, 125},
    {19378, 698, 125},
    {19545, 622, 125},
    {19795, 659, 125},
    {20087, 415, 125},
    {20212, 440, 125},
    {20337, 523, 125},
    {20587, 440, 125},
    {20712, 523, 125},
    {20837, 587, 125},
    {21212, 784, 125},
    {21337, 740, 125},
    {21462, 698, 125},
    {21629, 622, 125},
    {21879, 659, 125},
    {22171, 698, 125},
    {22421, 698, 125},
    {22546, 698, 125},
    {23296, 784, 125},
    {23421, 740, 125},
    {23546, 698, 125},
    {23713, 622, 125},
    {23963, 659, 125},
    {24255, 415, 125},
    {24380, 440, 125},
    {24505, 523, 125},
    {24755, 440, 125},
    {24880, 523, 125},
    {25005, 587, 125},
    {25380, 622, 125},
    {25755, 587, 125},
    {26130, 523, 125},
}

yecs.Behavior:Register("world_mario_music_play_btn_behavior", {
    OnClicked=function(self, x, y)
        local data = self.data
        if data.playing then return end
        data.playing = true
        data.delta_ms = 0

        self.world:GetEntityByTags({"world_mario_music_stop_btn"}):SetState("normal")
        self:SetState("disabled")
    end,
    OnInit=function(self)
        self:AddComponent("tags")
        self:AddComponent("data")
        self:AddComponent("tick")
        local data = self.data
        data.playing = false
        data.delta_ms = 0
        
        self.tags["world_mario_music_play_btn"] = true
        self.tick:AddTick("world_mario_music_play", 
        function(tick_ms) 
            if not data.playing then
                self.world:GetEntityByTags({"world_mario_music_stop_btn"}):SetState("disabled")
                self:SetState("normal")
                return
            end

            self.world:GetEntityByTags({"world_mario_music_stop_btn"}):SetState("normal")
            self:SetState("disabled")

            for _, md in ipairs(world_mario_music.data) do
                if md[1] > data.delta_ms + tick_ms then 
                    break 
                elseif md[1] > data.delta_ms then
                    yapre.Beep(md[2], md[3])
                    break
                end
            end
            data.delta_ms = data.delta_ms + tick_ms
        end)
 
    end
})

yecs.Behavior:Register("world_mario_music_stop_btn_behavior", {
    OnClicked=function(self, x, y)
        local play_btn = self.world:GetEntityByTags({"world_mario_music_play_btn"})
        play_btn:SetState("normal")
        play_btn.data.playing = false
        play_btn.data.delta_ms = 0
        self:SetState("disabled")
    end,
    OnInit=function(self)
        self:AddComponent("tags")
        self.tags["world_mario_music_stop_btn"] = true
    end
})


function world_mario_music:Make()
    local world = yecs.World:New("world_mario_music")
    world:AddSystems({"sprite", "input", "tree", "tick"})

    local play_btn = yecs.EntityFactory:Make("button", {"world_mario_music_play_btn_behavior"})
    local stop_btn = yecs.EntityFactory:Make("button", {"world_mario_music_stop_btn_behavior"})
    local image = yecs.EntityFactory:Make("image")
    image:SetTextureSize(32, 32)
    image:SetTexture("./image/mario.png")

    play_btn.position = {x=yapre.render_width/2-32, y=yapre.render_height/2, z=1}
    stop_btn.position = {x=yapre.render_width/2, y=yapre.render_height/2, z=1}
    image.position = {x=yapre.render_width/2-16, y=yapre.render_height/2-32-8, z=1}

    world:AddEntity(play_btn)
    world:AddEntity(stop_btn)
    world:AddEntity(image)

    return world 
end

return world_mario_music
local world_image = {}

local core = require("core")
local yecs = core.yecs


yecs.Behavior:Register("world_image_button1_behavior", {
    OnClicked=function(self, x, y)
        self.world:GetEntityByTags({"image2"}):PlayAnimation("die")
        self.world:GetEntityByTags({"button2"}):SetState("normal")
        self:SetState("disabled")
    end,
    OnInit=function(self)
        self:AddComponent("tags")
        self.tags["button1"] = true
    end
})

yecs.Behavior:Register("world_image_button2_behavior", {
    OnClicked=function(self, x, y)
        self.world:GetEntityByTags({"image2"}):PlayAnimation("live")
        self.world:GetEntityByTags({"button1"}):SetState("normal")
        self:SetState("disabled")
    end,
    OnInit=function(self)
        self:AddComponent("tags")
        self.tags["button2"] = true
    end
})

yecs.Behavior:Register("world_image_image2_behavior", {
    OnInit=function(self)
        self:AddComponent("tags")
        self.tags["image2"] = true
    end
})


function world_image:Make()
    local world = yecs.World:New("world_image")
    world:AddSystems({"sprite", "input", "tree", "tick"})

    local image1 = yecs.EntityFactory:Make("image")
    image1.position = {x=8, y=8, z=1}
    image1:SetTextureSize(128,128)
    image1:AddAnimationState("loop", "./image/animation/wizard/%d.png", 1, 16, true)
    image1:PlayAnimation("loop")

    local image2 = yecs.EntityFactory:Make("image", {"world_image_image2_behavior"})
    image2.position = {x=8+128+8, y=8+32+8, z=1}
    image2:SetTextureSize(128,128)
    image2:SetTexture("./image/animation/blood/1.png")

    image2:AddAnimationState("die", "./image/animation/blood/%d.png", 1, 20)
    image2:AddAnimationState("live", "./image/animation/blood/%d.png", 1, 1)

    local button1 = yecs.EntityFactory:Make("button", {"world_image_button1_behavior"})
    local button2 = yecs.EntityFactory:Make("button", {"world_image_button2_behavior"})

    button1.position = {x=8+8+128+32, y=8+32+8+128+4, z=1}
    button2.position = {x=8+8+128, y=8+32+8+128+4, z=1}

    button1:SetState("normal")
    button2:SetState("disabled")

    world:AddEntity(button1)
    world:AddEntity(button2)
    world:AddEntity(image1)
    world:AddEntity(image2)

    return world
end


return world_image
local world_label = {}

local core = require("core")
local yecs = core.yecs

yecs.Behavior:Register("world_label_time_label_behavior", {
    OnInit=function(self)
        self:AddComponent("tick")
        self:AddComponent("data")
        self.data.now_time = 0
        local interval = 23
        self.data.timer_callback = function(delta_ms)
            self.data.now_time = self.data.now_time + interval + delta_ms
            self:SetText(string.format("timing: %.4f", self.data.now_time/1000))
            self.tick:AddTimer("time_tick", interval, self.data.timer_callback)
        end
        self.tick:AddTimer("time_tick", interval, self.data.timer_callback)
    end,
})


function world_label:Make()
    local world = yecs.World:New("world_label")
    world:AddSystems({"sprite", "input", "tree", "tick"})

    local time_label = yecs.EntityFactory:Make("label", {"world_label_time_label_behavior"})
    local world_label_a = yecs.EntityFactory:Make("label")
    local world_label_b = yecs.EntityFactory:Make("label")
    local world_label_c = yecs.EntityFactory:Make("label")
    local world_label_d = yecs.EntityFactory:Make("label")

    time_label:SetFontSize(2)
    time_label.position = {x=8, y=yapre.render_height-16-4, z=1}
    
    local worlds = "O wonder! \nHow many goodly creatures are there here!\nHow beauteous mankind is!\nO brave new world,\nThat has such people in't."
    world_label_a:SetText(worlds)
    world_label_b:SetText(worlds)
    world_label_c:SetText(worlds)
    world_label_d:SetText("Label test")

    world_label_a:SetMaxSize(32, -1)
    world_label_a.position = {x=8, y=8, z=1}

    world_label_b:SetMaxSize(yapre.render_width-48-8, -1)
    world_label_b.position = {x=48, y=8, z=1}

    world_label_c:SetMaxSize(yapre.render_width-48-8, -1)
    world_label_c.position = {x=48, y=9*4+8+8, z=1}
    world_label_c:SetFontSize(2)

    world_label_d:SetMaxSize(yapre.render_width-48-8, -1)
    world_label_d.position = {x=48, y=yapre.render_height-56, z=1}
    world_label_d:SetFontSize(4)

    world:AddEntity(time_label)
    world:AddEntity(world_label_a)
    world:AddEntity(world_label_b)
    world:AddEntity(world_label_c)
    world:AddEntity(world_label_d)

    return world
end

return world_label
local world_slides = {}

local core = require("core")
local yecs = core.yecs


yecs.Behavior:Register("world_slides_next_btn_behavior", {
    OnClicked=function(self, x, y)
        local game = require("app.game")
        if game.NextWorld then
            game:NextWorld()
        end
    end,
})

yecs.Behavior:Register("world_slides_prev_btn_behavior", {
    OnClicked=function(self, x, y)
        local game = require("app.game")
        if game.PrevWorld then
            game:PrevWorld()
        end
    end,
})

function world_slides:Make()
    local world = yecs.World:New("world_slides")
    world:AddSystems({"sprite", "input", "tree", "tick"})

    local next_btn = yecs.EntityFactory:Make("button", {"world_slides_next_btn_behavior"})
    local prev_btn = yecs.EntityFactory:Make("button", {"world_slides_prev_btn_behavior"})

    next_btn.position = {x=yapre.render_width-4-32, y=yapre.render_height-32, z=1024}
    prev_btn.position = {x=yapre.render_width-4-32*2, y=yapre.render_height-32, z=1024}

    world:AddEntity(next_btn)
    world:AddEntity(prev_btn)

    return world
end

return world_slides
local game = {}

local rewind_controller = require("app.rewind_controller")
local world_mario_music = require("app.game.world_mario_music")
local world_slides = require("app.game.world_slides")
local world_label = require("app.game.world_label")
local world_image = require("app.game.world_image")
local world_flappy_duck = require("app.game.world_flappy_duck")

game.worlds = setmetatable({}, {__mode="v"})
game.rewind_controller = nil

function game:Init()
    self.cur_world_idx = 1
    self.worlds = {}
    self.rewind_controller = rewind_controller:Make(self.worlds)

    self.worlds_to_show = {world_label, world_mario_music, world_image, world_flappy_duck}
    
    self.worlds["world_slides"] = world_slides:Make()
    self.worlds[self.cur_world_idx] =  self.worlds_to_show[self.cur_world_idx]:Make()
end

function game:Deinit()
end

function game:NextWorld()
    if self.cur_world_idx == #self.worlds_to_show then return end

    self.worlds[self.cur_world_idx]:Destroy()
    self.cur_world_idx = self.cur_world_idx + 1

    self.worlds[self.cur_world_idx] = self.worlds_to_show[self.cur_world_idx]:Make()
end

function game:PrevWorld()
    if self.cur_world_idx == 1 then return end

    self.worlds[self.cur_world_idx]:Destroy()
    self.cur_world_idx = self.cur_world_idx - 1

    self.worlds[self.cur_world_idx] = self.worlds_to_show[self.cur_world_idx]:Make()
end


function game:Dump()

end

function game:Load()

end


return game
local world_flappy_duck = {}

local core = require("core")
local yecs = core.yecs

yecs.Behavior:Register("world_flappy_duck_duck_behavior", {
    OnInit=function(self)
        self.tags["duck"] = true
        
        self.size = {width = 32, height=32}
        self:SetTextureSize(self.size.width, self.size.height)
        self:SetTexture("./image/flappy_duck/duck/up1.png")

        self:AddAnimationState("up", "./image/flappy_duck/duck/up%d.png", 1, 2, true)
        self:AddAnimationState("down", "./image/flappy_duck/duck/down%d.png", 1, 2, true)
        self:PlayAnimation("up")
        self:SetBorderEnabled(false)
        
        self:Born()
        self.data.y = yapre.render_height * 2
        self.position.y = self.data.y
        self.position.z = 128
        self:Die()

        self.tick:AddTick("duck_tick", 
        function(delta_ms)
            local cs = self.world:GetEntitiesByTags({"cactus"})
            for _, c in pairs(cs) do
                if self.position.x + self.size.width - 12 < c.position.x or
                    self.position.x + 12 > c.position.x + c.size.width or
                    self.position.y + self.size.height - 12 < c.position.y or
                    self.position.y + 12 > c.position.y + c.size.height then
                    -- nothing
                else
                    self:Die()
                end
            end

            if self.position.y > yapre.render_height or self.position.y < - self.size.height then
                self:Die()
            end

            if self.position.y > yapre.render_height * 2 and self.data.up_speed < 0 then
                return 
            end 

           if delta_ms > 100 then delta_ms = 100 end

           local last_speed = self.data.up_speed
           self.data.y = self.data.y - delta_ms * self.data.up_speed / 1000
           self.position.y = self.data.y // 1
           self.data.up_speed = self.data.up_speed - self.data.g * delta_ms / 1000
           if last_speed * self.data.up_speed > 0 then return end
           if self.data.up_speed > 0 then
                self:PlayAnimation("up")
           else
                self:PlayAnimation("down")
           end
       end
       )
   end,
   Die=function(self)
       self.data.dead = true
       self.data.g = 1000
       if self.data.up_speed > 0 then self.data.up_speed = 0 end

   end,
   Born=function(self)
       self.data.dead = false

       self.data.up_speed = 100
       self.data.d_up_speed = 150 
       self.data.y = yapre.render_height/2
       self.data.g = 500

       self.position.x = 32
       self.position.y = self.data.y
   end,
   Fly=function(self)
       if self.data.dead then return end
       local last_speed = self.data.up_speed
       self.data.up_speed = self.data.d_up_speed 
       if last_speed <= 0 then 
           self:PlayAnimation("up")
       end
   end
})

yecs.EntityFactory:Register(
"flappy_duck",
{"position", "sprite", "tree", "size", "animation", "input", "tags", "data", "tick"},
{"image", "world_flappy_duck_duck_behavior"})


yecs.Behavior:Register("world_flappy_duck_cactus_behavior", {
    OnInit=function(self)
        self.tags["cactus"] = true
        self.size = {width=9, height=240}
        for idx = 1, 30, 1 do
            self.sprite:AddSprite(
            "cactus_"..idx, 
            "./image/flappy_duck/cactus.png", 
            {
                size={width=8, height=8}, 
                offset={x=0, y=(idx-1)*8, z=1}
            })
        end 
        self.data.x = -10
        self.data.y = 0
        self.data.speed = 10
        self.position.z = 64

        self.tick:AddTick("cactus_tick", 
        function(delta_ms)
            local duck = self.world:GetEntityByTags({"duck"})
            if duck.data.dead then
                self.data.x = -self.size.width
                self.position.x = self.data.x
                return
            end
            
            self.data.x = self.data.x - self.data.speed / delta_ms

            if self.data.x < -self.size.width then
                local cs = self.world:GetEntitiesByTags({"cactus"})
                local p_x = yapre.render_width
                for _, c in pairs(cs) do
                    if c.data.x + 80 > p_x then
                        p_x = c.data.x + 80
                    end
                end

                self.data.x = p_x
                local y = 50 + 140 * math.random() // 1
                if math.random() > 0.5 then
                    self.data.y = y - self.size.height
                else
                    self.data.y = y
                end
            end

            self.position.x = self.data.x // 1
            self.position.y = self.data.y //1
        end
        )
    end
})

yecs.Behavior:Register("world_flappy_duck_label_behavior", {
    OnInit=function(self)
        self:AddComponent("tags")
        self:AddComponent("tick")
        self.tags["label"] = true

        self:SetText("TAP THE BUTTON \nTO START!")
        self:SetFontSize(2)
        self.position = {x=128, y=32, z=1}
        self.position.z = 64

        self.tick:AddTick("label_tick", 
        function(delta_ms)
            local duck = self.world:GetEntityByTags({"duck"})
            if duck.data.dead and duck.position.y < yapre.render_height * 2 then
                self:SetText("YOU DIED!\nTAP THE BUTTON \nTO START!")
            elseif not duck.data.dead then
                self:SetText("")
            end
        end
        )
    end,
})

yecs.Behavior:Register("world_flappy_duck_duck_head_behavior", {
    OnInit=function(self)
        self:AddComponent("tags")
        self:AddComponent("tick")
        self.tags["duck_head"] = true

        self.position = {x=16, y=yapre.render_height-128, z=64}
        self:SetTextureSize(128,128)
        self:SetTexture("./image/flappy_duck/duck_head.png")
        self:SetBorderEnabled(false)

        self.tick:AddTick("label_tick", 
        function(delta_ms)
            local duck = self.world:GetEntityByTags({"duck"})
            if duck.data.dead and duck.position.y < yapre.render_height * 2 then
                self.position.x = 16 
            elseif not duck.data.dead then
                self.position.x = -1024 
            end
        end
        )
    end,
})

yecs.EntityFactory:Register(
"cactus",
{"position", "sprite", "tree", "size", "tick", "tags", "data"},
{"world_flappy_duck_cactus_behavior"})

yecs.Behavior:Register("world_flappy_duck_button_behavior", {
    OnClicked=function(self, x, y)
        local duck = self.world:GetEntityByTags({"duck"})
        if duck.data.dead then
            if duck.position.y > yapre.render_height then
                duck:Born()
            end
            return
        end
        duck:Fly()
        
    end,
    OnInit=function(self)
        self:AddComponent("tags")
        self.tags["button"] = true
        self:SetButtonSize(64, 64)
        self.position.y = yapre.render_height - 64 - 32 
        self.position.x = yapre.render_width - 64 - 32
        self.position.z = 128
    end
})

yecs.Behavior:Register("world_flappy_duck_background_behavior", {
    OnInit=function(self)
        self:AddComponent("tags")
        self:AddComponent("tick")
        self:AddComponent("data")

        self.tags["background"] = true
        self.data.tag = "background"

        self.size = {width=128, height=128}
        self:SetTextureSize(128, 128)
        self:SetBorderEnabled(false)

        self.data.x = 0
        self.data.y = 0
        self.data.z = 0
        self.data.speed = 10
        self.data.interval = 0 
        self.data.y_rate = 0 

        self.tick:AddTick("background_tick", 
        function(delta_ms)
            local duck = self.world:GetEntityByTags({"duck"})
            if duck.data.dead then
                return
            end

            self.data.x = self.data.x - self.data.speed / delta_ms
            if self.data.x < -self.size.width then
                local bs = self.world:GetEntitiesByTags({self.data.tag})
                local p_x = 0 -- yapre.render_width
                for _, b in pairs(bs) do
                    if b.data.x + self.data.interval + self.size.width > p_x then
                        p_x = b.data.x + self.data.interval + self.size.width
                    end
                end
                self.data.x = p_x
            end

            self.position.x = self.data.x // 1
            self.position.y = (self.data.y + self.data.y_rate * (duck.data.y - yapre.render_height/2))  // 1
            self.position.z = self.data.z // 1
        
        end
        )
    end
})


function world_flappy_duck:MakeBackground(world)

    local background = yecs.Entity:New({"sprite", "position"}, {})
    background.sprite:AddSprite(
    "background", 
    "./image/ui/blank2.png", 
    {size={width=yapre.render_width, height=yapre.render_height}, color=yapre.palette.colors[1]} 
    )

    background.position.z = 1
    world:AddEntity(background)

    local idx = 1
    for idx = 1, 3, 1 do
        local background_stars = yecs.EntityFactory:Make("image", {"world_flappy_duck_background_behavior"}) 
        world:AddEntity(background_stars)

        background_stars:SetTexture( "./image/flappy_duck/stars.png")
        background_stars.data.tag = "background_stars"
        background_stars.tags[background_stars.data.tag] = true
        background_stars.data.x = 16 * (idx-1) + 128 * (idx-1)
        background_stars.data.y = math.random(32)
        background_stars.data.z = 3
        background_stars.data.interval = 32
        background_stars.data.speed = 2
        background_stars.data.y_rate = 0.03
        
        background_stars.position.x = background_stars.data.x
        background_stars.position.y = background_stars.data.y
        background_stars.position.z = background_stars.data.z
    end
    
    for idx = 1, 4, 1 do
        local background_layer = yecs.EntityFactory:Make("image", {"world_flappy_duck_background_behavior"})  
        world:AddEntity(background_layer)

        background_layer:SetTexture( "./image/flappy_duck/skybg1.png")
        background_layer.data.tag = "background_layer1"
        background_layer.tags[background_layer.data.tag] = true
        background_layer.data.x = 127 * (idx-1)
        background_layer.data.y = 160
        background_layer.data.z = 2
        background_layer.data.speed = 8
        background_layer.data.interval = -1
        background_layer.data.y_rate = -0.1
        
        background_layer.position.x = background_layer.data.x
        background_layer.position.y = background_layer.data.y
        background_layer.position.z = background_layer.data.z
    end

    for idx = 1, 4, 1 do
        local background_layer = yecs.EntityFactory:Make("image", {"world_flappy_duck_background_behavior"})  
        world:AddEntity(background_layer)

        background_layer:SetTexture( "./image/flappy_duck/skybg2.png")
        background_layer.data.tag = "background_layer2"
        background_layer.tags[background_layer.data.tag] = true
        background_layer.data.x = 127 * (idx-1)
        background_layer.data.y = 200
        background_layer.data.z = 4
        background_layer.data.interval = -1
        background_layer.data.y_rate = -0.2
        
        background_layer.position.x = background_layer.data.x
        background_layer.position.y = background_layer.data.y
        background_layer.position.z = background_layer.data.z
    end
end

function world_flappy_duck:Make()
    local world = yecs.World:New("world_flappy_duck")
    world:AddSystems({"sprite", "input", "tree", "tick"})

    local button = yecs.EntityFactory:Make("button", {"world_flappy_duck_button_behavior"})   
    world:AddEntity(button)

    local label = yecs.EntityFactory:Make("label", {"world_flappy_duck_label_behavior"})
    world:AddEntity(label)

    local duck_head = yecs.EntityFactory:Make("image", {"world_flappy_duck_duck_head_behavior"})
    world:AddEntity(duck_head)

    local duck = yecs.EntityFactory:Make("flappy_duck")
    world:AddEntity(duck)

    local idx = 1
    for idx = 1, 5, 1 do
        local cactus = yecs.EntityFactory:Make("cactus")
        world:AddEntity(cactus)
    end

    self:MakeBackground(world)
    return world
end

return world_flappy_duck
PNG

   IHDR   @   @   iq   sRGB   IDATx=jQo}HA"+YOgRtZM+a|hx}=_y3B!r__$ZtW;@Q-6~CH]Lys  &-yz03{3dk/74_ 72; o(Sb\1|  	o 	~<'6lP@.GJpwK z:Z.%MRh.o,9Pl=3 5=),*>7HW^;6pnE/KpLqf:jf==-^{!GAU\    IENDB`PNG

   IHDR         a   IDATxS0}~D~ qdf$.n	&	I$u6^!qXp|D@!O6+o&tYnJmHK10fU?LBTnJN p>^Q~f
!c(:+`>TNYCd!TLZ.KyB*yj	EZ!ZP! 6f([0=
9[sy    IENDB`PNG

   IHDR    @   ,
   sRGB   IDATxj[g4zC/]Kl@PHMP0 Md{I?6?W;                                                                                                                                                                                                                                              eT]6{M|pq Yu  l  X  F  yut|zr/+=?^J V:  a@ 0  @    F  #      avI -_WM  |2yV]v>?. x`:  a@ 0q#U|uP]?%  [ F  #      a@ 0  @    F  (8w9\kh-'OU_}z?  @    &7__u	Au 6      a@ 0  @    F  #      aLe>m3LKb>k~_}[ F  #      a~8.xZ]  E:  a@ 0  @    F  #      aB}x;:lY]k<@ 0  @    &&V  u:  a@ 0q#Yu	  t    a@ 0  @    F   ?.[hSc<6}b>ktUG-  @    F  #    XcO&n}l  = #  1Mc]78 @ 8  @    F  .`Qui/euV F  =!^^p|z     D{ :t    aGwtm;E    &z]8 v  @    o _-[?<z>T-YO]WK  -	 @ 0  @#:'Y     qG3 0:  q@ 0  @    F  #   ];<z>x2~  <Ww]a~ 0 @  bj l  @  07x_^,  #  }_c_ :  a@ 0eu t                                                                                                                                                                                                          `rB7YA    IENDB`PNG

   IHDR           szz   sRGB    IDATXc``Q0Xvyq?.66>6EV	8-@b,&dF.\@D,0\|%6X9bb7
F(`r     IENDB`PNG

   IHDR         a   sRGB    [IDAT8cd#$sawH~7	slY:00&"	\\|4a0<3 !y    IENDB`PNG

   IHDR           szz   sRGB    IDATXcd#X9aodMD+ #RR5P; |QC.zQ G)A G1EJt]/67	j<
`p|  %K!1!ARI8h'NnD9f@Lt8=`kE- s6@IkybPW!0  'JAfoM    IENDB`PNG

   IHDR         >a   sRGB   IDATxMn0 azz/vyy6?03McjeY:v|kmZ37&#u0znW n>Gyf6e#?E:;54eQ?fX8(?|/_5?r_1[(cU!8qqxM5}^5Vt-	*$[j}~d>qN#[c6[G}tu7mfTadef5wdX
tzGju3s{ l6]nH7u myu7GO` 	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	 hNmw)    IENDB`PNG

   IHDR            sRGB    ~IDATcd```H* Fd7a%#aw%afL'C[	d`:l!X470tA907 7YseNb .rx/    IENDB`PNG

   IHDR         >a   sRGB   IDATx?nA5*MJH q!e4r 3;i	a?ow      @|H)z>~}=Z,Wo lu	W_}%h_&k];g6/})) 1 qjYPi:^UA}5Yw: nFG p758no?Tl7p\]$ma)u2c?r?xWEoi81g,oz 9	sM/)]^O= z q@G  q@G  q@G  q@G "> i^Vj9Y>PEE  q@G  q@G  q JvuLz_;<p8E
 9E=T 8  # ANH6 7E(;e-J[+Mq+:S9z g>SFMu hc qs)H= z q@G  q@i !4 nd%0-fhiy1(pfv[h- nCu~c
B ff];v0`&SWT]./uZ#y>#`j84G/       #    IENDB`PNG

   IHDR         >a   sRGB   IDATxR1N5<Ar;{(fTEj37d+Z C[$|x|^dVlUdviU
7dodN*x?/&%D|x#"guZ}3_	M|>I?nfK=;E%fW>^W Q3Yf/zdlB?as|Z/lU?
9&%m"ebe/9UQVlg{W}e\,V,x3xOo/.Ss3nfmO|x03kr<_xYkC{|KdvYAF,n5v~G%Ndv{fU{#Wd?FQ`m6	YQBlXW(p,~6neb}<>E|`$z${9K>PY=Yl	7e7k,.*O+ghq++z6VtOvj7bwkzWoWGl<#cUW!;fV"Vrsje=l^>_Ee>sq*{{X].ky3+H 7 h  8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8  A|    IENDB`PNG

   IHDR         a   sRGB    IDAT8c`DXC,YU-).&OkL:
ML	;5(|lk 5nmO"a7xXH QU0 kC= .A kn]?JJiBfsdK'C12.l 9IQ    IENDB`PNG

   IHDR         a   sRGB    IDAT8c`DXC,YU-).&OkL:
ML	;5(|lk 5nmO"a7xXH Q"TNT7a%\A AtBPl-0\\T 0BY    IENDB`PNG

   IHDR         a   sRGB    IDAT8c`D<0.&YZy1(71E$Pk%3)s5nmO"a7xH QDI	+0EdXbJ4@ffsldK- %Cd    IENDB`PNG

   IHDR         a   sRGB    IDAT8c`D<0.&YZy1(71E$Pk%3)s5nmO"a7xH QDVS
&yVb!(d2S!(ZeX$K2d G-OtF Gno:2A    IENDB`PNG

   IHDR            $IDATxcF	J'	8Q
i V'2    IENDB`PNG

   IHDR            2IDATxc?,@  
eDY h<    IENDB`PNG

   IHDR            ,IDATxc?>C5^TQndPEY -Oe    IENDB`PNG

   IHDR            8IDATxu @{f?k#G$@3r@W FI	5M'%%]c`M    IENDB`PNG

   IHDR            -IDATxc?>	I0G"dGt^  $J    IENDB`PNG

   IHDR            )IDATxc`dI"+	?.,x|  Wn4$8    IENDB`PNG

   IHDR            'IDATxc?F,	 (@DY w\    IENDB`PNG

   IHDR            3IDATxc`d@,h I`5	II!MAGb V  _    IENDB`PNG

   IHDR            ,IDATxc?>C5^*`f4	0E$ Xh#    IENDB`PNG

   IHDR            )IDATxc?>WFtx &t$A _k\    IENDB`PNG

   IHDR            /IDATxcF@31 LPF6$V xL  f     IENDB`PNG

   IHDR            IDATxcF	`SD  %    IENDB`PNG

   IHDR            +IDATxc?>U1+.Ox!H z    IENDB`PNG

   IHDR            IDATxc?>Wv(  c3f    IENDB`PNG

   IHDR            6IDATxc?`d@LPIF(M^1t 	M'V_ qBM    IENDB`PNG

   IHDR            2IDATxc?g```d@L$Lt0BT@
|  Fgv    IENDB`PNG

   IHDR            1IDATxc`d@,h1fL'N+0g) 	 qd    IENDB`PNG

   IHDR            %IDATxcLc q#K  D  Aa    IENDB`PNG

   IHDR            <IDATxc?`Db3@%QT?)(
`2bS.`n@$
 j	^    IENDB`PNG

   IHDR            ,IDATxcTaA@W&OV SU7I&`M	 +~    IENDB`PNG

   IHDR            0IDATxcF@f3000001 tP q(D[ qTwD    IENDB`PNG

   IHDR            1IDATxc?F,	JcDV:
p  $ `    IENDB`PNG

   IHDR            0IDATxc?>	 2`A	c3"+`Ddd@@V( JI    IENDB`PNG

   IHDR            +IDATxc?> SU%$#>X%uA8' g%@    IENDB`PNG

   IHDR            8IDATx}A  WgjM\B?%	u AMcI(O-x^    IENDB`PNG

   IHDR            +IDATxc?F,	*0 / h e    IENDB`PNG

   IHDR            #IDATxc?>Wv(`a``FdX W2#    IENDB`PNG

   IHDR            7IDATxc?>`&	S 5C $0nd7 xOE    IENDB`PNG

   IHDR            IDATxc?>W~
"+ wB/    IENDB`PNG

   IHDR            9IDATxc?`d@,PI	`L11`sN*A fe	dB*D    IENDB`PNG

   IHDR            2IDATxA 0`3QNIO[IAJkSRU    IENDB`PNG

   IHDR            IDATxcF	`SD  %    IENDB`PNG

   IHDR            -IDATxcF@31 Q~dI[!I X<    IENDB`PNG

   IHDR            9IDATxI  g<i%IKad25/re*aL
    IENDB`PNG

   IHDR            .IDATxc?>K#LO07
Q  mC/    IENDB`PNG

   IHDR            /IDATxcF	PS#c("

}&  )%    IENDB`PNG

   IHDR            +IDATxc?>]#b8u ;#q f     IENDB`PNG

   IHDR            .IDATxc`d@LHq)	X4L'`B38     IENDB`PNG

   IHDR            %IDATxc`dpI +?>,| [n}    IENDB`PNG

   IHDR            &IDATxcF	FL
+  _$2    IENDB`PNG

   IHDR            *IDATxc?F,	$L^@'5/ 5gk2D    IENDB`PNG

   IHDR            AIDATxmA 1TCrBEs%
0 }U.C
ia0    IENDB`PNG

   IHDR            4IDATxA
 0bgwa[)`P6 v(9~RkVf\X    IENDB`PNG

   IHDR            0IDATxcTaA@W&KVI07X (	E    IENDB`PNG

   IHDR            'IDATxcF	@Hb
p(+ x12    IENDB`PNG

   IHDR            2IDATxcF	PS#c("h00QV  5w3    IENDB`PNG

   IHDR            1IDATxc`d@LH@H
I3	]d+X	d -:^    IENDB`PNG

   IHDR            0IDATx}A @?F[c2E@(n_@5*M/*P34	$+    IENDB`PNG

   IHDR            0IDATxc?>C1VC 
Xf V      IENDB`PNG

   IHDR            6IDATxc?>

XtG W$a$^7 '  Zr    IENDB`PNG

   IHDR            9IDATxc?`Db3@%QL 
Xt$ LY1h| ZWY    IENDB`PNG

   IHDR            &IDATxcFR 3xYA      IENDB`PNG

   IHDR            0IDATxc?>C1`J03nd+p*bAj>	 		i-    IENDB`PNG

   IHDR            +IDATxcF	F@dV 1x    IENDB`PNG

   IHDR            ,IDATxc?g```d@Lh)@	
:(  >U    IENDB`PNG

   IHDR            (IDATxc?>q)`$r+pJ2000  P3    IENDB`PNG

   IHDR            1IDATxc?`d@LPIF(MtHV  %
=H    IENDB`PNG

   IHDR            .IDATxc?>U1"+`J2K + h#XM 
t  9uq    IENDB`PNG

   IHDR            2IDATxc?>C1VC	XL#>7j
Q& 
    IENDB`PNG

   IHDR            +IDATxc?g```d@L$U@hX' i(    IENDB`PNG

   IHDR             IDATxcF	S &!    IENDB`PNG

   IHDR            )IDATxc?>(
%+`i*SYN  b    IENDB`PNG

   IHDR            ,IDATxcF	*  )08AD'  N;e9    IENDB`PNG

   IHDR            )IDATxc?F,	 a
pJm  T    IENDB`PNG

   IHDR            7IDATxc?>a?4IFd$Id`	 <2    IENDB`PNG

   IHDR            8IDATxc?>C1VC :`XM9"\0  z	AH    IENDB`PNG

   IHDR            2IDATxc?>C1NPVG22
  P	"_    IENDB`PNG

   IHDR            6IDATxI
  9P8B$ EM-=i8&.Kn6	    IENDB`PNG

   IHDR            #IDATxcF	*N
N  9*?    IENDB`PNG

   IHDR            "IDATxcF	t LL  Z$F5    IENDB`PNG

   IHDR            (IDATxc?F$I1$a
  /L|    IENDB`PNG

   IHDR            /IDATxc?`Db3@%QL 
Xu$ IV  -!V    IENDB`PNG

   IHDR            2IDATxc?>W#>ELP"PE8Ux  ,S!    IENDB`PNG

   IHDR            3IDATx}A
 0swQG5Q(d-~o7Xf`G<M	    IENDB`PNG

   IHDR            .IDATxcTa&( DL@68'
 	7    IENDB`PNG

   IHDR            /IDATxc?`d@LPIF(M^@41Kh+ /c*8    IENDB`PNG

   IHDR            5IDATxc?`d@LPIF(M^K'	0+,$	 FF-    IENDB`PNG

   IHDR            4IDATxcF@f3000001 ,H:	FmQ
	 l    IENDB`PNG

   IHDR            0IDATxc?>	I"&$Ilu|0$
 (	    IENDB`PNG

   IHDR            :IDATx}A  :</,
!WF,scg,+ UW    IENDB`PNG

   IHDR            4IDATx1  SC(	 azNI+.]XS"{7    IENDB`PNG

   IHDR            %IDATxc?>W,v0bS!H]7T  )/s1    IENDB`PNG

   IHDR            .IDATxc?>K#YN@H|6A fD    IENDB`PNG

   IHDR            .IDATxc?g```d@L`M	x4hpf```  1V    IENDB`PNG

   IHDR            4IDATxc?>C5^(`a```f4	Pda(b% \    IENDB`PNG

   IHDR            "IDATxc?>W#!h7  Z0J    IENDB`PNG

   IHDR            *IDATxcTa&( D D  _    IENDB`PNG

   IHDR            3IDATx 0/5klYU[Z lf^|p62C    IENDB`PNG

   IHDR            'IDATxc?>W
p:(3000SS  j    IENDB`PNG

   IHDR            8IDATx}A
 0swr*4TC`.e]hBB+e=>9 y	I    IENDB`PNG

   IHDR            ,IDATxc?>?&`I	P4	h4V  L    IENDB`PNG

   IHDR            4IDATxc`d@,$`	Jb?iL XDY P{h    IENDB`PNG

   IHDR            2IDATxc`d@LHq)	X4L',$	nL  \{    IENDB`PNG

   IHDR            .IDATxc?`Db3@%Q.	)`$Y ZE    IENDB`PNG

   IHDR            /IDATxc`d@LHq)	(Wavc8 IV  P    IENDB`PNG

   IHDR            9IDATxc?`Db3@%Q?I
MFVx  ;J    IENDB`PNG

   IHDR            %IDATxcF	$LB
( H  >B    IENDB`PNG

   IHDR   @   @   iq  uIDATxZOHQF)XP5{IB)tPB[!<DuA'nth/Q-(tiAel:LowgB?X7~6M\lm\`l 7@@^6~|ucZC%V!0X!eM:e0DC a2T[YS:
9cf6%0X)d_	-6n,7wJ>
b<zK%:[m07`E6|) X]o	m9C"#0<1,a~?pQL'2]|q5p?|Q-D 'O ~`{/pi'+>+"dDX!`9{8OI\uAD=f*2t,<iO!# !Ni?Mw|- x1_7|Bu1;1I(+wz B}@"0gHsW	^* =qy	bDX(ibS4hUbp1x`3y, l}UGl[$ *ZU9/mP!UAv+"@/MD,d:( yn{'#amR&1h(qQ'JT <|C	z@3{OFWxO ha%-
}@"T eQ
P2}31a(T ^zgW #	(u'>+@SVHe_QRRQ
+@!!JQ0blj{ ldV^V&4XrT\]j]aF@=Ld[ktC)bxDYQ@X2.k%`E	-{L
}	hpW'/
!T    IENDB`PNG

   IHDR   @   @   iq  IDATxZOhWvZXY)l4H.]d\D1)*xzCr4,%d8&.7oL|df}w?|!1#lO6=W1X!` [ro< /=0}G O$NPML*;PCv/eQg.'J	:;.V4 TSk^;{zzxhWN0 AuZBF=!3x{X	PYHr9*b^5/~>gwJmZ"_
G B=~a'=eDRF`-}%@YTGy8 n?EspT=x;!Jb= |"I [{ECFEvja(u|)^m^ ,LO`azB 5= UY}yl		|?m4H#

X	 @)^5kja^RU OuKg HRO`;D=)  
oj"KW$> m	!QHI~A:&NEq<dik*?dm#!n{ ""q977	6MT+ng7`|8W1@/n1$5L;:Z  u-Qd&		d":N<X	A$,=7v-]yq+"?<2/]'Pj  {~/BY+/ec `^5 u'(k})fobuCN>2|e A  Q	<S	PJe*P _=	i
HO%.jx[p= ?mV}+?%z#!uIU eT0m8n6DISL5eaDIAdoENh!n2`{TapL+?FL3J    IENDB`PNG

   IHDR   @   @   iq  IDATxZkcUj&GDEdFP,D	eU.]p]LSI#Xtdi0 7xs/M2GJA/%||}S$%ocqvNo;s Kb>x#zaYA W-qL]"OKB.[Of,
'1v(_OA -pysY @HIaZ!N*Q,nbnsFIr'8(,A W8xJa#/^ 6bI)Ot FNe?ldi;\
t5qn?>?
O96=?sN	P%^RZ'KbjkkVa( k" ^X(km8$U4pso%-X\\n",RWI|nC9"|P} P:-
)S"<x[jAf+BEhP lUX]W?W
 QW?^=\si?ktWU
tK/"D%O}di~Y=}$=Z	f%ls7N(/Z#`,L`,;8@8I DpKR'4[5/dX`'+(
vt7UU_Z"D<W _C$jLj/U9[X:;;.8	a#d mO56$K{<>kV
Us//0m&xp@QwV6u
:S0 >8IC$&`u?
bMX\]|-vWkx{DfdcX\A vSb>3OF 7 s%}8Q@JKxP'x'78
}a	(lW'/OQ    IENDB`PNG

   IHDR   @   @   iq  IDATxZKQm!(k[A<n*"FD]<DvH$<EKx(,"uo{;ovgy~.;oLqql SA<0SAI\f;og>	  
\38 dkA@+6 2^	Za&QmxuFQ6/}/WUKBq"C~e+EpqcyQ$@" $F`H?\ P{`<T .$gwnkF)}7CX&  '=@jzX)c#U}Tw<y SR#5u ?](=?jA;CdW`5}.`l$n	{+~C 5i\*VXlg6Tj13 ;_[T`GKh0eC{?i rJE2R M. {g,??H"xoa2N6zUa 2^JUJwa=S`Say_7F^eUv,.l]mc" yxpn+ 5" y 
;:*OkYKEv%"xy2(d(2OgwVZ4=P3/5ou9ro[r=,UE7e-Byqp GWA*S~hKdLgQqf<:5s7G*SbLG+~^%	!UO @~'#3GKm:T0^VU\m@{~ChJO$o*tW]zQYm*
LB&aI;JV@$=@ bNwBY[OF	kr`	*A: JDC*QxVy1TB	$dT2N:a >w[4:p`FU<p	#4}h&E    IENDB`PNG

   IHDR   @   @   iq  IDATxZAkAj]HziI-Xb 'E"z TE^-x(FA 5b@M]7$M3~7ogmezC	FK0s	=wKMO`3]>v0= n3h
L))rl%	 UDPOfE[!FZX"ri 0TIW6hj@, t$9bKS 	gyV<`w	v6Z1% ,n:Gg%T(v6bD+l7 <}c)P&l<1}c}c>+Z&';f&XSTo/>#'8Or~tf{FV2WTW~katfl<40Z(;Nbee24Ww9RCv6H%"i gFQ,I BJh~>1 bck9N6D9Wr$ CG]x-TAk9 pSw^} ||4;44`8SGPK`5m g>'{4;;'s(Av+8>	FV6omIYD8o'2@$Hf-P#Ee']Vu^dkhv0i{5@;Kea=?RC. 7Pl:agH.)+ P- _ng$(VCY#T,,be[2y{;DY$-J>:CycNwTwMeN( E	<Fm CA#g @u*h =("^
ahA)0L{=^	:EX7n$-E0_<AY!`BB 1s:aLR4lh!DGd	NP%>= ) R    IENDB`PNG

   IHDR   @   @   iq  IDATxZkQjB AHH, TvC'A S7WV 2	H$r/wB p/y{].\S/4`L /]2+{Ot" x&F 	@"%@)m.p:_qD@6Q+P ^TcN ~6j<
FPtd.Tc<hTlF9#@;?px}6iHb  p0J K^/Qo2b[26Jz$hz9gko\m  Z.ZMv vovgrc* \/HR`$,fz(y"8}q|Rvd P'  /^} _% WB%Q>'NcP!D<9`g{oP`#Y u6*V
6QbGE]9 @q?1uUI Sl3Nl@[,yVqTD=qYc@OwHHSed|4-->rX_F(3=gA<~]w `R}zF%@A}ig]wkan`;G{d*i>Ivc+: ?w!/tL.(Xu +{7R4 X`]MJe[*f 	>wjL|$P{>HR|<.Op-0r v^1pU}@aLA/}^Jr8]jeh9d3_;%a@7=}Y[26|< f2[{TCyCD}v0PJDQ uY0lP	]#zpM(Z1y. EaH>2 tC b4EPI%@$M&??HD<I v!;D/2qRXa/?( nnq    IENDB`PNG

   IHDR   @   @   iq  IDATxZ=hSQjy@!U+$*8TC:TpN.vP4;ehH
!Z{}i~OJAwwn3t88zqH!19:Y<ji{w9P
p}GqF@/p*T&H`$l xybSHV~pcr'7G.q$31 @z!:)CB@2Czq~nrtV+	CCB$r!8~; z!I' jD{W.9n 1lUwDh. cOz%7EB7
;/KGX'tJBnH t|33gQ1 g}
E*N  2O]7m_1 v,AJ@+K5gKo?L+sC	n0sK -%/z/\RBq)
 _ e@.un)mrJVNra!&^wN(cRZoJ>!paJ|RG1Ji++F0WV
L%xxWJ9GTpSHS(^'tE@1pC DA<@\2cS2~7K:SuuJDp< HjL{t3d$z]z>&.9}%AN*[Hym@xa'8}7/P"UFxgB$(VNh>A['Hm/qo4Ve</w'hU@1W&8xvl*t2D~6@*O|{ySN
^Uk"QR@'DPBB-pmMyf-6>.g
y^U

N"cWe@0WBwDJ}s\<v{0t8TNPGb<l:6Vd    IENDB`PNG

   IHDR   @   @   iq  IDATxAhUq]U]bVPjzhA<Xx=yJ!jC1
-]$xX$sIpL\=o{3fL{9x.g=L8l$6*R;LQy L!S,-A )D"nZ8(tE0=%23@.
90m;JYe	JkGHP<""7H*y. V*]1) H/Vu8\b5t=GQTWSzc >}M\1S@d@NGTq
]>g9qGq>@]+t Q'ZJX*Yp7v[]~e(wX[%d " W:wBB* 2C`H\r+=T3`qn?g) >|#w
Fh6D 2:+1_(m@u?1}(Ruf'A[;d7H	~9~?:-s0;dDK\	l5E5'DlQ6jfU2V<`P;P*Mfw}xH5W] NCXw[]@zsvrl?I^F0$)oY<CkoeWp ynY6[[]]\K
mphfkGXq0\{/ mu o~Qts|O;y(a}MP,*.hR8mPnNpPC~P~x	a2.=/ ov~tnh.0	 %Az0!".
m(kAt@^	]#d0P6@~HZUxW{|D.^4Ru@i`P#qLL%vnLA2'?Hd<@1]2/2q0Icc/-    IENDB`PNG

   IHDR   @   @   iq  IDATxZAhA}5.BC/ *zHDQ<{< <xQKQP,SmCB@	kC7fwvg>f?u88bz q 0C068^G%$lv} 8tE`aQ!FS/g pqC	&O;B_\G 2^	dQ  ll`@m  T50*d|:W CejK$y2k:Asu7-t:*=vjfGk?~^A($j;f|_tcf|w^mLFDP4FGQ2;hu >a6
QF#p)l |f3O#)89'8:_c9Oqs SC^RreL_> %FKXJ QVV{Y4 
J0bY(mdl3rB53@tRP?lA6c6VJL|2S oe  e'oy/	=}]Wn\OH]ZoEA(6.nh:tR%!h 9e&i 7" ku#(4.x$x Vu@H^4)+WyDd;=t:![h`C_T;_X8IH[pLl,1Wt-4B+$	l:ynBn<2OUbgQONB09]@%bu \E\>n},P'(/d1uqAbVNzJ]?6e f@ 52<=L4i<r>c: 10a<wD_Z`z Ctgw?E*
/t    IENDB`PNG

   IHDR   @   @   iq  IDATxZkG}xI  WTi\b(*lH\rh _SO`Cs+VCS"tj 0u~ {7<qq`eM/kM	\=8nnkK+l@uJ0QHNm(%`|>"Z"Q>&HPO} XmqP:K"J 66$X13 `yH lSglV6C5C:DvLZI1q$QpE^Av
9 -;g|,F	pA>[z`^qXq~xvQF	 "2M
$aT&Cx koXhfP)8w
:j417<t1MmvuA{@sIr*|^9.U@+5C-uyvyt zsn5l;LMv
 9qS~P
OB(J+IW_92Fm&>]Jlq0b BY_&=Zh?yl}p6vKg		@[AbHSyG<@V<e%	|4l!5t=w@_lDy?QMzAXO*d
awCGa20JP,$]} pU^!gLIp)d3(+<Gy"}Jp4#B?JhP
	
F: *U7De#J<
AQ0gq_S!2v#{!_>g3^4v,&,02h?XFIU@q-F 6C(}	>L,: >w0F\) lCK%LW'?J+n    IENDB`PNG

   IHDR   @   @   iq  IDATxZ?hQ(
tIi $ZpC2t"uWDb:Th7it`J8wy$wy*~}.?l6`{ q &Gf<D%c0@Tja b'dNTc1s) jwbM0Hu CI @h_WjXM2>kpL35`u14D:N~Z 3>kiaV5P]FZ&Gf0;5F@%Q4+g&y};NM{dEym ~<(qf '},!hE.wX<7d_a0`]f#<E/Ce)0zwoJ;7_e8Y+PV
|?w-y^gWp *k"[y?	f+M;c W>'{E6t;H]]Km rEB6S!0VtYb )hJ8ZE,X-m`!}N/MY^Lb/`D/366U!^?//7 36O M/YrRhmR<r~" H+]l.>y&LU,lMO:e$^"&VyD:d;b{x\wBq"2z|b-d&!&nZ&*2u]Yu|cF_v"HHBOd{2ZBJp.?.(/	x:T)a>UP ^},-..D>U"AWR7p~M9f aU ]`V^IepQf&o4 m19oaL<{al0{n8`JP}}2    IENDB`PNG

   IHDR   @   @   iq  IDATxZ1h[G[CB@4rccCP	xp /B
k2yqB3e"hb! D<WN$uw't_\`\= $ lL07%q	#;MqpINraNi4y]$X'6]K# [Bx]=frbbB@q'!jXt nGVr@Hnv<@7)CQ	vs~o+_RMxH}e?DJ [	<4{
$XKj]o	UtFJ e}i	4 n7?X]WcmkS[m*9ZIReX\_;hwxPRP<vI[ySNFCfSHX 'Qm<S[=_/	cg/aBCO  n W|Fy< P1@G[Mc"- yr0 TU*|WA
t8N0
S|KJU`{+TXa1>d N	vF|`O}Fn?o\'PNX/1 ~By~xMS_r 9e%$1$	8U:wd|;y;	5=mj]t3+|@[#5V[gFvPt:~%/?^[Ga2ZL|r	|o
d|e3nIIpq$hh+yj#y[>Ak%S<3Q06^T`Z	RR@/vzUB-{@!JjL%!|&I0cNH~@!	XbN{D
:0agr@g<lM&H|<@Nm!0<p #Ur
A*&;B	    IENDB`PNG

   IHDR   @   @   iq  IDATxZ?hWlGrT\*`3t+tAS.J@
!jPB]$HbMTa{z]$wOA@w{417 q%0J]4*(tY`q% 4L 5cs$N$H.[ NkMe$E\8S'@FVXala{l,*$BXTFS_$j]G]Im3 yci!#\#`W{p;Xp6P_2vrw%/9j0Rc_OwU,
@UPz`$ky|z-m;~
x	 C"`?ABG^52o>!q8~7m22LZoy=g _k&P?V;Qyxx d9T,]{ Q{
q(x(nPu|xy<1-U	=g-#+?Z/FV=om~tA+ !^z	@OY  |/6<J /L1RaH>m:F~G<w\Y<<wqzr4Kcm%a#JBy;+"h~b#|Gm_DHCw-1[l|zr$x#/DC75]`EbY8GxyvM0Q#T,ihXttGj/FG,-Xg t}>8?P _> `zrVl*<P j{il[Vj6<.|r^x'i/JTAjDH>D@Rd 7,I<HX	yYSAOO wEKo!Xo7$
F#DA_
F y  gS'I3@.)D,""IuH$&C`l&(:0u?3/>@E~gU#f>f^     IENDB`PNG

   IHDR   @   @   iq  IDATxZAhG}V"	l*PZI0=H4q=C*
9@N:Co>894C
M >Xd/6BM?;;dfgjv=?f5gckLw4^`3';9y^P`t9@8S1O	syJ(u
8zXt~8Na  Uq `3Ovx;/u)+[p@UOcS Wl;ydu'N-_\F&`o'yy#-}U -@WgY,z\2o=u* /R!",8)J\Ha	.Wg9S \/FM 73P,qy@
1Aqk6W(S,}6HWLBF&k!P6"LKJsyrWx/[B"h6,' 'T.kFX KZ,E PN {8.mlvdL ?eD8Q&@4v/b< !s@$vqE)TOT`(k?^' "}nn %.;-Nt.dLMgC'By	{jz&L,@(QB)G&?_yxU@J*C<rkOh[s~"| &,l34ctOq4o[M~-Wl'"';pk {7['?A4&Tue$%Kpn6]z't@Q&  8S{t9Rz R.BI05=>P~"D"}V8T1 5>G1(w @4F}:<A! 1BL4:;~"F :`Q .nuanh@MQ6q8"daWb&$@$8w_x8%R1#|i\O    IENDB`PNG

   IHDR   @   @   iq  IDATxZMhG}"l	TBsQs)BoA=)CIr0Cs!:BHB"AA]Dziu]k}|~s#f_m|l '@p^8vC I'5M;$J ;A v7)LL%$]0r .`.,)pwe:jTj^/ z0&:5c b Ui9(?	YBP,wz+#sT Z ++xFTl<x/+t SX-} V-`mzH|s} _u.V,  y.*qy@0dfP*]VXr(KC>F$_,9|+|zk??|~F+>DGcYM@Nhqv:Fx;,j	"HS& 'c/.vAhED	e1b<{vY1 t" ]DB J +w }He_  7m:W^M:1UPDcBq*^{o$7,RBb?oH<YgpZ rDR KH 1}V4j>QHRr(^y`J=OD1mw^|Yl{^z 5Nz (!iU
*	eDaq~ J=%ujV6. lQ5sQjB%j?4!<e'Jt`W?n7GZCB
>D!9~$>,U *U|\b;!fPMq0^W ri}u!19/t}E&V LPv] ,kXu$a`PWSyyuL"1{Df#XDcw3@"c3/BHG|g#f3/fHEp6    IENDB`PNG

   IHDR   @   @   iq  IDATxZ?hW\G!
vR/*8=xpl)tP.:eR!2$C@]"H&E8Ut8~O{w?$i0	 O5>*vS!d< _>D< \p=VG,"|$Yw {<3hdyXBQ~/k-%YNZFOf-^D[@:k]W"8t:Tj!sKm[u(8q_j#s Nzn}8  A=V)%wvWvW5I9?\
@Odyr NRc{KTyl;g #>NXYj?^@tIu : ziq1<[U{]<kW@E~~Fh!V"t"pV| pJm7`8u~%y 1`*z&xHtx'	]*rFh	|z8) 8r#!?}qdm)@0:*Fbc==D\
fc$7y)n8t6YF j`Qd}y:Z'5@G%;M$-.;@pMC;wcA *e^<"~~.~d
=OUkTklE~#p'Y	:GhhGAO;z!1 A Q(}i~ZmPK{|UKmEc9vr/U<7_VDZ} r@l@ AVQA??.;@@$n<h5s6_	}v3([GL.6	*U6nvmz	pVWX	)L*yGX NL&56'!H$]Z*0	C(_`Q2b0u|,    IENDB`PNG

   IHDR   @   @   iq   sRGB   (IDATx0q1	O;0TDkwS 0Ol-@  4
@( -@  4
@( -@  4
@( -@  4
@( -@  4
@( -@ r\rp_rboLb  4(!\u^c};oq]
isVPw_6hN?1|&Ghhy(1?K)%    IENDB`PNG

   IHDR   @   @   iq   sRGB   MIDATx@#HwU;FJ_z<pWm1d	BwvfvuQyrmk\![]{w
(Mv!x|S=nx4ct|S 9K{fP)M
0MIewn@'A A=-N{Pd=f%;TI:QRC~VWU
<
V:]sz9bPZvsb0@
YJ  :|_|Q}T(F#&k#TEUr&l@}*`B\Ce	QHYRn7r+'Di@(:Da~-Y UNQx%D`9D(Z% RsD  jvDK.%v;E}Ht_YLlI\A fpmk    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATxZN0BUPTFT[&vJ&%RATQ$+u;5oi \,*yc=v."@8"9r\0dPulZulP[bli.}E\" "g&gX _F%T(w(*ri7x`
qj;A!\FqKfS IU!*JS'8JOWe	Skkk%.J'6,*pi#rTmHPuI1F fy<:qr^~$}bS`j? w{@%FQ0v<)P0e,}@H>@]H]u`kmHcC>f2[{]K	Hj.FnR*
!L%r JE@'TK$.FCH8h@ J!& t`A'	
`P  SqVBaxp[w'hu  8XP. [NXh@#f2@YCG> T5* hmo467~xYJ    IENDB`PNG

   IHDR   @   @   iq   sRGB   	IDATxn@''Jd*=yOp}Cx ]scNm<|/p3m 7 p\,B?2*85`s,9
`h5u5EwY,sD`7I&Dq> SR.m%Us?E,1%xmCQXS ]$,9uk
 1)9 =];"$ ^g:]6FY_'b
r WQH r*X&#a*TnHs@ BT#o  pLsS,H!U }ViWc
!"06VMx^Yj, guwu|LJ0F<ug9Lmk`MxfUVa2ur`Z|<j&9k/.!F y&TgBG m j")$dEPMJEJ ;A/Eax` j!9@{ lA*XQ ]
C.]@t#DW{}%H;B_: @-|B~3ys,,}IF`Dej {%H|6A n6R\    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATx0 MRDg0hVHdIYOsw%wt4Szsh@1 -@c Z  h4h@1 -@c Z  h4h@1 -@c Z  h4h@xu4StP_X"a ]?m9k0ay|c Z  h'`%ou:    IENDB`PNG

   IHDR   @   @   iq   sRGB   oIDATx1j@E!P"e
>*WzUHk!T$ev2olK^}B-;: h$@S\G+mG 4@ : h$@#t 	H F 4@RoRCr=\&p&5EQpNWY@ : 68R)&6;Yyb= '7AhB  !"E6)%0,TMDf{@	q)TPc[,wx>w3Wh#zvNnY$%0N>;@B7H F 4@Ug    IENDB`PNG

   IHDR   @   @   iq   sRGB   DIDATx@Ec	<=XuY=hI6 HA;&cf~Wh$@#t 	H F 4@ : h$@#t 	H F 4@Z/x\f9PO_2 S<TeHu!Kg?b"{l /_[]3<C][^e
f5d m;A: TG>,Cym_>^7 4@Fh$@#t 	| >3p    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATx;0 @Iw w\{yw9No	%}},-t+fC1 -@c Z  h4h@1 -@c Z [x3r@1 -@c Z  h4h@1 -@c Zf8'{^w9gs
!cnqv/S8D3bW5?gih@1 -@ )=*    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATx0 MRDg0hVHdIYOsw%wt4Szsh@1 -@c Z  h4h@1 -@c Z  h4h@1 -@c Z  h4h@xu4StP_X"a ]?m9k0ay|c Z  h'`%ou:    IENDB`PNG

   IHDR   @   @   iq   sRGB   >IDATx
PF?"VqMeOW]>U7t\;i;'7gW1}Zhhq Zhhq Zhhq Zhhq Zhhq Zl^0$`{E RB  wBD`7!	 J FtQ'Ypx([+:>$YZEhZW7]!?A_i]o=?oOHisq Zh5    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATx1j@EBZ)w05\9A"!Jc!_dl,? @@X>,*&syAe	Y`P
wx@@ t 4.  7BO_qwo9  E q hV'/WacR.O*KLt`&*U1YERI2In,PCPp<"=5MD#j&Z@[Y/WX{ [,Rg"'Tq(Tii^5U(|<	b: t 4.  @@f    IENDB`PNG

   IHDR   @   @   iq   sRGB   &IDATxZ@=YQ(HBH}+7(B?$}je))k]gcw999|]H 7OG v6G6m&k,&@%c	p *[DVE9 eiyU	Z	")Jl06D 'aseN~6GenAWg:c* <[p[Wq]qebT"		 sn+Mn j)^8
m3k <{CMN`u(Y<= 6LyD Gk^$[A`X-;Y`y>#H]MF{|C)* Q	;nsi0$zv"m0Y^XCGmNU!j:.n
i:Om}H3A9bp1/_z	6TRAX|wc]gq"I0p>w==_\JABxsS!	* !Bdp)9(C
jOA| Q\r	J*}nB4x}.yk9uyk9!3y B#kDA@d@S`N>WOx
@UH 7o^6f:
L    IENDB`PNG

   IHDR   @   @   iq   sRGB   LIDATxZ=k#1}9lW\ip7\>pJ`#b\seI+>wzO3oF~}G	Eay<D{Vvuhwxt%Am"E
pb? , { p?8] <| y-
Lc?uDsYyVD:cn8vg6+A"+G  j#CYY	 kWe]9G4&C(I`w M<"sHk
t`4#gH8W.p85BAR+Ncr)<tE/xe]fM]n$)8xE7L,(UfGS_Pjp-O N@a+o$qU *?m>?DUP0V6Czxk2&y"nEtX" @I	B`ePmAueyo"3 btV|&ByB,cD%4i< 7xJtyuJ R6&voML{|[ 
y
."-J$D%R"<6,>AsC>/B/}bZLgCIFs'HdV:JY bY SRb@8Or5BCX}@X wAD :;D#6)q RCPtp R"@	EH
    IENDB`PNG

   IHDR   @   @   iq   sRGB   IIDATxjPF?K!OW1){@|-%55 ^3	Qs*d6-1O 4@8 -@  4@8 -@  4@8 -@  4@8 -@  4@D`o4$&B46T	 #IT0..8 -@ 7tD*=qV~wG3BI,Us\nyXZ|":;]G@/o{]"w#hh9>=    IENDB`PNG

   IHDR   @   @   iq   sRGB   pIDATxjP:tuv	|+t8!5
=~'&A81myhQ ZFhhQ ZFhhQ ZFhhQ ZF<8<W v	hq'`F
,A& X
2?KOB=`7D 
@ {"!DGD:%D !	0GI(v7Xz?+e\of]n#3Fp\o}.UMm?[${@w]|)`f{#U 7
DhhlPY    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATx0 MRDg0hVHdIYOsw%wt4Szsh@1 -@c Z  h4h@1 -@c Z  h4h@1 -@c Z  h4h@xu4StP_X"a ]?m9k0ay|c Z  h'`%ou:    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATx=j@!q"wHiiu]	rw |`IV*}c4_nv<.<>_2bll  6pVNG1W318r  6*Xnr}xd`tx``qll : [ 7-Gltlq>x@5n%6a17tj@,"LPX6,0RspwuP"`Poc.a12*%<;lMR]d@H\/6Rkk(@VnPwjIg@{u-qll  6fv    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATxj@C"xwk;4rhH=)jtfgugf1@'t 8DRH>3U )6h\[1+i$[/jLLf1r 7j) t1U+.
 ^p7=%PL  qH  o?T|,|gz	2<  _k>y 8<
W
iZ0MPz^o>`??o#9*>7XuD)2pppb9 O3k((Df~q2LxiB QX, &DaK	7 
hQrL?J9@k. @oDjum?+($gKkM ~uWi2YW4NFHsuSW't 8	 4="      IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATx0 MRDg0hVHdIYOsw%wt4Szsh@1 -@c Z  h4h@1 -@c Z  h4h@1 -@c Z  h4h@xu4StP_X"a ]?m9k0ay|c Z  h'`%ou:    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATxn0*;tDHl}H#B6`@.:q;Iw9uGO 4Y h hd@@& yva3QX:D`b" 2H!L `SBGA 6U"8KkUXEQBb'];A[$g~By{k-E`-v2Zx	p]"f}97.=l}A]7DRYLEQmQ62!A9%V"zw:pDky|Bk[ jK^QCyO{mJAbF/Wzbk4^Z3= ut=i"+1vk" c'w	:Bx:M-Bs qg `pY %:@."^ f;S9f8iP283_!)
`tD|W"  4A8S `@O{K%z"NKr h h})<}d@@PQ6=:    IENDB`PNG

   IHDR         r$   sRGB    IDATc&(  = |F    IENDB`PNG

   IHDR         a   sRGB    aIDAT8c`#h:YshZ"qf#`32N6	Y-<>z($Pb@NH ZiT    IENDB`PNG

   IHDR         a   sRGB    _IDAT8c`h1bOs#^l$V7	!jF7$]XH@&d,$(	)4-(MgGMHc rRx  CqT    IENDB`PNG

   IHDR         a   sRGB    ]IDAT8c`FA?)1g` $&p=##9a"K'6]T D450r C.Zo    IENDB`