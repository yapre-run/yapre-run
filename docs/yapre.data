package.path = package.path .. ";./lua/?.lua;./lua/?/init.lua"

local yapre = yapre
local debug_log = require("utils.debug_log")


yapre.dbg = require("utils.debugger")
yapre.dbg.read = yapre.DebugRead
yapre.dbg.write = yapre.DebugWrite

require("utils.strict")
require("utils.table_save")

local palette_data = require("core.data.palette_data")
yapre.palette = palette_data

local background_color = palette_data.background_color
yapre.SetClearColor(background_color.r, background_color.g, background_color.b, background_color.a)

local NES = require("nes.nes")
local PPU = require("nes.ppu")
local PADS = require("nes.pads")

local file = "./roms/Super Mario Bros (E).nes"
local loglvl = 0
local Nes = NES:new({
    file = file,
    loglevel = loglvl
    --[[
    pc = false,
    palette = UTILS.map(
    PALETTE:defacto_palette(),
    function(c)
    return c
    end
    )
    --]]
})
local width = 256
local height = 240
local pixSize = 1
local sound = false
local DEBUG = false

local time = 0
local timeTwo = 0
local rate = 1 / 59.94
local rate = 1 / 59.94
local fps = 0
local tickRate = 0
local tickRatetmp = 0
local pixelCount = PPU.SCREEN_HEIGHT * PPU.SCREEN_WIDTH
local Pad = PADS.Pad

local keyEvents = {}
local keyButtons = {
    ["w"] = Pad.UP,
    [119] = Pad.UP,
    ["a"] = Pad.LEFT,
    [97] = Pad.LEFT,
    ["s"] = Pad.DOWN,
    [115] = Pad.DOWN,
    ["d"] = Pad.RIGHT,
    [100] = Pad.RIGHT,
    ["o"] = Pad.A,
    [111] = Pad.A,
    ["p"] = Pad.B,
    [112] = Pad.B,
    ["z"] = Pad.SELECT,
    [122] = Pad.SELECT,
    ["x"] = Pad.START,
    [120] = Pad.START
}

local function keypressed(key)
    for k, v in pairs(keyButtons) do
        if k == key then
            keyEvents[#keyEvents + 1] = {"keydown", v}
        end
    end
end

local function keyreleased(key)
    for k, v in pairs(keyButtons) do
        if k == key then
            keyEvents[#keyEvents + 1] = {"keyup", v}
        end
    end
end

local function OnKey(timestamp, state, multi, keycode)
    --[[
    if yapre.platform == "emscripten" then
        keycode = emscripten_keycode_mapping:GetKeyCode(keycode)
    end
    --]]
    debug_log.log(string.format("[OnKey] %i:%i:%i:%i", timestamp, state, multi, keycode))
    if state == 1 then
        keypressed(keycode)
        -- self:OnKey(timestamp, state, multi, keycode)
    elseif state == 2 then
        keyreleased(keycode)
    end
end

-- local app = require("main")
local imageData = yapre.Texture.new(width, height)

function Init()

    imageData = yapre.Texture.new(width * pixSize, height * pixSize)
    -- Nes:run()
    Nes:reset()
    yapre.SetRenderSize(width * pixSize, height * pixSize)
    yapre.BindKeyboardInputCallback("nes_on_key", OnKey)
    return true
end

local function drawScreen()
    --[[
    for x = 0, width-1 do
        for y = 0, height-1 do 
            imageData:SetPixel(x, y, 128, 0, 0, 255)
        end
    end
    --]]

    yapre.DrawSpriteWithImageData(imageData, {0, 0, 0}, {width, height}, 0, {1, 1, 1})
end

local function update()
    tickRatetmp = tickRatetmp + 1
    for i, v in ipairs(keyEvents) do
        Nes.pads[v[1]](Nes.pads, 1, v[2])
    end
    keyEvents = {}
    Nes:run_once()
    --[[
    local samples = Nes.cpu.apu.output
    for i = 1, #samples do
        sound:setSample(i, samples[i])
    end
    QS:queue(sound)
    QS:play()
    --]]
end

rate = rate * 1000
local d = 0

function Update(delta_ms)
    d = d + delta_ms
    if d < rate then
        return
    end

    d = 0
    update()

    local pxs = Nes.cpu.ppu.output_pixels
    local px = nil
    local iy = 0
    local ix = 0
    for y = 0, height - 1 do
        iy = y * width
        for x = 0, width - 1 do
            ix = iy + x
            px = pxs[ix + 1]
            imageData:SetPixel(x, y, math.floor(px[1]), math.floor(px[2]), math.floor(px[3]), 255)
        end
    end
    drawScreen()
end

function Deinit()
end
local yapre = yapre

package.path = package.path .. ";./lua/?.lua;./lua/?/init.lua"

yapre.dbg = require("utils.debugger")
yapre.dbg.read = yapre.DebugRead
yapre.dbg.write = yapre.DebugWrite

require("utils.strict")
require("utils.table_save")

local palette_data = require("core.data.palette_data")
yapre.palette = palette_data

local background_color = palette_data.background_color
yapre.SetClearColor(background_color.r, background_color.g, background_color.b, background_color.a)

local app = require("app")
yapre.app = app

function Init(str)
    return app:Init()
end

function Update(delta_ms)
    app:Update(delta_ms)
end

function Deinit()
    app:Deinit()
end
local serpent = require("nes.libs.serpent")
local UTILS = require("nes.utils")
local CPU = require("nes.cpu")

local band, bor, bxor, bnot, lshift, rshift = bit.band, bit.bor, bit.bxor, bit.bnot, bit.lshift, bit.rshift
local map, rotatePositiveIdx, nthBitIsSet, nthBitIsSetInt, range, bind =
    UTILS.map,
    UTILS.rotatePositiveIdx,
    UTILS.nthBitIsSet,
    UTILS.nthBitIsSetInt,
    UTILS.range,
    UTILS.bind

local ROM = {}
ROM._mt = {__index = ROM}

--[[
    There are different ROM mappers that map the ROM PRG and CHR memory to CP addresses.
    There's a code in the header for each mapper. MAPPER_DB is a mapping of codes into ROM classes.
    The base class uses the most common one (NROM).
]]
ROM.MAPPER_DB = {
    [0x00] = ROM
}

function ROM:initialize(conf, cpu, ppu, basename, bytes, str)
    self.conf = conf or {}
    self.cpu = cpu
    self.ppu =
        ppu or
        {
            set_chr_mem = function()
            end
        }
    self.basename = basename
    local idx = 0
    local prg_count, chr_count, wrk_count
    do
        local header_size = 16
        prg_count, chr_count, wrk_count = self:parse_header({table.unpack(bytes, idx + 1, idx + header_size)}, str)
        idx = header_size
    end
    self.prg_banks = {}
    do
        local prg_bank_size = 0x4000
        if #bytes < prg_bank_size * prg_count then
            error "EOF in ROM bank data"
        end
        for i = 1, prg_count do
            self.prg_banks[i] = UTILS.copy(bytes, prg_bank_size, idx)
            idx = idx + prg_bank_size
        end
    end

    self.chr_banks = {}
    do
        local chr_bank_size = 0x2000
        if #bytes < chr_bank_size * chr_count + 0x4000 * prg_count then
            error "EOF in CHR bank data"
        end
        for i = 1, chr_count do
            self.chr_banks[i] = UTILS.copy(bytes, chr_bank_size, idx)
            idx = idx + chr_bank_size
        end
    end
    self.prg_ref = {}
    UTILS.fill(self.prg_ref, 0, 0x10000)
    for i = 0x8000 + 1, 0x4000 + 0x8000 do
        self.prg_ref[i] = self.prg_banks[1][i - 0x8000]
    end
    for i = 0xc000 + 1, 0x4000 + 0xc000 do
        self.prg_ref[i] = self.prg_banks[#(self.prg_banks)][i - 0xc000]
    end
    self.chr_ram = chr_count == 0 -- No CHR bank implies CHR-RAM (writable CHR bank)
    self.chr_ref = self.chr_ram and (UTILS.fill({}, 0, 0x2000)) or UTILS.copy(self.chr_banks[1])

    self.wrk_readable = wrk_count > 0
    self.wrk_writable = false
    self.wrk =
        wrk_count > 0 and
        UTILS.map(
            range(0x6000, 0x7fff),
            function(n)
                return rshift(n, 8)
            end
        ) or
        nil

    self:init()

    self.ppu:nametables(self.mirroring)
    self.ppu:set_chr_mem(self.chr_ref, self.chr_ram)
end

function ROM:init()
end

function ROM:reset()
    self.cpu:add_mappings(range(0x8000, 0xffff), UTILS.tGetter(self.prg_ref), CPU.UNDEFINED)
end

function ROM:peek_6000(addr)
    return self.wrk_readable and self.wrk[addr - 0x6000] or rshift(addr, 8)
end

function ROM:poke_6000(addr, data)
    if self.wrk_writable then
        self.wrk[addr - 0x6000] = data
    end
end

function ROM:vsync()
end

function ROM:load_battery()
    if not self.battery then
        return
    end
    local sav = self.basename + ".sav"
    self.wrk.replace(sav.bytes)
    local inp = assert(io.open(sav, "rb"))
    self.wrk = serpent.load(inp:read("*all"))
    assert(inp:close())
end

function ROM:save_battery()
    if not self.battery then
        return
    end
    local sav = self.basename + ".sav"
    print("Saving: " .. sav)
    local out = assert(io.open(sav, "wb"))
    out:write(serpent.dump(self.wrk))
    assert(out:close())
end

function ROM:new(conf, cpu, ppu, basename, bytes, str)
    local rom = {}
    setmetatable(rom, ROM._mt)
    rom:initialize(conf, cpu, ppu, basename, bytes, str)
    return rom
end

function ROM.load(conf, cpu, ppu)
    local filename = conf.romfile
    local path, basename, extension = string.match(filename, "(.-)([^\\]-([^\\%.]+))$")

    local inp = assert(io.open(filename, "rb"))
    local str = inp:read("*all")
    assert(inp:close())
    local blob = {}
    for i = 1, str:len() do
        blob[i] = str:byte(i, i)
    end
    local mapper = bor(rshift(blob[7], 4), band(blob[8], 0xf0))

    local klass = ROM.MAPPER_DB[mapper]
    if not klass then
        error(string.format("Unsupported mapper type 0x%02x", mapper))
    end
    return klass:new(conf, cpu, ppu, basename, blob, str)
end

function ROM:parse_header(buf, str)
    if #buf < 16 then
        error "Missing 16-byte header"
    end
    local header = {
        check = str:sub(1, 4),
        trainer = nthBitIsSet(buf[7], 2),
        VS = nthBitIsSet(buf[8], 0),
        PAl = nthBitIsSet(buf[10], 0),
        prg_pages = buf[5],
        chr_pages = buf[6],
        battery = nthBitIsSet(buf[7], 1),
        mapper = bor(rshift(buf[7], 4), band(buf[8], 0xf0)),
        mapping = not nthBitIsSet(buf[7], 0) and "horizontal" or "vertical"
    }
    if header.check ~= "NES\x1a" then
        error "Missing 'NES' constant in header"
    end
    if header.trainer then
        error "trainer not supported"
    end
    if header.VS then
        error "VS cart not supported"
    end
    if header.PAL then
        error "PAL not supported"
    end

    local prg_banks = buf[5] -- program page count
    local chr_banks = buf[6] --vrom page count
    self.mirroring = not nthBitIsSet(buf[7], 0) and "horizontal" or "vertical"
    if nthBitIsSet(buf[7], 3) then
        self.mirroring = "four_screen"
    end
    self.battery = nthBitIsSet(buf[7], 1)
    self.mapper = bor(rshift(buf[7], 4), band(buf[8], 0xf0))
    local ram_banks = math.max(1, buf[9])

    return prg_banks, chr_banks, ram_banks
end

local UxROM = {}
UxROM._mt = {__index = UxROM}
setmetatable(UxROM, {__index = ROM})
function UxROM:new(...)
    local rom = ROM:new(unpack(...))
    setmetatable(rom, UxROM._mt)
    return rom
end
function UxROM:reset()
    self.cpu:add_mappings(range(0x8000, 0xffff), UTILS.tGetter(self.prg_ref), bind(self.poke_8000, self))
end

function UxROM:poke_8000(_addr, data)
    local j = band(data, 7)
    for i = 0x8000 + 1, 0x4000 do
        self.prg_ref[i] = self.prg_banks[j][i - 0x8000]
    end
end
ROM.MAPPER_DB[0x02] = UxROM

local CNROM = {}
CNROM._mt = {__index = CNROM}
setmetatable(CNROM, {__index = ROM})
function CNROM:new(...)
    local rom = ROM:new(unpack(...))
    setmetatable(rom, CNROM._mt)
    return rom
end
function CNROM:reset()
    self.cpu:add_mappings(
        range(0x8000, 0xffff),
        UTILS.tGetter(self.prg_ref),
        self.chr_ram and bind(self.poke_8000, self) or CPU.UNDEFINED
    )
end

function CNROM:poke_8000(_addr, data)
    local j = band(data, 3)
    self.chr_ref = {unpack(self.chr_banks[j])}
end
ROM.MAPPER_DB[0x03] = CNROM

local MMC1 = {}
MMC1._mt = {__index = MMC1}
setmetatable(MMC1, {__index = ROM})
function MMC1:new(...)
    local rom = {}
    setmetatable(rom, MMC1._mt)
    rom:initialize(...)
    return rom
end

local NMT_MODE = {"first", "second", "vertical", "horizontal"}
local PRG_MODE = {"conseq", "conseq", "fix_first", "fix_last"}
local CHR_MODE = {"conseq", "noconseq"}

function MMC1:init()
    self.chr_mode = nil
    self.nmt_mode = nil
    self.prg_mode = nil
    self.prg_bank = 0
    self.chr_bank_0 = 0
    self.chr_bank_1 = 0
end

function MMC1:reset()
    self.shift = 0
    self.shift_count = 0

    --self.chr_banks = self.chr_banks.flatten.each_slice(0x1000).to_a
    local chr = self.chr_banks
    local old = UTILS.copy(self.chr_banks)
    for i = 2, #chr do
        chr[i] = nil
    end
    chr[1] = {}
    local j, k = 1, 1
    for i = 1, #old do
        local bank = old[i]
        for h = 1, #bank do
            local x = bank[h]
            if x then
                chr[j][k] = x
                k = k + 1
                if k == 0x1000 + 1 then
                    j = j + 1
                    k = 1
                    if not chr[j] then
                        chr[j] = {}
                    end
                end
            end
        end
    end

    self.wrk_readable = true
    self.wrk_writable = true
    self.cpu:add_mappings(range(0x6000, 0x7fff), bind(self.peek_6000, self), bind(self.poke_6000, self))
    self.cpu:add_mappings(range(0x8000, 0xffff), UTILS.tGetter(self.prg_ref), bind(self.poke_prg, self))

    self:update_nmt("horizontal")
    self:update_prg("fix_last", 0, 0)
    self:update_chr("conseq", 0, 0)
end

function MMC1:poke_prg(addr, val)
    if nthBitIsSetInt(val, 7) == 1 then
        self.shift = 0
        self.shift_count = 0
        return
    end
    self.shift = bor(self.shift, lshift(nthBitIsSetInt(val, 0), self.shift_count))
    self.shift_count = self.shift_count + 1
    if self.shift_count == 0x05 then
        local x = band(rshift(addr, 13), 0x3)
        if x == 0 then -- control
            local nmt_mode = NMT_MODE[1 + band(self.shift, 3)]
            local prg_mode = PRG_MODE[1 + band(rshift(self.shift, 2), 3)]
            local chr_mode = CHR_MODE[1 + band(rshift(self.shift, 4), 1)]
            self:update_nmt(nmt_mode)
            self:update_prg(prg_mode, self.prg_bank, self.chr_bank_0)
            self:update_chr(chr_mode, self.chr_bank_0, self.chr_bank_1)
        elseif x == 1 then -- change chr_bank_0
            -- update_prg might modify self.chr_bank_0 and prevent updating chr bank,
            -- so keep current value.
            local bak_chr_bank_0 = self.chr_bank_0
            self:update_prg(self.prg_mode, self.prg_bank, self.shift)
            self.chr_bank_0 = bak_chr_bank_0
            self:update_chr(self.chr_mode, self.shift, self.chr_bank_1)
        elseif x == 2 then -- change chr_bank_1
            self:update_chr(self.chr_mode, self.chr_bank_0, self.shift)
        elseif x == 3 then -- change png_bank
            self:update_prg(self.prg_mode, self.shift, self.chr_bank_0)
        end
        self.shift = 0
        self.shift_count = 0
    end
end

function MMC1:update_nmt(nmt_mode)
    if self.nmt_mode == nmt_mode then
        return
    end
    self.nmt_mode = nmt_mode
    self.ppu:nametables(self.nmt_mode)
end

function MMC1:update_prg(prg_mode, prg_bank, chr_bank_0)
    if prg_mode == self.prg_mode and prg_bank == self.prg_bank and chr_bank_0 == self.chr_bank_0 then
        return
    end
    self.prg_mode, self.prg_bank, self.chr_bank_0 = prg_mode, prg_bank, chr_bank_0

    local high_bit = band(chr_bank_0, 0x10, #self.prg_banks - 1)
    local prg_bank_ex = band(bor(band(self.prg_bank, 0x0f), high_bit), #self.prg_banks - 1)
    local lower
    local upper
    if self.prg_mode == "conseq" then
        lower = band(prg_bank_ex, bnot(1))
        upper = lower + 1
    elseif self.prg_mode == "fix_first" then
        lower = 0
        upper = prg_bank_ex
    elseif self.prg_mode == "fix_last" then
        lower = prg_bank_ex
        upper = bor(band(#self.prg_banks - 1, 0x0f), high_bit)
    end
    for i = 1, 0x4000 + 1 do
        self.prg_ref[i + 0x8000] = self.prg_banks[1 + lower][i]
    end
    for i = 1, 0x4000 + 1 do
        self.prg_ref[i + 0xc000] = self.prg_banks[1 + upper][i]
    end
end

function MMC1:update_chr(chr_mode, chr_bank_0, chr_bank_1)
    if chr_mode == self.chr_mode and chr_bank_0 == self.chr_bank_0 and chr_bank_1 == self.chr_bank_1 then
        return
    end
    self.chr_mode, self.chr_bank_0, self.chr_bank_1 = chr_mode, chr_bank_0, chr_bank_1
    if self.chr_ram then
        return
    end
    local lower
    local upper
    self.ppu:update(0)
    if self.chr_mode == "conseq" then
        lower = band(self.chr_bank_0, 0x1e) + 1
        upper = lower + 1
    else
        lower = self.chr_bank_0 + 1
        upper = self.chr_bank_1 + 1
    end
    for i = 1, 0x1000 do
        self.chr_ref[i] = self.chr_banks[lower][i]
    end
    for i = 1, 0x1000 do
        self.chr_ref[i + 0x1000] = self.chr_banks[upper][i]
    end
end
ROM.MAPPER_DB[0x01] = MMC1

local MMC3 = {}
MMC3._mt = {__index = MMC3}
setmetatable(MMC3, {__index = ROM})
function MMC3:new(...)
    local rom = ROM:new(unpack(...))
    setmetatable(rom, MMC3._mt)
    return rom
end

function MMC3:init(rev) -- rev = :A or :B or :C
    rev = rev or "B"
    self.persistant = rev ~= "A"

    self.prg_banks = self.prg_banks.flatten.each_slice(0x2000).to_a
    self.prg_bank_swap = false

    self.chr_banks = self.chr_banks.flatten.each_slice(0x0400).to_a
    self.chr_bank_mapping = UTILS.fill({}, nil, 8)
    self.chr_bank_swap = false
end

function MMC3:reset()
    self.wrk_readable = true
    self.wrk_writable = false

    local poke_a000 = self.mirroring ~= "FourScreen" and bind(self.poke_a000, self) or CPU.UNDEFINED
    self.cpu:add_mappings(range(0x6000, 0x7fff), bind(self.peek_6000, self), bind(self.poke_6000, self))
    local g = UTILS.tGetter(self.prg_ref)
    self.cpu:add_mappings(range(0x8000, 0x9fff, 2), g, bind(self.poke_8000, self))
    self.cpu:add_mappings(range(0x8001, 0x9fff, 2), g, bind(self.poke_8001, self))
    self.cpu:add_mappings(range(0xa000, 0xbfff, 2), g, poke_a000)
    self.cpu:add_mappings(range(0xa001, 0xbfff, 2), g, bind(self.poke_a001, self))
    self.cpu:add_mappings(range(0xc000, 0xdfff, 2), g, bind(self.poke_c000, self))
    self.cpu:add_mappings(range(0xc001, 0xdfff, 2), g, bind(self.poke_c001, self))
    self.cpu:add_mappings(range(0xe000, 0xffff, 2), g, bind(self.poke_e000, self))
    self.cpu:add_mappings(range(0xe001, 0xffff, 2), g, bind(self.poke_e001, self))

    self:update_prg(0x8000, 0)
    self:update_prg(0xa000, 1)
    self:update_prg(0xc000, -2)
    self:update_prg(0xe000, -1)
    for i = 0, 7 do
        self:update_chr(i * 0x400, i)
    end

    self.clock = 0
    if PPU then
        self.hold = PPU.RP2C02_CC * 16
    end
    self.ppu:monitor_a12_rising_edge(self)
    self.cpu.ppu_sync = true

    self.count = 0
    self.latch = 0
    self.reload = false
    self.enabled = false
end

-- prg_bank_swap = F T
-- 0x8000..0x9fff: 0 2
-- 0xa000..0xbfff: 1 1
-- 0xc000..0xdfff: 2 0
-- 0xe000..0xffff: 3 3
function MMC3:update_prg(addr, bank)
    bank = bank % (#self.prg_banks)
    if self.prg_bank_swap and addr[13] == 0 then
        addr = bxor(addr, 0x4000)
    end
    for i = addr + 1, addr + 0x2000 + 1 do
        self.prg_ref[i] = self.prg_banks[bank][i - addr]
    end
end

function MMC3:update_chr(addr, bank)
    if self.chr_ram then
        return
    end
    local idx = addr / 0x400
    bank = bank % (#self.chr_banks)
    if self.chr_bank_mapping[idx] == bank then
        return
    end
    if self.chr_bank_swap then
        addr = bxor(addr, 0x1000)
    end
    self.ppu:update(0)
    for i = 1, 0x400 + 1 do
        self.chr_ref[i + addr] = self.chr_banks[bank][i]
    end
    self.chr_bank_mapping[idx] = bank
end

function MMC3:poke_8000(_addr, data)
    self.reg_select = band(data, 7)
    local prg_bank_swap = data[6] == 1
    local chr_bank_swap = data[7] == 1

    if prg_bank_swap ~= self.prg_bank_swap then
        self.prg_bank_swap = prg_bank_swap
        for i = 0x8000 + 1, 0x8000 + 0x2000 + 1 do
            self.prg_ref[i] = self.prg_ref[bank][i - 0x8000 + 0xc000]
        end
        for i = 0xc000 + 1, 0xc000 + 0x2000 + 1 do
            self.chr_ref[i] = self.prg_ref[bank][i - 0xc000 + 0x8000]
        end
    --self.prg_ref[0x8000, 0x2000], self.prg_ref[0xc000, 0x2000] = self.prg_ref[0xc000, 0x2000], self.prg_ref[0x8000, 0x2000]
    end

    if chr_bank_swap ~= self.chr_bank_swap then
        self.chr_bank_swap = chr_bank_swap
        if not self.chr_ram then
            self.ppu.update(0)
            self.chr_ref = UTILS.rotate(self.chr_ref, 0x1000)
            self.chr_bank_mapping = UTILS.rotate(self.chr_bank_mapping, 4)
        end
    end
end

function MMC3:poke_8001(_addr, data)
    if self.reg_select < 6 then
        if self.reg_select < 2 then
            self:update_chr(self.reg_select * 0x0800, band(data, 0xfe))
            self:update_chr(self.reg_select * 0x0800 + 0x0400, bor(data, 0x01))
        else
            self:update_chr((self.reg_select - 2) * 0x0400 + 0x1000, data)
        end
    else
        self:update_prg((self.reg_select - 6) * 0x2000 + 0x8000, band(data, 0x3f))
    end
end

function MMC3:poke_a000(_addr, data)
    self.ppu:nametables(data[0] == 1 and "horizontal" or "vertical")
end

function MMC3:poke_a001(_addr, data)
    self.wrk_readable = data[7] == 1
    self.wrk_writable = data[6] == 0 and self.wrk_readable
end

function MMC3:poke_c000(_addr, data)
    self.ppu:update(0)
    self.latch = data
end

function MMC3:poke_c001(_addr, _data)
    self.ppu:update(0)
    self.reload = true
end

function MMC3:poke_e000(_addr, _data)
    self.ppu:update(0)
    self.enabled = false
    self.cpu:clear_irq(CPU.IRQ_EXT)
end

function MMC3:poke_e001(_addr, _data)
    self.ppu:update(0)
    self.enabled = true
end

function MMC3:vsync()
    self.clock = self.clock > self.cpu.next_frame_clock and self.clock - self.cpu.next_frame_clock or 0
end

function MMC3:a12_signaled(cycle)
    local clk = self.clock
    self.clock = cycle + self.hold
    if cycle < clk then
        return
    end
    local flag = self.persistant or self.count > 0
    if self.reload then
        self.reload = false
        self.count = self.latch
    elseif self.count == 0 then
        self.count = self.latch
    else
        self.count = self.count - 1
    end
    if flag and self.count == 0 and self.enabled then
        self.cpu:do_irq(CPU.IRQ_EXT, cycle)
    end
end

ROM.MAPPER_DB[0x04] = MMC3

return ROM
local band = bit.band
local bor = bit.bor
local bxor = bit.bxor
local bnot = bit.bnot
local lshift = bit.lshift
local rshift = bit.rshift

local UTILS = {}

function UTILS.isDefined(v)
    local CPU = require("nes.cpu")
    return (v and v ~= CPU.UNDEFINED) and v or nil
end

function UTILS.bind(f, param)
    return function(...)
        return f(param, ...)
    end
end

function UTILS.timeF(f, n)
    local t = os.clock()
    for i = 1, n or 1 do
        f()
    end
    return os.clock() - t
end

function UTILS.tSetter(t)
    return function(i, v)
        t[i] = v
    end
end
function UTILS.tGetter(t, offs)
    offs = (offs or 1)
    return function(i)
        return t[i + offs]
    end
end
function UTILS.map(t, f)
    local tt = {}
    for i = t[0] and 0 or 1, #t do
        tt[i] = f(t[i])
    end
    return tt
end
function UTILS.fill(t, v, n, step, offs)
    for i = t[0] and 0 or 1, math.max(#t, n or 0), step or 1 do
        t[i + (offs or 0)] = v
    end
    return t
end

function UTILS.shiftingArray()
    local _t = {}
    local t = {}
    local shift = 0
    setmetatable(
        t,
        {
            __index = function(t, k)
                return _t[UTILS.rotateIdx(_t, k + shift)]
            end,
            __newindex = function(t, k, v)
                if k > #_t then
                    table.insert(_t, shift + k - #_t - 1, v)
                else
                    _t[UTILS.rotateIdx(_t, k + shift)] = v
                end
            end
        }
    )
    t.rotate = function(self, newshift)
        shift = UTILS.rotateIdx(_t, newshift + shift)
    end
    return t
end

function UTILS.indexRotating(t, idx)
    return t[UTILS.rotateIdx(t, idx)]
end

function UTILS.rotatePositiveIdx(t, idx, size)
    size = size or #t
    return ((idx - 1) % size) + 1
end

function UTILS.rotateIdx(t, idx, size)
    size = size or #t
    if idx > size then
        return UTILS.rotateIdx(t, idx - size, size)
    elseif idx < 1 then
        return UTILS.rotateIdx(t, idx + size, size)
    else
        return idx
    end
end

-- In-place
function UTILS.rotate(array, shift) -- Works for array with consecutive entries
    shift = shift or 1 -- make second arg optional, defaults to 1

    local start = array[0] and 0 or 1
    local size = #array

    if shift > 0 then
        for i = 1, math.abs(shift) do
            table.insert(array, 1, table.remove(array, size))
        end
    else
        for i = 1, math.abs(shift) do
            table.insert(array, size, table.remove(array, 1))
        end
    end
    return array
end
function UTILS.rotateNew(t, r)
    local rotated = {}
    local size = #t
    local start = t[0] and 0 or 1
    if r >= 0 then
        for i = start, size do
            local idx = i + r
            if idx > size then
                idx = idx - size
            elseif (idx < start) then
                idx = idx + size
            end
            rotated[i] = t[idx]
        end
    else
        for i = 1, size do
            local idx = size - i + r
            if idx > size then
                idx = idx - size
            elseif (idx < start) then
                idx = idx + size
            end
            rotated[i] = t[idx]
        end
    end
    return rotated
end
function UTILS.nthBitIsSet(n, nth)
    return band(n, nth == 0 and 0x1 or lshift(0x1, nth)) ~= 0
end
function UTILS.nthBitIsSetInt(n, nth)
    return UTILS.nthBitIsSet(n, nth) and 1 or 0
end
function UTILS.transpose(t)
    local tt = {}
    if #t == 0 then
        return tt
    end
    local ttSize = #(t[1])
    for i = t[1][0] and 0 or 1, ttSize do
        local ttt = {}
        tt[i] = ttt
        for j = t[0] and 0 or 1, #t do
            ttt[j] = t[j][i]
        end
    end
    return tt
end
function UTILS.range(a, b, step)
    local t = {}
    -- is floor right here?
    local qty = (b - a)
    if not step then
        if qty > 0 then
            step = 1
        else
            step = -1
            qty = -qty
        end
    end
    for i = 0, (math.floor(math.abs(qty / step))) do
        t[i] = a + i * step
    end
    return t
end
function UTILS.printf(...)
    print(string.format(...))
end
function UTILS.concat0(...)
    local args = {...}
    if type(args[1]) == "table" then
        local ct = {}
        for j = 1, #args do
            local t = args[j]
            for i = 0, #t do
                ct[(not ct[0]) and 0 or (#ct + 1)] = t[i]
            end
        end
        return ct
    else
        return table.concat(...)
    end
end
function UTILS.concat(...)
    local args = {...}
    if type(args[1]) == "table" then
        local ct = {}
        for j = 1, #args do
            local t = args[j]
            for i = 1, #t do
                ct[#ct + 1] = t[i]
            end
        end
        return ct
    else
        return table.concat(...)
    end
end
function UTILS.copy(t, n, offset, step)
    local tt = {}
    n = n or #t
    offset = offset or 0
    for i = t[0] and 0 or 1, n, step or 1 do
        tt[i] = t[i + offset]
    end
    return tt
end
function UTILS.dump(o)
    if type(o) == "table" then
        local s = "{ "
        for k, v in pairs(o) do
            if type(k) ~= "number" then
                k = '"' .. k .. '"'
            end
            s = s .. "[" .. k .. "] = " .. UTILS.dump(v) .. ","
        end
        return s .. "} "
    else
        return tostring(o)
    end
end
function UTILS.dumpi(o)
    if type(o) == "table" then
        local s = "{ "
        for k, v in ipairs(o) do
            if type(k) ~= "number" then
                k = '"' .. k .. '"'
            end
            s = s .. UTILS.dumpi(v) .. ","
        end
        return s .. "} "
    else
        return tostring(o)
    end
end
function UTILS.all(t, f)
    for i = t[0] and 0 or 1, #t do
        if not f(t[i]) then
            return false
        end
    end
    return true
end
function UTILS.flat_map(t, f)
    t = UTILS.map(t, f)
    local tt = {}
    for j = t[0] and 0 or 1, #t do
        local st = t[j]
        for i = t[0] and 0 or 1, #st do
            local v = st[i]
            tt[#tt + 1] = v
        end
    end
    return tt
end
function UTILS.clear(t)
    for k in pairs(t) do
        t[k] = nil
    end
end
function UTILS.uniq(t)
    local tt = {}
    local done = {}
    for i = t[0] and 0 or 1, #t do
        local x = t[i]
        if not done[x] then
            tt[#tt + 1] = x
            done[x] = true
        end
    end
    return tt
end
local p = print
local f = nil
function UTILS.print(x)
    if not f then
        local ff = assert(io.open("logs.txt", "w"))
        ff:write("")
        ff:close()
        f = assert(io.open("logs.txt", "a"))
        asdasdsssasd = f
    end
    local str = UTILS.dump(x)
    f:write(str .. "\n")
    --f:flush()
    --p(str)
end
function UTILS.import(t)
    local e = getfenv(2)
    for k, v in pairs(t) do
        e[k] = v
    end
end

function UTILS.class(parent)
    local class = {}
    if parent then
        setmetatable(class, {__index = parent})
        class._parent = parent
    end
    class._mt = {__index = class}
    function class:new(...)
        local instance = {}
        setmetatable(instance, class._mt)
        if instance.initialize then
            instance:initialize(...)
        end
        return instance
    end
    return class
end

return UTILS
local complex = require("nes.libs.complex")
local UTILS = require("nes.utils")

local band, bor, bxor, bnot, lshift, rshift = bit.band, bit.bor, bit.bxor, bit.bnot, bit.lshift, bit.rshift
local map, rotatePositiveIdx, nthBitIsSet, nthBitIsSetInt =
    UTILS.map,
    UTILS.rotatePositiveIdx,
    UTILS.nthBitIsSet,
    UTILS.nthBitIsSetInt

local PALETTE = {}

function PALETTE:defacto_palette()
    local p =
        UTILS.flat_map(
        {
            {1.00, 1.00, 1.00}, -- default
            {1.00, 0.80, 0.81}, -- emphasize R
            {0.78, 0.94, 0.66},
            -- emphasize G
            {0.79, 0.77, 0.63}, -- emphasize RG
            {0.82, 0.83, 1.12}, -- emphasize B
            {0.81, 0.71, 0.87}, -- emphasize RB
            {0.68, 0.79, 0.79}, -- emphasize GB
            {0.70, 0.70, 0.70} -- emphasize RGB
        },
        function(t)
            local rf, gf, bf = t[1], t[2], t[3]
            -- RGB default palette (I don't know where this palette came from)
            return UTILS.map(
                {
                    0x666666,
                    0x002a88,
                    0x1412a7,
                    0x3b00a4,
                    0x5c007e,
                    0x6e0040,
                    0x6c0600,
                    0x561d00,
                    0x333500,
                    0x0b4800,
                    0x005200,
                    0x004f08,
                    0x00404d,
                    0x000000,
                    0x000000,
                    0x000000,
                    0xadadad,
                    0x155fd9,
                    0x4240ff,
                    0x7527fe,
                    0xa01acc,
                    0xb71e7b,
                    0xb53120,
                    0x994e00,
                    0x6b6d00,
                    0x388700,
                    0x0c9300,
                    0x008f32,
                    0x007c8d,
                    0x000000,
                    0x000000,
                    0x000000,
                    0xfffeff,
                    0x64b0ff,
                    0x9290ff,
                    0xc676ff,
                    0xf36aff,
                    0xfe6ecc,
                    0xfe8170,
                    0xea9e22,
                    0xbcbe00,
                    0x88d800,
                    0x5ce430,
                    0x45e082,
                    0x48cdde,
                    0x4f4f4f,
                    0x000000,
                    0x000000,
                    0xfffeff,
                    0xc0dfff,
                    0xd3d2ff,
                    0xe8c8ff,
                    0xfbc2ff,
                    0xfec4ea,
                    0xfeccc5,
                    0xf7d8a5,
                    0xe4e594,
                    0xcfef96,
                    0xbdf4ab,
                    0xb3f3cc,
                    0xb5ebf2,
                    0xb8b8b8,
                    0x000000,
                    0x000000
                },
                function(rgb)
                    local r = math.min(math.floor(band(rshift(rgb, 16), 0xff) * rf), 0xff)
                    local g = math.min(math.floor(band(rshift(rgb, 8), 0xff) * gf), 0xff)
                    local b = math.min(math.floor(band(rshift(rgb, 0), 0xff) * bf), 0xff)
                    --return bor(0x00000000, lshift(r, 16), lshift(g, 8), b)
                    return {r, g, b}
                end
            )
        end
    )
    return p
end
--[
-- Nestopia generates a palette systematically (cool!), but it is not compatible with nes-tests-rom
function PALETTE:nestopia_palette()
    return UTILS.map(
        range(0, 511),
        function(n)
            local tint, level, color = band(rshift(n, 6), 7), band(rshift(n, 4), 3), band(n, 0x0f)
            local t = ({{-0.12, 0.40}, {0.00, 0.68}, {0.31, 1.00}, {0.72, 1.00}})[level + 1]
            local level0, level1 = t[1], t[2]
            if color == 0x00 then
                level0 = level1
            end
            if color == 0x0d then
                level1 = level0
            end
            if color >= 0x0e then
                level0 = 0
                level1 = 0
            end
            local y = (level1 + level0) * 0.5
            local s = (level1 - level0) * 0.5
            local iq = complex.convpolar(s, math.pi / 6 * (color - 3))
            if tint ~= 0 and color <= 0x0d then
                if tint == 7 then
                    y = (y * 0.79399 - 0.0782838) * 1.13
                else
                    level1 = (level1 * (1 - 0.79399) + 0.0782838) * 0.5
                    y = y - level1 * 0.5
                    if tint == 3 or tint == 5 or tint == 6 then
                        level1 = level1 * 0.6
                        y = y - level1
                    end
                    iq = iq + complex.convpolar(level1, math.pi / 12 * (({0, 6, 10, 8, 2, 4, 0, 0})[tint + 1]) * 2 - 7)
                end
            end
            return UTILS.map(
                {{105, 0.570}, {251, 0.351}, {15, 1.015}},
                function(pair)
                    local angle, gain = pair[1], pair[2]

                    local clr =
                        y + ((complex.convpolar(gain * 2, (angle - 33) * math.pi / 180) * complex.conjugate(iq))[1])
                    return math.min(math.max(0, math.floor(clr * 255)), 255)
                end
            )
        end
    )
end
--]]

return PALETTE
-- Refer to https://wiki.nesdev.com/w/index.php/APU
-- for documentation on how the APU works
local UTILS = require("nes.utils")
local CPU = require("nes.cpu")

local band, bor, bxor, bnot, lshift, rshift = bit.band, bit.bor, bit.bxor, bit.bnot, bit.lshift, bit.rshift
local map, rotatePositiveIdx, nthBitIsSet, nthBitIsSetInt, range, concat0, concat =
  UTILS.map,
  UTILS.rotatePositiveIdx,
  UTILS.nthBitIsSet,
  UTILS.nthBitIsSetInt,
  UTILS.range,
  UTILS.concat0,
  UTILS.concat

local Pulse = nil
local Triangle = nil
local LengthCounter = nil
local Noise = nil
local DMC = nil
local MIXER = nil

local APU = {} 
APU._mt = {__index = APU}

local NES =
  {
    -- DUMMY NES
    RP2A03_CC = 12,
    FOREVER_CLOCK = 0xffffffff
  }
APU.CLK_M2_MUL = 6
APU.CLK_NTSC = 39375000 * APU.CLK_M2_MUL
APU.CLK_NTSC_DIV = 11

APU.CHANNEL_OUTPUT_MUL = 256
APU.CHANNEL_OUTPUT_DECAY = APU.CHANNEL_OUTPUT_MUL / 4 - 1

APU.FRAME_CLOCKS =
  UTILS.map(
  {29830, 1, 1, 29828},
  function(n)
    return CPU.RP2A03_CC * n
  end
)
APU.OSCILLATOR_CLOCKS =
  map(
  {
    {7458, 7456, 7458, 7458},
    {7458, 7456, 7458, 7458 + 7452}
  },
  function(a)
    return UTILS.map(
      a,
      function(n)
        return CPU.RP2A03_CC * n
      end
    )
  end
)
function APU:new(conf, cpu, rate, bits)
  local apu = {}
  setmetatable(apu, APU._mt)
  apu:initialize(conf, cpu, rate, bits)
  return apu
end
function APU:initialize(conf, cpu, rate, bits)
  self.conf = conf
  self.cpu = cpu
  rate = rate or 44100
  bits = bits or 8

  self.pulse_0, self.pulse_1 = Pulse:new(self), Pulse:new(self)
  self.triangle = Triangle:new(self)
  self.noise = Noise:new(self)
  self.dmc = DMC:new(self.cpu, self)
  self.mixer = MIXER:new(self.pulse_0, self.pulse_1, self.triangle, self.noise, self.dmc)

  if rate < 11050 then
    error("audio sample rate must be >= 11050")
  end
  if bits ~= 8 and bits ~= 16 then
    error("audio bit depth must be 8 or 16")
  end

  self.settings_rate = rate

  self.output = {}
  self.buffer = {}

  self.fixed_clock = 1
  self.rate_clock = 1
  self.rate_counter = 0
  self.frame_counter = 0
  self.frame_divider = 0
  self.frame_irq_clock = 0
  self.frame_irq_repeat = 0
  self.dmc_clock = 0

  self:reset(false)
  return self
end

function APU:reset_mapping()
  self.frame_counter = self.frame_counter / self.fixed_clock
  self.rate_counter = self.rate_counter / self.fixed_clock
  local multiplier = 0
  while true do
    multiplier = multiplier + 1
    if multiplier >= 512 then
      break
    end
    if APU.CLK_NTSC * multiplier % self.settings_rate == 0 then
      break
    end
  end
  self.rate_clock = APU.CLK_NTSC * multiplier / self.settings_rate
  self.fixed_clock = APU.CLK_NTSC_DIV * multiplier
  self.frame_counter = self.frame_counter * self.fixed_clock
  self.rate_counter = self.rate_counter * self.fixed_clock

  self.mixer:reset()
  self.buffer = {} -- is this right? should we empty existing table? (It was .clear())

  local multiplier = 0
  while true do
    multiplier = multiplier + 1
    if multiplier >= 0x1000 then
      break
    end
    if APU.CLK_NTSC * (multiplier + 1) / self.settings_rate > 0x7ffff then
      break
    end
    if APU.CLK_NTSC * multiplier % self.settings_rate == 0 then
      break
    end
  end
  local rate = APU.CLK_NTSC * multiplier / self.settings_rate
  local fixed = APU.CLK_NTSC_DIV * CPU.CLK[1] * multiplier

  self.pulse_0:update_settings(rate, fixed)
  self.pulse_1:update_settings(rate, fixed)
  self.triangle:update_settings(rate, fixed)
  self.noise:update_settings(rate, fixed)

  self.cpu:add_mappings(0x4000, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.pulse_0.poke_0, self.pulse_0))
  self.cpu:add_mappings(0x4001, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.pulse_0.poke_1, self.pulse_0))
  self.cpu:add_mappings(0x4002, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.pulse_0.poke_2, self.pulse_0))
  self.cpu:add_mappings(0x4003, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.pulse_0.poke_3, self.pulse_0))
  self.cpu:add_mappings(0x4004, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.pulse_1.poke_0, self.pulse_1))
  self.cpu:add_mappings(0x4005, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.pulse_1.poke_1, self.pulse_1))
  self.cpu:add_mappings(0x4006, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.pulse_1.poke_2, self.pulse_1))
  self.cpu:add_mappings(0x4007, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.pulse_1.poke_3, self.pulse_1))
  self.cpu:add_mappings(0x4008, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.triangle.poke_0, self.triangle))
  self.cpu:add_mappings(0x400a, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.triangle.poke_2, self.triangle))
  self.cpu:add_mappings(0x400b, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.triangle.poke_3, self.triangle))
  self.cpu:add_mappings(0x400c, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.noise.poke_0, self.noise))
  self.cpu:add_mappings(0x400e, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.noise.poke_2, self.noise))
  self.cpu:add_mappings(0x400f, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.noise.poke_3, self.noise))
  self.cpu:add_mappings(0x4010, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.dmc.poke_0, self.dmc))
  self.cpu:add_mappings(0x4011, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.dmc.poke_1, self.dmc))
  self.cpu:add_mappings(0x4012, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.dmc.poke_2, self.dmc))
  self.cpu:add_mappings(0x4013, UTILS.bind(self.peek_40xx, self), UTILS.bind(self.dmc.poke_3, self.dmc))
  self.cpu:add_mappings(0x4015, UTILS.bind(self.peek_4015, self), UTILS.bind(self.poke_4015, self))
  self.frame_irq_clock = (self.frame_counter / self.fixed_clock) - CPU.CLK[1]
end

function APU:reset(mapping)
  mapping = mapping == nil and true or mapping
  self.cycles_ratecounter = 0
  self.frame_divider = 0
  self.frame_irq_clock = CPU.FOREVER_CLOCK
  self.frame_irq_repeat = 0
  self.dmc_clock = DMC.LUT[1]
  self.frame_counter = APU.FRAME_CLOCKS[1] * self.fixed_clock

  if mapping then
    self:reset_mapping()
  end

  self.pulse_0:reset()
  self.pulse_1:reset()
  self.triangle:reset()
  self.noise:reset()
  self.dmc:reset()
  self.mixer:reset()
  self.buffer = {} -- ..clear -> this. Is it enough? (Or do we empty existing table)
  self.oscillator_clocks = APU.OSCILLATOR_CLOCKS[1]
end

--##########################################################################
-- other APIs

function APU:do_clock()
  local curClk = self.cpu:current_clock()
  self:clock_dma(curClk)
  curClk = self.cpu:current_clock()
  if self.frame_irq_clock <= curClk then
    self:clock_frame_irq(curClk)
  end
  return math.min(self.dmc_clock, self.frame_irq_clock)
end

function APU:clock_dma(clk)
  if self.dmc_clock <= clk then
    self:clock_dmc(clk)
  end
end

function APU:update(target)
  target = (target or self.cpu:update()) * self.fixed_clock
  self:proceed(target)
  if self.frame_counter < target then
    return self:clock_frame_counter()
  end
end

function APU:update_latency()
  self:update(self.cpu:update() + 1)
end

function APU:update_delta()
  local elapsed = self.cpu:update()
  local delta = self.frame_counter ~= elapsed * self.fixed_clock
  self:update(elapsed + 1)
  return delta
end

function APU:vsync()
  self:flush_sound()
  self:update(self.cpu:current_clock())
  local frame = self.cpu:next_frame_clock()
  self.dmc_clock = self.dmc_clock - frame
  if self.frame_irq_clock ~= CPU.FOREVER_CLOCK then
    self.frame_irq_clock = self.frame_irq_clock - frame
  end
  frame = frame * self.fixed_clock
  self.rate_counter = self.rate_counter - frame
  self.frame_counter = self.frame_counter - frame
end

-- helpers

function APU:clock_oscillators(two_clocks)
  self.pulse_0:clock_envelope()
  self.pulse_1:clock_envelope()
  self.triangle:clock_linear_counter()
  self.noise:clock_envelope()
  if not two_clocks then
    return
  end
  self.pulse_0:clock_sweep(-1)
  self.pulse_1:clock_sweep(0)
  self.triangle:clock_length_counter()
  self.noise:clock_length_counter()
end

function APU:clock_dmc(target)
  repeat
    if self.dmc.clock_dac then
      self:update(self.dmc_clock)
      self.dmc:update()
    end
    self.dmc_clock = self.dmc_clock + self.dmc.freq
    self.dmc:clock_dma() -- TODO: IS THIS RIGHT?
  until not (self.dmc_clock <= target)
end
function APU:clock_frame_counter()
  self:clock_oscillators(nthBitIsSetInt(self.frame_divider, 0) == 1)
  self.frame_divider = band((self.frame_divider + 1), 3)
  self.frame_counter = self.frame_counter + self.oscillator_clocks[self.frame_divider + 1] * self.fixed_clock
end

function APU:clock_frame_irq(target)
  self.cpu:do_irq(CPU.IRQ_FRAME, self.frame_irq_clock)
  repeat
    self.frame_irq_clock = self.frame_irq_clock + APU.FRAME_CLOCKS[2 + self.frame_irq_repeat % 3]
    self.frame_irq_repeat = self.frame_irq_repeat + 1
  until not (self.frame_irq_clock <= target)
end

function APU:flush_sound()
  if #self.buffer < self.settings_rate / 60 then
    local target = self.cpu:current_clock() * self.fixed_clock
    self:proceed(target)
    if #self.buffer < self.settings_rate / 60 then
      if self.frame_counter < target then
        self:clock_frame_counter()
      end
      while #self.buffer < self.settings_rate / 60 do
        self.buffer[#(self.buffer) + 1] = self.mixer:sample()
      end
    end
  end
  self.output = concat({}, self.buffer)
  self.buffer = {} --.clear
end

function APU:proceed(target)
  while self.rate_counter < target and #self.buffer < self.settings_rate / 60 do
    self.buffer[#(self.buffer) + 1] = self.mixer:sample()
    if self.frame_counter <= self.rate_counter then
      self:clock_frame_counter()
    end
    self.rate_counter = self.rate_counter + self.rate_clock
  end
end

-- mapped memory handlers

-- Control
function APU:poke_4015(_addr, data)
  self:update()
  self.pulse_0:enable(nthBitIsSet(data, 0))
  self.pulse_1:enable(nthBitIsSet(data, 1))
  self.triangle:enable(nthBitIsSet(data, 2))
  self.noise:enable(nthBitIsSet(data, 3))
  self.dmc:enable(nthBitIsSet(data, 4))
end

-- Status
--function
function APU:peek_4015(_addr)
  local elapsed = self.cpu:update()
  if self.frame_irq_clock <= elapsed then
    self:clock_frame_irq(elapsed)
  end
  if self.frame_counter < elapsed * self.fixed_clock then
    self:update(elapsed)
  end
  return bor(
    self.cpu:clear_irq(CPU.IRQ_FRAME),
    (self.pulse_0.status and 0x01 or 0),
    (self.pulse_1.status and 0x02 or 0),
    (self.triangle.status and 0x04 or 0),
    (self.noise.status and 0x08 or 0),
    (self.dmc.status and 0x10 or 0)
  )
end

-- Frame counter (NOTE: this handler is called via Pads)
function APU:poke_4017(_addr, data)
  local n = self.cpu:update()
  if self.cpu:odd_clock() then
    n = n + CPU.CLK[1]
  end
  self:update(n)
  if self.frame_irq_clock <= n then
    clock_frame_irq(n)
  end
  n = n + CPU.CLK[1]
  self.oscillator_clocks = APU.OSCILLATOR_CLOCKS[nthBitIsSetInt(data, 7) + 1]
  self.frame_counter = (n + self.oscillator_clocks[1]) * self.fixed_clock
  self.frame_divider = 0
  self.frame_irq_clock = (band(data, 0xc0) ~= 0) and CPU.FOREVER_CLOCK or (n + APU.FRAME_CLOCKS[1])
  self.frame_irq_repeat = 0
  if nthBitIsSetInt(data, 6) ~= 0 then
    self.cpu:clear_irq(CPU.IRQ_FRAME)
  end
  if nthBitIsSetInt(data, 7) ~= 0 then
    self:clock_oscillators(true)
  end
end

function APU:peek_40xx(_addr)
  return 0x40
end

LengthCounter = UTILS.class()
LengthCounter.LUT = {
  0x0a,
  0xfe,
  0x14,
  0x02,
  0x28,
  0x04,
  0x50,
  0x06,
  0xa0,
  0x08,
  0x3c,
  0x0a,
  0x0e,
  0x0c,
  0x1a,
  0x0e,
  0x0c,
  0x10,
  0x18,
  0x12,
  0x30,
  0x14,
  0x60,
  0x16,
  0xc0,
  0x18,
  0x48,
  0x1a,
  0x10,
  0x1c,
  0x20,
  0x1e
}
function LengthCounter:reset()
  self.enabled = false
  self.count = 0
end

function LengthCounter:enable(enabled)
  self.enabled = enabled
  if not self.enabled then
    self.count = 0
  end
  return self.enabled
end

function LengthCounter:write(data, frame_counter_delta)
  if frame_counter_delta or self.count == 0 then
    self.count = self.enabled and LengthCounter.LUT[data + 1] or 0
  end
end

function LengthCounter:clock()
  if self.count == 0 then
    return false
  end
  self.count = self.count - 1
  return self.count == 0
end

local Envelope = UTILS.class()

function Envelope:reset_clock()
  self.clock_reset = true
end

function Envelope:reset()
  self.output = 0
  self.count = 0
  self.volume_base = 0
  self.volume = 0
  self.constant = true
  self.looping = false
  self.clock_reset = false
  return self:update_output()
end

function Envelope:clock()
  if self.clock_reset then
    self.clock_reset = false
    self.volume = 0x0f
  else
    if self.count ~= 0 then
      self.count = self.count - 1
      return
    end
    if self.volume ~= 0 or self.looping then
      self.volume = band((self.volume - 1), 0x0f)
    end
  end
  self.count = self.volume_base
  return self:update_output()
end

function Envelope:write(data)
  self.volume_base = band(data, 0x0f)
  self.constant = nthBitIsSet(data, 4)
  self.looping = nthBitIsSet(data, 5)
  return self:update_output()
end

function Envelope:update_output()
  self.output = (self.constant and self.volume_base or self.volume)
end

MIXER = UTILS.class()
MIXER.VOL = 192
MIXER.P_F = 900
MIXER.P_0 = 9552 * APU.CHANNEL_OUTPUT_MUL * MIXER.VOL * (MIXER.P_F / 100)
MIXER.P_1 = 8128 * APU.CHANNEL_OUTPUT_MUL * MIXER.P_F
MIXER.P_2 = MIXER.P_F * 100
MIXER.TND_F = 500
MIXER.TND_0 = 16367 * APU.CHANNEL_OUTPUT_MUL * MIXER.VOL * (MIXER.TND_F / 100)
MIXER.TND_1 = 24329 * APU.CHANNEL_OUTPUT_MUL * MIXER.TND_F
MIXER.TND_2 = MIXER.TND_F * 100

function MIXER:initialize(pulse_0, pulse_1, triangle, noise, dmc)
  self.pulse_0, self.pulse_1, self.triangle, self.noise, self.dmc = pulse_0, pulse_1, triangle, noise, dmc
end

function MIXER:reset()
  self.next = 0
  self.acc = 0
  self.prev = 0
end

function MIXER:sample()
  -- Formulas taken from https://wiki.nesdev.com/w/index.php/APU_Mixer
  --[[
    local dac0 = self.pulse_0:sample() + self.pulse_1:sample()
    local dac0 = 0.00752 * dac0
    local dac1 = 0 --0.00851 * self.triangle:sample() + 0.00494 * self.noise:sample() + 0.00335 * self.dmc:sample()
    --]]
  --[
  local dac0 = self.pulse_0:sample() + self.pulse_1:sample()
  local dac0 = 95.88 / ((8128 / dac0) + 100)
  -- TODO: DMC (For some reason it sounds really bad)
  local dac1 = 159.79 / (159 + 1 / ((self.triangle:sample() / 8227) + (self.noise:sample() / 12241))) --+ (self.dmc:sample() / 22638)))
  --]]
  return (dac0 + dac1)
  --[[
  local dac0 = self.pulse_0:sample() + self.pulse_1:sample()
  local dac1 = self.triangle:sample() + self.noise:sample() + self.dmc:sample()
  local sample =
    (MIXER.P_0 * dac0 / (MIXER.P_1 + MIXER.P_2 * dac0)) + (MIXER.TND_0 * dac1 / (MIXER.TND_1 + MIXER.TND_2 * dac1))

  self.acc = self.acc - self.prev
  self.prev = lshift(sample, 15)
  self.acc = self.acc + self.prev - self.next * 3 -- POLE
  self.next = rshift(self.acc, 15)
  sample = self.next

  if sample < -0x7fff then
    sample = -0x7fff
  end
  if sample > 0x7fff then
    sample = 0x7fff
  end
  return sample
  --]]
end

local Oscillator = UTILS.class()

function Oscillator:initialize(apu)
  self.apu = apu
  self.rate = 1
  self.fixed = 1
  self.envelope = nil
  self.length_counter = nil
  self.wave_length = nil
end

function Oscillator:reset()
  self.timer = 2048 * self.fixed -- 2048: reset cycles
  self.freq = self.fixed
  self.amp = 0

  if self.wave_length then
    self.wave_length = 0
  end
  if self.envelope then
    self.envelope:reset()
  end
  if self.length_counter then
    self.length_counter:reset()
  end
  self.is_active = self:active()
end

function Oscillator:active()
  if self.length_counter and self.length_counter.count == 0 then
    return false
  end
  if self.envelope and self.envelope.output == 0 then
    return false
  end
  return true
end

function Oscillator:poke_0(_addr, data)
  if self.envelope then
    self.apu:update_latency()
    self.envelope:write(data)
    self.is_active = self:active()
  end
end

function Oscillator:poke_2(_addr, data)
  self.apu:update()
  if self.wave_length then
    self.wave_length = bor(band(self.wave_length, 0x0700), band(data, 0x00ff))
    self:update_freq()
  end
end

function Oscillator:poke_3(_addr, data)
  local delta = self.apu:update_delta()
  if self.wave_length then
    self.wave_length = bor(band(self.wave_length, 0x00ff), lshift(band(data, 0x07), 8))
    self:update_freq()
  end
  if self.envelope then
    self.envelope:reset_clock()
  end
  if self.length_counter then
    self.length_counter:write(rshift(data, 3), delta)
  end
  self.is_active = self:active()
end

function Oscillator:enable(enabled)
  self.length_counter:enable(enabled)
  self.is_active = self:active()
end

function Oscillator:update_settings(r, f)
  self.freq = self.freq / self.fixed * f
  self.timer = self.timer / self.fixed * f
  self.rate, self.fixed = r, f
end

function Oscillator:status()
  return self.length_counter.count > 0
end

function Oscillator:clock_envelope()
  self.envelope:clock()
  self.is_active = self:active()
end

Pulse = UTILS.class(Oscillator)
Pulse.MIN_FREQ = 0x0008
Pulse.MAX_FREQ = 0x07ff
--Pulse.WAVE_FORM = map{0b11111101, 0b11111001, 0b11100001, 0b00000110},function(n) return UTILS.map(range(0,7), function(i) return n[i] * 0x1f } end))
Pulse.WAVE_FORM = {
  {[0] = 0, 0, 0, 0, 0, 0, 0, 1},
  {[0] = 0, 0, 0, 0, 0, 0, 1, 1},
  {[0] = 0, 0, 0, 0, 1, 1, 1, 1},
  {[0] = 1, 1, 1, 1, 1, 1, 0, 0}
}

function Pulse:initialize(_apu)
  self._parent.initialize(self, _apu)
  self.wave_length = 0
  self.envelope = Envelope:new()
  self.length_counter = LengthCounter:new()
  self.duty = 0
end

function Pulse:reset()
  self._parent.reset(self)
  self.freq = self.fixed * 2
  self.period_timer = (2048 - (self.freq / 1000)) * 4
  self.valid_freq = false
  self.step = 0
  self.form = Pulse.WAVE_FORM[1]
  self.sweep_rate = 0
  self.sweep_count = 1
  self.sweep_reload = false
  self.sweep_increase = -1
  self.sweep_shift = 0
end

function Pulse:active()
  return self._parent.active(self) and self.valid_freq
end

function Pulse:update_freq()
  if
    self.wave_length >= Pulse.MIN_FREQ and
      self.wave_length + band(self.sweep_increase, rshift(self.wave_length, self.sweep_shift)) <= Pulse.MAX_FREQ
   then
    self.freq = (self.wave_length + 1) * 2 * self.fixed
    self.period_timer = (2048 - (self.freq / 1000)) * 4
    self.valid_freq = true
  else
    self.valid_freq = false
  end
  self.is_active = self:active()
end

function Pulse:poke_0(_addr, data)
  self._parent.poke_0(self, _addr, data)
  self.duty = band(rshift(data, 6), 3)
  self.form = Pulse.WAVE_FORM[1 + self.duty]
end

function Pulse:poke_1(_addr, data)
  self.apu:update()
  self.sweep_increase = nthBitIsSetInt(data, 3) ~= 0 and 0 or -1
  self.sweep_shift = band(data, 0x07)
  self.sweep_rate = 0
  if nthBitIsSetInt(data, 7) == 1 and self.sweep_shift > 0 then
    self.sweep_rate = band(rshift(data, 4), 0x07) + 1
    self.sweep_reload = true
  end
  return self:update_freq()
end

function Pulse:poke_3(_addr, data)
  self._parent.poke_3(self, _addr, data)
  self.step = 0
end

function Pulse:clock_sweep(complement)
  if not self.envelope.looping and self.length_counter:clock() then
    self.is_active = false
  end
  if self.sweep_rate ~= 0 then
    self.sweep_count = self.sweep_count - 1
    if self.sweep_count == 0 then
      self.sweep_count = self.sweep_rate
      if self.wave_length >= Pulse.MIN_FREQ then
        local shifted = rshift(self.wave_length, self.sweep_shift)
        if self.sweep_increase == 0 then
          self.wave_length = self.wave_length + complement - shifted
          self:update_freq()
        elseif self.wave_length + shifted <= Pulse.MAX_FREQ then
          self.wave_length = self.wave_length + shifted
          self:update_freq()
        end
      end
    end
  end

  if not self.sweep_reload then
    return
  end

  self.sweep_reload = false
  self.sweep_count = self.sweep_rate
end
function Pulse:sample()
  --[[
  if self.is_active then
    local rate = self.apu.settings_rate
    local samples_per_frame = rate / 60
    local cpu_clocks_per_frame = 29780
    -- rate/60 samples _ 29780 clocks
    -- 1 sample _ (29780*60)/rate clocks
    local period_timer_decrement_per_frame = cpu_clocks_per_frame / samples_per_frame
    self.period_timer = self.period_timer - period_timer_decrement_per_frame
    if self.period_timer <= 0 then
      self.period_timer = (2048 - (self.freq / 1000)) * 4
      self.step = band((self.step + 1), 7)
    end
    self.amp = self.envelope.output * self.form[self.step]
  else
    self.amp = 0
  end
  return self.amp
  --]]
  --[
  local sum = self.timer
  self.timer = self.timer - self.rate
  if self.is_active then
    if self.timer < 0 then
      sum = sum * self.form[self.step]
      repeat
        local v = -self.timer
        if v > self.freq then
          v = self.freq
        end
        self.step = band((self.step + 1), 7)
        sum = sum + v * self.form[self.step]
        self.timer = self.timer + self.freq
      until self.timer > 0
      self.amp = (sum * self.envelope.output) / self.rate
    else
      self.amp = self.envelope.output * self.form[self.step]
    end
  else
    if self.amp < APU.CHANNEL_OUTPUT_DECAY then
      return 0
    end
    self.amp = self.amp - APU.CHANNEL_OUTPUT_DECAY
  end
  return self.amp
  --]]
end

Triangle = UTILS.class(Oscillator)
Triangle.MIN_FREQ = 2 + 1
Triangle.WAVE_FORM = concat0(range(0, 15), range(15, 0))

function Triangle:initialize(_apu)
  self._parent.initialize(self, _apu)
  self.wave_length = 0
  self.length_counter = LengthCounter:new()
end

function Triangle:reset()
  self._parent.reset(self)
  self.step = 7
  self.status = "counting"
  self.linear_counter_load = 0
  self.linear_counter_start = true
  self.linear_counter = 0
end

function Triangle:active()
  return self._parent.active(self) and self.linear_counter ~= 0 and self.wave_length >= Triangle.MIN_FREQ
end

function Triangle:update_freq()
  self.freq = (self.wave_length + 1) * self.fixed
  self.is_active = self:active()
end

function Triangle:poke_0(_addr, data)
  self._parent.poke_0(self, _addr, data)
  self.apu:update()
  self.linear_counter_load = band(data, 0x7f)
  self.linear_counter_start = nthBitIsSetInt(data, 7) == 0
end

function Triangle:poke_3(_addr, data)
  self._parent.poke_3(self, _addr, data)
  self.status = "reload"
end

function Triangle:clock_linear_counter()
  if self.status == "counting" then
    if self.linear_counter ~= 0 then
      self.linear_counter = self.linear_counter - 1
    end
  else
    if self.linear_counter_start then
      self.status = "counting"
    end
    self.linear_counter = self.linear_counter_load
  end
  self.is_active = self:active()
end

function Triangle:clock_length_counter()
  if self.linear_counter_start and self.length_counter:clock() then
    self.is_active = false
  end
end

function Triangle:sample()
  if self.is_active then
    local sum = self.timer
    self.timer = self.timer - self.rate
    if self.timer < 0 then
      sum = sum * Triangle.WAVE_FORM[self.step]
      repeat
        local v = math.min(-(self.timer), self.freq)
        self.step = band((self.step + 1), 0x1f)
        sum = sum + v * Triangle.WAVE_FORM[self.step]
        self.timer = self.timer + self.freq
      until not (self.timer < 0)
      self.amp = (sum + self.rate / 2) / self.rate
    else
      self.amp = Triangle.WAVE_FORM[self.step]
    end
  else
    if self.amp < APU.CHANNEL_OUTPUT_DECAY then
      return 0
    end
    self.amp = self.amp - APU.CHANNEL_OUTPUT_DECAY
    self.step = 0
  end
  return self.amp
end

Noise = UTILS.class(Oscillator)
Noise.LUT = {4, 8, 16, 32, 64, 96, 128, 160, 202, 254, 380, 508, 762, 1016, 2034, 4068}
Noise.NEXT_BITS_1, Noise.NEXT_BITS_6 =
  table.unpack(
  UTILS.map(
    {1, 6},
    function(shifter)
      return UTILS.map(
        range(0, 0x7fff),
        function(bits)
          return math.floor(
            nthBitIsSetInt(bits, 0) == nthBitIsSetInt(bits, shifter) and (bits / 2) or (bits / 2 + 0x4000)
          )
        end
      )
    end
  )
)

function Noise:initialize(_apu)
  self._parent.initialize(self, _apu)
  self.envelope = Envelope:new()
  self.length_counter = LengthCounter:new()
  self.bits = 0x4000
end

function Noise:reset()
  self._parent.reset(self)
  self.freq = Noise.LUT[1] * self.fixed
  self.bits = 0x4000
  self.shifter = Noise.NEXT_BITS_1
end

function Noise:poke_2(_addr, data)
  self.apu:update()
  self.freq = Noise.LUT[band(data, 0x0f) + 1] * self.fixed
  self.shifter = nthBitIsSetInt(data, 7) ~= 0 and Noise.NEXT_BITS_6 or Noise.NEXT_BITS_1
end

function Noise:clock_length_counter()
  if not self.envelope.looping and self.length_counter:clock() then
    self.is_active = false
  end
end

function Noise:sample()
  self.bits = self.bits or 0x4000
  self.timer = self.timer - self.rate
  if self.is_active then
    if self.timer >= 0 then
      return self.bits % 2 == 0 and self.envelope.output * 2 or 0
    end

    local sum = self.bits % 2 == 0 and self.timer or 0
    repeat
      self.bits = self.shifter[self.bits]
      if self.bits % 2 == 0 then
        sum = sum + math.min(-self.timer, self.freq)
      end
      self.timer = self.timer + self.freq
    until not (self.timer < 0)
    return (sum * self.envelope.output + self.rate / 2) / self.rate * 2
  else
    while self.timer < 0 do
      self.bits = self.shifter[self.bits]
      self.timer = self.timer + self.freq
    end
    return 0
  end
end

DMC = UTILS.class()
DMC.LUT =
  UTILS.map(
  {428, 380, 340, 320, 286, 254, 226, 214, 190, 160, 142, 128, 106, 84, 72, 54},
  function(n)
    return n * CPU.RP2A03_CC
  end
)

function DMC:initialize(cpu, apu)
  self.apu = apu
  self.cpu = cpu
  self.freq = DMC.LUT[1]
end

function DMC:reset()
  self.cur_sample = 0
  self.lin_sample = 0
  self.freq = DMC.LUT[1]
  self.loop = false
  self.irq_enable = false
  self.regs_length_counter = 1
  self.regs_address = 0xc000
  self.out_active = false
  self.out_shifter = 0
  self.out_dac = 0
  self.out_buffer = 0x00
  self.dma_length_counter = 0
  self.dma_buffered = false
  self.dma_address = 0xc000
  self.dma_buffer = 0x00
end

function DMC:enable(enabled)
  self.cpu:clear_irq(CPU.IRQ_DMC)
  if not enabled then
    self.dma_length_counter = 0
  elseif self.dma_length_counter == 0 then
    self.dma_length_counter = self.regs_length_counter
    self.dma_address = self.regs_address
    if not self.dma_buffered then
      self:do_dma()
    end
  end
end

function DMC:sample()
  if self.cur_sample ~= self.lin_sample then
    local step = APU.CHANNEL_OUTPUT_MUL * 8
    if self.lin_sample + step < self.cur_sample then
      self.lin_sample = self.lin_sample + step
    elseif self.cur_sample < self.lin_sample - step then
      self.lin_sample = self.lin_sample - step
    else
      self.lin_sample = self.cur_sample
    end
  end
  return self.lin_sample
end

function DMC:do_dma()
  self.dma_buffer = self.cpu:dmc_dma(self.dma_address)
  self.dma_address = bor(0x8000, band((self.dma_address + 1), 0x7fff))
  self.dma_buffered = true
  self.dma_length_counter = self.dma_length_counter - 1
  if self.dma_length_counter == 0 then
    if self.loop then
      self.dma_address = self.regs_address
      self.dma_length_counter = self.regs_length_counter
    elseif self.irq_enable then
      self.cpu:do_irq(CPU.IRQ_DMC, self.cpu:current_clock())
    end
  end
end

function DMC:update()
  self.cur_sample = self.out_dac * APU.CHANNEL_OUTPUT_MUL
end

function DMC:poke_0(_addr, data)
  self.loop = nthBitIsSetInt(data, 6) ~= 0
  self.irq_enable = nthBitIsSetInt(data, 7) ~= 0
  self.freq = DMC.LUT[band(data, 0x0f) + 1]
  if not self.irq_enable then
    self.cpu:clear_irq(CPU.IRQ_DMC)
  end
end

function DMC:poke_1(_addr, data)
  self.apu:update()
  self.out_dac = band(data, 0x7f)
  self:update()
end

function DMC:poke_2(_addr, data)
  self.regs_address = bor(0xc000, lshift(data, 6))
end

function DMC:poke_3(_addr, data)
  self.regs_length_counter = lshift(data, 4) + 1
end

function DMC:clock_dac()
  if self.out_active then
    n = self.out_dac + lshift(band(self.out_buffer, 1), 2) - 2
    self.out_buffer = rshift(self.out_buffer, 1)
    if 0 <= n and n <= 0x7f and n ~= self.out_dac then
      self.out_dac = n
      return true
    end
  end
  return false
end

function DMC:clock_dma()
  if self.out_shifter == 0 then
    self.out_shifter = 7
    self.out_active = self.dma_buffered
    if self.out_active then
      self.dma_buffered = false
      self.out_buffer = self.dma_buffer
      if self.dma_length_counter ~= 0 then
        self:do_dma()
      end
    end
  else
    self.out_shifter = self.out_shifter - 1
  end
end

function DMC:status()
  return self.dma_length_counter > 0
end

return APU
local UTILS = require("nes.utils")
local CPU = require("nes.cpu")

local band, bor, bxor, bnot, lshift, rshift = bit.band, bit.bor, bit.bxor, bit.bnot, bit.lshift, bit.rshift
local map, rotatePositiveIdx, nthBitIsSet, nthBitIsSetInt, range =
    UTILS.map,
    UTILS.rotatePositiveIdx,
    UTILS.nthBitIsSet,
    UTILS.nthBitIsSetInt,
    UTILS.range

local PPU = {}
PPU._mt = {__index = PPU}
function PPU:new(conf, cpu, palette)
    local ppu = {}
    setmetatable(ppu, PPU._mt)
    ppu:initialize(conf, cpu, palette)
    return ppu
end

PPU.SCREEN_HEIGHT = 240
PPU.SCREEN_WIDTH = 256
-- clock/timing constants (stolen from Nestopia)
PPU.RP2C02_CC = 4
PPU.RP2C02_HACTIVE = PPU.RP2C02_CC * 256
PPU.RP2C02_HBLANK = PPU.RP2C02_CC * 85
PPU.RP2C02_HSYNC = PPU.RP2C02_HACTIVE + PPU.RP2C02_HBLANK
PPU.RP2C02_VACTIVE = 240
PPU.RP2C02_VSLEEP = 1
PPU.RP2C02_VINT = 20
PPU.RP2C02_VDUMMY = 1
PPU.RP2C02_VBLANK = PPU.RP2C02_VSLEEP + PPU.RP2C02_VINT + PPU.RP2C02_VDUMMY
PPU.RP2C02_VSYNC = PPU.RP2C02_VACTIVE + PPU.RP2C02_VBLANK
PPU.RP2C02_HVSYNCBOOT = PPU.RP2C02_VACTIVE * PPU.RP2C02_HSYNC + PPU.RP2C02_CC * 312
PPU.RP2C02_HVINT = PPU.RP2C02_VINT * PPU.RP2C02_HSYNC
PPU.RP2C02_HVSYNC_0 = PPU.RP2C02_VSYNC * PPU.RP2C02_HSYNC
PPU.RP2C02_HVSYNC_1 = PPU.RP2C02_VSYNC * PPU.RP2C02_HSYNC - PPU.RP2C02_CC

-- special scanlines
PPU.SCANLINE_HDUMMY = -1 -- pre-render scanline
PPU.SCANLINE_VBLANK = 240 -- post-render scanline

-- special horizontal clocks
PPU.HCLOCK_DUMMY = 341
PPU.HCLOCK_VBLANK_0 = 681
PPU.HCLOCK_VBLANK_1 = 682
PPU.HCLOCK_VBLANK_2 = 684
PPU.HCLOCK_BOOT = 685
PPU.DUMMY_FRAME = {PPU.RP2C02_HVINT / PPU.RP2C02_CC - PPU.HCLOCK_DUMMY, PPU.RP2C02_HVINT, PPU.RP2C02_HVSYNC_0}
PPU.BOOT_FRAME = {
    PPU.RP2C02_HVSYNCBOOT / PPU.RP2C02_CC - PPU.HCLOCK_BOOT,
    PPU.RP2C02_HVSYNCBOOT,
    PPU.RP2C02_HVSYNCBOOT
}

-- constants related to OAM (sprite)
PPU.SP_PIXEL_POSITIONS = {
    {3, 7, 2, 6, 1, 5, 0, 4}, -- normal
    {4, 0, 5, 1, 6, 2, 7, 3} -- flip
}

-- A look-up table mapping: (two pattern bytes * attr) -> eight pixels
--   TILE_LUT[attr][high_byte * 0x100 + low_byte] = [pixels] * 8
PPU.TILE_LUT =
    map(
    {0x0, 0x4, 0x8, 0xc},
    function(attr)
        return UTILS.transpose(
            map(
                range(0, 7),
                function(j)
                    return map(
                        range(0, 0x10000),
                        function(i)
                            local clr = nthBitIsSetInt(i, 15 - j) * 2 + nthBitIsSetInt(i, 7 - j)
                            return clr ~= 0 and bor(attr, clr) or 0
                        end
                    )
                end
            )
        )
    end
)
local TILE_LUT,
    HCLOCK_BOOT,
    HCLOCK_DUMMY,
    BOOT_FRAME,
    DUMMY_FRAME,
    FOREVER_CLOCK,
    SCANLINE_VBLANK,
    SCANLINE_HDUMMY,
    RP2C02_CC =
    PPU.TILE_LUT,
    PPU.HCLOCK_BOOT,
    PPU.HCLOCK_DUMMY,
    PPU.BOOT_FRAME,
    PPU.DUMMY_FRAME,
    CPU.FOREVER_CLOCK,
    PPU.SCANLINE_VBLANK,
    PPU.SCANLINE_HDUMMY,
    PPU.RP2C02_CC
--------------------------------------------------------------------------------------------------------------------
-- initialization
local any_show
function PPU:initialize(conf, cpu, palette)
    self.conf = conf
    self.cpu = cpu
    self.palette = palette

    self.nmt_mem = {[0] = UTILS.fill({}, 0xff, 0x400, 1, -1), [1] = UTILS.fill({}, 0xff, 0x400, 1, -1)}
    --[  [0xff] * 0x400, [0xff] * 0x400]
    self.nmt_ref =
        map(
        {[0] = 0, [1] = 1, [2] = 0, [3] = 1},
        function(i)
            return self.nmt_mem[i]
        end
    )

    --self.output_pixels = {}
    self.output_pixels = UTILS.fill({}, self.palette[16], PPU.SCREEN_HEIGHT * PPU.SCREEN_WIDTH)

    self.output_pixels_size = 0
    self.output_color = UTILS.fill({}, {self.palette[1]}, 0x20) -- palette size is 0x20
    self:reset(true)
    self:setup_lut()
end

function PPU:reset(mapping)
    if mapping or true then
        -- setup mapped memory
        self.cpu:add_mappings(
            range(0x2000, 0x3fff, 8),
            UTILS.bind(self.peek_2xxx, self),
            UTILS.bind(self.poke_2000, self)
        )
        self.cpu:add_mappings(
            range(0x2001, 0x3fff, 8),
            UTILS.bind(self.peek_2xxx, self),
            UTILS.bind(self.poke_2001, self)
        )
        self.cpu:add_mappings(
            range(0x2002, 0x3fff, 8),
            UTILS.bind(self.peek_2002, self),
            UTILS.bind(self.poke_2xxx, self)
        )
        self.cpu:add_mappings(
            range(0x2003, 0x3fff, 8),
            UTILS.bind(self.peek_2xxx, self),
            UTILS.bind(self.poke_2003, self)
        )
        self.cpu:add_mappings(
            range(0x2004, 0x3fff, 8),
            UTILS.bind(self.peek_2004, self),
            UTILS.bind(self.poke_2004, self)
        )
        self.cpu:add_mappings(
            range(0x2005, 0x3fff, 8),
            UTILS.bind(self.peek_2xxx, self),
            UTILS.bind(self.poke_2005, self)
        )
        self.cpu:add_mappings(
            range(0x2006, 0x3fff, 8),
            UTILS.bind(self.peek_2xxx, self),
            UTILS.bind(self.poke_2006, self)
        )
        self.cpu:add_mappings(
            range(0x2007, 0x3fff, 8),
            UTILS.bind(self.peek_2007, self),
            UTILS.bind(self.poke_2007, self)
        )
        self.cpu:add_mappings(0x3000, UTILS.bind(self.peek_3000, self), UTILS.bind(self.poke_2000, self))
        self.cpu:add_mappings(0x4014, UTILS.bind(self.peek_4014, self), UTILS.bind(self.poke_4014, self))
    end

    self.palette_ram = {
        0x3f,
        0x01,
        0x00,
        0x01,
        0x00,
        0x02,
        0x02,
        0x0d,
        0x08,
        0x10,
        0x08,
        0x24,
        0x00,
        0x00,
        0x04,
        0x2c,
        0x09,
        0x01,
        0x34,
        0x03,
        0x00,
        0x04,
        0x00,
        0x14,
        0x08,
        0x3a,
        0x00,
        0x02,
        0x00,
        0x20,
        0x2c,
        0x08
    }
    self.coloring = 0x3f -- not monochrome
    self.emphasis = 0
    self:update_output_color()

    -- clock management
    self.hclk = HCLOCK_BOOT
    self.vclk = 0
    self.hclk_target = FOREVER_CLOCK

    -- CPU-PPU interface
    self.io_latch = 0
    self.io_buffer = 0xe8 -- garbage

    self.regs_oam = 0

    -- misc
    self.vram_addr_inc = 1 -- 1 or 32
    self.need_nmi = false
    self.pattern_end = 0x0ff0
    self.any_show = false -- == self.bg_show or self.sp_show
    self.sp_overflow = false
    self.sp_zero_hit = false
    self.vblanking = false
    self.vblank = false

    -- PPU-nametable interface
    self.io_addr = 0
    self.io_pattern = 0

    self.a12_monitor = nil
    self.a12_state = nil

    -- the current scanline
    self.odd_frame = false
    self.scanline = SCANLINE_VBLANK

    -- scroll state
    self.scroll_toggle = false
    self.scroll_latch = 0
    self.scroll_xfine = 0
    self.scroll_addr_0_4 = 0
    self.scroll_addr_5_14 = 0
    self.name_io_addr = 0x2000 -- == (self.scroll_addr_0_4 | self.scroll_addr_5_14) & 0x0fff | 0x2000

    ------ BG-sprite state
    self.bg_enabled = false
    self.bg_show = false
    self.bg_show_edge = false
    self.bg_pixels = UTILS.fill({}, 0, 16)
    self.bg_pixels_idx = 0
    self.bg_pattern_base = 0 -- == 0 or 0x1000
    self.bg_pattern_base_15 = 0 -- == self.bg_pattern_base[12] << 15
    self.bg_pattern = 0
    self.bg_pattern_lut = TILE_LUT[1]
    self.bg_pattern_lut_fetched = TILE_LUT[1]
    -- invariant:
    --   self.bg_pattern_lut_fetched == TILE_LUT[
    --     self.nmt_ref[self.io_addr >> 10 & 3][self.io_addr & 0x03ff] >>
    --       ((self.scroll_addr_0_4 & 0x2) | (self.scroll_addr_5_14[6] * 0x4)) & 3
    --   ]

    ------ OAM-sprite state
    self.sp_enabled = false
    self.sp_active = false -- == self.sp_visible and self.sp_enabled
    self.batch_render_eight_pixels = self.batch_render_eight_pixels_bg
    self.sp_show = false
    self.sp_show_edge = false

    -- for CPU-PPU interface
    self.sp_base = 0
    self.sp_height = 8

    -- for OAM fetcher
    self.evaluate_sprites_odd_phase = self.evaluate_sprites_odd_phase_0
    self.sp_ram = UTILS.fill({}, 0xff, 0x100) -- ram size is 0x100, 0xff is a OAM garbage
    self.sp_index = 0
    self.sp_addr = 0
    self.sp_latch = 0

    -- for internal state
    -- 8 sprites per line are allowed in standard NES, but a user may remove this limit.
    self.sp_limit = (self.conf.sprite_limit and 8 or 32) * 4
    self.sp_buffer = UTILS.fill({}, 0, self.sp_limit)
    self.sp_buffered = 0
    self.sp_visible = false
    self.sp_map = {} -- [[behind?, zero?, color]]
    self.sp_map_buffer =
        map(
        range(0, 264),
        function()
            return {false, false, 0}
        end
    ) -- preallocation for self.sp_map
    self.sp_zero_in_line = false
end

function PPU:update_output_color()
    for i = 1, 0x20 do
        local idx = bor(band(self.palette_ram[i], self.coloring), self.emphasis)
        self.output_color[i] = self.palette[idx]
    end
end

function PPU:setup_lut()
    self.lut_update = {}

    self.name_lut =
        map(
        range(0, 0xffff),
        function(i)
            local nmt_bank = self.nmt_ref[band(rshift(i, 10), 3)]
            local nmt_idx = band(i, 0x03ff)
            local fixed = bor(band(rshift(i, 12), 7), lshift(nthBitIsSetInt(i, 15), 12))
            if not self.lut_update[nmt_bank] then
                self.lut_update[nmt_bank] = {}
            end
            if not self.lut_update[nmt_bank][nmt_idx] then
                self.lut_update[nmt_bank][nmt_idx] = {nil, nil}
            end
            local upd = self.lut_update[nmt_bank][nmt_idx]
            if not upd[1] then
                upd[1] = {}
            end
            upd = upd[1]
            upd[#upd + 1] = {i, fixed}
            return bor(lshift(nmt_bank[nmt_idx], 4), fixed)
        end
    )

    local entries = {}
    self.attr_lut =
        map(
        range(0, 0x7fff),
        function(i)
            local io_addr = bor(0x23c0, band(i, 0x0c00), band(rshift(i, 4), 0x0038), band(rshift(i, 2), 0x0007))
            local nmt_bank = self.nmt_ref[band(rshift(io_addr, 10), 3)]
            local nmt_idx = band(io_addr, 0x03ff)
            local attr_shift = bor(band(i, 2), band(rshift(i, 4), 4))
            local key = tostring(io_addr) .. "-" .. tostring(attr_shift)
            if not entries[key] then
                entries[key] = {
                    io_addr,
                    TILE_LUT[1 + band(rshift(nmt_bank[nmt_idx], attr_shift), 3)],
                    attr_shift
                }
            end
            if not self.lut_update[nmt_bank] then
                self.lut_update[nmt_bank] = {}
            end
            if not self.lut_update[nmt_bank][nmt_idx] then
                self.lut_update[nmt_bank][nmt_idx] = {nil, nil}
            end
            local upd = self.lut_update[nmt_bank][nmt_idx]
            if not upd[2] then
                upd[2] = {}
            end
            upd = upd[2]
            upd[#upd + 1] = entries[key]
            return entries[key]
        end
    )
    return entries
end

--------------------------------------------------------------------------------------------------------------------
-- other APIs

function PPU:set_chr_mem(mem, writable)
    self.chr_mem = mem
    self.chr_mem_writable = writable
end

PPU.NMT_TABLE = {
    horizontal = {0, 0, 1, 1},
    vertical = {0, 1, 0, 1},
    four_screen = {0, 1, 2, 3},
    first = {0, 0, 0, 0},
    second = {1, 1, 1, 1}
}
function PPU:nametables(mode)
    self:update(RP2C02_CC)
    local idxs = PPU.NMT_TABLE[mode]
    if
        UTILS.all(
            range(0, 3),
            function(i)
                return self.nmt_ref[i] == self.nmt_mem[idxs[i + 1]]
            end
        )
     then
        return
    end
    self.nmt_ref[0] = self.nmt_mem[idxs[1]]
    self.nmt_ref[1] = self.nmt_mem[idxs[2]]
    self.nmt_ref[2] = self.nmt_mem[idxs[3]]
    self.nmt_ref[3] = self.nmt_mem[idxs[4]]
    self:setup_lut()
end

function PPU:update(data_setup)
    --print "ppu update"
    --print(debug.traceback())
    local ticks = (self.cpu):update()
    --print(data_setup)
    --print(ticks)
    --print(self.hclk_target)
    return self:sync(ticks + data_setup)
end

function PPU:setup_frame()
    local clr = self.palette[16]
    local output = self.output_pixels
    for i = 1, PPU.SCREEN_HEIGHT * PPU.SCREEN_WIDTH do
        output[i] = clr
    end
    self.output_pixels_size = 0
    self.odd_frame = not self.odd_frame
    local t = self.hclk == HCLOCK_DUMMY and DUMMY_FRAME or BOOT_FRAME
    self.vclk, self.hclk_target = t[1], t[2]
    self.cpu:set_next_frame_clock(t[3])
end

function PPU:vsync()
    if self.hclk_target ~= FOREVER_CLOCK then
        self.hclk_target = FOREVER_CLOCK
        self:run()
    end
end

function PPU:monitor_a12_rising_edge(monitor)
    self.a12_monitor = monitor
    self.update_address_line = self.do_update_address_line
    self.update_scroll_address_line = update_scroll_address_line_monitor_a12
end

--------------------------------------------------------------------------------------------------------------------
-- helpers

function PPU:update_vram_addr()
    if self.vram_addr_inc == 32 then
        if self:isactive() then
            if band(self.scroll_addr_5_14, 0x7000) == 0x7000 then
                self.scroll_addr_5_14 = band(self.scroll_addr_5_14, 0x0fff)
                local x = band(self.scroll_addr_5_14, 0x03e0)
                if x == 0x03a0 then
                    self.scroll_addr_5_14 = bxor(self.scroll_addr_5_14, 0x0800)
                elseif x == 0x03e0 then
                    self.scroll_addr_5_14 = band(self.scroll_addr_5_14, 0x7c00)
                else
                    self.scroll_addr_5_14 = self.scroll_addr_5_14 + 0x20
                end
            else
                self.scroll_addr_5_14 = self.scroll_addr_5_14 + 0x1000
            end
        else
            self.scroll_addr_5_14 = self.scroll_addr_5_14 + 0x20
        end
    elseif self.scroll_addr_0_4 < 0x1f then
        self.scroll_addr_0_4 = self.scroll_addr_0_4 + 1
    else
        self.scroll_addr_0_4 = 0
        self.scroll_addr_5_14 = self.scroll_addr_5_14 + 0x20
    end
    return self:update_scroll_address_line()
end

function PPU:update_scroll_address_line()
    self.name_io_addr = bor(band(bor(self.scroll_addr_0_4, self.scroll_addr_5_14), 0x0fff), 0x2000)
end

function PPU:update_scroll_address_line_monitor_a12()
    self.name_io_addr = bor(band(bor(self.scroll_addr_0_4, self.scroll_addr_5_14), 0x0fff), 0x2000)
    if self.a12_monitor then
        local a12_state = band(self.scroll_addr_5_14, 0x3000) == 0x1000
        if not self.a12_state and a12_state then
            self.a12_monitor.a12_signaled(self.cpu:current_clock())
        end
        self.a12_state = a12_state
    end
end

function PPU:isactive()
    return self.scanline ~= SCANLINE_VBLANK and self.any_show
end

function PPU:sync(elapsed)
    if not (self.hclk_target < elapsed) then
        return
    end
    self.hclk_target = elapsed / RP2C02_CC - self.vclk
    return self:run()
end

function PPU:make_sure_invariants()
    local scroll_addr_5_14 = self.scroll_addr_5_14
    self.name_io_addr = bor(band(bor(self.scroll_addr_0_4, scroll_addr_5_14), 0x0fff), 0x2000)
    local a = self.nmt_ref[band(rshift(self.io_addr, 10), 3)][band(self.io_addr, 0x03ff)]
    local b = bor(band(self.scroll_addr_0_4, 0x2), (nthBitIsSetInt(scroll_addr_5_14, 6) * 0x4))
    local idx = 1 + band(rshift(a, b), 3)
    self.bg_pattern_lut_fetched = TILE_LUT[idx]
end

function PPU:io_latch_mask(data)
    if self:isactive() then
        return 0xff
    elseif band(self.regs_oam, 0x03) == 0x02 then
        return band(data, 0xe3)
    else
        return data
    end
end

--------------------------------------------------------------------------------------------------------------------
-- mapped memory handlers

-- PPUCTRL
function PPU:poke_2000(_addr, data)
    self:update(RP2C02_CC)
    local need_nmi_old = self.need_nmi

    self.scroll_latch = bor(band(self.scroll_latch, 0x73ff), lshift(band(data, 0x03), 10))
    self.vram_addr_inc = nthBitIsSetInt(data, 2) == 1 and 32 or 1
    self.sp_base = nthBitIsSetInt(data, 3) == 1 and 0x1000 or 0x0000
    self.bg_pattern_base = (nthBitIsSetInt(data, 4) == 1) and 0x1000 or 0x0000
    self.sp_height = nthBitIsSetInt(data, 5) == 1 and 16 or 8
    self.need_nmi = nthBitIsSetInt(data, 7) == 1

    self.io_latch = data
    self.pattern_end = (self.sp_base ~= 0 or self.sp_height == 16) and 0x1ff0 or 0x0ff0
    self.bg_pattern_base_15 = lshift(nthBitIsSetInt(self.bg_pattern_base, 12), 15)

    if self.need_nmi and self.vblank and not need_nmi_old then
        local clock = self.cpu:current_clock() + RP2C02_CC
        if clock < PPU.RP2C02_HVINT then
            self.cpu:do_nmi(clock)
        end
    end
end

-- PPUMASK
function PPU:poke_2001(_addr, data)
    self:update(RP2C02_CC)
    local bg_show_old, bg_show_edge_old = self.bg_show, self.bg_show_edge
    local sp_show_old, sp_show_edge_old = self.sp_show, self.sp_show_edge
    local any_show_old = self.any_show
    local coloring_old, emphasis_old = self.coloring, self.emphasis

    self.bg_show = nthBitIsSetInt(data, 3) == 1
    self.bg_show_edge = nthBitIsSetInt(data, 1) == 1 and self.bg_show
    self.sp_show = nthBitIsSetInt(data, 4) == 1
    self.sp_show_edge = nthBitIsSetInt(data, 2) == 1 and self.sp_show
    self.any_show = self.bg_show or self.sp_show
    self.coloring = nthBitIsSetInt(data, 0) == 1 and 0x30 or 0x3f -- 0x30: monochrome
    self.emphasis = lshift(band(data, 0xe0), 1)

    self.io_latch = data

    if
        bg_show_old ~= self.bg_show or bg_show_edge_old ~= self.bg_show_edge or sp_show_old ~= self.sp_show or
            sp_show_edge_old ~= self.sp_show_edge
     then
        if self.hclk < 8 or self.hclk >= 248 then
            self:update_enabled_flags_edge()
        else
            self:update_enabled_flags()
        end
        if any_show_old and not self.any_show then
            self:update_scroll_address_line()
        end
    end

    if coloring_old ~= self.coloring or emphasis_old ~= self.emphasis then
        self:update_output_color()
    end
end

-- PPUSTATUS
function PPU:peek_2002(_addr)
    self:update(RP2C02_CC)
    local v = band(self.io_latch, 0x1f)
    if self.vblank then
        v = bor(v, 0x80)
    end
    if self.sp_zero_hit then
        v = bor(v, 0x40)
    end
    if self.sp_overflow then
        v = bor(v, 0x20)
    end
    self.io_latch = v
    self.scroll_toggle = false
    self.vblanking = false
    self.vblank = false
    return self.io_latch
end
-- OAMADDR
function PPU:poke_2003(_addr, data)
    self:update(RP2C02_CC)
    self.regs_oam = data
    self.io_latch = data
end

-- OAMDATA (write)
function PPU:poke_2004(_addr, data)
    self:update(RP2C02_CC)
    self.sp_ram[self.regs_oam + 1] = self:io_latch_mask(data)
    self.io_latch = self.sp_ram[self.regs_oam + 1]
    self.regs_oam = band(self.regs_oam + 1, 0xff)
end

-- OAMDATA (read)
function PPU:peek_2004(_addr)
    if
        not self.any_show or
            self.cpu:current_clock() - (self.cpu:next_frame_clock() - (341 * 241) * RP2C02_CC) >=
                (341 * 240) * RP2C02_CC
     then
        self.io_latch = self.sp_ram[self.regs_oam + 1]
    else
        self:update(RP2C02_CC)
        self.io_latch = self.sp_latch
    end
end

-- PPUSCROLL
function PPU:poke_2005(_addr, data)
    self:update(RP2C02_CC)
    self.io_latch = data
    self.scroll_toggle = not self.scroll_toggle
    if self.scroll_toggle then
        self.scroll_latch = bor(band(self.scroll_latch, 0x7fe0), rshift(data, 3))
        local xfine = 8 - band(data, 0x7)
        self.bg_pixels_idx = rotatePositiveIdx(self.bg_pixels, self.bg_pixels_idx + self.scroll_xfine - xfine)
        self.scroll_xfine = xfine
    else
        self.scroll_latch = bor(band(self.scroll_latch, 0x0c1f), band(bor(lshift(data, 2), lshift(data, 12)), 0x73e0))
    end
end

-- PPUADDR
function PPU:poke_2006(_addr, data)
    self:update(RP2C02_CC)
    self.io_latch = data
    self.scroll_toggle = not self.scroll_toggle
    if self.scroll_toggle then
        self.scroll_latch = bor(band(self.scroll_latch, 0x00ff), lshift(band(data, 0x3f), 8))
    else
        self.scroll_latch = bor(band(self.scroll_latch, 0x7f00), data)
        self.scroll_addr_0_4 = band(self.scroll_latch, 0x001f)
        self.scroll_addr_5_14 = band(self.scroll_latch, 0x7fe0)
        self:update_scroll_address_line()
    end
end

-- PPUDATA (write)
function PPU:poke_2007(_addr, data)
    self:update(RP2C02_CC * 4)
    local addr = bor(self.scroll_addr_0_4, self.scroll_addr_5_14)
    self:update_vram_addr()
    self.io_latch = data
    if band(addr, 0x3f00) == 0x3f00 then
        addr = band(addr, 0x1f)
        local final = self.palette[1 + bor(band(data, self.coloring), self.emphasis)]
        self.palette_ram[addr + 1] = data
        self.output_color[addr + 1] = final
        if band(addr, 3) == 0 then
            local addr = bxor(addr, 0x10) + 1
            self.palette_ram[addr] = data
            self.output_color[addr] = final
        end
        self.output_bg_color = band(self.palette_ram[1], 0x3f)
    else
        addr = band(addr, 0x3fff)
        if addr >= 0x2000 then
            local nmt_bank = self.nmt_ref[band(rshift(addr, 10), 0x3)]
            local nmt_idx = band(addr, 0x03ff)
            if nmt_bank[nmt_idx] ~= data then
                nmt_bank[nmt_idx] = data
                local t = self.lut_update[nmt_bank][nmt_idx]
                local name_lut_update, attr_lut_update = t[1], t[2]
                if name_lut_update then
                    for i = 1, #name_lut_update do
                        local t = name_lut_update[i]
                        self.name_lut[t[1]] = bor(lshift(data, 4), t[2])
                    end
                end
                if attr_lut_update then
                    for i = 1, #attr_lut_update do
                        local a = attr_lut_update[i]
                        a[2] = TILE_LUT[1 + band(rshift(data, a[3]), 3)]
                    end
                end
            end
        elseif self.chr_mem_writable then
            self.chr_mem[addr + 1] = data
        end
    end
end

-- PPUDATA (read)
function PPU:peek_2007(_addr)
    self:update(RP2C02_CC)
    local addr = band(bor(self.scroll_addr_0_4, self.scroll_addr_5_14), 0x3fff)
    self:update_vram_addr()
    self.io_latch =
        band(addr, 0x3f00) ~= 0x3f00 and self.io_buffer or band(self.palette_ram[band(addr, 0x1f) + 1], self.coloring)
    self.io_buffer =
        addr >= 0x2000 and self.nmt_ref[band(rshift(addr, 10), 0x3)][band(addr, 0x3ff)] or self.chr_mem[addr + 1]
    return self.io_latch
end

function PPU:poke_2xxx(_addr, data)
    self.io_latch = data
end

function PPU:peek_2xxx(_addr)
    return self.io_latch
end

function PPU:peek_3000(_addr)
    self:update(RP2C02_CC)
    return self.io_latch
end

-- OAMDMA
function PPU:poke_4014(_addr, data) -- DMA
    if self.cpu:odd_clock() then
        self.cpu:steal_clocks(CPU.CLK[1])
    end
    self:update(RP2C02_CC)
    self.cpu:steal_clocks(CPU.CLK[1])
    data = lshift(data, 8)
    if
        self.regs_oam == 0 and data < 0x2000 and
            ((not self.any_show) or self.cpu:current_clock() <= PPU.RP2C02_HVINT - CPU.CLK[1] * 512)
     then
        self.cpu:steal_clocks(CPU.CLK[1] * 512)
        self.cpu:sprite_dma(band(data, 0x7ff), self.sp_ram)
        self.io_latch = self.sp_ram[0xff + 1]
    else
        repeat
            self.io_latch = self.cpu:fetch(data)
            data = data + 1
            self.cpu:steal_clocks(CPU.CLK[1])
            self:update(RP2C02_CC)
            self.cpu:steal_clocks(CPU.CLK[1])
            self.io_latch = self:io_latch_mask(self.io_latch)
            self.sp_ram[self.regs_oam + 1] = self.io_latch
            self.regs_oam = band(self.regs_oam + 1, 0xff)
        until not (band(data, 0xff) ~= 0)
    end
end

function PPU:peek_4014(_addr)
    return 0x40
end

------------------------------------------------------------------------------------------------------------------------------------------------------
-- helper methods for PPU--run

function PPU:open_pattern(exp)
    if not self.any_show then
        return
    end
    self.io_addr = exp
    return self:update_address_line()
end

function PPU:open_sprite(buffer_idx)
    local sp_buffer = self.sp_buffer
    local flip_v = nthBitIsSetInt(sp_buffer[buffer_idx + 3], 7) -- OAM byte2 bit7: "Flip vertically" flag
    local tmp = bxor((self.scanline - sp_buffer[buffer_idx + 1]), (flip_v * 0xf))
    local byte1 = sp_buffer[buffer_idx + 2]
    local addr =
        self.sp_height == 16 and
        bor(lshift(band(byte1, 0x01), 12), lshift(band(byte1, 0xfe), 4), (nthBitIsSetInt(tmp, 3) * 0x10)) or
        bor(self.sp_base, lshift(byte1, 4))
    return bor(addr, band(tmp, 7))
end

function PPU:load_sprite(pat0, pat1, buffer_idx)
    local sp_buffer = self.sp_buffer
    local byte2 = sp_buffer[buffer_idx + 3]
    local pos = PPU.SP_PIXEL_POSITIONS[1 + nthBitIsSetInt(byte2, 6)] -- OAM byte2 bit6: "Flip horizontally" flag
    local pat =
        bor(
        band(rshift(pat0, 1), 0x55),
        band(pat1, 0xaa),
        lshift(bor(band(pat0, 0x55), band(lshift(pat1, 1), 0xaa)), 8)
    )
    local x_base = sp_buffer[buffer_idx + 4]
    local palette_base = 0x10 + lshift(band(byte2, 3), 2) -- OAM byte2 bit0-1: Palette
    if not self.sp_visible then
        self.sp_visible = true
        self.sp_map = {}
    end
    for i = 1, 8 do
        local x = x_base + i
        local clr = band(rshift(pat, (pos[i] * 2)), 3)
        if not (self.sp_map[x] or clr == 0) then
            local sprite = self.sp_map_buffer[x]
            self.sp_map[x] = sprite
            -- sprite[0]: behind flag, sprite[1]: zero hit flag, sprite[2]: color
            sprite[0] = nthBitIsSetInt(byte2, 5) == 1 -- OAM byte2 bit5: "Behind background" flag
            sprite[1] = buffer_idx == 0 and self.sp_zero_in_line
            sprite[2] = palette_base + clr
        end
    end
    local sp_enabled = self.sp_enabled
    self.sp_active = sp_enabled
    self.batch_render_eight_pixels =
        sp_enabled and self.batch_render_eight_pixels_sp or self.batch_render_eight_pixels_bg
end

function PPU:update_address_line()
end

function PPU:do_update_address_line()
    if self.a12_monitor then
        local a12_state = self.io_addr[12] == 1
        if not self.a12_state and a12_state then
            self.a12_monitor.a12_signaled((self.vclk + self.hclk) * RP2C02_CC)
        end
        self.a12_state = a12_state
    end
end

------------------------------------------------------------------------------------------------------------------------------------------------------
-- actions for PPU--run

function PPU:open_name()
    if not self.any_show then
        return
    end
    self.io_addr = self.name_io_addr
    return self:update_address_line()
end

function PPU:fetch_name()
    if not self.any_show then
        return
    end
    self.io_pattern = self.name_lut[self.scroll_addr_0_4 + self.scroll_addr_5_14 + self.bg_pattern_base_15]
end

function PPU:open_attr()
    if not self.any_show then
        return
    end
    local t = self.attr_lut[bit.bor(self.scroll_addr_0_4, self.scroll_addr_5_14)]
    self.io_addr, self.bg_pattern_lut_fetched = t[1], t[2]
    return self:update_address_line()
end

function PPU:fetch_attr()
    if not self.any_show then
        return
    end
    self.bg_pattern_lut = self.bg_pattern_lut_fetched
    -- raise unless self.bg_pattern_lut_fetched ==
    --   self.nmt_ref[self.io_addr >> 10 & 3][self.io_addr & 0x03ff] >>
    --     ((self.scroll_addr_0_4 & 0x2) | (self.scroll_addr_5_14[6] * 0x4)) & 3
end

function PPU:fetch_bg_pattern_0()
    if not self.any_show then
        return
    end
    self.bg_pattern = self.chr_mem[1 + band(self.io_addr, 0x1fff)]
end

function PPU:fetch_bg_pattern_1()
    if not self.any_show then
        return
    end
    self.bg_pattern = bor(self.bg_pattern, self.chr_mem[1 + band(self.io_addr, 0x1fff)] * 0x100)
end

function PPU:scroll_clock_x()
    if not self.any_show then
        return
    end
    if self.scroll_addr_0_4 < 0x001f then
        self.scroll_addr_0_4 = self.scroll_addr_0_4 + 1
        self.name_io_addr = self.name_io_addr + 1 -- make cache consistent
    else
        self.scroll_addr_0_4 = 0
        self.scroll_addr_5_14 = bxor(self.scroll_addr_5_14, 0x0400)
        self.name_io_addr = bxor(self.name_io_addr, 0x041f) -- make cache consistent
    end
end

function PPU:scroll_reset_x()
    if not self.any_show then
        return
    end
    self.scroll_addr_0_4 = band(self.scroll_latch, 0x001f)
    self.scroll_addr_5_14 = bor(band(self.scroll_addr_5_14, 0x7be0), band(self.scroll_latch, 0x0400))
    self.name_io_addr = bor(band(bor(self.scroll_addr_0_4, self.scroll_addr_5_14), 0x0fff), 0x2000) -- make cache consistent
end

function PPU:scroll_clock_y()
    if not self.any_show then
        return
    end
    if band(self.scroll_addr_5_14, 0x7000) ~= 0x7000 then
        self.scroll_addr_5_14 = self.scroll_addr_5_14 + 0x1000
    else
        local mask = band(self.scroll_addr_5_14, 0x03e0)
        if mask == 0x03a0 then
            self.scroll_addr_5_14 = bxor(self.scroll_addr_5_14, 0x0800)
            self.scroll_addr_5_14 = band(self.scroll_addr_5_14, 0x0c00)
        elseif mask == 0x03e0 then
            self.scroll_addr_5_14 = band(self.scroll_addr_5_14, 0x0c00)
        else
            self.scroll_addr_5_14 = band(self.scroll_addr_5_14, 0x0fe0) + 32
        end
    end

    self.name_io_addr = bor(band(bor(self.scroll_addr_0_4, self.scroll_addr_5_14), 0x0fff), 0x2000) -- make cache consistent
end

function PPU:preload_tiles()
    if not self.any_show then
        return
    end
    local patt = self.bg_pattern_lut[self.bg_pattern]
    local length = #self.bg_pixels
    local idx = self.scroll_xfine + 1
    for i = 0, 7 do --8 do
        self:set_bg_pxs(i + idx, patt[i], length)
    end
end

function PPU:index_bg_pxs(idx, size)
    return self.bg_pixels[rotatePositiveIdx(self.bg_pixels, self.bg_pixels_idx + idx, size)]
end

function PPU:set_bg_pxs(idx, v, size)
    self.bg_pixels[rotatePositiveIdx(self.bg_pixels, self.bg_pixels_idx + idx, size)] = v
end

function PPU:load_tiles()
    local length = #self.bg_pixels
    self.bg_pixels_idx = rotatePositiveIdx(self.bg_pixels, self.bg_pixels_idx + 8, length)
    local patt = self.bg_pattern_lut[self.bg_pattern]
    local idx = self.scroll_xfine + 1
    for i = 0, 7 do --8 do
        self:set_bg_pxs(i + idx, patt[i], length)
    end
end

function PPU:evaluate_sprites_even()
    self.sp_latch = self.sp_ram[self.sp_addr + 1]
end

function PPU:evaluate_sprites_odd()
    if not self.any_show then
        return
    end
    self:evaluate_sprites_odd_phase()
end

function PPU:evaluate_sprites_odd_phase_0()
end

function PPU:evaluate_sprites_odd_phase_1()
    self.sp_index = self.sp_index + 1
    if self.sp_latch <= self.scanline and self.scanline < self.sp_latch + self.sp_height then
        --print "phase 2"
        self.sp_addr = self.sp_addr + 1
        self.evaluate_sprites_odd_phase = self.evaluate_sprites_odd_phase_2
        self.sp_buffer[self.sp_buffered + 1] = self.sp_latch
    elseif self.sp_index == 64 then
        self.sp_addr = 0
        self.evaluate_sprites_odd_phase = self.evaluate_sprites_odd_phase_9
    elseif self.sp_index == 2 then
        self.sp_addr = 8
    else
        self.sp_addr = self.sp_addr + 4
    end
end

function PPU:evaluate_sprites_odd_phase_2()
    self.sp_addr = self.sp_addr + 1
    self.evaluate_sprites_odd_phase = self.evaluate_sprites_odd_phase_3
    self.sp_buffer[self.sp_buffered + 2] = self.sp_latch
end

function PPU:evaluate_sprites_odd_phase_3()
    self.sp_addr = self.sp_addr + 1
    self.evaluate_sprites_odd_phase = self.evaluate_sprites_odd_phase_4
    self.sp_buffer[self.sp_buffered + 3] = self.sp_latch
end

function PPU:evaluate_sprites_odd_phase_4()
    self.sp_buffer[self.sp_buffered + 4] = self.sp_latch
    self.sp_buffered = self.sp_buffered + 4
    --print "evaluate_sprites_odd_phase_4"
    --print(self.sp_buffered)
    if self.sp_index ~= 64 then
        if self.sp_buffered ~= self.sp_limit then
            self.evaluate_sprites_odd_phase = self.evaluate_sprites_odd_phase_1
        else
            self.evaluate_sprites_odd_phase = self.evaluate_sprites_odd_phase_5
        end
        if self.sp_index ~= 2 then
            self.sp_addr = self.sp_addr + 1
            if not self.sp_zero_in_line then
                self.sp_zero_in_line = self.sp_index == 1
            end
        else
            self.sp_addr = 8
        end
    else
        self.sp_addr = 0
        self.evaluate_sprites_odd_phase = self.evaluate_sprites_odd_phase_9
    end
end

function PPU:evaluate_sprites_odd_phase_5()
    if self.sp_latch <= self.scanline and self.scanline < self.sp_latch + self.sp_height then
        self.evaluate_sprites_odd_phase = self.evaluate_sprites_odd_phase_6
        self.sp_addr = band(self.sp_addr + 1, 0xff)
        self.sp_overflow = true
    else
        self.sp_addr = band((self.sp_addr + 4), 0xfc) + band((self.sp_addr + 1), 3)
        if self.sp_addr <= 5 then
            self.evaluate_sprites_odd_phase = self.evaluate_sprites_odd_phase_9
            self.sp_addr = band(self.sp_addr, 0xfc)
        end
    end
end

function PPU:evaluate_sprites_odd_phase_6()
    self.evaluate_sprites_odd_phase = self.evaluate_sprites_odd_phase_7
    self.sp_addr = band(self.sp_addr + 1, 0xff)
end

function PPU:evaluate_sprites_odd_phase_7()
    self.evaluate_sprites_odd_phase = self.evaluate_sprites_odd_phase_8
    self.sp_addr = band(self.sp_addr + 1, 0xff)
end

function PPU:evaluate_sprites_odd_phase_8()
    self.evaluate_sprites_odd_phase = self.evaluate_sprites_odd_phase_9
    self.sp_addr = band(self.sp_addr + 1, 0xff)
    if band(self.sp_addr, 3) == 3 then
        self.sp_addr = self.sp_addr + 1
    end
    self.sp_addr = band(self.sp_addr, 0xfc)
end

function PPU:evaluate_sprites_odd_phase_9()
    self.sp_addr = band(self.sp_addr + 4, 0xff)
end

function PPU:load_extended_sprites()
    if not self.any_show then
        return
    end
    if 32 < self.sp_buffered then
        local buffer_idx = 32
        repeat
            local addr = self:open_sprite(buffer_idx)
            local pat0 = self.chr_mem[1 + addr]
            local pat1 = self.chr_mem[1 + bor(addr, 8)]
            if pat0 ~= 0 or pat1 ~= 0 then
                self:load_sprite(pat0, pat1, buffer_idx)
            end
            buffer_idx = buffer_idx + 4
        until not (buffer_idx ~= self.sp_buffered)
    end
end

function PPU:render_pixel()
    self:set_bg_pxs(self.hclk % 8 + 1, 0)
    local px = self.output_color[band(self.scroll_addr_5_14, 0x3f00) == 0x3f00 and self.scroll_addr_0_4 or 0]
    if px then
        self.output_pixels_size = self.output_pixels_size + 1
        self.output_pixels[self.output_pixels_size] = px
    end
end

function PPU:batch_render_eight_pixels_sp()
    local pixel
    local output_color = self.output_color
    local clr = output_color[1]
    if self.bg_enabled then
        local hclk = self.hclk
        local hclk255 = hclk ~= 255
        local sp_map = self.sp_map
        local size = self.output_pixels_size
        local output = self.output_pixels
        for i = 1, 8 do
            local px = self:index_bg_pxs(i)
            local sprite = sp_map[hclk + i - 1]
            if sprite then
                if px % 4 == 0 then
                    px = sprite[2]
                else
                    if sprite[1] and hclk255 then
                        self.sp_zero_hit = true
                    end
                    if not sprite[0] then
                        px = sprite[2]
                    end
                end
            end
            output[size + i] = output_color[1 + px] or clr
        end
    else
        for i = 1, 8 do
            local sprite = self.sp_map[self.hclk + i - 1]
            self.output_pixels[self.output_pixels_size + i] = output_color[sprite and (sprite[2] + 1) or 1] or clr
        end
    end
    self.output_pixels_size = self.output_pixels_size + 8
end

function PPU:batch_render_eight_pixels_bg()
    local pixel
    local output_color = self.output_color
    local clr = output_color[1]
    if self.bg_enabled then
        for i = 1, 8 do
            local v = self:index_bg_pxs((self.hclk % 8) + i)
            self.output_pixels[self.output_pixels_size + i] = output_color[1 + v] or clr
        end
    else
        for i = 1, 8 do
            self.output_pixels[self.output_pixels_size + i] = clr
        end
    end
    self.output_pixels_size = self.output_pixels_size + 8
end

function PPU:boot()
    self.vblank = true
    self.hclk = HCLOCK_DUMMY
    self.hclk_target = FOREVER_CLOCK
end

function PPU:vblank_0()
    self.vblanking = true
    self.hclk = PPU.HCLOCK_VBLANK_1
end

function PPU:vblank_1()
    if not self.vblank then
        self.vblank = self.vblanking
    end
    self.vblanking = false
    self.sp_visible = false
    self.sp_active = false
    self.batch_render_eight_pixels = self.batch_render_eight_pixels_bg
    self.hclk = PPU.HCLOCK_VBLANK_2
end

function PPU:vblank_2()
    if not self.vblank then
        self.vblank = self.vblanking
    end
    self.vblanking = false
    self.hclk = HCLOCK_DUMMY
    self.hclk_target = FOREVER_CLOCK
    if self.need_nmi and self.vblank then
        self.cpu:do_nmi(self.cpu:next_frame_clock())
    end
end

function PPU:update_enabled_flags()
    if not self.any_show then
        return
    end
    self.bg_enabled = self.bg_show
    self.sp_enabled = self.sp_show
    local sp_active = self.sp_enabled and self.sp_visible
    self.sp_active = sp_active
    self.batch_render_eight_pixels =
        sp_active and self.batch_render_eight_pixels_sp or self.batch_render_eight_pixels_bg
end

function PPU:update_enabled_flags_edge()
    self.bg_enabled = self.bg_show_edge
    self.sp_enabled = self.sp_show_edge
    local sp_active = self.sp_enabled and self.sp_visible
    self.sp_active = sp_active
    self.batch_render_eight_pixels =
        sp_active and self.batch_render_eight_pixels_sp or self.batch_render_eight_pixels_bg
end
------------------------------------------------------------------------------------------------------------------------------------------------------
-- default core

function PPU:debug_logging(scanline, hclk, hclk_target)
    if hclk == FOREVER_CLOCK then
        hclk = "forever"
    end
    if hclk_target == FOREVER_CLOCK then
        hclk_target = "forever"
    end

    self.conf.debug("ppu: scanline --{ scanline }, hclk --{ hclk }->--{ hclk_target }")
end

function PPU:run()
    if not self.fiber then
        self.fiber = coroutine.wrap(UTILS.bind(self.main_loop, self), 0)
    end

    --if self.conf.loglevel >= 3 then self:debug_logging(self.scanline, self.hclk, self.hclk_target) end

    self:make_sure_invariants()

    if not self.fiber() then
        self.hclk_target = (self.vclk + self.hclk) * RP2C02_CC
    end
end

function PPU:wait_frame()
    --print "wait ppu frame"
    coroutine.yield(true)
end

function PPU:wait_zero_clocks()
    if self.hclk_target <= self.hclk then
        coroutine.yield()
    end
end

function PPU:wait_one_clock()
    self.hclk = self.hclk + 1
    self:wait_zero_clocks()
end

function PPU:wait_two_clocks()
    self.hclk = self.hclk + 2
    self:wait_zero_clocks()
end

function PPU:pre_render()
    self.vblank = false
    self.sp_overflow = false
    self.sp_zero_hit = false
    self.vblanking = false
    self.scanline = PPU.SCANLINE_HDUMMY
    for i = 1, 32 do
        --341.step(589, 8) do
        -- when 341, 349, ..., 589
        self:open_name()
        self:wait_two_clocks()

        -- when 343, 351, ..., 591
        self:open_attr()
        self:wait_two_clocks()

        -- when 345, 353, ..., 593
        self:open_pattern(self.bg_pattern_base)
        self:wait_two_clocks()

        -- when 347, 355, ..., 595
        self:open_pattern(bor(self.io_addr, 8))
        self:wait_two_clocks()
    end

    for i = 1, 8 do
        --597.step(653, 8) do
        -- when 597, 605, ..., 653
        if self.any_show and self.hclk == 645 then
            self.scroll_addr_0_4 = band(self.scroll_latch, 0x001f)
            self.scroll_addr_5_14 = band(self.scroll_latch, 0x7fe0)
            self.name_io_addr = bor(band(bor(self.scroll_addr_0_4, self.scroll_addr_5_14), 0x0fff), 0x2000) -- make cache consistent
        end
        self:open_name()
        self:wait_two_clocks()

        -- when 599, 607, ..., 655
        -- Nestopia uses open_name here?
        self:open_attr()
        self:wait_two_clocks()

        -- when 601, 609, ..., 657
        self:open_pattern(self.pattern_end)
        self:wait_two_clocks()

        -- when 603, 611, ..., 659
        self:open_pattern(bor(self.io_addr, 8))
        if self.hclk == 659 then
            self.hclk = 320
            self.vclk = self.vclk + HCLOCK_DUMMY
            self.hclk_target = self.hclk_target - HCLOCK_DUMMY
        else
            self:wait_two_clocks()
        end
        self:wait_zero_clocks()
    end
end

function PPU:pre_render_scanline()
    -- when 320
    self:load_extended_sprites()
    self:open_name()
    if self.any_show then
        self.sp_latch = self.sp_ram[1]
    end
    self.sp_buffered = 0
    self.sp_zero_in_line = false
    self.sp_index = 0
    self.evaluate_sprites_odd_phase = self.evaluate_sprites_odd_phase_0
    self:wait_one_clock()

    -- when 321
    self:fetch_name()
    self:wait_one_clock()

    -- when 322
    self:open_attr()
    self:wait_one_clock()

    -- when 323
    self:fetch_attr()
    self:scroll_clock_x()
    self:wait_one_clock()

    -- when 324
    self:open_pattern(self.io_pattern)
    self:wait_one_clock()

    -- when 325
    self:fetch_bg_pattern_0()
    self:wait_one_clock()

    -- when 326
    self:open_pattern(bor(self.io_pattern, 8))
    self:wait_one_clock()

    -- when 327
    self:fetch_bg_pattern_1()
    self:wait_one_clock()

    -- when 328
    self:preload_tiles()
    self:open_name()
    self:wait_one_clock()

    -- when 329
    self:fetch_name()
    self:wait_one_clock()

    -- when 330
    self:open_attr()
    self:wait_one_clock()

    -- when 331
    self:fetch_attr()
    self:scroll_clock_x()
    self:wait_one_clock()

    -- when 332
    self:open_pattern(self.io_pattern)
    self:wait_one_clock()

    -- when 333
    self:fetch_bg_pattern_0()
    self:wait_one_clock()

    -- when 334
    self:open_pattern(bor(self.io_pattern, 8))
    self:wait_one_clock()

    -- when 335
    self:fetch_bg_pattern_1()
    self:wait_one_clock()

    -- when 336
    self:open_name()
    self:wait_one_clock()

    -- when 337
    if self.any_show then
        self:update_enabled_flags_edge()
        if self.scanline == PPU.SCANLINE_HDUMMY and self.odd_frame then
            self.cpu:set_next_frame_clock(PPU.RP2C02_HVSYNC_1)
        end
    end
    self:wait_one_clock()

    -- when 338
    self:open_name()
    self.scanline = self.scanline + 1
end

function PPU:render_scanline()
    for i = 1, 32 do
        --0.step(248, 8) do
        -- when 0, 8, ..., 248
        if self.any_show then
            if self.hclk == 64 then
                --print "hclk 64 sp addr"
                self.sp_addr = band(self.regs_oam, 0xf8) -- SP_OFFSET_TO_0_1
                self.evaluate_sprites_odd_phase = self.evaluate_sprites_odd_phase_1
                self.sp_latch = 0xff
            end
            self:load_tiles()
            self:batch_render_eight_pixels()
            if self.hclk >= 64 then
                self:evaluate_sprites_even()
            end
            self:open_name()
        else
            self:render_pixel()
        end
        self:wait_one_clock()

        -- when 1, 9, ..., 249
        --print "when 1,9"
        --print(self.any_show)
        --print(self.hclk)
        if self.any_show then
            self:fetch_name()
            if self.hclk >= 64 then
                self:evaluate_sprites_odd()
            end
        else
            self:render_pixel()
        end
        self:wait_one_clock()

        -- when 2, 10, ..., 250
        if self.any_show then
            if self.hclk >= 64 then
                self:evaluate_sprites_even()
            end
            self:open_attr()
        else
            self:render_pixel()
        end
        self:wait_one_clock()

        -- when 3, 11, ..., 251
        if self.any_show then
            self:fetch_attr()
            if self.hclk >= 64 then
                self:evaluate_sprites_odd()
            end
            if self.hclk == 251 then
                self:scroll_clock_y()
            end
            self:scroll_clock_x()
        else
            self:render_pixel()
        end
        self:wait_one_clock()

        -- when 4, 12, ..., 252
        if self.any_show then
            if self.hclk >= 64 then
                self:evaluate_sprites_even()
            end
            self:open_pattern(self.io_pattern)
        else
            self:render_pixel()
        end
        self:wait_one_clock()

        if self.any_show then
            self:fetch_bg_pattern_0()
            if self.hclk >= 64 then
                self:evaluate_sprites_odd()
            end
        else
            self:render_pixel()
        end
        self:wait_one_clock()

        if self.any_show then
            if self.hclk >= 64 then
                self:evaluate_sprites_even()
            end
            self:open_pattern(bor(self.io_pattern, 8))
        else
            self:render_pixel()
        end
        self:wait_one_clock()

        if self.any_show then
            self:fetch_bg_pattern_1()
            if self.hclk >= 64 then
                self:evaluate_sprites_odd()
            end
        else
            self:render_pixel()
        end
        if self.hclk ~= 255 and self.any_show then
            self:update_enabled_flags()
        end
        self:wait_one_clock()
    end
end
function PPU:post_render_scanline()
    for i = 1, 8 do
        --256.step(312, 8) do
        if self.hclk == 256 then
            -- when 256
            self:open_name()
            if self.any_show then
                self.sp_latch = 0xff
            end
            self:wait_one_clock()
            -- when 257
            self:scroll_reset_x()
            self.sp_visible = false
            self.sp_active = false
            self.batch_render_eight_pixels = self.batch_render_eight_pixels_bg
            self:wait_one_clock()
        else
            -- when 264, 272, ..., 312
            self:open_name()
            self:wait_two_clocks()
        end

        -- when 258, 266, ..., 314
        -- Nestopia uses open_name here?
        self:open_attr()
        self:wait_two_clocks()

        -- when 260, 268, ..., 316
        if self.any_show then
            local buffer_idx = (self.hclk - 260) / 2
            self:open_pattern(buffer_idx >= self.sp_buffered and self.pattern_end or self:open_sprite(buffer_idx))
            if self.scanline == 238 and self.hclk == 316 then
                self.regs_oam = 0
            end
        end
        self:wait_one_clock()

        -- when 261, 269, ..., 317
        if self.any_show then
            if (self.hclk - 261) / 2 < self.sp_buffered then
                self.io_pattern = self.chr_mem[1 + band(self.io_addr, 0x1fff)]
            end
        end
        self:wait_one_clock()

        -- when 262, 270, ..., 318
        self:open_pattern(bor(self.io_addr, 8))
        self:wait_one_clock()

        -- when 263, 271, ..., 319
        if self.any_show then
            local buffer_idx = (self.hclk - 263) / 2
            if buffer_idx < self.sp_buffered then
                local pat0 = self.io_pattern
                local pat1 = self.chr_mem[1 + band(self.io_addr, 0x1fff)]
                if pat0 ~= 0 or pat1 ~= 0 then
                    self:load_sprite(pat0, pat1, buffer_idx)
                end
            end
        end
        self:wait_one_clock()
    end
end
function PPU:post_render()
    -- when 681
    self:vblank_0()
    self:wait_zero_clocks()

    -- when 682
    self:vblank_1()
    self:wait_zero_clocks()

    -- when 684
    self:vblank_2()
    self:wait_frame()
end
function PPU:main_loop()
    -- when 685

    -- wait for boot
    self:boot()
    self:wait_frame()
    while true do
        self:pre_render()

        while true do
            self:pre_render_scanline()

            if self.scanline ~= SCANLINE_VBLANK then
                local line
                if self.any_show then
                    line = (self.scanline ~= 0 or not self.odd_frame) and 341 or 340
                else
                    self:update_enabled_flags_edge()
                    line = 341
                end
                self.hclk = 0
                self.vclk = self.vclk + line
                self.hclk_target = self.hclk_target <= line and 0 or self.hclk_target - line
            else
                self.hclk = PPU.HCLOCK_VBLANK_0
                self:wait_zero_clocks()
                break
            end
            self:wait_zero_clocks()

            -- visible scanline (shown)
            self:render_scanline()

            self:post_render_scanline()
        end

        -- post-render scanline (vblank)
        self:post_render()
    end
end

return PPU
local UTILS = require("nes.utils")

local band, bor, bxor, bnot, lshift, rshift = bit.band, bit.bor, bit.bxor, bit.bnot, bit.lshift, bit.rshift
local map, rotatePositiveIdx, nthBitIsSet, nthBitIsSetInt =
    UTILS.map,
    UTILS.rotatePositiveIdx,
    UTILS.nthBitIsSet,
    UTILS.nthBitIsSetInt

local CPU = {
    RP2A03_CC = 12,
    FOREVER_CLOCK = 0xffffffff
}
local DISPATCH
CPU._mt = {__index = CPU}

do
    CPU.CLK = {}
    local clocks = {1, 2, 3, 4, 5, 6, 7, 8}
    for i = 1, #clocks do
        CPU.CLK[i] = clocks[i] * CPU.RP2A03_CC
    end
end
CPU.UNDEFINED = {}
CPU.RAM_SIZE = 0x0800
CPU.MAINMEM_SIZE = 0x10000
CPU.NMI_VECTOR = 0xfffa
CPU.RESET_VECTOR = 0xfffc
CPU.IRQ_VECTOR = 0xfffe

CPU.IRQ_EXT = 0x01
CPU.IRQ_FRAME = 0x40
CPU.IRQ_DMC = 0x80

CPU.ClockRates = {
    Ntsc = 1789773,
    Pal = 1662607,
    Dendy = 1773448
}
local RAM_SIZE, UNDEFINED, NMI_VECTOR, IRQ_VECTOR, FOREVER_CLOCK =
    CPU.RAM_SIZE,
    CPU.UNDEFINED,
    CPU.NMI_VECTOR,
    CPU.IRQ_VECTOR,
    CPU.FOREVER_CLOCK

local UNDEFINED = CPU.UNDEFINED
local CLK = CPU.CLK

local isDefined = UTILS.isDefined
local bind = UTILS.bind
local tSetter = UTILS.tSetter
local tGetter = UTILS.tGetter
local fill = UTILS.fill
local range = UTILS.range
local printf = UTILS.printf
local nthBitIsSetInt = UTILS.nthBitIsSetInt

CPU.PokeNop = function()
end

function CPU:steal_clocks(clk)
    self.clk = self.clk + clk
end

function CPU:odd_clock()
    return ((self.clk_total + self.clk) % CLK[2]) ~= 0
end

function CPU:update()
    self.apu:clock_dma(self.clk)
    return self.clk
end

function CPU:dmc_dma(addr)
    -- This is inaccurate; it must steal *up to* 4 clocks depending upon
    -- whether CPU writes in this clock, but this always steals 4 clocks.
    self.clk = self.clk + CLK[3]
    local dma_buffer = self:fetch(addr)
    self.clk = self.clk + CLK[1]
    return dma_buffer
end

function CPU:next_frame_clock()
    return self.clk_frame
end

function CPU:set_next_frame_clock(x)
    self.clk_frame = x
    self.clk_target = x < self.clk_target and x or self.clk_target
    return x
end
function CPU:current_clock()
    return self.clk
end

function CPU:peek_nop(addr)
    return rshift(addr, 8)
end

function CPU:peek_jam_1(addr)
    self._pc = band(self._pc - 1, 0xffff)
    return 0xfc
end
function CPU:peek_jam_2(_addr)
    return 0xff
end

function CPU:peek_ram(addr)
    return self.ram[addr % CPRAM_SIZE]
end
function CPU:poke_ram(addr, data)
    self.ram[addr % RAM_SIZE] = data
end

-- read an addr (8 bit)
function CPU:fetch(addr)
    return self._fetch[addr](addr)
end
function CPU:store(addr, value)
    return self._store[addr](addr, value)
end

-- Read 16 bits (word) from addr
function CPU:peek16(addr)
    return self:fetch(addr) + lshift(self:fetch(addr + 1), 8)
end

function CPU:add_mappings(addr, peek, poke)
    self.peeks[peek] = isDefined(self.peeks[peek]) and self.peeks[peek] or peek
    peek = self.peeks[peek]
    self.pokes[poke] = isDefined(self.pokes[poke]) and self.pokes[poke] or poke
    poke = self.pokes[poke]
    if type(addr) == "number" then
        addr = {addr}
    end
    for i = addr[0] and 0 or 1, #addr do
        local x = addr[i]
        self._fetch[x] = peek
        if poke and type(poke) ~= "table" then
            self._store[x] = poke
        else
            self._store[x] = CPU.PokeNop
        end
    end
end

function CPU:reset()
    self._a = 0
    self._x = 0
    self._y = 0
    self._sp = 0xfd
    self._pc = 0xfffc
    self._p_nz = 1
    self._p_c = 0
    self._p_v = 0
    self._p_i = 0x04
    self._p_d = 0
    fill(self.ram, 0xff)
    self.clk = 0
    self.clk_total = 0
    local ram = self.ram
    self:add_mappings(
        range(0x0000, 0x07ff),
        function(i)
            return ram[i]
        end,
        tSetter(self.ram)
    )
    self:add_mappings(
        range(0x0800, 0x1fff),
        function(i)
            return ram[i % RAM_SIZE]
        end,
        bind(self.poke_ram, self)
    )
    self:add_mappings(range(0x2000, 0xffff), bind(self.peek_nop, self), UNDEFINED) -- 8 PPU registers mirrored
    --self:add_mappings(0xfffc, bind(self.peek_jam_1, self), UNDEFINED)
    --self:add_mappings(0xfffd, bind(self.peek_jam_2, self), UNDEFINED)
end

function CPU:new(conf)
    local cpu = {}
    setmetatable(cpu, CPU._mt)
    cpu.conf = conf or {loglevel = 0, pc = nil}
    cpu.ram = fill({}, UNDEFINED, RAM_SIZE)
    cpu._store = fill({}, UNDEFINED, CPU.MAINMEM_SIZE)
    cpu._fetch = fill({}, UNDEFINED, CPU.MAINMEM_SIZE)
    cpu.peeks = {}
    cpu.pokes = {}
    cpu.clk_rate = CPU.ClockRates.Ntsc
    cpu.clk = 0 -- the current clock
    cpu.clk_frame = 0
    cpu.clk_target = 0 -- the goal clock for the current CPU#run
    cpu.clk_total = 0 -- the total elapsed clocks
    cpu.clk_nmi = FOREVER_CLOCK -- the next NMI clock (FOREVER_CLOCK means "not scheduled")
    cpu.clk_irq = FOREVER_CLOCK -- the next IRQ clock
    cpu.irq_flags = 0
    cpu.jammed = false
    cpu:reset()
    cpu.data = 0
    cpu.addr = 0
    cpu.opcode = nil
    cpu.ppu_sync = nil
    -- DUMMY APU
    cpu.apu = {
        clock_dma = function(clk)
        end,
        do_clock = function()
            return CLK[1]
        end
    }
    return cpu
end

function CPU:dmc_dma(addr)
    -- This is inaccurate; it must steal *up to* 4 clocks depending upon
    -- whether CPU writes in this clock, but this always steals 4 clocks.
    self.clk = CLK[3] + self.clk
    local dma_buffer = self:fetch(addr)
    self.clk = CLK[1] + self.clk
    return dma_buffer
end

function CPU:sprite_dma(addr, sp_ram)
    do
        local ram = self.ram
        for i = 1, 256 do
            sp_ram[i] = ram[addr + i - 1]
        end
    end
    for i = 0, 63 do
        local j = i * 4 + 3
        sp_ram[j] = band(sp_ram[j], 0xe3)
    end
end

function CPU:boot()
    self.clk = CLK[7] -- clocks it takes to boot
    self._pc = self.conf.pc or self:peek16(CPU.RESET_VECTOR)
end

function CPU:vsync()
    if self.ppu_sync then
        (self.ppu):sync(self.clk)
    end

    self.clk = self.clk - self.clk_frame
    self.clk_total = self.clk_total + self.clk_frame

    if self.clk_nmi ~= FOREVER_CLOCK then
        self.clk_nmi = self.clk_nmi - self.clk_frame
    end
    if self.clk_irq ~= FOREVER_CLOCK then
        self.clk_irq = self.clk_irq - self.clk_frame
        if self.clk_irq < 0 then
            self.clk_irq = 0
        end
    end
end

-------------------------------------------------------------------------------------------------------------------
-- interrupts

function CPU:clear_irq(line)
    local old_irq_flags = band(self.irq_flags, bor(CPU.IRQ_FRAME, CPU.IRQ_DMC))
    self.irq_flags = band(bxor(self.irq_flags, bxor(line, bor(bor(CPU.IRQ_EXT, CPU.IRQ_FRAME), CPU.IRQ_DMC))))
    if self.irq_flags == 0 then
        self.clk_irq = FOREVER_CLOCK
    end
    return old_irq_flags
end

function CPU:next_interrupt_clock(clk)
    clk = clk + CLK[1] + CLK[1] / 2 -- interrupt edge
    if self.clk_target > clk then
        self.clk_target = clk
    end
    return clk
end

function CPU:do_irq(line, clk)
    self.irq_flags = bor(self.irq_flags, line)
    if self.clk_irq == FOREVER_CLOCK and self._p_i == 0 then
        self.clk_irq = self:next_interrupt_clock(clk)
    end
end

function CPU:do_nmi(clk)
    if self.clk_nmi == FOREVER_CLOCK then
        self.clk_nmi = self:next_interrupt_clock(clk)
    end
end

function CPU:do_isr(vector)
    if self.jammed then
        return
    end
    self:push16(self._pc)
    self:push8(self:flags_pack())
    self._p_i = 0x04
    self.clk = self.clk + CLK[7]
    local addr = vector == NMI_VECTOR and NMI_VECTOR or self:fetch_irq_isr_vector()
    self._pc = self:peek16(addr)
end

function CPU:fetch_irq_isr_vector()
    if self.clk >= self.clk_frame then
        self:fetch(0x3000)
    end
    if self.clk_nmi ~= FOREVER_CLOCK then
        if self.clk_nmi + CLK[2] <= self.clk then
            self.clk_nmi = FOREVER_CLOCK
            return NMI_VECTOR
        end
        self.clk_nmi = self.clk + 1
    end
    return IRQ_VECTOR
end

------------------------------------------------------------------------------------------------------------------------
-- instruction helpers

------ P regeister ------

function CPU:flags_pack()
    local nz = self._p_nz
    return bor(
        bor(
            bor(
                bor(
                    bor(bor(band(bor(rshift(nz, 1), nz), 0x80), (band(nz, 0xff) ~= 0 and 0 or 2)), self._p_c),
                    self._p_v ~= 0 and 0x40 or 0
                ),
                self._p_i
            ),
            self._p_d
        ),
        0x20
    )
end

function CPU:flags_unpack(f)
    self._p_nz = bor(band(bnot(f), 2), lshift(band(f, 0x80), 1))
    self._p_c = band(f, 0x01)
    self._p_v = band(f, 0x40)
    self._p_i = band(f, 0x04)
    self._p_d = band(f, 0x08)
end

------ branch helper ------
function CPU:branch(cond)
    if cond then
        local tmp = self._pc + 1
        local rel = self:fetch(self._pc)
        self._pc = band(tmp + (rel < 128 and rel or bor(rel, 0xff00)), 0xffff)
        self.clk = self.clk + (nthBitIsSetInt(tmp, 8) == nthBitIsSetInt(self._pc, 8) and CLK[3] or CLK[4])
    else
        self._pc = self._pc + 1
        self.clk = self.clk + CLK[2]
    end
end

------ storers ------
function CPU:store_mem()
    self:store(self.addr, self.data)
    self.clk = self.clk + CLK[1]
end

function CPU:store_zpg()
    self.ram[self.addr] = self.data
end

------ stack management ------
function CPU:push8(data)
    local sp = self._sp
    self.ram[0x0100 + sp] = data
    self._sp = band(sp - 1, 0xff)
end

function CPU:push16(data)
    self:push8(rshift(data, 8))
    self:push8(band(data, 0xff))
end

function CPU:pull8()
    self._sp = band(self._sp + 1, 0xff)
    return self.ram[0x0100 + self._sp]
end

function CPU:pull16()
    local x = self:pull8()
    local b = self:pull8()
    return x + 256 * b
end

------------------------------------------------------------------------------------------------------------------------
-- addressing modes

-- immediate addressing (read only)
function CPU:imm(_read, _write)
    self.data = self:fetch(self._pc)
    self._pc = self._pc + 1
    self.clk = self.clk + CLK[2]
end

-- zero-page addressing
function CPU:zpg(read, write)
    self.addr = self:fetch(self._pc)
    self._pc = self._pc + 1
    self.clk = self.clk + CLK[3]
    if read then
        self.data = self.ram[self.addr]
        if write then
            self.clk = self.clk + CLK[2]
        end
    end
end

-- zero-page indexed addressing
function CPU:zpg_reg(indexed, read, write)
    self.addr = band(indexed + self:fetch(self._pc), 0xff)
    self._pc = self._pc + 1
    self.clk = self.clk + CLK[4]
    if read then
        self.data = self.ram[self.addr]
        if write then
            self.clk = self.clk + CLK[2]
        end
    end
end

function CPU:zpg_x(read, write)
    return self:zpg_reg(self._x, read, write)
end

function CPU:zpg_y(read, write)
    return self:zpg_reg(self._y, read, write)
end
-- absolute addressing
function CPU:abs(read, write)
    self.addr = self:peek16(self._pc)
    self._pc = self._pc + 2
    self.clk = self.clk + CLK[3]
    return self:read_write(read, write)
end

-- absolute indexed addressing
function CPU:abs_reg(indexed, read, write)
    local addr = self._pc + 1
    local i = indexed + self:fetch(self._pc)
    self.addr = band(lshift(self:fetch(addr), 8) + i, 0xffff)
    if write then
        addr = band(self.addr - band(i, 0x100), 0xffff)
        self:fetch(addr)
        self.clk = self.clk + CLK[4]
    else
        self.clk = self.clk + CLK[3]
        if band(i, 0x100) ~= 0 then
            addr = band(self.addr - 0x100, 0xffff) -- for inlining fetch
            self:fetch(addr)
            self.clk = self.clk + CLK[1]
        end
    end
    self:read_write(read, write)
    self._pc = self._pc + 2
end

function CPU:abs_x(read, write)
    return self:abs_reg(self._x, read, write)
end

function CPU:abs_y(read, write)
    return self:abs_reg(self._y, read, write)
end
-- indexed indirect addressing
function CPU:ind_x(read, write)
    local addr = self:fetch(self._pc) + self._x
    self._pc = self._pc + 1
    self.clk = self.clk + CLK[5]
    self.addr = bor(self.ram[band(addr, 0xff)], lshift(self.ram[band(addr + 1, 0xff)], 8))
    return self:read_write(read, write)
end

-- indirect indexed addressing
function CPU:ind_y(read, write)
    local addr = self:fetch(self._pc)
    self._pc = self._pc + 1
    local ram = self.ram
    local indexed = ram[addr] + self._y
    self.clk = self.clk + CLK[4]
    if write then
        self.clk = self.clk + CLK[1]
        self.addr = lshift(ram[band(addr + 1, 0xff)], 8) + indexed
        addr = self.addr - band(indexed, 0x100) -- for inlining fetch
        self:fetch(addr)
    else
        self.addr = band(lshift(ram[band(addr + 1, 0xff)], 8) + indexed, 0xffff)
        if band(indexed, 0x100) ~= 0 then
            addr = band(self.addr - 0x100, 0xffff) -- for inlining fetch
            self:fetch(addr)
            self.clk = self.clk + CLK[1]
        end
    end
    return self:read_write(read, write)
end

function CPU:read_write(read, write)
    if read then
        --print(string.format("%04X",self.addr))
        self.data = self:fetch(self.addr)
        --print(self.clk)
        self.clk = self.clk + CLK[1]
        --print(self.clk)
        if write then
            self:store(self.addr, self.data)
            --print(self.clk)
            self.clk = self.clk + CLK[1]
        --print(self.clk)
        end
    end
end

--------------------------------------------------------------------------------------------------------------------
-- instructions

-- load instructions
function CPU:_lda()
    self._p_nz = self.data
    self._a = self.data
end

function CPU:_ldx()
    self._p_nz = self.data
    self._x = self.data
end

function CPU:_ldy()
    self._y = self.data
    self._p_nz = self.data
end

-- store instructions
function CPU:_sta()
    self.data = self._a
end

function CPU:_stx()
    self.data = self._x
end

function CPU:_sty()
    self.data = self._y
end

-- transfer instructions
function CPU:_tax()
    self.clk = self.clk + CLK[2]
    local a = self._a
    self._x = a
    self._p_nz = a
end

function CPU:_tay()
    self.clk = self.clk + CLK[2]
    local a = self._a
    self._y = a
    self._p_nz = a
end

function CPU:_txa()
    self.clk = self.clk + CLK[2]
    local x = self._x
    self._a = x
    self._p_nz = x
end

function CPU:_tya()
    self.clk = self.clk + CLK[2]
    local y = self._y
    self._a = y
    self._p_nz = y
end

-- flow control instructions
function CPU:_jmp_a()
    self._pc = self:peek16(self._pc)
    self.clk = self.clk + CLK[3]
end

function CPU:_jmp_i()
    local pos = self:peek16(self._pc)
    local low = self:fetch(pos)
    pos = bor(band(pos, 0xff00), band(pos + 1, 0x00ff))
    local high = self:fetch(pos)
    self._pc = high * 256 + low
    self.clk = self.clk + CLK[5]
end

function CPU:_jsr()
    local data = self._pc + 1
    self:push16(data)
    self._pc = self:peek16(self._pc)
    self.clk = self.clk + CLK[6]
end

function CPU:_rts()
    local x = self:pull16()
    self._pc = band(x + 1, 0xffff)
    self.clk = self.clk + CLK[6]
end

function CPU:_rti()
    self.clk = self.clk + CLK[6]
    local packed = self:pull8()
    self._pc = self:pull16()
    self:flags_unpack(packed)
    if self.irq_flags == 0 or self._p_i ~= 0 then
        self.clk_irq = FOREVER_CLOCK
    else
        self.clk_target = 0
        self.clk_irq = 0
    end
end

function CPU:_bne()
    return self:branch(band(self._p_nz, 0xff) ~= 0)
end

function CPU:_beq()
    return self:branch(band(self._p_nz, 0xff) == 0)
end

function CPU:_bmi()
    return self:branch(band(self._p_nz, 0x180) ~= 0)
end

function CPU:_bpl()
    return self:branch(band(self._p_nz, 0x180) == 0)
end

function CPU:_bcs()
    return self:branch(self._p_c ~= 0)
end

function CPU:_bcc()
    return self:branch(self._p_c == 0)
end

function CPU:_bvs()
    return self:branch(self._p_v ~= 0)
end

function CPU:_bvc()
    return self:branch(self._p_v == 0)
end

-- math operations
function CPU:_adc()
    local tmp = self._a + self.data + self._p_c
    self._p_v = band(bnot(bxor(self._a, self.data)), bxor(self._a, tmp), 0x80)
    self._a = band(tmp, 0xff)
    self._p_nz = self._a
    self._p_c = nthBitIsSetInt(tmp, 8)
end

function CPU:_sbc()
    local data = bxor(self.data, 0xff)
    local tmp = self._a + data + self._p_c
    self._p_v = band(bnot(bxor(self._a, data)), bxor(self._a, tmp), 0x80)
    self._a = band(tmp, 0xff)
    self._p_nz = self._a
    self._p_c = nthBitIsSetInt(tmp, 8)
end

-- logical operations
function CPU:_and()
    self._a = band(self._a, self.data)
    self._p_nz = self._a
end

function CPU:_ora()
    self._a = bor(self._a, self.data)
    self._p_nz = self._a
end

function CPU:_eor()
    self._a = bxor(self._a, self.data)
    self._p_nz = self._a
end

function CPU:_bit()
    self._p_nz = bor(band(self.data, self._a) ~= 0 and 1 or 0, lshift(band(self.data, 0x80), 1))
    self._p_v = band(self.data, 0x40)
end

function CPU:_cmp()
    local data = self._a - self.data
    self._p_nz = band(data, 0xff)
    self._p_c = 1 - nthBitIsSetInt(data, 8)
end

function CPU:_cpx()
    local data = self._x - self.data
    self._p_nz = band(data, 0xff)
    self._p_c = 1 - nthBitIsSetInt(data, 8)
end

function CPU:_cpy()
    local data = self._y - self.data
    self._p_nz = band(data, 0xff)
    self._p_c = 1 - nthBitIsSetInt(data, 8)
end

-- shift operations
function CPU:_asl()
    self._p_c = rshift(self.data, 7)
    self._p_nz = band(lshift(self.data, 1), 0xff)
    self.data = self._p_nz
end

function CPU:_lsr()
    self._p_c = band(self.data, 1)
    self._p_nz = rshift(self.data, 1)
    self.data = self._p_nz
end

function CPU:_rol()
    self._p_nz = bor(band(lshift(self.data, 1), 0xff), self._p_c)
    self._p_c = rshift(self.data, 7)
    self.data = self._p_nz
end

function CPU:_ror()
    self._p_nz = bor(rshift(self.data, 1), lshift(self._p_c, 7))
    self._p_c = band(self.data, 1)
    self.data = self._p_nz
end

-- increment and decrement operations
function CPU:_dec()
    self._p_nz = band(self.data - 1, 0xff)
    self.data = self._p_nz
end

function CPU:_inc()
    self._p_nz = band(self.data + 1, 0xff)
    self.data = self._p_nz
end

function CPU:_dex()
    self.clk = self.clk + CLK[2]
    local x = band(self._x - 1, 0xff)
    self.data = x
    self._p_nz = x
    self._x = x
end

function CPU:_dey()
    self.clk = self.clk + CLK[2]
    self._y = band(self._y - 1, 0xff)
    self.data = self._y
    self._p_nz = self._y
end

function CPU:_inx()
    self.clk = self.clk + CLK[2]
    self._x = band(self._x + 1, 0xff)
    self.data = self._x
    self._p_nz = self._x
end

function CPU:_iny()
    self.clk = self.clk + CLK[2]
    self._y = band(self._y + 1, 0xff)
    self.data = self._y
    self._p_nz = self._y
end

-- flags instructions
function CPU:_clc()
    self.clk = self.clk + CLK[2]
    self._p_c = 0
end

function CPU:_sec()
    self.clk = self.clk + CLK[2]
    self._p_c = 1
end

function CPU:_cld()
    self.clk = CLK[2] + self.clk
    self._p_d = 0
end

function CPU:_sed()
    self.clk = self.clk + CLK[2]
    self._p_d = 8
end

function CPU:_clv()
    self.clk = self.clk + CLK[2]
    self._p_v = 0
end
function CPU:_sei()
    self.clk = self.clk + CLK[2]
    if self._p_i == 0 then
        self._p_i = 0x04
        self.clk_irq = FOREVER_CLOCK
        if self.irq_flags ~= 0 then
            self:do_isr(IRQ_VECTOR)
        end
    end
end

function CPU:_cli()
    self.clk = self.clk + CLK[2]
    if self._p_i ~= 0 then
        self._p_i = 0
        if self.irq_flags ~= 0 then
            local clk = self.clk + 1
            self.clk_irq = clk
            if self.clk_target > clk then
                self.clk_target = clk
            end
        end
    end
end

-- stack operations
function CPU:_pha()
    self.clk = self.clk + CLK[3]
    return self:push8(self._a)
end

function CPU:_php()
    self.clk = self.clk + CLK[3]
    local data = bor(self:flags_pack(), 0x10)
    return self:push8(data)
end

function CPU:_pla()
    self.clk = self.clk + CLK[4]
    self._a = self:pull8()
    self._p_nz = self._a
end

function CPU:_plp()
    self.clk = self.clk + CLK[4]
    local i = self._p_i
    self:flags_unpack(self:pull8())
    if self.irq_flags ~= 0 then
        if i > self._p_i then
            local clk = self.clk + 1
            self.clk_irq = clk
            if self.clk_target > clk then
                self.clk_target = clk
            end
        elseif i < self._p_i then
            self.clk_irq = FOREVER_CLOCK
            self:do_isr(IRQ_VECTOR)
        end
    end
end

function CPU:_tsx()
    self.clk = self.clk + CLK[2]
    self._p_nz = self._sp
    self._x = self._sp
end

function CPU:_txs()
    self.clk = self.clk + CLK[2]
    self._sp = self._x
end

-- undocumented instructions, rarely used
function CPU:_anc()
    self._a = band(self._a, self.data)
    self._p_nz = self._a
    self._p_c = rshift(self._p_nz, 7)
end

function CPU:_ane()
    self._a = band(band(bor(self._a, 0xee), self._x), self.data)
    self._p_nz = self._a
end

function CPU:_arr()
    self._a = bor(rshift(band(self.data, self._a), 1), lshift(self._p_c, 7))
    self._p_nz = self._a
    self._p_c = nthBitIsSetInt(self._a, 6)
    self._p_v = bxor(nthBitIsSetInt(self._a, 6), nthBitIsSetInt(self._a, 5))
end

function CPU:_asr()
    self._p_c = band(band(self.data, self._a), 0x1)
    self._a = rshift(band(self.data, self._a), 1)
    self._p_nz = self._a
end

function CPU:_dcp()
    self.data = band(self.data - 1, 0xff)
    return self:_cmp()
end

function CPU:_isb()
    self.data = band(self.data + 1, 0xff)
    return self:_sbc()
end

function CPU:_las()
    self._sp = band(self._sp, self.data)
    self._x = self._sp
    self._p_nz = self._x
    self._a = self._x
end

function CPU:_lax()
    self._x = self.data
    self._p_nz = self._x
    self._a = self._x
end

function CPU:_lxa()
    self._x = self.data
    self._p_nz = self._x
    self._a = self._x
end

function CPU:_rla()
    local c = self._p_c
    self._p_c = rshift(self.data, 7)
    self.data = bor(band(lshift(self.data, 1), 0xff), c)
    self._a = band(self._a, self.data)
    self._p_nz = self._a
end

function CPU:_rra()
    local c = lshift(self._p_c, 7)
    self._p_c = band(self.data, 1)
    self.data = bor(rshift(self.data, 1), c)
    return self:_adc()
end

function CPU:_sax()
    self.data = band(self._a, self._x)
end

function CPU:_sbx()
    self.data = band(self._a, self._x) - self.data
    self._p_c = band(self.data, 0xffff) <= 0xff and 1 or 0
    self._x = band(self.data, 0xff)
    self._p_nz = self._x
end

function CPU:_sha()
    self.data = band(self._a, band(self._x, (rshift(self.addr, 8) + 1)))
end

function CPU:_shs()
    self._sp = band(self._a, self._x)
    self.data = band(self._sp, (rshift(self.addr, 8) + 1))
end

function CPU:_shx()
    self.data = band(self._x, (rshift(self.addr, 8) + 1))
    self.addr = bor(lshift(self.data, 8), band(self.addr, 0xff))
end

function CPU:_shy()
    self.data = band(self._y, (rshift(self.addr, 8) + 1))
    self.addr = bor(lshift(self.data, 8), band(self.addr, 0xff))
end

function CPU:_slo()
    self._p_c = rshift(self.data, 7)
    self.data = band(lshift(self.data, 1), 0xff)
    self._a = bor(self.data, self._a)
    self._p_nz = self._a
end

function CPU:_sre()
    self._p_c = band(self.data, 1)
    self.data = rshift(self.data, 1)
    self._a = bxor(self._a, self.data)
    self._p_nz = self._a
end

-- nops
function CPU:_nop()
end

-- interrupts
function CPU:_brk()
    local data = self._pc + 1
    self:push16(data)
    data = bor(self:flags_pack(), 0x10)
    self:push8(data)
    self._p_i = 0x04
    self.clk_irq = FOREVER_CLOCK
    self.clk = self.clk + CLK[7]
    local addr = self:fetch_irq_isr_vector() -- for inlining peek16
    self._pc = self:peek16(addr)
end

function CPU:_jam()
    self._pc = band((self._pc - 1), 0xffff)
    self.clk = self.clk + CLK[2]
    if not self.jammed then
        self.jammed = true
        -- interrupt reset
        self.clk_nmi = FOREVER_CLOCK
        self.clk_irq = FOREVER_CLOCK
        self.irq_flags = 0
    end
end

--------------------------------------------------------------------------------------------------------------------
-- default core
function CPU:printState(doFetch)
    --[
    local ppuclk = 0
    if self.ppu then
        ppuclk = self.ppu.hclk
    end
    print(
        string.format(
            "PC:%04X OP:%02X %02X %02X %s %04X %02X \t A:%02X X:%02X Y:%02X P:%02X SP:%02X CYC:%3d %s",
            self._pc,
            self.opcode or 0,
            doFetch and self:fetch(self._pc + 1) or -1,
            doFetch and self:fetch(self._pc + 2) or -1,
            table.concat(DISPATCH[self.opcode] or {}, " "),
            self.data,
            self.addr,
            self._a,
            self._x,
            self._y,
            self:flags_pack(),
            self._sp,
            self.clk / 4 % 341,
            tostring(ppuclk),
            self.clk
        )
    )
    --]]
    --[[
    print(
        string.format(
            "PC:%04X OP:%02X %02X %02X %s %04X %02X \t A:%02X X:%02X Y:%02X P:%02X SP:%02X CYC:%3d %d %d %d",
            self._pc,
            self.opcode or 0,
            doFetch and self:fetch(self._pc + 1) or -1,
            doFetch and self:fetch(self._pc + 2) or -1,
            table.concat(DISPATCH[self.opcode] or {}, " "),
            self.data,
            self.addr,
            self._a,
            self._x,
            self._y,
            self:flags_pack(),
            self._sp,
            self.clk / 4 % 341,
            self.clk,
            self.clk_target,
            self.clk_frame
        )
    )
    --]]
end
function CPU:r_op(instr, mode)
    self[mode](self, true, false)
    self[instr](self)
end

function CPU:w_op(instr, mode, store)
    self[mode](self, false, true)
    self[instr](self)
    self[store](self)
end

function CPU:rw_op(instr, mode, store)
    self[mode](self, true, true)
    self[instr](self)
    self[store](self)
end

function CPU:a_op(instr)
    self.clk = self.clk + CLK[2]
    self.data = self._a
    self[instr](self)
    self._a = self.data
end

function CPU:no_op(_instr, ops, ticks)
    self._pc = self._pc + ops
    self.clk = self.clk + ticks * CPU.RP2A03_CC
end

function CPU:do_clock()
    local ticks = self.apu:do_clock()
    local clock = math.min(ticks, self.clk_frame)
    if self.clk < self.clk_nmi then
        clock = math.min(clock, self.clk_nmi)
        if self.clk < self.clk_irq then
            clock = math.min(clock, self.clk_irq)
        else
            self.clk_irq = FOREVER_CLOCK
            self:do_isr(IRQ_VECTOR)
        end
    else
        self.clk_nmi = FOREVER_CLOCK
        self.clk_irq = FOREVER_CLOCK
        self:do_isr(NMI_VECTOR)
    end
    self.clk_target = clock
end
local asd = 0
function CPU:run_once()
    self.opcode = self:fetch(self._pc)
    --[[
    if self.conf.loglevel >= 3 then
        self:printState(true)
            self.conf.debug(string.format("PC:%04X A:%02X X:%02X Y:%02X P:%02X SP:%02X CYC:%3d : OPCODE:%02X (%d, %d)" ,
              self._pc, self._a, self._x, self._y, self:flags_pack(), self._sp, self.clk / 4 % 341, self.opcode, self.cl
            ))
    end
    --]]
    self._pc = self._pc + 1

    --[[
    DISPATCHER[self.opcode](self)
    ]]
    local operationData = DISPATCH[self.opcode]
    self[operationData[1]](self, table.unpack(operationData, 2))
    if self.ppu_sync then
        self.ppu:sync(self.clk)
    end
    --[[
    asd = asd + 1
    if asd > 350000000 then
        if asdasdsssasd then
            asdasdsssasd:flush()
            asdasdsssasd:close()
        end
        error "asd"
    end
    ]]
end
function CPU:run()
    self:do_clock()
    repeat
        repeat
            self:run_once()
        until not (self.clk < self.clk_target)
        self:do_clock()
    until not (self.clk < self.clk_frame)
end

CPU.ADDRESSING_MODES = {
    ctl = {"imm", "zpg", "imm", "abs", UNDEFINED, "zpg_x", UNDEFINED, "abs_x"},
    rmw = {"imm", "zpg", "imm", "abs", UNDEFINED, "zpg_y", UNDEFINED, "abs_y"},
    alu = {"ind_x", "zpg", "imm", "abs", "ind_y", "zpg_x", "abs_y", "abs_x"},
    uno = {"ind_x", "zpg", "imm", "abs", "ind_y", "zpg_y", "abs_y", "abs_y"}
}
CPU.DISPATCH = {}
DISPATCH = CPU.DISPATCH

-- add an op/instruction
-- opcodes is a table or a single intruction code
-- args is a table of strings or a string of the form {kind,funcName,addrmode} or funcName
local function op(opcodes, args)
    for _, opcode in ipairs(opcodes) do
        local send_args
        if type(args) == "table" then
            if (args[1] == "r_op" or args[1] == "w_op" or args[1] == "rw_op") then
                local kind, ope, addrmode = args[1], args[2], args[3]
                addrmode = CPU.ADDRESSING_MODES[addrmode][band(rshift(opcode, 2), 7) + 1]
                send_args = {kind, ope, addrmode}
                if kind ~= "r_op" then
                    send_args[#send_args + 1] = (addrmode:sub(1, 3) == "zpg" and "store_zpg" or "store_mem")
                end
            else
                send_args = args
            end
        else
            send_args = {args}
        end
        DISPATCH[opcode] = send_args
    end
end

-- load instructions
op({0xa9, 0xa5, 0xb5, 0xad, 0xbd, 0xb9, 0xa1, 0xb1}, {"r_op", "_lda", "alu"})
op({0xa2, 0xa6, 0xb6, 0xae, 0xbe}, {"r_op", "_ldx", "rmw"})
op({0xa0, 0xa4, 0xb4, 0xac, 0xbc}, {"r_op", "_ldy", "ctl"})

-- store instructions
op({0x85, 0x95, 0x8d, 0x9d, 0x99, 0x81, 0x91}, {"w_op", "_sta", "alu"})
op({0x86, 0x96, 0x8e}, {"w_op", "_stx", "rmw"})
op({0x84, 0x94, 0x8c}, {"w_op", "_sty", "ctl"})

-- transfer instructions
op({0xaa}, "_tax")
op({0xa8}, "_tay")
op({0x8a}, "_txa")
op({0x98}, "_tya")
-- flow control instructions
op({0x4c}, "_jmp_a")
op({0x6c}, "_jmp_i")
op({0x20}, "_jsr")
op({0x60}, "_rts")
op({0x40}, "_rti")
op({0xd0}, "_bne")
op({0xf0}, "_beq")
op({0x30}, "_bmi")
op({0x10}, "_bpl")
op({0xb0}, "_bcs")
op({0x90}, "_bcc")
op({0x70}, "_bvs")
op({0x50}, "_bvc")

-- math operations
op({0x69, 0x65, 0x75, 0x6d, 0x7d, 0x79, 0x61, 0x71}, {"r_op", "_adc", "alu"})
op({0xe9, 0xeb, 0xe5, 0xf5, 0xed, 0xfd, 0xf9, 0xe1, 0xf1}, {"r_op", "_sbc", "alu"})

-- logical operations
op({0x29, 0x25, 0x35, 0x2d, 0x3d, 0x39, 0x21, 0x31}, {"r_op", "_and", "alu"})
op({0x09, 0x05, 0x15, 0x0d, 0x1d, 0x19, 0x01, 0x11}, {"r_op", "_ora", "alu"})
op({0x49, 0x45, 0x55, 0x4d, 0x5d, 0x59, 0x41, 0x51}, {"r_op", "_eor", "alu"})
op({0x24, 0x2c}, {"r_op", "_bit", "alu"})
op({0xc9, 0xc5, 0xd5, 0xcd, 0xdd, 0xd9, 0xc1, 0xd1}, {"r_op", "_cmp", "alu"})
op({0xe0, 0xe4, 0xec}, {"r_op", "_cpx", "rmw"})
op({0xc0, 0xc4, 0xcc}, {"r_op", "_cpy", "rmw"})

-- shift operations
op({0x0a}, {"a_op", "_asl"})
op({0x06, 0x16, 0x0e, 0x1e}, {"rw_op", "_asl", "alu"})
op({0x4a}, {"a_op", "_lsr"})
op({0x46, 0x56, 0x4e, 0x5e}, {"rw_op", "_lsr", "alu"})
op({0x2a}, {"a_op", "_rol"})
op({0x26, 0x36, 0x2e, 0x3e}, {"rw_op", "_rol", "alu"})
op({0x6a}, {"a_op", "_ror"})
op({0x66, 0x76, 0x6e, 0x7e}, {"rw_op", "_ror", "alu"})

-- increment and decrement operations
op({0xc6, 0xd6, 0xce, 0xde}, {"rw_op", "_dec", "alu"})
op({0xe6, 0xf6, 0xee, 0xfe}, {"rw_op", "_inc", "alu"})
op({0xca}, "_dex")
op({0x88}, "_dey")
op({0xe8}, "_inx")
op({0xc8}, "_iny")

-- flags instructions
op({0x18}, "_clc")
op({0x38}, "_sec")
op({0xd8}, "_cld")
op({0xf8}, "_sed")
op({0x58}, "_cli")
op({0x78}, "_sei")
op({0xb8}, "_clv")

-- stack operations
op({0x48}, "_pha")
op({0x08}, "_php")
op({0x68}, "_pla")
op({0x28}, "_plp")
op({0xba}, "_tsx")
op({0x9a}, "_txs")

-- undocumented instructions, rarely used
op({0x0b, 0x2b}, {"r_op", "_anc", "uno"})
op({0x8b}, {"r_op", "_ane", "uno"})
op({0x6b}, {"r_op", "_arr", "uno"})
op({0x4b}, {"r_op", "_asr", "uno"})
op({0xc7, 0xd7, 0xc3, 0xd3, 0xcf, 0xdf, 0xdb}, {"rw_op", "_dcp", "alu"})
op({0xe7, 0xf7, 0xef, 0xff, 0xfb, 0xe3, 0xf3}, {"rw_op", "_isb", "alu"})
op({0xbb}, {"r_op", "_las", "uno"})
op({0xa7, 0xb7, 0xaf, 0xbf, 0xa3, 0xb3}, {"r_op", "_lax", "uno"})
op({0xab}, {"r_op", "_lxa", "uno"})
op({0x27, 0x37, 0x2f, 0x3f, 0x3b, 0x23, 0x33}, {"rw_op", "_rla", "alu"})
op({0x67, 0x77, 0x6f, 0x7f, 0x7b, 0x63, 0x73}, {"rw_op", "_rra", "alu"})
op({0x87, 0x97, 0x8f, 0x83}, {"w_op", "_sax", "uno"})
op({0xcb}, {"r_op", "_sbx", "uno"})
op({0x9f, 0x93}, {"w_op", "_sha", "uno"})
op({0x9b}, {"w_op", "_shs", "uno"})
op({0x9e}, {"w_op", "_shx", "rmw"})
op({0x9c}, {"w_op", "_shy", "ctl"})
op({0x07, 0x17, 0x0f, 0x1f, 0x1b, 0x03, 0x13}, {"rw_op", "_slo", "alu"})
op({0x47, 0x57, 0x4f, 0x5f, 0x5b, 0x43, 0x53}, {"rw_op", "_sre", "alu"})

-- nops
op({0x1a, 0x3a, 0x5a, 0x7a, 0xda, 0xea, 0xfa}, {"no_op", "_nop", 0, 2})
op({0x80, 0x82, 0x89, 0xc2, 0xe2}, {"no_op", "_nop", 1, 2})
op({0x04, 0x44, 0x64}, {"no_op", "_nop", 1, 3})
op({0x14, 0x34, 0x54, 0x74, 0xd4, 0xf4}, {"no_op", "_nop", 1, 4})
op({0x0c}, {"no_op", "_nop", 2, 4})
op({0x1c, 0x3c, 0x5c, 0x7c, 0xdc, 0xfc}, {"r_op", "_nop", "ctl"})
op({0x00}, "_brk")
op({0x02, 0x12, 0x22, 0x32, 0x42, 0x52, 0x62, 0x72, 0x92, 0xb2, 0xd2, 0xf2}, "_jam")
--[[
  --This aims to "cache" unpack (Maybe also "cache" self and op indexing?)
CPU.DISPATCHER = {}
for k, v in pairs(CPU.DISPATCH) do
  local op = v[1]
  local cacheF
  if #v == 2 then
    local a = unpack(v, 2)
    cacheF = function(self)
      self[op](self, a)
    end
  elseif #v == 1 then
    cacheF = function(self)
      self[op](self)
    end
  elseif #v == 3 then
    local a, b = unpack(v, 2)
    cacheF = function(self)
      self[op](self, a, b)
    end
  elseif #v == 4 then
    local a, b, c = unpack(v, 2)
    cacheF = function(self)
      self[op](self, a, b, c)
    end
  elseif #v == 5 then
    local a, b, c, d = unpack(v, 2)
    cacheF = function(self)
      self[op](self, a, b, c, d)
    end
  end
  CPU.DISPATCHER[k] = cacheF
end
]]

return CPU
local serpent =  require "nes.libs.serpent"
local UTILS = require("nes.utils")
local CPU = require("nes.cpu")
local PPU = require("nes.ppu")
local APU = require("nes.apu")
local ROM = require("nes.rom")
local PALETTE = require("nes.palette")
local PADS = require("nes.pads")

local band, bor, bxor, bnot, lshift, rshift = bit.band, bit.bor, bit.bxor, bit.bnot, bit.lshift, bit.rshift
local map, rotatePositiveIdx, nthBitIsSet, nthBitIsSetInt =
    UTILS.map,
    UTILS.rotatePositiveIdx,
    UTILS.nthBitIsSet,
    UTILS.nthBitIsSetInt

local NES = {}
NES._mt = {__index = NES}

function NES:reset()
    self.audio, self.video, self.input = {spec = {}}, {palette = {}}, {}

    local cpu = self.cpu
    cpu:reset()
    cpu.apu:reset(self.audio.spec)
    cpu.ppu:reset()
    self.rom:reset()
    self.pads:reset()
    cpu:boot()
    self.rom:load_battery()
end
function NES:run_once()
    self.cpu.ppu:setup_frame()
    self.cpu:run()
    self.cpu.ppu:vsync()
    --print "ppu vsync"
    --print(self.cpu.clk)
    self.cpu.apu:vsync()
    --print "apu vsync"
    --print(self.cpu.clk)
    self.cpu:vsync()
    self.rom:vsync()

    self.frame = self.frame + 1
end
function NES:run(counter)
    self:reset()
    if not counter then
        while true do
            self:run_once()
        end
    end
    local acum = 0
    while acum < counter do
        self:run_once()
        acum = acum + 1
    end
end
function NES:new(opts)
    opts = opts or {}
    local conf = {romfile = opts.file, pc = opts.pc or nil, loglevel = opts.loglevel or 0}
    local nes = {}
    local palette = opts.palette or PALETTE:defacto_palette()
    setmetatable(nes, NES._mt)
    nes.cpu = CPU:new(conf)
    nes.cpu.apu = APU:new(conf, nes.cpu)
    --[[
        clock_dma = function(clk)
        end,
        reset = function()
        end,
        vsync = function()
        end,
        do_clock = function()
            return CPU.CLK[1]
        end
    }
    ]]
    --[[
    nes.cpu.ppu = {
        reset = function()
        end,
        vsync = function()
        end,
        setup_frame = function()
        end,
        sync = function(clk)
        end
    }
    --]]
    nes.cpu.ppu = PPU:new(conf, nes.cpu, palette)
    nes.pads = {
        reset = function()
        end
    }
    nes.rom = ROM.load(conf, nes.cpu, nes.cpu.ppu)
    nes.pads = PADS:new(conf, nes.cpu, nes.cpu.apu)

    nes.frame = 0
    nes.frame_target = nil
    return nes
end

return NES
local UTILS = require("nes.utils")

local band, bor, bxor, bnot, lshift, rshift = bit.band, bit.bor, bit.bxor, bit.bnot, bit.lshift, bit.rshift
local map, rotatePositiveIdx, nthBitIsSet, nthBitIsSetInt =
  UTILS.map,
  UTILS.rotatePositiveIdx,
  UTILS.nthBitIsSet,
  UTILS.nthBitIsSetInt

local Pad = nil

local Pads = {}
Pads._mt = {__index = Pads}
function Pads:new(conf, cpu, apu)
  local pads = {}
  setmetatable(pads, Pads._mt)
  pads:initialize(conf, cpu, apu)
  return pads
end
function Pads:initialize(conf, cpu, apu)
  self.conf = conf
  self.cpu = cpu
  self.apu = apu
  self.pads = {Pad:new(), Pad:new()}
end

function Pads:reset()
  self.cpu:add_mappings(0x4016, UTILS.bind(self.peek_401x, self), UTILS.bind(self.poke_4016, self))
  self.cpu:add_mappings(0x4017, UTILS.bind(self.peek_401x, self), UTILS.bind(self.apu.poke_4017, self.apu)) -- delegate 4017H to APU
  self.pads[1]:reset()
  self.pads[2]:reset()
end

function Pads:peek_401x(addr)
  self.cpu:update()
  return bor(self.pads[addr - 0x4016 + 1]:peek(), 0x40)
end

function Pads:poke_4016(_addr, data)
  self.pads[1]:poke(data)
  self.pads[2]:poke(data)
end

-- APIs

function Pads:keydown(pad, btn)
  self.pads[pad].buttons = bor(self.pads[pad].buttons, lshift(1, btn))
end

function Pads:keyup(pad, btn)
  self.pads[pad].buttons = band(self.pads[pad].buttons, bnot(lshift(1, btn)))
end

-- each pad
Pad = UTILS.class()
Pad.A = 0
Pad.B = 1
Pad.SELECT = 2
Pad.START = 3
Pad.UP = 4
Pad.DOWN = 5
Pad.LEFT = 6
Pad.RIGHT = 7

Pads.Pad = Pad

function Pad:initialize()
  self:reset()
end

function Pad:reset()
  self.strobe = false
  self.buttons = 0
  self.stream = 0
end

function Pad:poke(data)
  local prev = self.strobe
  self.strobe = nthBitIsSetInt(data, 0) == 1
  if prev and not self.strobe then
    self.stream = bxor(lshift(self:poll_state(), 1), -512)
  end
end

function Pad:peek()
  if self.strobe then
    return band(self:poll_state(), 1)
  end
  self.stream = rshift(self.stream, 1)
  return nthBitIsSetInt(self.stream, 0)
end

function Pad:poll_state()
  local state = self.buttons

  -- prohibit impossible simultaneous keydown (right and left, up and down)
  -- 0b00110000
  if band(state, 0x30) == 0x30 then
    state = band(state, 0xff - 0x30)
  end
  --0b00111111
  if band(state, 0xc0) == 0xc0 then
    state = band(state, 0xff - 0xc0)
  end

  return state
end

return Pads
local clock = os.clock
local getinfo = debug.getinfo
local sethook = debug.sethook
local sort = table.sort
local format = string.format
local len = string.len
local rep = string.rep
local sub = string.sub
local concat = table.concat

local profile = {}

-- filter non-hooked functions
local _filter = nil
-- user-hooked functions
local _hooked = {}
-- function labels
local _labeled = {}
-- function definitions
local _defined = {}
-- time of last call
local _tcalled = {}
-- total execution time
local _telapsed = {}
-- number of calls
local _ncalls = {}
-- recursion counter
local _rcount = {}
-- list of internal profiler functions
local _internal = {}

local function _hooker(event)
    local info = getinfo(2, "nfS")
    -- function address
    local f = info.func
    -- ignore if not hooked
    if _filter then
        if _filter == "hooked" then
            if not _hooked[f] then
                return
            end
        elseif _filter == "internal" then
            if not _internal[f] then
                return
            end
        elseif _filter ~= info.what then
            return
        end
    end
    -- ignore if explicitly unhooked
    if _hooked[f] == false then
        return
    end
    -- grab the function name and line definition
    if not _labeled[f] then
        _labeled[f] = info.name
        if not _defined[f] then
            _defined[f] = format("%s:%s", info.short_src, info.linedefined)
            _ncalls[f] = 0
            _rcount[f] = 0
            _telapsed[f] = 0
        end
    end
    -- count the number of calls and execution time
    if event == "call" then
        -- call time, ignoring recursion
        if not _tcalled[f] then
            _tcalled[f] = clock()
        end
        _rcount[f] = _rcount[f] + 1
        _ncalls[f] = _ncalls[f] + 1
    elseif event == "return" then
        -- elapsed time
        local rc = _rcount[f]
        if rc then
            -- last return, including recursion
            if rc == 1 and _tcalled[f] then
                local c = clock()
                local dt = c - _tcalled[f]
                _telapsed[f] = _telapsed[f] + dt
                _tcalled[f] = nil
            end
            if rc > 0 then
                _rcount[f] = rc - 1
            end
        end
    end
end

local _i, _i2 = 0, 0
local _f = {}
local function _iterator()
    if _i == _i2 then
        return
    end
    local f = _f[_i]
    _i = _i - 1
    local d = _defined[f]
    return _labeled[f] or d, _ncalls[f] or 0, _telapsed[f] or 0, d
end

local _fs, _fs2 = nil, nil
local function _comp(a, b)
    if _fs[a] == _fs[b] then
        return _fs2[a] < _fs2[b]
    end
    return _fs[a] < _fs[b]
end

--- Sets a clock function to be used by the profiler.
-- @param f Clock function that returns a number
function profile.setclock(f)
    assert(type(f) == "function", "clock must be a function")
    clock = f
end

--- Starts collecting data.
function profile.start()
    sethook(_hooker, "cr")
end

--- Stops collecting data.
function profile.stop()
    sethook()
    local t1 = clock()
    for f, t2 in pairs(_tcalled) do
        local dt = t1 - t2
        _telapsed[f] = _telapsed[f] + dt
        _tcalled[f] = nil
    end
    for k in pairs(_rcount) do
        _rcount[k] = 0
    end
    collectgarbage("collect")
end

--- Resets all collected data.
function profile.reset()
    for k in pairs(_ncalls) do
        _ncalls[k] = 0
    end
    for f in pairs(_tcalled) do
        _tcalled[f] = nil
    end
    for k in pairs(_telapsed) do
        _telapsed[k] = 0
    end
    for k in pairs(_rcount) do
        _rcount[k] = 0
    end
    collectgarbage("collect")
end

-- Combines data generated by closures, should be called prior to queries
function profile.combine()
    local lookup = {}
    for f, d in pairs(_defined) do
        local id = (_labeled[f] or "?") .. d
        local f2 = lookup[id]
        if f2 then
            _ncalls[f2] = _ncalls[f2] + (_ncalls[f] or 0)
            _telapsed[f2] = _telapsed[f2] + (_telapsed[f] or 0)
            _defined[f], _labeled[f] = nil, nil
            _ncalls[f], _telapsed[f] = nil, nil
        else
            lookup[id] = f
        end
    end
end

--- Collects data for a given function.
-- @param f Function
-- @param fn Function name or label
function profile.hook(f, fn)
    assert(type(f) == "function", "cannot hook a non-function")
    assert(fn == nil or type(fn) == "string", "function label must be a string")
    local info = getinfo(f, "nS")
    _hooked[f] = true
    _labeled[f] = fn or info.name
    if not _defined[f] then
        _defined[f] = format("%s:%s", info.short_src, info.linedefined)
        _ncalls[f] = 0
        _rcount[f] = 0
        _telapsed[f] = 0
    end
    fn = info.name
    _filter = "hooked"
end

--- Ignores data for a given function.
-- @param f Function
function profile.unhook(f)
    assert(type(f) == "function", "cannot unhook a non-function")
    _hooked[f] = false
    _labeled[f] = nil
end

--- Collects data for functions of a given type.
-- @param what Type of functions to profile, could be "Lua", "C", "hooked" or "internal" (optional)
function profile.hookall(what)
    _filter = what
    if what == "internal" then
        for f in pairs(_internal) do
            profile.hook(f)
        end
    end
end

--- Iterates all functions that have been called since the profile was started.
-- @param s Type of sorting, could be by "call" or "time" (optional)
-- @param n Number of results (optional)
function profile.query(s, n)
    _fs, _fs2 = _ncalls, _telapsed
    if s == "time" then
        _fs, _fs2 = _fs2, _fs
    end
    for i = #_f, 1, -1 do
        _f[i] = nil
    end
    for f in pairs(_ncalls) do
        _f[#_f + 1] = f
    end
    sort(_f, _comp)
    _i = #_f
    _i2 = 0
    if n and _i > n then
        _i2 = _i - n
    end
    -- todo: check for nested queries
    return _iterator
end

local function expand(s, l2)
    s = tostring(s)
    local l1 = len(s)
    if l1 < l2 then
        s = s .. rep(" ", l2 - l1)
    elseif l1 > l2 then
        s = sub(s, l1 - l2 + 1, l1)
    end
    return s
end

local function pretty(t)
    local c = {3, 32, 8, 24, 32}
    for i = 1, #t do
        if type(t[i] == "table") then
            for j = 1, 5 do
                t[i][j] = expand(t[i][j], c[j])
            end
            t[i] = concat(t[i], " | ")
        end
    end
    local row =
        " +-----+----------------------------------+----------+--------------------------+----------------------------------+ \n"
    local col =
        " | #   | Function                         | Calls    | Time                     | Code                             | \n"
    local out = row .. col .. row
    if #t > 0 then
        out = out .. " | " .. concat(t, " | \n | ") .. " | \n"
    end
    out = out .. row
    return out
end

function profile.report(s, n)
    local i = 0
    local out = {}
    for f, c, t, d in profile.query(s, n) do
        i = i + 1
        out[i] = {i, f, c, t, d}
    end
    return "Profilling report:\n" .. pretty(out)
end

-- store all internal profiler functions
for k, v in pairs(profile) do
    if type(v) == "function" then
        _internal[v] = true
    end
end
_internal[_iterator] = true
_internal[_comp] = true
_internal[sethook] = true
_internal[getinfo] = true
_internal[expand] = true
_internal[pretty] = true

-- don't remove unless you want to profile the profiler
for f in pairs(_internal) do
    profile.unhook(f)
end

return profile
local n, v = "serpent", "0.302" -- (C) 2012-18 Paul Kulchenko; MIT License
local c, d = "Paul Kulchenko", "Lua serializer and pretty printer"
local snum = {
    [tostring(1 / 0)] = "1/0 --[[math.huge]]",
    [tostring(-1 / 0)] = "-1/0 --[[-math.huge]]",
    [tostring(0 / 0)] = "0/0"
}
local badtype = {thread = true, userdata = true, cdata = true}
local getmetatable = debug and debug.getmetatable or getmetatable
local pairs = function(t)
    return next, t
end -- avoid using __pairs in Lua 5.2+
local keyword, globals, G = {}, {}, (_G or _ENV)
for _, k in ipairs(
    {
        "and",
        "break",
        "do",
        "else",
        "elseif",
        "end",
        "false",
        "for",
        "function",
        "goto",
        "if",
        "in",
        "local",
        "nil",
        "not",
        "or",
        "repeat",
        "return",
        "then",
        "true",
        "until",
        "while"
    }
) do
    keyword[k] = true
end
for k, v in pairs(G) do
    globals[v] = k
end -- build func to name mapping
for _, g in ipairs({"coroutine", "debug", "io", "math", "string", "table", "os"}) do
    for k, v in pairs(type(G[g]) == "table" and G[g] or {}) do
        globals[v] = g .. "." .. k
    end
end

local function s(t, opts)
    local name, indent, fatal, maxnum = opts.name, opts.indent, opts.fatal, opts.maxnum
    local sparse, custom, huge = opts.sparse, opts.custom, not opts.nohuge
    local space, maxl = (opts.compact and "" or " "), (opts.maxlevel or math.huge)
    local maxlen, metatostring = tonumber(opts.maxlength), opts.metatostring
    local iname, comm = "_" .. (name or ""), opts.comment and (tonumber(opts.comment) or math.huge)
    local numformat = opts.numformat or "%.17g"
    local seen, sref, syms, symn = {}, {"local " .. iname .. "={}"}, {}, 0
    local function gensym(val)
        return "_" ..
            (tostring(tostring(val)):gsub("[^%w]", ""):gsub(
                "(%d%w+)",
                -- tostring(val) is needed because __tostring may return a non-string value
                function(s)
                    if not syms[s] then
                        symn = symn + 1
                        syms[s] = symn
                    end
                    return tostring(syms[s])
                end
            ))
    end
    local function safestr(s)
        return type(s) == "number" and tostring(huge and snum[tostring(s)] or numformat:format(s)) or
            type(s) ~= "string" and tostring(s) or -- escape NEWLINE/010 and EOF/026
            ("%q"):format(s):gsub("\010", "n"):gsub("\026", "\\026")
    end
    local function comment(s, l)
        return comm and (l or 0) < comm and " --[[" .. select(2, pcall(tostring, s)) .. "]]" or ""
    end
    local function globerr(s, l)
        return globals[s] and globals[s] .. comment(s, l) or not fatal and safestr(select(2, pcall(tostring, s))) or
            error("Can't serialize " .. tostring(s))
    end
    local function safename(path, name) -- generates foo.bar, foo[3], or foo['b a r']
        local n = name == nil and "" or name
        local plain = type(n) == "string" and n:match("^[%l%u_][%w_]*$") and not keyword[n]
        local safe = plain and n or "[" .. safestr(n) .. "]"
        return (path or "") .. (plain and path and "." or "") .. safe, safe
    end
    local alphanumsort =
        type(opts.sortkeys) == "function" and opts.sortkeys or
        function(k, o, n) -- k=keys, o=originaltable, n=padding
            local maxn, to = tonumber(n) or 12, {number = "a", string = "b"}
            local function padnum(d)
                return ("%0" .. tostring(maxn) .. "d"):format(tonumber(d))
            end
            table.sort(
                k,
                function(a, b)
                    -- sort numeric keys first: k[key] is not nil for numerical keys
                    return (k[a] ~= nil and 0 or to[type(a)] or "z") .. (tostring(a):gsub("%d+", padnum)) <
                        (k[b] ~= nil and 0 or to[type(b)] or "z") .. (tostring(b):gsub("%d+", padnum))
                end
            )
        end
    local function val2str(t, name, indent, insref, path, plainindex, level)
        local ttype, level, mt = type(t), (level or 0), getmetatable(t)
        local spath, sname = safename(path, name)
        local tag =
            plainindex and ((type(name) == "number") and "" or name .. space .. "=" .. space) or
            (name ~= nil and sname .. space .. "=" .. space or "")
        if seen[t] then -- already seen this element
            sref[#sref + 1] = spath .. space .. "=" .. space .. seen[t]
            return tag .. "nil" .. comment("ref", level)
        end
        -- protect from those cases where __tostring may fail
        if type(mt) == "table" and metatostring ~= false then
            local to, tr =
                pcall(
                function()
                    return mt.__tostring(t)
                end
            )
            local so, sr =
                pcall(
                function()
                    return mt.__serialize(t)
                end
            )
            if (to or so) then -- knows how to serialize itself
                seen[t] = insref or spath
                t = so and sr or tr
                ttype = type(t)
            end -- new value falls through to be serialized
        end
        if ttype == "table" then
            if level >= maxl then
                return tag .. "{}" .. comment("maxlvl", level)
            end
            seen[t] = insref or spath
            if next(t) == nil then
                return tag .. "{}" .. comment(t, level)
            end -- table empty
            if maxlen and maxlen < 0 then
                return tag .. "{}" .. comment("maxlen", level)
            end
            local maxn, o, out = math.min(#t, maxnum or #t), {}, {}
            for key = 1, maxn do
                o[key] = key
            end
            if not maxnum or #o < maxnum then
                local n = #o -- n = n + 1; o[n] is much faster than o[#o+1] on large tables
                for key in pairs(t) do
                    if o[key] ~= key then
                        n = n + 1
                        o[n] = key
                    end
                end
            end
            if maxnum and #o > maxnum then
                o[maxnum + 1] = nil
            end
            if opts.sortkeys and #o > maxn then
                alphanumsort(o, t, opts.sortkeys)
            end
            local sparse = sparse and #o > maxn -- disable sparsness if only numeric keys (shorter output)
            for n, key in ipairs(o) do
                local value, ktype, plainindex = t[key], type(key), n <= maxn and not sparse
                if
                    opts.valignore and opts.valignore[value] or -- skip ignored values; do nothing
                        opts.keyallow and not opts.keyallow[key] or
                        opts.keyignore and opts.keyignore[key] or
                        opts.valtypeignore and opts.valtypeignore[type(value)] or -- skipping ignored value types
                        sparse and value == nil
                 then -- skipping nils; do nothing
                elseif ktype == "table" or ktype == "function" or badtype[ktype] then
                    if not seen[key] and not globals[key] then
                        sref[#sref + 1] = "placeholder"
                        local sname = safename(iname, gensym(key)) -- iname is table for local variables
                        sref[#sref] = val2str(key, sname, indent, sname, iname, true)
                    end
                    sref[#sref + 1] = "placeholder"
                    local path = seen[t] .. "[" .. tostring(seen[key] or globals[key] or gensym(key)) .. "]"
                    sref[#sref] =
                        path .. space .. "=" .. space .. tostring(seen[value] or val2str(value, nil, indent, path))
                else
                    out[#out + 1] = val2str(value, key, indent, nil, seen[t], plainindex, level + 1)
                    if maxlen then
                        maxlen = maxlen - #out[#out]
                        if maxlen < 0 then
                            break
                        end
                    end
                end
            end
            local prefix = string.rep(indent or "", level)
            local head = indent and "{\n" .. prefix .. indent or "{"
            local body = table.concat(out, "," .. (indent and "\n" .. prefix .. indent or space))
            local tail = indent and "\n" .. prefix .. "}" or "}"
            return (custom and custom(tag, head, body, tail, level) or tag .. head .. body .. tail) .. comment(t, level)
        elseif badtype[ttype] then
            seen[t] = insref or spath
            return tag .. globerr(t, level)
        elseif ttype == "function" then
            seen[t] = insref or spath
            if opts.nocode then
                return tag .. "function() --[[..skipped..]] end" .. comment(t, level)
            end
            local ok, res = pcall(string.dump, t)
            local func = ok and "((loadstring or load)(" .. safestr(res) .. ",'self.serialized'))" .. comment(t, level)
            return tag .. (func or globerr(t, level))
        else
            return tag .. safestr(t)
        end -- handle all other types
    end
    local sepr = indent and "\n" or ";" .. space
    local body = val2str(t, name, indent) -- this call also populates sref
    local tail = #sref > 1 and table.concat(sref, sepr) .. sepr or ""
    local warn =
        opts.comment and #sref > 1 and space .. "--[[incomplete output with shared/self-references skipped]]" or ""
    return not name and body .. warn or "do local " .. body .. sepr .. tail .. "return " .. name .. sepr .. "end"
end

local function deserialize(data, opts)
    local env =
        (opts and opts.safe == false) and G or
        setmetatable(
            {},
            {
                __index = function(t, k)
                    return t
                end,
                __call = function(t, ...)
                    error("cannot call functions")
                end
            }
        )
    local f, res = (loadstring or load)("return " .. data, nil, nil, env)
    if not f then
        f, res = (loadstring or load)(data, nil, nil, env)
    end
    if not f then
        return f, res
    end
    if setfenv then
        setfenv(f, env)
    end
    return pcall(f)
end

local function merge(a, b)
    if b then
        for k, v in pairs(b) do
            a[k] = v
        end
    end
    return a
end
return {
    _NAME = n,
    _COPYRIGHT = c,
    _DESCRIPTION = d,
    _VERSION = v,
    serialize = s,
    load = deserialize,
    dump = function(a, opts)
        return s(a, merge({name = "_", compact = true, sparse = true}, opts))
    end,
    line = function(a, opts)
        return s(a, merge({sortkeys = true, comment = true}, opts))
    end,
    block = function(a, opts)
        return s(a, merge({indent = "  ", sortkeys = true, comment = true}, opts))
    end
}
--[[
 
LUA MODULE
 
   complex v$(_VERSION) - complex numbers implemented as Lua tables
 
SYNOPSIS

  local complex = require 'complex'
  local cx1 = complex "2+3i" -- or complex.new(2, 3) 
  local cx2 = complex "3+2i"
  assert( complex.add(cx1,cx2) == complex "5+5i" )
  assert( tostring(cx1) == "2+3i" )
 
DESCRIPTION
 
  'complex' provides common tasks with complex numbers

   function complex.to( arg ); complex( arg )
   returns a complex number on success, nil on failure
   arg := number or { number,number } or ( "(-)<number>" and/or "(+/-)<number>i" )
      e.g. 5; {2,3}; "2", "2+i", "-2i", "2^2*3+1/3i"
      note: 'i' is always in the numerator, spaces are not allowed

  A complex number is defined as Cartesian complex number
  complex number := { real_part, imaginary_part } .
  This gives fast access to both parts of the number for calculation.
  The access is faster than in a hash table
  The metatable is just an add on.  When it comes to speed, one is faster using a direct function call.

API

  See code and test_complex.lua.

DEPENDENCIES

  None (other than Lua 5.1 or 5.2).
  
HOME PAGE
  
  http://luamatrix.luaforge.net
  http://lua-users.org/wiki/LuaMatrix

DOWNLOAD/INSTALL

  ./util.mk
  cd tmp/*
  luarocks make
  
 Licensed under the same terms as Lua itself.
 
  Developers:
    Michael Lutz (chillcode)
    David Manura http://lua-users.org/wiki/DavidManura (maintainer)
--]]
--/////////////--
--// complex //--
--/////////////--

-- link to complex table
local complex = {_TYPE = "module", _NAME = "complex", _VERSION = "0.3.3.20111212"}

-- link to complex metatable
local complex_meta = {}

-- helper functions for parsing complex number strings.
local function parse_scalar(s, pos0)
    local x, n, pos = s:match("^([+-]?[%d%.]+)(.?)()", pos0)
    if not x then
        return
    end
    if n == "e" or n == "E" then
        local x2, n2, pos2 = s:match("^([+-]?%d+)(.?)()", pos)
        if not x2 then
            error "number format error"
        end
        x = tonumber(x .. n .. x2)
        if not x then
            error "number format error"
        end
        return x, n2, pos2
    else
        x = tonumber(x)
        if not x then
            error "number format error"
        end
        return x, n, pos
    end
end
local function parse_component(s, pos0)
    local x, n, pos = parse_scalar(s, pos0)
    if not x then
        local x2, n2, pos2 = s:match("^([+-]?)(i)()$", pos0)
        if not x2 then
            error "number format error"
        end
        return (x2 == "-" and -1 or 1), n2, pos2
    end
    if n == "/" then
        local x2, n2, pos2 = parse_scalar(s, pos)
        x = x / x2
        return x, n2, pos2
    end
    return x, n, pos
end
local function parse_complex(s)
    local x, n, pos = parse_component(s, 1)
    if n == "+" or n == "-" then
        local x2, n2, pos2 = parse_component(s, pos)
        if n2 ~= "i" or pos2 ~= #s + 1 then
            error "number format error"
        end
        if n == "-" then
            x2 = -x2
        end
        return x, x2
    elseif n == "" then
        return x, 0
    elseif n == "i" then
        if pos ~= #s + 1 then
            error "number format error"
        end
        return 0, x
    else
        error "number format error"
    end
end

-- complex.to( arg )
-- return a complex number on success
-- return nil on failure
function complex.to(num)
    -- check for table type
    if type(num) == "table" then
        -- check for a complex number
        if getmetatable(num) == complex_meta then
            return num
        end
        local real, imag = tonumber(num[1]), tonumber(num[2])
        if real and imag then
            return setmetatable({real, imag}, complex_meta)
        end
        return
    end
    -- check for number
    local isnum = tonumber(num)
    if isnum then
        return setmetatable({isnum, 0}, complex_meta)
    end
    if type(num) == "string" then
        local real, imag = parse_complex(num)
        return setmetatable({real, imag}, complex_meta)
    end
end

-- complex( arg )
-- same as complex.to( arg )
-- set __call behaviour of complex
setmetatable(
    complex,
    {__call = function(_, num)
            return complex.to(num)
        end}
)

-- complex.new( real, complex )
-- fast function to get a complex number, not invoking any checks
function complex.new(...)
    return setmetatable({...}, complex_meta)
end

-- complex.type( arg )
-- is argument of type complex
function complex.type(arg)
    if getmetatable(arg) == complex_meta then
        return "complex"
    end
end

-- complex.convpolar( r, phi )
-- convert polar coordinates ( r*e^(i*phi) ) to carthesic complex number
-- r (radius) is a number
-- phi (angle) must be in radians; e.g. [0 - 2pi]
function complex.convpolar(radius, phi)
    return setmetatable({radius * math.cos(phi), radius * math.sin(phi)}, complex_meta)
end

-- complex.convpolardeg( r, phi )
-- convert polar coordinates ( r*e^(i*phi) ) to carthesic complex number
-- r (radius) is a number
-- phi must be in degrees; e.g. [0 - 360 deg]
function complex.convpolardeg(radius, phi)
    phi = phi / 180 * math.pi
    return setmetatable({radius * math.cos(phi), radius * math.sin(phi)}, complex_meta)
end

--// complex number functions only

-- complex.tostring( cx [, formatstr] )
-- to string or real number
-- takes a complex number and returns its string value or real number value
function complex.tostring(cx, formatstr)
    local real, imag = cx[1], cx[2]
    if formatstr then
        if imag == 0 then
            return string.format(formatstr, real)
        elseif real == 0 then
            return string.format(formatstr, imag) .. "i"
        elseif imag > 0 then
            return string.format(formatstr, real) .. "+" .. string.format(formatstr, imag) .. "i"
        end
        return string.format(formatstr, real) .. string.format(formatstr, imag) .. "i"
    end
    if imag == 0 then
        return real
    elseif real == 0 then
        return ((imag == 1 and "") or (imag == -1 and "-") or imag) .. "i"
    elseif imag > 0 then
        return real .. "+" .. (imag == 1 and "" or imag) .. "i"
    end
    return real .. (imag == -1 and "-" or imag) .. "i"
end

-- complex.print( cx [, formatstr] )
-- print a complex number
function complex.print(...)
    print(complex.tostring(...))
end

-- complex.polar( cx )
-- from complex number to polar coordinates
-- output in radians; [-pi,+pi]
-- returns r (radius), phi (angle)
function complex.polar(cx)
    return math.sqrt(cx[1] ^ 2 + cx[2] ^ 2), math.atan2(cx[2], cx[1])
end

-- complex.polardeg( cx )
-- from complex number to polar coordinates
-- output in degrees; [-180, 180 deg]
-- returns r (radius), phi (angle)
function complex.polardeg(cx)
    return math.sqrt(cx[1] ^ 2 + cx[2] ^ 2), math.atan2(cx[2], cx[1]) / math.pi * 180
end

-- complex.norm2( cx )
-- multiply with conjugate, function returning a scalar number
-- norm2(x + i*y) returns x^2 + y^2
function complex.norm2(cx)
    return cx[1] ^ 2 + cx[2] ^ 2
end

-- complex.abs( cx )
-- get the absolute value of a complex number
function complex.abs(cx)
    return math.sqrt(cx[1] ^ 2 + cx[2] ^ 2)
end

-- complex.get( cx )
-- returns real_part, imaginary_part
function complex.get(cx)
    return cx[1], cx[2]
end

-- complex.set( cx, real, imag )
-- sets real_part = real and imaginary_part = imag
function complex.set(cx, real, imag)
    cx[1], cx[2] = real, imag
end

-- complex.is( cx, real, imag )
-- returns true if, real_part = real and imaginary_part = imag
-- else returns false
function complex.is(cx, real, imag)
    if cx[1] == real and cx[2] == imag then
        return true
    end
    return false
end

--// functions returning a new complex number

-- complex.copy( cx )
-- copy complex number
function complex.copy(cx)
    return setmetatable({cx[1], cx[2]}, complex_meta)
end

-- complex.add( cx1, cx2 )
-- add two numbers; cx1 + cx2
function complex.add(cx1, cx2)
    return setmetatable({cx1[1] + cx2[1], cx1[2] + cx2[2]}, complex_meta)
end

-- complex.sub( cx1, cx2 )
-- subtract two numbers; cx1 - cx2
function complex.sub(cx1, cx2)
    return setmetatable({cx1[1] - cx2[1], cx1[2] - cx2[2]}, complex_meta)
end

-- complex.mul( cx1, cx2 )
-- multiply two numbers; cx1 * cx2
function complex.mul(cx1, cx2)
    return setmetatable({cx1[1] * cx2[1] - cx1[2] * cx2[2], cx1[1] * cx2[2] + cx1[2] * cx2[1]}, complex_meta)
end

-- complex.mulnum( cx, num )
-- multiply complex with number; cx1 * num
function complex.mulnum(cx, num)
    return setmetatable({cx[1] * num, cx[2] * num}, complex_meta)
end

-- complex.div( cx1, cx2 )
-- divide 2 numbers; cx1 / cx2
function complex.div(cx1, cx2)
    -- get complex value
    local val = cx2[1] ^ 2 + cx2[2] ^ 2
    -- multiply cx1 with conjugate complex of cx2 and divide through val
    return setmetatable(
        {(cx1[1] * cx2[1] + cx1[2] * cx2[2]) / val, (cx1[2] * cx2[1] - cx1[1] * cx2[2]) / val},
        complex_meta
    )
end

-- complex.divnum( cx, num )
-- divide through a number
function complex.divnum(cx, num)
    return setmetatable({cx[1] / num, cx[2] / num}, complex_meta)
end

-- complex.pow( cx, num )
-- get the power of a complex number
function complex.pow(cx, num)
    if math.floor(num) == num then
        if num < 0 then
            local val = cx[1] ^ 2 + cx[2] ^ 2
            cx = {cx[1] / val, -cx[2] / val}
            num = -num
        end
        local real, imag = cx[1], cx[2]
        for i = 2, num do
            real, imag = real * cx[1] - imag * cx[2], real * cx[2] + imag * cx[1]
        end
        return setmetatable({real, imag}, complex_meta)
    end
    -- we calculate the polar complex number now
    -- since then we have the versatility to calc any potenz of the complex number
    -- then we convert it back to a carthesic complex number, we loose precision here
    local length, phi = math.sqrt(cx[1] ^ 2 + cx[2] ^ 2) ^ num, math.atan2(cx[2], cx[1]) * num
    return setmetatable({length * math.cos(phi), length * math.sin(phi)}, complex_meta)
end

-- complex.sqrt( cx )
-- get the first squareroot of a complex number, more accurate than cx^.5
function complex.sqrt(cx)
    local len = math.sqrt(cx[1] ^ 2 + cx[2] ^ 2)
    local sign = (cx[2] < 0 and -1) or 1
    return setmetatable({math.sqrt((cx[1] + len) / 2), sign * math.sqrt((len - cx[1]) / 2)}, complex_meta)
end

-- complex.ln( cx )
-- natural logarithm of cx
function complex.ln(cx)
    return setmetatable(
        {
            math.log(math.sqrt(cx[1] ^ 2 + cx[2] ^ 2)),
            math.atan2(cx[2], cx[1])
        },
        complex_meta
    )
end

-- complex.exp( cx )
-- exponent of cx (e^cx)
function complex.exp(cx)
    local expreal = math.exp(cx[1])
    return setmetatable({expreal * math.cos(cx[2]), expreal * math.sin(cx[2])}, complex_meta)
end

-- complex.conjugate( cx )
-- get conjugate complex of number
function complex.conjugate(cx)
    return setmetatable({cx[1], -cx[2]}, complex_meta)
end

-- complex.round( cx [,idp] )
-- round complex numbers, by default to 0 decimal points
function complex.round(cx, idp)
    local mult = 10 ^ (idp or 0)
    return setmetatable(
        {
            math.floor(cx[1] * mult + 0.5) / mult,
            math.floor(cx[2] * mult + 0.5) / mult
        },
        complex_meta
    )
end

--// variables
complex.zero = complex.new(0, 0)
complex.one = complex.new(1, 0)

--// metatable functions

complex_meta.__add = function(cx1, cx2)
    local cx1, cx2 = complex.to(cx1), complex.to(cx2)
    return complex.add(cx1, cx2)
end
complex_meta.__sub = function(cx1, cx2)
    local cx1, cx2 = complex.to(cx1), complex.to(cx2)
    return complex.sub(cx1, cx2)
end
complex_meta.__mul = function(cx1, cx2)
    local cx1, cx2 = complex.to(cx1), complex.to(cx2)
    return complex.mul(cx1, cx2)
end
complex_meta.__div = function(cx1, cx2)
    local cx1, cx2 = complex.to(cx1), complex.to(cx2)
    return complex.div(cx1, cx2)
end
complex_meta.__pow = function(cx, num)
    if num == "*" then
        return complex.conjugate(cx)
    end
    return complex.pow(cx, num)
end
complex_meta.__unm = function(cx)
    return setmetatable({-cx[1], -cx[2]}, complex_meta)
end
complex_meta.__eq = function(cx1, cx2)
    if cx1[1] == cx2[1] and cx1[2] == cx2[2] then
        return true
    end
    return false
end
complex_meta.__tostring = function(cx)
    return tostring(complex.tostring(cx))
end
complex_meta.__concat = function(cx, cx2)
    return tostring(cx) .. tostring(cx2)
end
-- cx( cx, formatstr )
complex_meta.__call = function(...)
    print(complex.tostring(...))
end
complex_meta.__index = {}
for k, v in pairs(complex) do
    complex_meta.__index[k] = v
end

return complex

--///////////////--
--// chillcode //--
--///////////////--
local yecs = {}
local copy = require("utils.copy")
local uuid = require("utils.uuid")
local debug_log = require("utils.debug_log")
local deep_copy = copy.deep_copy

-- world
yecs.worlds = {}

local World = {
    __metatable = 'WorldMeta',
    __tostring = function(self)
        return string.format('<yecs-world: %s>', self.key)
    end
}
World.__index = World

function World:New(key)
    local world = yecs.worlds[key]
    if world then
        return world
    end

    world = setmetatable({
        paused = false,
        update_delta = 0,
        key = key,
        entities = {},
        systems = {},
        system_update_queue = setmetatable({}, {
            __mode = 'v'
        })
    }, self)

    yecs.worlds[key] = world
    return world
end

function World:Destroy()
    yecs.worlds[self.key] = nil
    for _, system in pairs(self.systems) do
        system:Deinit()
    end
    self.entities = {}
    self.systems = {}
    self.system_update_queue = {}
end

function World:Update(delta_ms)
    self.update_delta = self.update_delta + delta_ms

    if self.paused then
        for _, system in ipairs(self.system_update_queue) do
            if system.update_when_paused then
                system:Update(0)
            end
        end
    else
        for _, system in ipairs(self.system_update_queue) do
            system:Update(self.update_delta)
        end
        self.update_delta = 0
    end
end

function World:UpdateAllWorlds(delta_ms)
    local worlds = {}

    for _, world in pairs(yecs.worlds) do
        table.insert(worlds, world)
    end

    for _, world in pairs(worlds) do
        world:Update(delta_ms)
    end
end

function World:Pause()
    self.paused = true
end

function World:Resume()
    self.paused = false
end

function World:AddEntity(entity)
    if getmetatable(entity) ~= "EntityMeta" then
        return
    end

    self.entities[entity.key] = entity
    entity.world = self
end

function World:RemoveEntity(entity)
    self:RemoveEntityByKey(entity.key)
end

function World:RemoveEntityByKey(entity_key)
    local entity = self.entities[entity_key]

    if entity and entity.world == self then
        entity.world = nil
        self.entities[entity_key] = nil
    end
end

function World:AddSystem(system)
    if getmetatable(system) ~= "SystemMeta" then
        return
    end

    if system == nil or self.systems[system.key] ~= nil then
        return
    end

    system.world = self
    self.systems[system.key] = system
    table.insert(self.system_update_queue, system)
    table.sort(self.system_update_queue, function(s1, s2)
        return s1.update_order < s2.update_order
    end)

    system:Init()
end

function World:AddSystemByKey(system_key)
    local system = yecs.System:New(system_key)
    self:AddSystem(system)
end

function World:AddSystems(systems)
    for _, system in pairs(systems) do
        self:AddSystem(system)
    end
end

function World:AddSystemsByKeys(system_keys)
    for _, system_key in pairs(system_keys) do
        self:AddSystemByKey(system_key)
    end
end

function World:RemoveSystem(system)
    if getmetatable(system) ~= "SystemMeta" then
        return
    end
    self:RemoveSystemByKey(system.key)
end

function World:RemoveSystemByKey(system_key)
    local system = self.systems[system_key]
    if system == nil or system.world ~= self then
        return
    end

    system.world = nil
    self.systems[system_key] = nil
    system:Deinit()
    collectgarbage()

    system.system_update_queue = {}
    for _, system in pairs(self.systems) do
        table.insert(self.system_update_queue, system)
    end
    table.sort(self.system_update_queue, function(s1, s2)
        return s1.update_order < s2.update_order
    end)
end

function World:GetEntities(condition)
    local entities = {}

    for _, entity in pairs(self.entities) do
        if (not condition) or condition(entity) then
            table.insert(entities, entity)
        end
    end

    return entities
end

function World:GetEntity(condition)
    for _, entity in pairs(self.entities) do
        if (not condition) or condition(entity) then
            return entity
        end
    end

    return nil
end

function World:GetEntitiesWithComponent(component_key)
    return self:GetEntities(function(entity)
        return entity.components[component_key]
    end)
end

function World:GetEntitiesByTags(tags)
    return self:GetEntities(function(entity)
        if entity.tags == nil then
            return false
        end
        for _, tag in pairs(tags) do
            if entity.tags[tag] then
                return true
            end
        end
    end)
end

function World:GetEntityByTags(tags)
    return self:GetEntity(function(entity)
        if entity.tags == nil then
            return false
        end
        for _, tag in pairs(tags) do
            if entity.tags[tag] then
                return true
            end
        end
    end)
end

-- behavior
local behavior_templates = {}

local Behavior = {
    key = "",
    __metatable = "BehaviorMeta",
    __tostring = function(self)
        return string.format("<yecs-behavior: %s>", self.key)
    end
}

Behavior.__index = function(self, k)
    return self.behavior_funcs[k] or self.super_behavior[k]
end

function Behavior:Register(key, behavior_funcs)
    if type(behavior_funcs) ~= 'table' then
        return
    end
    behavior_templates[key] = behavior_funcs
end

function Behavior:New(key, super_behavior)
    local behavior_funcs = behavior_templates[key] or {}

    local behavior = setmetatable({
        key = key,
        behavior_funcs = behavior_funcs,
        super_behavior = super_behavior
    }, self)

    return behavior
end

-- entity
local Entity = {
    key = "",
    __metatable = "EntityMeta",
    __tostring = function(self)
        return string.format("<yecs-entity: %s>", self.key)
    end
}

Entity.__index = function(self, k)
    return Entity[k] or self._behavior[k] or self.components[k]
end
Entity.__newindex = function(self, k, v)
    if k == "world" then
        rawset(self, k, v)
    elseif self.components[k] == nil then
        debug_log.log("can not add property to entity")
        -- rawset(self, k, v)
    elseif type(v) == "table" then
        local component = self.components[k]
        for ck, cv in pairs(v) do
            component[ck] = cv
        end
    end
end

function Entity:_BehaviorOnInit()
    local function _call_super(behavior)
        if behavior then
            _call_super(behavior.super_behavior)
            if behavior.OnInit then
                behavior.OnInit(self)
            end
        end
    end
    _call_super(self._behavior)
end

function Entity:New(component_keys, behavior_keys)
    component_keys = component_keys or {}
    behavior_keys = behavior_keys or {}

    local component_data = {}
    local behavior = {}
    for _, bk in ipairs(behavior_keys) do
        behavior = Behavior:New(bk, behavior)
    end

    local entity = setmetatable({
        key = uuid.new(),
        components = component_data,
        behavior_keys = copy.copy(behavior_keys),
        _behavior = behavior
    }, self)

    for _, component_key in pairs(component_keys) do
        local component = yecs.Component:New(component_key)

        if component ~= nil then
            component.entity = entity
            component_data[component.key] = component
        end
    end

    return entity
end

function Entity:AddComponent(component)
    if getmetatable(component) ~= "ComponentMeta" then
        component = yecs.Component:New(component)
    end

    if component and self.components[component.key] == nil then
        self.components[component.key] = component
    end
end

function Entity:AddBehavior(behavior_key)
    self._behavior = Behavior:New(behavior_key, self._behavior)
    table.insert(self.behavior_keys, behavior_key)
end

function Entity:Serialize()
    local data = {}
    data.key = self.key

    local components = {}
    for c_k, c in pairs(self.components) do
        components[c_k] = c:Serialize()
    end

    data.components = components
    data.behavior_keys = copy.copy(self.behavior_keys)
    return data
end

function Entity:Deserialize(data)
    self.key = data.key
    for c_k, c_v in pairs(data.components) do
        self.components[c_k]:Deserialize(c_v)
    end
end

-- component
local component_templates = {}

local Component = {
    key = "",
    _operations = {},
    __metatable = "ComponentMeta",
    __tostring = function(self)
        return string.format("<yecs-component: %s>", self.key)
    end
}
Component.__index = function(self, k)
    return self._operations[k] or Component[k]
end
Component.__newindex = function(self, k, v)
    if type(v) ~= 'function' then
        rawset(self, k, v)
    else
        self._operations[k] = v
    end
end

function Component:Register(key, data)
    if component_templates[key] ~= nil then
        return
    end
    if type(data) ~= 'table' then
        return
    end

    data["key"] = key
    if data._operations == nil then
        data._operations = {}
    end

    component_templates[key] = data
end

function Component:New(key)
    local component_data = component_templates[key]
    if component_data == nil then
        return nil
    end

    local component = setmetatable(deep_copy(component_data), self)
    return component
end

function Component:Serialize()
    local data = {}

    for k, v in pairs(self) do
        if type(k) == "string" and string.sub(k, 1, 1) ~= "_" and k ~= "entity" then
            data[k] = v
        end
    end

    return deep_copy(data)
end

function Component:Deserialize(data)
    for k, v in pairs(data) do
        self[k] = v
    end
end

-- system
local system_templates = {}
local System = {
    key = "",
    update_order = 1024,
    update_when_paused = false,
    __metatable = "SystemMeta",
    __tostring = function(self)
        return string.format("<yecs-system: %s>", self.key)
    end
}
System.__index = System

function System:Register(key, data)
    if type(data) ~= 'table' then
        return
    end
    data["key"] = key
    system_templates[key] = data
end

function System:New(key)
    local system_data = system_templates[key]
    if system_data == nil then
        return nil
    end

    local system = setmetatable(deep_copy(system_data), self)
    return system
end

function System:Update(delta_ms)
    debug_log.log(self, "Update", delta_ms)
end

function System:Init()
end

function System:Deinit()
end

-- EntityFactory
local EntityFactory = {
    entity_models = {}
}

function EntityFactory:Make(entity_type, ex_behavior_keys)
    local data = self.entity_models[entity_type]
    if not data then
        return nil
    end

    local component_keys = data.component_keys
    local behavior_keys = data.behavior_keys

    local entity = yecs.Entity:New(component_keys, behavior_keys)
    if not entity then
        return nil
    end

    if ex_behavior_keys then
        for _, behavior_key in pairs(ex_behavior_keys) do
            entity:AddBehavior(behavior_key)
        end
    end

    if entity.Init then
        entity:Init()
    end

    -- behaviors OnInit
    entity:_BehaviorOnInit()

    return entity
end

function EntityFactory:Register(entity_type, component_keys, behavior_keys)
    self.entity_models[entity_type] = {
        component_keys = component_keys,
        behavior_keys = behavior_keys
    }
end

yecs.World = World
yecs.Entity = Entity
yecs.Component = Component
yecs.System = System
yecs.EntityFactory = EntityFactory
yecs.Behavior = Behavior

return yecs
local components = require("core.components")
local systems = require("core.systems")
local entities = require("core.entities")

local core = {}
core.yecs = require("core.yecs")

return core
local components = {}
local yecs = require("core.yecs")
local palette_data = require("core.data.palette_data")
local copy = require("utils.copy")
local debug_log = require("utils.debug_log")

local deep_copy = copy.deep_copy

yecs.Component:Register("data", {})
yecs.Component:Register("tags", {})

yecs.Component:Register("position", {
    x = 0,
    y = 0,
    z = 0
})
yecs.Component:Register("size", {
    width = 0,
    height = 0
})
yecs.Component:Register("sprite", {
    sprites = {},
    _operations = {
        AddSprite = function(self, key, texture, params)
            params = params or {}
            self.sprites[key] = {
                texture = texture or "./image/sprite16.png",
                color = deep_copy(params.color) or {
                    r = 1,
                    g = 1,
                    b = 1
                },
                size = deep_copy(params.size) or {
                    width = -1,
                    height = -1
                },
                offset = deep_copy(params.offset) or {
                    x = 0,
                    y = 0,
                    z = 0
                }
            }
        end,
        RemoveSprite = function(self, key)
            self.sprites[key] = nil
        end
    }
})

yecs.Component:Register("input", {
    touch_size = nil,
    touched = false,
    transparent = false,
    _operations = {
        _OnTouchBegan = function(self, x, y)
            debug_log.log("_OnTouchBegan")
            return self:OnTouchBegan(x, y)
        end,
        _OnTouchMoved = function(self, x, y)
            debug_log.log("_OnTouchMoved")
            self:OnTouchMoved(x, y)
        end,
        _OnTouchEnded = function(self, x, y)
            debug_log.log("_OnTouchEnded")
            self:OnTouchEnded(x, y)
            self:OnClicked(x, y)
        end,
        _OnKeyPressed = function(self, keycode)
            debug_log.log(string.format("_OnKeyPressed: %s", keycode))
            self:OnKeyPressed(keycode)
        end,
        _OnKeyReleased = function (self, keycode)
            debug_log.log(string.format("_OnKeyReleased: %s", keycode))
            self:OnKeyReleased(keycode)
        end,

        OnClicked = function(self, x, y)
            debug_log.log("OnClicked")
        end,
        OnTouchBegan = function(self, x, y)
            debug_log.log("OnTouchBegan")
        end,
        OnTouchMoved = function(self, x, y)
            debug_log.log("OnTouchMoved")
        end,
        OnTouchEnded = function(self, x, y)
            debug_log.log("OnTouchEnded")
        end,
        OnKeyPressed = function(self, keycode)
            debug_log.log(string.format("OnKeyPressed: %s", keycode))
        end,
        OnKeyReleased = function(self, keycode)
            debug_log.log(string.format("OnKeyReleased: %s", keycode))
        end
    }
})

yecs.Component:Register("tree", {
    parent = nil,
    children = {},
    _operations = {
        AddChild = function(self, c)
            if c.tree == nil then
                return
            end
            local c_parent = c.tree.parent
            if c_parent then
                c_parent.tree:RemoveChild(c)
            end

            c.tree.parent = self.entity
            self.children[c.key] = c
        end,
        RemoveChild = function(self, c)
            local c_tree = c.tree
            if c_tree == nil then
                return
            end
            if c_tree.parent ~= self.entity then
                return
            end

            c_tree.parent = nil
            self.children[c.key] = nil
        end,
        Serialize = function(self)
            local children = {}
            local data = {
                parent = self.parent and self.parent.key,
                children = children
            }

            for c_key, _ in pairs(self.children) do
                table.insert(children, c_key)
            end
            return data
        end,
        Deserialize = function(self, data)
            local world_entities = self.entity.world.entities
            self.parent = world_entities[data.parent]

            for _, c_key in ipairs(data.children) do
                self.children[c_key] = world_entities[c_key]
            end
        end
    }
})

local font_data = require("core.data.font_data")
yecs.Component:Register("text", {
    text = "",
    size = 1,
    max_width = 0,
    max_height = 0,
    render_width = 0,
    render_height = 0,

    _operations = {
        SetText = function(self, new_text)
            self.text = new_text
            self:Format()
        end,
        GetText = function(self)
            return self.text
        end,
        Format = function(self)
            local sprite = self.entity.sprite
            if sprite == nil then
                return
            end

            local new_sprites = {}
            local pos_x = 0
            local pos_y = 0
            local pos_z = 1
            self.render_width = 0
            self.render_height = 0
            local size = self.size
            self.text:gsub(".", function(c)
                if c == "\n" then
                    pos_y = pos_y + font_data.height + 1
                    pos_x = 0
                    return
                end

                local c_n = string.byte(c)
                local width = font_data.width[c_n]
                if width == nil then
                    c_n = -1
                    width = font_data[-1]
                end

                if self.max_width > 0 and (pos_x + width) * size > self.max_width then
                    pos_y = pos_y + font_data.height + 1
                    pos_x = 0
                end

                if self.max_height > 0 and pos_y + font_data.height > self.max_height then
                    return
                end

                local texture = {
                    texture = string.format("./image/font/%d.png", c_n),
                    color = palette_data.foreground_color,
                    size = {
                        width = font_data.size * size,
                        height = font_data.size * size
                    },
                    offset = {
                        x = pos_x * size,
                        y = pos_y * size,
                        z = pos_z
                    }
                }
                table.insert(new_sprites, texture)
                pos_x = pos_x + width
                pos_z = pos_z + 1

                self.render_width = math.max(pos_x, self.render_width)
            end)

            self.render_height = pos_y
            sprite.sprites = new_sprites
        end,
        SetMaxSize = function(self, w, h)
            self.max_width = w
            self.max_height = h
            self:Format()
        end,
        SetFontSize = function(self, v)
            self.size = v
            self:Format()
        end,
        GetRenderSize = function(self)
            return {
                width = self.render_width,
                height = self.render_height
            }
        end
    }

})

local default_tick_order = 1
yecs.Component:Register("tick", {
    _tick_callbacks = {}, -- callback(delta_ms)
    _timer_callbacks = {}, -- callback(timeover_ms)
    _operations = {
        AddTick = function(self, key, callback, tick_order)
            self._tick_callbacks[key] = {
                tick_order = tick_order or default_tick_order,
                callback = callback,
                entity = self.entity
            }
        end,
        RemoveTick = function(self, key)
            self._tick_callbacks[key] = nil
        end,
        AddTimer = function(self, key, time_ms, callback)
            self._timer_callbacks[key] = {
                time_ms = time_ms,
                callback = callback,
                entity = self.entity
            }
        end,
        RemoveTimer = function(self, key)
            self._timer_callbacks[key] = nil
        end

    }
})

local animation_frame_rate = 12
local animation_callback_key = 1
yecs.Component:Register("animation", {
    frame_rate = animation_frame_rate,
    waiting_timer = false,
    next_idx = {},
    animations = {},

    _callback = function(self)
        self.waiting_timer = false
        local entity = self.entity
        local sprite = entity.sprite
        if not sprite then
            self.next_idx = {}
            return
        end

        local next_timer = false
        local next_idx = {}
        for k, idx in pairs(self.next_idx) do
            local a = self.animations[k]
            if a then
                local s = sprite.sprites[a.sprite_key]
                if s then
                    s.texture = string.format(a.texture_format, idx)
                    if idx + 1 <= a.end_idx then
                        next_idx[k] = idx + 1
                        next_timer = true
                    elseif a.loop then
                        next_idx[k] = a.start_idx
                        next_timer = true
                    end
                end
            end
        end

        if next_timer then
            entity.tick:AddTimer("animation", 1000 // self.frame_rate, function()
                self:_callback()
            end)
            self.waiting_timer = true
        end

        self.next_idx = next_idx
    end,

    _operations = {
        AddState = function(self, key, sprite_key, texture_format, start_idx, end_idx, loop)
            self.animations[key] = {
                sprite_key = sprite_key,
                texture_format = texture_format,
                start_idx = start_idx,
                end_idx = end_idx,
                loop = loop
            }
        end,
        RemoveState = function(self, key)
            self.animations[key] = nil
        end,
        Play = function(self, key)
            local a = self.animations[key]
            if not a then
                return
            end

            local s = self.entity.sprite.sprites[a.sprite_key]
            if not s then
                return
            end

            self.next_idx[key] = a.start_idx

            if not self.waiting_timer then
                self.entity.tick:AddTimer("animation", 1000 // self.frame_rate, function()
                    self:_callback()
                end)
                self.waiting_timer = true
            end
        end,
        Stop = function(self, key)
            self.next_idx[key] = nil
        end,
        StopAll = function(self)
            self.next_idx = {}
        end,
        Deserialize = function(self, data)
            yecs.Component.Deserialize(self, data)
            self.entity.tick:AddTimer("animation", 1000 // self.frame_rate, function()
                self:_callback()
            end)
        end

    }
})

return components
local yapre = yapre

local systems = {}
local yecs = require("core.yecs")
local emscripten_keycode_mapping = require("core.data.emscripten_keycode_mapping")
local debug_log = require("utils.debug_log")

-- dummy system
local dummy_system = {}
dummy_system.update_order = 0
function dummy_system:Init()
    debug_log.log("dummy Init")
end

function dummy_system:Deinit()
    debug_log.log("dummy Deinit")
end

function dummy_system:Update(delta_ms)
    debug_log.log("dummy Update ", delta_ms)
end
yecs.System:Register("dummy", dummy_system)

-- sprite system
local sprite_system = {}
sprite_system.update_order = 2048
sprite_system.update_when_paused = true
function sprite_system:Update(delta_ms)
    local tree_system = self.world.systems["tree"]
    local sprite_entities = self.world:GetEntitiesWithComponent("sprite")

    for _, entity in pairs(sprite_entities) do
        local position = entity.position
        if tree_system then
            position = tree_system:GetGlobalPosition(entity)
        end
        position = position or {
            x = 0,
            y = 0,
            z = 0
        }

        for _, sprite_data in pairs(entity.sprite.sprites) do
            local offset = sprite_data.offset
            local size = sprite_data.size
            local color = sprite_data.color
            yapre.DrawSprite(sprite_data.texture, {position.x + offset.x, position.y + offset.y, position.z + offset.z},
                {size.width, size.height}, 0., {color.r, color.g, color.b})
        end
    end
end
yecs.System:Register("sprite", sprite_system)

-- input system
local input_system = {
    _key_events = {},
    _mouse_events = {}
}

function input_system:Update(delta_ms)
    local input_entities = self.world:GetEntitiesWithComponent("input")
    local tree_system = self.world.systems["tree"]

    for _, mouse_event in ipairs(self._mouse_events) do
        if mouse_event.button ~= 1 then
            goto continue0
        end

        for _, entity in pairs(input_entities) do
            local einput = entity.input

            if mouse_event.state == 1 then
                local size = einput.touch_size or entity.size
                if size == nil then
                    goto continue1
                end

                local position = nil
                if tree_system then
                    position = tree_system:GetGlobalPosition(entity)
                end

                position = position or entity.position
                if position == nil then
                    goto continue1
                end
                local x = position.x
                local y = position.y
                local w = size.width
                local h = size.height

                if mouse_event.x > x and mouse_event.x < x + w and mouse_event.y > y and mouse_event.y < y + h then
                    if einput:_OnTouchBegan(mouse_event.x, mouse_event.y) then
                        einput.touched = true
                        if not einput.transparent then
                            break
                        end
                    end
                end
            elseif mouse_event.state == 2 then
                if einput.touched then
                    einput:_OnTouchEnded(mouse_event.x, mouse_event.y)
                    einput.touched = false
                end
            elseif mouse_event.state == 4 then
                if einput.touched then
                    einput:_OnTouchMoved(mouse_event.x, mouse_event.y)
                end
            end
            ::continue1::
        end
        ::continue0::
    end

    for _, key_event in ipairs(self._key_events) do
        if key_event.state == 1 then
            for _, entity in pairs(input_entities) do
                entity.input:_OnKeyPressed(key_event.keycode)
            end
        else
            for _, entity in pairs(input_entities) do
                entity.input:_OnKeyReleased(key_event.keycode)
            end
        end
    end

    self._key_events = {}
    self._mouse_events = {}
end

function input_system:Init()
    local function OnKey(timestamp, state, multi, keycode)
        if yapre.platform == "emscripten" then
            keycode = emscripten_keycode_mapping:GetKeyCode(keycode)
        end
        debug_log.log(string.format("%s-[OnKey] %i:%i:%i:%i", self.world, timestamp, state, multi, keycode))
        table.insert(self._key_events, {
            timestamp = timestamp,
            state = state,
            multi = multi,
            keycode = keycode
        })
        if self.OnKey then
            self:OnKey(timestamp, state, multi, keycode)
        end
    end

    local function OnMouse(timestamp, state, button, x, y)
        debug_log.log(string.format("%s-:[OnMouse] %i:%i:%i:(%i,%i)", self.world, timestamp, state, button, x, y))
        table.insert(self._mouse_events, {
            timestamp = timestamp,
            state = state,
            button = button,
            x = x,
            y = y
        })
        if self.OnMouse then
            self:OnMouse(timestamp, state, button, x, y)
        end
    end

    yapre.BindKeyboardInputCallback(string.format("%s-OnKey", self.world), OnKey)
    yapre.BindMouseInputCallback(string.format("%s-OnMouse", self.world), OnMouse)
end

function input_system:Deinit()
    yapre.UnbindKeyboardInputCallback(string.format("%s-OnKey", self.world))
    yapre.UnbindMouseInputCallback(string.format("%s-OnMouse", self.world))
end

yecs.System:Register("input", input_system)

-- tree_system
local tree_system = {}
tree_system.update_order = sprite_system.update_order - 1
tree_system.global_position = {}

function tree_system:_UpdateTreeNodePos(node, parent_pos)
    local pos = node.position
    local node_pos = {
        x = pos.x + parent_pos.x,
        y = pos.y + parent_pos.y,
        z = pos.z + parent_pos.z
    }
    self.global_position[node.key] = node_pos

    for _, c in pairs(node.tree.children) do
        self:_UpdateTreeNodePos(c, node_pos)
    end
end

function tree_system:Update(delta_ms)
    self.global_position = {}
    local world = self.world
    local tree_entities = self.world:GetEntitiesWithComponent("tree")

    for _, entity in pairs(tree_entities) do
        local parent = entity.tree.parent
        if parent == nil then
            self:_UpdateTreeNodePos(entity, {
                x = 0,
                y = 0,
                z = 0
            })
        else
            if world.entities[parent.key] == nil then
                world:RemoveEntity(entity)
            end
        end
    end
end

function tree_system:Init()
end

function tree_system:Deinit()
end

function tree_system:GetGlobalPosition(entity)
    local position = self.global_position[entity.key]
    if position then
        return position
    else
        return entity.position
    end
end

yecs.System:Register("tree", tree_system)

-- tick system
local tick_system = {}
tick_system.update_order = 0
function tick_system:Init()
end

function tick_system:Deinit()
end

function tick_system:Update(delta_ms)
    local world = self.world
    local tick_entities = self.world:GetEntitiesWithComponent("tick")

    local g_tick_callbacks = {}
    local g_timer_callbacks = {}
    for _, entity in pairs(tick_entities) do
        local etick = entity.tick
        local timer_callbacks = etick._timer_callbacks
        local tick_callbacks = etick._tick_callbacks
        local timer_to_remove = {}

        for timer_key, callback in pairs(timer_callbacks) do
            callback.time_ms = callback.time_ms - delta_ms
            if callback.time_ms <= 0 then
                table.insert(timer_to_remove, timer_key)
                table.insert(g_timer_callbacks, callback)
            end
        end

        for _, timer_key in ipairs(timer_to_remove) do
            timer_callbacks[timer_key] = nil
        end

        for _, callback in pairs(tick_callbacks) do
            table.insert(g_tick_callbacks, callback)
        end
    end

    table.sort(g_timer_callbacks, function(t1, t2)
        if t1.time_ms < t2.time_ms then
            return true
        end
    end)

    table.sort(g_tick_callbacks, function(t1, t2)
        if t1.tick_order < t2.tick_order then
            return true
        elseif t1.tick_order > t2.tick_order then
            return false
        else
            return false
        end
    end)

    for _, callback in ipairs(g_timer_callbacks) do
        callback.callback(-callback.time_ms)
    end

    for _, callback in ipairs(g_tick_callbacks) do
        callback.callback(delta_ms)
    end

end

yecs.System:Register("tick", tick_system)

return systems
local serialization = {}
local yecs = require("core.yecs")
local copy = require("utils.copy")
local debug_log = require("utils.debug_log")

function serialization:DumpWorld(world)
    local world_data = {}

    world_data.paused = world.paused
    world_data.update_delta = world.update_delta
    world_data.key = world.key

    local systems = {}
    for system_key, _ in pairs(world.systems) do
        table.insert(systems, system_key)
    end
    world_data.systems = systems

    local entities_data = {}
    for entity_key, entity in pairs(world.entities) do
        entities_data[entity_key] = entity:Serialize()
    end

    world_data.entities = entities_data

    return world_data
end

function serialization:LoadWorld(world_data)
    local world = yecs.World:New(world_data.key)
    world:AddSystemsByKeys(world_data.systems)

    world.paused = world_data.paused
    world.update_delta = world_data.update_delta

    local entities_data = world_data.entities
    local entities = self:MakeEntities(entities_data)

    for _, entity in pairs(entities) do
        world:AddEntity(entity)
    end

    for e_key, entity in pairs(entities) do
        entity:Deserialize(entities_data[e_key])
    end

    return world
end

function serialization:MakeEntities(entities_data)
    local entities = {}

    for entity_key, entity_data in pairs(entities_data) do
        local components = {}
        for c_key, _ in pairs(entity_data.components) do
            table.insert(components, c_key)
        end

        local entity = yecs.Entity:New(components, entity_data.behavior_keys)
        if entity.Init then
            entity:Init()
        end

        -- behaviors OnInit
        entity:_BehaviorOnInit()

        entity.key = entity_key
        entities[entity_key] = entity
    end

    return entities
end

function serialization:DumpData(obj, seen)
    if type(obj) ~= "table" then
        if type(obj) == "function" then
            debug_log.log("unable to dump function")
            return nil
        end
        return obj
    end

    if seen and seen[obj] then
        return seen[obj]
    end

    local s = seen or {}
    local data = {}
    s[obj] = data

    for k, v in pairs(obj) do
        if type(k) == "string" and string.sub(k, 1, 1) ~= "_" or type(k) == "number" then
            data[k] = self:DumpData(v, s)
        end
    end

    return data
end

return serialization
local yapre = yapre

local splash_screen = {}

local core = require("core")
local yecs = core.yecs

function splash_screen:Show(callback)
    local world = yecs.World:New("splash_world")
    world:AddSystemsByKeys({"sprite", "tick"})

    local image = yecs.EntityFactory:Make("image")

    local image_size = 1

    while image_size < yapre.render_height / 2 do
        image_size = image_size * 2
    end

    local image_w = image_size * 2
    local image_h = image_size
    local image_x = yapre.render_width / 2 - image_w / 2
    local image_y = yapre.render_height / 2 - image_h / 2

    image:SetTexture("./image/splash.png")
    image:SetTextureSize(image_w, image_h)
    image:SetBorderEnabled(false)
    image.position = {
        x = image_x,
        y = image_y,
        z = 1
    }

    world:AddEntity(image)

    image:AddComponent("tick")
    image.tick:AddTimer("timer", 2000, function()
        world:Destroy()
        local c = yapre.palette.background_color
        yapre.SetClearColor(c.r, c.g, c.b, c.a)
        if callback then
            callback()
        end
    end)

    for idx = 1, 16, 1 do
        image.tick:AddTimer("timer_" .. idx, 100 * idx, function()
            local c = yapre.palette.colors[idx]
            yapre.SetClearColor(c.r, c.g, c.b, c.a)
        end)
    end

    return world
end

return splash_screen
local palette_data = {}

local GetColorFromHexStr = function(str)
    local color = {
        a = 0,
        r = 0,
        g = 0,
        b = 0
    }
    local tmp = {}
    for cc in string.gmatch(str, "..") do
        table.insert(tmp, tonumber(cc, 16))
    end
    color.a = tmp[1] / 255
    color.r = tmp[2] / 255
    color.g = tmp[3] / 255
    color.b = tmp[4] / 255
    return color
end

-- https://lospec.com/palette-list/summers-past-16
local _colors = {'FF320011', 'FF5f3a60', 'FF876672', 'FFb7a39d', 'FFece8c2', 'FF6db7c3', 'FF5e80b2', 'FF627057',
                 'FF8da24e', 'FFd2cb3e', 'FFf7d554', 'FFe8bf92', 'FFe78c5b', 'FFc66f5e', 'FFc33846', 'FF933942'}

local colors = {}
for _, c in ipairs(_colors) do
    table.insert(colors, GetColorFromHexStr(c))
end

palette_data.colors = colors
palette_data.black = colors[1]
palette_data.white = colors[5]
palette_data.blue = colors[6]
palette_data.green = colors[10]
palette_data.red = colors[14]

palette_data.main_colors = {palette_data.black, palette_data.white, palette_data.blue, palette_data.green,
                            palette_data.red}

palette_data.foreground_color = colors[5]
palette_data.background_color = colors[16]
palette_data.border_color = colors[1]

return palette_data

local emscripten_keycode_mapping = {}

emscripten_keycode_mapping.keycode_mapping = {
    [53] = 96,
    [30] = 49,
    [31] = 50,
    [32] = 51,
    [33] = 52,
    [34] = 53,
    [35] = 54,
    [36] = 55,
    [37] = 56,
    [38] = 57,
    [39] = 48,
    [46] = 61,
    [42] = 8,
    [43] = 9,
    [20] = 113,
    [26] = 119,
    [8] = 101,
    [21] = 114,
    [23] = 116,
    [28] = 121,
    [24] = 117,
    [12] = 105,
    [18] = 111,
    [19] = 112,
    [47] = 91,
    [48] = 93,
    [49] = 92,
    [4] = 97,
    [22] = 115,
    [7] = 100,
    [9] = 102,
    [10] = 103,
    [11] = 104,
    [13] = 106,
    [14] = 107,
    [15] = 108,
    [51] = 59,
    [52] = 39,
    [40] = 13,
    [29] = 122,
    [27] = 120,
    [6] = 99,
    [25] = 118,
    [5] = 98,
    [17] = 110,
    [16] = 109,
    [54] = 44,
    [55] = 46,
    [56] = 47,
    [44] = 32,
    [101] = 231
}

function emscripten_keycode_mapping:GetKeyCode(key_code)
    local n_key_code = self.keycode_mapping[key_code] or key_code
    return n_key_code
end

return emscripten_keycode_mapping
local font_data = {}
font_data.size = 8
font_data.height = 7
font_data.width = {
    [-1] = 7,
    [32] = 4,
    [33] = 2,
    [34] = 4,
    [35] = 6,
    [36] = 5,
    [37] = 6,
    [38] = 6,
    [39] = 3,
    [40] = 3,
    [41] = 3,
    [42] = 6,
    [43] = 6,
    [44] = 2,
    [45] = 4,
    [46] = 2,
    [47] = 4,
    [48] = 5,
    [49] = 3,
    [50] = 5,
    [51] = 5,
    [52] = 5,
    [53] = 5,
    [54] = 5,
    [55] = 5,
    [56] = 5,
    [57] = 5,
    [58] = 2,
    [59] = 2,
    [60] = 4,
    [61] = 5,
    [62] = 4,
    [63] = 4,
    [64] = 9,
    [65] = 5,
    [66] = 5,
    [67] = 5,
    [68] = 5,
    [69] = 5,
    [70] = 5,
    [71] = 5,
    [72] = 5,
    [73] = 2,
    [74] = 3,
    [75] = 5,
    [76] = 5,
    [77] = 6,
    [78] = 5,
    [79] = 6,
    [80] = 5,
    [81] = 6,
    [82] = 5,
    [83] = 5,
    [84] = 6,
    [85] = 5,
    [86] = 6,
    [87] = 8,
    [88] = 6,
    [89] = 6,
    [90] = 5,
    [91] = 3,
    [92] = 4,
    [93] = 3,
    [94] = 6,
    [95] = 6,
    [96] = 3,
    [97] = 5,
    [98] = 5,
    [99] = 5,
    [100] = 5,
    [101] = 5,
    [102] = 4,
    [103] = 5,
    [104] = 5,
    [105] = 2,
    [106] = 3,
    [107] = 5,
    [108] = 2,
    [109] = 8,
    [110] = 5,
    [111] = 5,
    [112] = 5,
    [113] = 5,
    [114] = 4,
    [115] = 4,
    [116] = 3,
    [117] = 5,
    [118] = 5,
    [119] = 6,
    [120] = 6,
    [121] = 5,
    [122] = 5,
    [123] = 4,
    [124] = 2,
    [125] = 4,
    [126] = 5,
    [127] = 6
}

return font_data
local ui_entities = require("core.entities.ui_entities")

local yapre = yapre
local entities = {}

local palette_data = yapre.palette
local yecs = require("core.yecs")

-- ui
-- button
local button_behavior = {}
yecs.Behavior:Register("button", button_behavior)
function button_behavior:OnInit()
    self.sprite:AddSprite("button", "./image/ui/button16/1.png", {
        size = {
            width = 32,
            height = 32
        }
    })

    self.size.width = 32
    self.size.height = 32

    self.animation:AddState("normal", "button", "./image/ui/button16/%d.png", 1, 1)
    self.animation:AddState("pressed", "button", "./image/ui/button16/%d.png", 2, 2)
    self.animation:AddState("disabled", "button", "./image/ui/button16/%d.png", 3, 3)
    function self.input:OnTouchBegan(x, y)
        self.entity.animation:StopAll()
        self.entity.animation:Play("pressed")
        local on_touch_began_func = self.entity.OnTouchBegan
        if on_touch_began_func then
            on_touch_began_func(self.entity, x, y)
        end
        return true
    end
    function self.input:OnTouchMoved(x, y)
        local on_touch_moved_func = self.entity.OnTouchMoved
        if on_touch_moved_func then
            on_touch_moved_func(self.entity, x, y)
        end
        return true
    end
    function self.input:OnTouchEnded(x, y)
        self.entity.animation:StopAll()
        self.entity.animation:Play("normal")
        local on_clicked_func = self.entity.OnClicked
        if on_clicked_func then
            on_clicked_func(self.entity, x, y)
        end
    end

    return self
end

function button_behavior:SetState(state)
    local animation = self.animation
    animation:Stop("normal")
    animation:Stop("pressed")
    animation:Stop("disabled")
    animation:Play(state)
end

function button_behavior:SetButtonSize(width, height)
    local image_sprite = self.sprite.sprites["button"]
    if image_sprite then
        image_sprite.size = {
            width = width,
            height = height
        }
    end
    self.size = {
        width = width,
        height = height
    }
end

yecs.EntityFactory:Register("button", {"position", "sprite", "tree", "size", "input", "tick", "animation"}, {"button"})

-- label
local label_behavior = {}
yecs.Behavior:Register("label", label_behavior)
function label_behavior:SetText(text)
    self.text:SetText(text)
end
function label_behavior:SetMaxSize(width, height)
    self.text:SetMaxSize(width, height)
end
function label_behavior:SetFontSize(size)
    self.text:SetFontSize(size)
end
function label_behavior:GetRenderSize()
    return self.text:GetRenderSize()
end

yecs.EntityFactory:Register("label", {"position", "sprite", "tree", "size", "text"}, {"label"})

-- image
local image_behavior = {}
yecs.Behavior:Register("image", image_behavior)
function image_behavior:OnInit()
    local default_image_size = {
        width = 32,
        height = 32
    }
    local default_border_size = {
        width = 36,
        height = 36
    }
    local default_image_offset = {
        x = 2,
        y = 2,
        z = 1
    }
    local border_color = palette_data.border_color
    self.sprite:AddSprite("image_border", "./image/ui/blank2.png", {
        size = default_border_size,
        color = border_color
    })

    self.sprite:AddSprite("image", "./image/ui/blank2.png", {
        size = default_image_size,
        offset = default_image_offset
    })

    return self
end

function image_behavior:SetTexture(texture)
    local image_sprite = self.sprite.sprites["image"]
    image_sprite.texture = texture
end

function image_behavior:SetTextureSize(width, height)
    local image_sprite = self.sprite.sprites["image"]
    if image_sprite then
        image_sprite.size = {
            width = width,
            height = height
        }
    end

    local border_sprite = self.sprite.sprites["image_border"]
    if border_sprite then
        border_sprite.size = {
            width = width + 4,
            height = height + 4
        }
    end
end

function image_behavior:SetBorderEnabled(enable)
    if not enable then
        self.sprite:RemoveSprite("image_border")
        return
    end

    local default_image_size = {
        width = 32,
        height = 32
    }
    local default_border_size = {
        width = 36,
        height = 36
    }
    local default_image_offset = {
        x = 2,
        y = 2,
        z = 1
    }
    local border_color = palette_data.border_color

    local image_sprite = self.sprite.sprites["image"]
    if not image_sprite then
        local size = default_border_size
    else
        local image_sprite_size = image_sprite.size
        if image_sprite_size.width == -1 or image_sprite_size.height == -1 then
            local size = self.size
        else
            local size = {
                width = image_sprite_size.width + 4,
                height = image_sprite_size.height + 4
            }
        end
    end

    self.sprite:AddSprite("image_border", "./image/ui/blank2.png", {
        size = default_border_size,
        color = border_color
    })
end

function image_behavior:AddAnimationState(key, texture_format, start_idx, end_idx, loop)
    self.animation:AddState(key, "image", texture_format, start_idx, end_idx, loop)
end
function image_behavior:RemoveAnimationState(key)
    self.animation:RemoveState(key)
end
function image_behavior:PlayAnimation(key)
    self.animation:StopAll()
    self.animation:Play(key)
end
function image_behavior:StopAnimation(key)
    self.animation:Stop(key)
end

yecs.EntityFactory:Register("image", {"position", "sprite", "size", "tick", "animation"}, {"image"})

-- progress
local progress_behavior = {}
yecs.Behavior:Register("progress", progress_behavior)
function progress_behavior:OnInit()
    local default_size = {
        width = 64,
        height = 4
    }
    local default_border_size = {
        width = 68,
        height = 8
    }
    local border_color = palette_data.border_color
    local background_color = palette_data.background_color
    local progress_color = palette_data.red

    self.sprite:AddSprite("progress_border", "./image/ui/blank2.png", {
        size = default_border_size,
        color = border_color
    })

    self.sprite:AddSprite("progress_backgroud", "./image/ui/blank2.png", {
        size = default_size,
        offset = {
            x = 2,
            y = 2,
            z = 1
        },
        color = background_color
    })

    self.sprite:AddSprite("progress", "./image/ui/blank2.png", {
        size = default_size,
        offset = {
            x = 2,
            y = 2,
            z = 2
        },
        color = progress_color
    })

    self:SetPercent(100)
    return self
end

function progress_behavior:SetPercent(percent)
    self.data.percent = percent
    local sprites = self.sprite.sprites
    local full_width = sprites["progress_backgroud"].size.width
    if percent < 0 then
        percent = 0
    end
    if percent > 100 then
        percent = 100
    end
    sprites["progress"].size.width = percent * full_width // 100
end

function progress_behavior:GetPercent()
    return self.data.percent
end

yecs.EntityFactory:Register("progress", {"position", "sprite", "tree", "size", "data"}, {"progress"})

-- panel
local panel_behavior = {}
yecs.Behavior:Register("panel", panel_behavior)
function panel_behavior:OnInit()
    local panel_size = {
        width = 64,
        height = 64
    }
    local panel_color = palette_data.colors[2]

    self.sprite:AddSprite("panel", "./image/ui/blank2.png", {
        size = panel_size,
        color = panel_color
    })
    self.size = {
        width = 64,
        height = 64
    }

    return self
end

function panel_behavior:SetSize(width, height)
    self.size.width = width
    self.size.height = height
    local sprites = self.sprite.sprites
    local sprite_size = sprites["panel"].size
    sprite_size.width = width
    sprite_size.height = height
end

yecs.EntityFactory:Register("panel", {"position", "sprite", "tree", "size"}, {"panel"})

-- palette
local palette_behavior = {}
yecs.Behavior:Register("palette", palette_behavior)
function palette_behavior:OnInit()
    local palette_size = 4
    local offset_x = 0
    for i, color in ipairs(palette_data.colors) do
        self.sprite:AddSprite("palette" .. i, "./image/ui/blank2.png", {
            size = {
                width = palette_size,
                height = palette_size
            },
            color = color,
            offset = {
                x = offset_x,
                y = 0,
                z = 1
            }
        })
        offset_x = offset_x + palette_size
    end
end

yecs.EntityFactory:Register("palette", {"position", "sprite", "tree", "size"}, {"palette"})

-- progress_selector
local progress_selector_behavior = {}
yecs.Behavior:Register("progress_selector", progress_selector_behavior)
function progress_selector_behavior:OnInit()
    local block_width = 2
    local block_interval = 1
    local block_height = 2
    local block_height_selected = 4
    local block_num = 100
    local color = palette_data.white

    self.data.block_height = block_height
    self.data.block_height_selected = block_height_selected
    self.data.block_num = block_num

    local offset_x = block_interval
    for idx = 1, block_num, 1 do
        self.sprite:AddSprite("progress_selector_block" .. idx, "./image/ui/blank2.png", {
            size = {
                width = block_width,
                height = block_height
            },
            color = color,
            offset = {
                x = offset_x,
                y = 0,
                z = 1
            }
        })
        offset_x = offset_x + block_interval + block_width
    end

    self:SetCurrent(1)
end

function progress_selector_behavior:SetCurrent(cur_idx)
    local sprite = nil
    local block_height = self.data.block_height
    local block_height_selected = self.data.block_height_selected
    self.data.current_idx = cur_idx

    for idx = 1, self.data.block_num, 1 do
        sprite = self.sprite.sprites["progress_selector_block" .. idx]
        if sprite then
            sprite.size.height = block_height
        end
    end

    sprite = self.sprite.sprites["progress_selector_block" .. cur_idx]
    if sprite then
        sprite.size.height = block_height_selected
    end
end

function progress_selector_behavior:GetCurrent()
    return self.data.current_idx
end

function progress_selector_behavior:GetMax()
    return self.data.block_num
end

yecs.EntityFactory:Register("progress_selector", {"position", "sprite", "tree", "size", "data"}, {"progress_selector"})

return entities
local app = require("app.app")
return app
local yapre = yapre
local test_world = {}

local core = require("core")
local yecs = core.yecs

yecs.Behavior:Register("increase_progress_behavior", {
    OnInit = function(self)
        self:AddComponent("tick")
        local progress_delta = 1
        self.tick:AddTick("increase_progress", function()
            local percent = self:GetPercent()
            if percent == 100 then
                progress_delta = -1
            elseif percent == 0 then
                progress_delta = 1
            end
            self:SetPercent(percent + progress_delta)
        end)
    end
})

yecs.Behavior:Register("button1_behavior", {
    OnClicked = function(self, x, y)
        self.world:GetEntityByTags({"image"}):PlayAnimation("die")
        self.world:GetEntityByTags({"button2"}):SetState("normal")
        self:SetState("disabled")
    end,
    OnInit = function(self)
        self:AddComponent("tags")
        self.tags["button1"] = true
    end
})

yecs.Behavior:Register("button2_behavior", {
    OnClicked = function(self, x, y)
        self.world:GetEntityByTags({"image"}):PlayAnimation("live")
        self.world:GetEntityByTags({"button1"}):SetState("normal")
        self:SetState("disabled")
    end,
    OnInit = function(self)
        self:AddComponent("tags")
        self.tags["button2"] = true
    end
})

yecs.Behavior:Register("image_behavior", {
    OnInit = function(self)
        self:AddComponent("tags")
        self.tags["image"] = true
    end
})

function test_world:Make()
    local world = yecs.World:New("test_world")
    world:AddSystemsByKeys({"sprite", "input", "tree", "tick"})

    local button1 = yecs.EntityFactory:Make("button", {"button1_behavior"})
    local button2 = yecs.EntityFactory:Make("button", {"button2_behavior"})

    local image = yecs.EntityFactory:Make("image", {"image_behavior"})

    local label = yecs.EntityFactory:Make("label")
    local progress = yecs.EntityFactory:Make("progress", {"increase_progress_behavior"})
    local panel = yecs.EntityFactory:Make("panel")
    local palette = yecs.EntityFactory:Make("palette")

    panel:SetSize(320, 128)
    panel.position = {
        x = 0,
        y = 0,
        z = 0
    }

    progress.position = {
        x = 80,
        y = 8,
        z = 1
    }
    progress:SetPercent(10)

    image:SetTextureSize(128, 128)
    image:SetTexture("./image/animation/blood/1.png")

    image.position = {
        x = 8,
        y = yapre.render_height - 8 - 128,
        z = 1
    }
    image:AddAnimationState("die", "./image/animation/blood/%d.png", 1, 20)
    image:AddAnimationState("live", "./image/animation/blood/%d.png", 1, 1)

    label:SetText(
        "O wonder! \nHow many goodly creatures are there here!\nHow beauteous mankind is!\nO brave new world,\nThat has such people in't.")
    label:SetMaxSize(64, -1)
    label.position = {
        x = 8,
        y = 8,
        z = 1
    }

    button1.position = {
        x = yapre.render_width - 8 - 32,
        y = yapre.render_height - 8 - 32,
        z = 1
    }
    button2.position = {
        x = yapre.render_width - 8 - 32 - 32,
        y = yapre.render_height - 8 - 32,
        z = 1
    }

    button1:SetState("normal")
    button2:SetState("disabled")

    world:AddEntity(button1)
    world:AddEntity(button2)
    world:AddEntity(label)
    world:AddEntity(image)
    world:AddEntity(progress)
    -- world:AddEntity(panel)
    world:AddEntity(palette)

    return world
end

return test_world
local yapre = yapre
local app = {}

local core = require("core")
local yecs = core.yecs

local splash_screen = require("core.splash_screen")
local game = require("app.game")

function app:Init()
    yapre.SetRenderSize(320, 240)
    splash_screen:Show(function()
        game:Init()
    end)
    return true
end

function app:Update(delta_ms)
    yecs.World:UpdateAllWorlds(delta_ms)
end

function app:Deinit()
end

return app
local yapre = yapre
local rewind_controller = {}

local core = require("core")
local yecs = core.yecs

local serialization = require("core.serialization")

local dump_interval = 1000 -- 1s

rewind_controller.dump_data = {}
rewind_controller.dump_data_cur_idx = 1
rewind_controller.dump_data_max_num = 100

function rewind_controller:OnKey(timestamp, state, multi, keycode)
    if state == 1 then
        keycode = string.char(keycode)
        if keycode == "\t" then
            self:PauseOrResume()
            return
        end

        if not self.paused then
            return
        end

        if keycode == "s" then
            self:Save()
            return
        end

        local delta = 1
        if keycode == "a" then
            delta = -1
        elseif keycode == "d" then
            delta = 1
        else
            return
        end

        local ps = self.progress_selector

        local cur_idx = ps:GetCurrent()
        local max_idx = ps:GetMax()

        cur_idx = cur_idx + delta
        if cur_idx > max_idx then
            cur_idx = max_idx
        elseif cur_idx < 1 then
            cur_idx = 1
        end

        local r_idx = self.dump_data_cur_idx - 1 - ps:GetMax() + cur_idx
        if r_idx < 1 then
            cur_idx = cur_idx - r_idx + 1
            r_idx = 1
        end

        ps:SetCurrent(cur_idx)
        self:Load(r_idx)
    end
end

function rewind_controller:Make(game_worlds)
    local world = yecs.World:New("rewind_controller")
    world:AddSystemsByKeys({"sprite", "input", "tree", "tick"})
    world.systems["input"].OnKey = function(input_system, timestamp, state, multi, keycode)
        self:OnKey(timestamp, state, multi, keycode)
    end

    local control_panel = yecs.EntityFactory:Make("panel")
    world:AddEntity(control_panel)
    control_panel:SetSize(yapre.render_width, 30)
    control_panel.position.z = 1024

    local progress_selector = yecs.EntityFactory:Make("progress_selector")
    world:AddEntity(progress_selector)
    control_panel.tree:AddChild(progress_selector)

    local label = yecs.EntityFactory:Make("label")
    world:AddEntity(label)
    label.text.size = 2
    label:SetText("PAUSED!")
    label.position.x = 10
    label.position.y = 10
    control_panel.tree:AddChild(label)

    self.game_worlds = game_worlds
    self.progress_selector = progress_selector
    self.control_panel = control_panel
    self.world = world

    self:ShowControlPanel(false)
    self:AddTimer()
    return world
end

function rewind_controller:Dump()
    local game_worlds = self.game_worlds

    local data = {}
    for game_world_key, game_world in pairs(game_worlds) do
        data[game_world_key] = serialization:DumpWorld(game_world)
    end

    local idx = self.dump_data_cur_idx
    idx = idx % self.dump_data_max_num
    self.dump_data[idx] = data
    self.dump_data_cur_idx = self.dump_data_cur_idx + 1
end

function rewind_controller:Load(idx)
    idx = idx % self.dump_data_max_num
    local data = self.dump_data[idx]
    if not data then
        return
    end

    local game_worlds = self.game_worlds
    for game_world_key, game_world in pairs(game_worlds) do
        game_world:Destroy()
    end

    for game_world_key, game_world_data in pairs(data) do
        local game_world = serialization:LoadWorld(game_world_data)
        game_world:Pause()
        game_worlds[game_world_key] = game_world
    end
end

function rewind_controller:PauseOrResume()
    local game_worlds = self.game_worlds
    if self.paused then
        self.paused = false
        for _, game_world in pairs(game_worlds) do
            game_world:Resume()
        end
        self.dump_data_cur_idx = self.dump_data_cur_idx - 1
        self.progress_selector:SetCurrent(-1)
        self:ShowControlPanel(false)
    else
        self.paused = true
        for _, game_world in pairs(game_worlds) do
            game_world:Pause()
        end
        self:Dump()
        self.progress_selector:SetCurrent(self.progress_selector:GetMax())
        self:ShowControlPanel(true)
    end
end

function rewind_controller:ShowControlPanel(v)
    if v then
        self.control_panel.position.y = 0
    else
        self.control_panel.position.y = -yapre.render_height
    end
end

function rewind_controller:AddTimer()
    yapre.AddTimer(dump_interval, function()
        if not self.paused then
            self:Dump()
        end
        self:AddTimer()
    end)
end

function rewind_controller:Save()
    if not self.paused then
        return
    end
    local data = self.dump_data[self.dump_data_cur_idx - 1]
    data = serialization:DumpWorld(self.world)
    table.save(data, "./dump.lua")
end

return rewind_controller
local game = {}

local rewind_controller = require("app.rewind_controller")
local world_mario_music = require("app.game.world_mario_music")
local world_slides = require("app.game.world_slides")
local world_label = require("app.game.world_label")
local world_image = require("app.game.world_image")
local world_flappy_duck = require("app.game.world_flappy_duck")

game.worlds = setmetatable({}, {
    __mode = "v"
})
game.rewind_controller = nil

function game:Init()
    self.cur_world_idx = 1
    self.worlds = {}
    self.rewind_controller = rewind_controller:Make(self.worlds)

    self.worlds_to_show = {world_label, world_mario_music, world_image, world_flappy_duck}

    self.worlds["world_slides"] = world_slides:Make()
    self.worlds[self.cur_world_idx] = self.worlds_to_show[self.cur_world_idx]:Make()
end

function game:Deinit()
end

function game:NextWorld()
    if self.cur_world_idx == #self.worlds_to_show then
        return
    end

    self.worlds[self.cur_world_idx]:Destroy()
    self.cur_world_idx = self.cur_world_idx + 1

    self.worlds[self.cur_world_idx] = self.worlds_to_show[self.cur_world_idx]:Make()
end

function game:PrevWorld()
    if self.cur_world_idx == 1 then
        return
    end

    self.worlds[self.cur_world_idx]:Destroy()
    self.cur_world_idx = self.cur_world_idx - 1

    self.worlds[self.cur_world_idx] = self.worlds_to_show[self.cur_world_idx]:Make()
end

function game:Dump()

end

function game:Load()

end

return game
local yapre = yapre
local world_mario_music = {}

local core = require("core")
local yecs = core.yecs

world_mario_music.data = {{0, 659, 125}, {125, 659, 125}, {375, 659, 125}, {667, 523, 125}, {792, 659, 125},
                          {1042, 784, 125}, {1542, 392, 125}, {2042, 523, 125}, {2417, 392, 125}, {2792, 330, 125},
                          {3167, 440, 125}, {3417, 494, 125}, {3667, 466, 125}, {3834, 440, 125}, {4084, 392, 125},
                          {4334, 659, 125}, {4584, 784, 125}, {4834, 880, 125}, {5084, 698, 125}, {5209, 784, 125},
                          {5459, 659, 125}, {5709, 523, 125}, {5959, 587, 125}, {6084, 494, 125}, {6334, 523, 125},
                          {6709, 392, 125}, {7084, 330, 125}, {7459, 440, 125}, {7709, 494, 125}, {7959, 466, 125},
                          {8126, 440, 125}, {8376, 392, 125}, {8626, 659, 125}, {8876, 784, 125}, {9126, 880, 125},
                          {9376, 698, 125}, {9501, 784, 125}, {9751, 659, 125}, {10001, 523, 125}, {10251, 587, 125},
                          {10376, 494, 125}, {10876, 784, 125}, {11001, 740, 125}, {11126, 698, 125}, {11293, 622, 125},
                          {11543, 659, 125}, {11835, 415, 125}, {11960, 440, 125}, {12085, 523, 125}, {12335, 440, 125},
                          {12460, 523, 125}, {12585, 587, 125}, {12960, 784, 125}, {13085, 740, 125}, {13210, 698, 125},
                          {13377, 622, 125}, {13627, 659, 125}, {13919, 698, 125}, {14169, 698, 125}, {14294, 698, 125},
                          {15044, 784, 125}, {15169, 740, 125}, {15294, 698, 125}, {15461, 622, 125}, {15711, 659, 125},
                          {16003, 415, 125}, {16128, 440, 125}, {16253, 523, 125}, {16503, 440, 125}, {16628, 523, 125},
                          {16753, 587, 125}, {17128, 622, 125}, {17503, 587, 125}, {17878, 523, 125}, {19128, 784, 125},
                          {19253, 740, 125}, {19378, 698, 125}, {19545, 622, 125}, {19795, 659, 125}, {20087, 415, 125},
                          {20212, 440, 125}, {20337, 523, 125}, {20587, 440, 125}, {20712, 523, 125}, {20837, 587, 125},
                          {21212, 784, 125}, {21337, 740, 125}, {21462, 698, 125}, {21629, 622, 125}, {21879, 659, 125},
                          {22171, 698, 125}, {22421, 698, 125}, {22546, 698, 125}, {23296, 784, 125}, {23421, 740, 125},
                          {23546, 698, 125}, {23713, 622, 125}, {23963, 659, 125}, {24255, 415, 125}, {24380, 440, 125},
                          {24505, 523, 125}, {24755, 440, 125}, {24880, 523, 125}, {25005, 587, 125}, {25380, 622, 125},
                          {25755, 587, 125}, {26130, 523, 125}}

yecs.Behavior:Register("world_mario_music_play_btn_behavior", {
    OnClicked = function(self, x, y)
        local data = self.data
        if data.playing then
            return
        end
        data.playing = true
        data.delta_ms = 0

        self.world:GetEntityByTags({"world_mario_music_stop_btn"}):SetState("normal")
        self:SetState("disabled")
    end,
    OnInit = function(self)
        self:AddComponent("tags")
        self:AddComponent("data")
        self:AddComponent("tick")
        local data = self.data
        data.playing = false
        data.delta_ms = 0

        self.tags["world_mario_music_play_btn"] = true
        self.tick:AddTick("world_mario_music_play", function(tick_ms)
            if not data.playing then
                self.world:GetEntityByTags({"world_mario_music_stop_btn"}):SetState("disabled")
                self:SetState("normal")
                return
            end

            self.world:GetEntityByTags({"world_mario_music_stop_btn"}):SetState("normal")
            self:SetState("disabled")

            for _, md in ipairs(world_mario_music.data) do
                if md[1] > data.delta_ms + tick_ms then
                    break
                elseif md[1] > data.delta_ms then
                    yapre.Beep(md[2], md[3])
                    break
                end
            end
            data.delta_ms = data.delta_ms + tick_ms
        end)

    end
})

yecs.Behavior:Register("world_mario_music_stop_btn_behavior", {
    OnClicked = function(self, x, y)
        local play_btn = self.world:GetEntityByTags({"world_mario_music_play_btn"})
        play_btn:SetState("normal")
        play_btn.data.playing = false
        play_btn.data.delta_ms = 0
        self:SetState("disabled")
    end,
    OnInit = function(self)
        self:AddComponent("tags")
        self.tags["world_mario_music_stop_btn"] = true
    end
})

function world_mario_music:Make()
    local world = yecs.World:New("world_mario_music")
    world:AddSystemsByKeys({"sprite", "input", "tree", "tick"})

    local play_btn = yecs.EntityFactory:Make("button", {"world_mario_music_play_btn_behavior"})
    local stop_btn = yecs.EntityFactory:Make("button", {"world_mario_music_stop_btn_behavior"})
    local image = yecs.EntityFactory:Make("image")
    image:SetTextureSize(32, 32)
    image:SetTexture("./image/mario.png")

    play_btn.position = {
        x = yapre.render_width / 2 - 32,
        y = yapre.render_height / 2,
        z = 1
    }
    stop_btn.position = {
        x = yapre.render_width / 2,
        y = yapre.render_height / 2,
        z = 1
    }
    image.position = {
        x = yapre.render_width / 2 - 16,
        y = yapre.render_height / 2 - 32 - 8,
        z = 1
    }

    world:AddEntity(play_btn)
    world:AddEntity(stop_btn)
    world:AddEntity(image)

    return world
end

return world_mario_music
local yapre = yapre
local world_slides = {}

local core = require("core")
local yecs = core.yecs

yecs.Behavior:Register("world_slides_next_btn_behavior", {
    OnClicked = function(self, x, y)
        local game = require("app.game")
        if game.NextWorld then
            game:NextWorld()
        end
    end
})

yecs.Behavior:Register("world_slides_prev_btn_behavior", {
    OnClicked = function(self, x, y)
        local game = require("app.game")
        if game.PrevWorld then
            game:PrevWorld()
        end
    end
})

function world_slides:Make()
    local world = yecs.World:New("world_slides")
    world:AddSystemsByKeys({"sprite", "input", "tree", "tick"})

    local next_btn = yecs.EntityFactory:Make("button", {"world_slides_next_btn_behavior"})
    local prev_btn = yecs.EntityFactory:Make("button", {"world_slides_prev_btn_behavior"})

    next_btn.position = {
        x = yapre.render_width - 4 - 32,
        y = yapre.render_height - 32,
        z = 1024
    }
    prev_btn.position = {
        x = yapre.render_width - 4 - 32 * 2,
        y = yapre.render_height - 32,
        z = 1024
    }

    world:AddEntity(next_btn)
    world:AddEntity(prev_btn)

    return world
end

return world_slides
local world_image = {}

local core = require("core")
local yecs = core.yecs

yecs.Behavior:Register("world_image_button1_behavior", {
    OnClicked = function(self, x, y)
        self.world:GetEntityByTags({"image2"}):PlayAnimation("die")
        self.world:GetEntityByTags({"button2"}):SetState("normal")
        self:SetState("disabled")
    end,
    OnInit = function(self)
        self:AddComponent("tags")
        self.tags["button1"] = true
    end
})

yecs.Behavior:Register("world_image_button2_behavior", {
    OnClicked = function(self, x, y)
        self.world:GetEntityByTags({"image2"}):PlayAnimation("live")
        self.world:GetEntityByTags({"button1"}):SetState("normal")
        self:SetState("disabled")
    end,
    OnInit = function(self)
        self:AddComponent("tags")
        self.tags["button2"] = true
    end
})

yecs.Behavior:Register("world_image_image2_behavior", {
    OnInit = function(self)
        self:AddComponent("tags")
        self.tags["image2"] = true
    end
})

function world_image:Make()
    local world = yecs.World:New("world_image")
    world:AddSystemsByKeys({"sprite", "input", "tree", "tick"})

    local image1 = yecs.EntityFactory:Make("image")
    image1.position = {
        x = 8,
        y = 8,
        z = 1
    }
    image1:SetTextureSize(128, 128)
    image1:AddAnimationState("loop", "./image/animation/wizard/%d.png", 1, 16, true)
    image1:PlayAnimation("loop")

    local image2 = yecs.EntityFactory:Make("image", {"world_image_image2_behavior"})
    image2.position = {
        x = 8 + 128 + 8,
        y = 8 + 32 + 8,
        z = 1
    }
    image2:SetTextureSize(128, 128)
    image2:SetTexture("./image/animation/blood/1.png")

    image2:AddAnimationState("die", "./image/animation/blood/%d.png", 1, 20)
    image2:AddAnimationState("live", "./image/animation/blood/%d.png", 1, 1)

    local button1 = yecs.EntityFactory:Make("button", {"world_image_button1_behavior"})
    local button2 = yecs.EntityFactory:Make("button", {"world_image_button2_behavior"})

    button1.position = {
        x = 8 + 8 + 128 + 32,
        y = 8 + 32 + 8 + 128 + 4,
        z = 1
    }
    button2.position = {
        x = 8 + 8 + 128,
        y = 8 + 32 + 8 + 128 + 4,
        z = 1
    }

    button1:SetState("normal")
    button2:SetState("disabled")

    world:AddEntity(button1)
    world:AddEntity(button2)
    world:AddEntity(image1)
    world:AddEntity(image2)

    return world
end

return world_image
local yapre = yapre

local world_word_slide_maker = {}
local world_word_slide = {
    words = "",
    font_size = 2
}

local core = require("core")
local copy = require("utils.copy")
local yecs = core.yecs

function world_word_slide:Make()
    local world = yecs.World:New("world_word_slide_" .. self.words)
    world:AddSystemsByKeys({"sprite", "input", "tree", "tick"})

    local words = yecs.EntityFactory:Make("label")
    words:SetText(self.words)

    local rs = words:GetRenderSize()
    words.position = {
        x = yapre.render_width / 2 - rs.width / 2,
        y = yapre.render_height / 2 + rs.height,
        z = 1
    }

    world:AddEntity(words)

    return world
end

function world_word_slide_maker:Make(words, font_size)
    local new_world = copy.copy(world_word_slide)
    new_world.words = words
    new_world.font_size = font_size
    return new_world
end

return world_word_slide_maker
local yapre = yapre
local world_label = {}

local core = require("core")
local yecs = core.yecs

yecs.Behavior:Register("world_label_time_label_behavior", {
    OnInit = function(self)
        self:AddComponent("tick")
        self:AddComponent("data")
        self.data.now_time = 0
        local interval = 23
        self.data.timer_callback = function(delta_ms)
            self.data.now_time = self.data.now_time + interval + delta_ms
            self:SetText(string.format("timing: %.4f", self.data.now_time / 1000))
            self.tick:AddTimer("time_tick", interval, self.data.timer_callback)
        end
        self.tick:AddTimer("time_tick", interval, self.data.timer_callback)
    end
})

function world_label:Make()
    local world = yecs.World:New("world_label")
    world:AddSystemsByKeys({"sprite", "input", "tree", "tick"})

    local time_label = yecs.EntityFactory:Make("label", {"world_label_time_label_behavior"})
    local world_label_a = yecs.EntityFactory:Make("label")
    local world_label_b = yecs.EntityFactory:Make("label")
    local world_label_c = yecs.EntityFactory:Make("label")
    local world_label_d = yecs.EntityFactory:Make("label")

    time_label:SetFontSize(2)
    time_label.position = {
        x = 8,
        y = yapre.render_height - 16 - 4,
        z = 1
    }

    local worlds =
        "O wonder! \nHow many goodly creatures are there here!\nHow beauteous mankind is!\nO brave new world,\nThat has such people in't."
    world_label_a:SetText(worlds)
    world_label_b:SetText(worlds)
    world_label_c:SetText(worlds)
    world_label_d:SetText("Label test")

    world_label_a:SetMaxSize(32, -1)
    world_label_a.position = {
        x = 8,
        y = 8,
        z = 1
    }

    world_label_b:SetMaxSize(yapre.render_width - 48 - 8, -1)
    world_label_b.position = {
        x = 48,
        y = 8,
        z = 1
    }

    world_label_c:SetMaxSize(yapre.render_width - 48 - 8, -1)
    world_label_c.position = {
        x = 48,
        y = 9 * 4 + 8 + 8,
        z = 1
    }
    world_label_c:SetFontSize(2)

    world_label_d:SetMaxSize(yapre.render_width - 48 - 8, -1)
    world_label_d.position = {
        x = 48,
        y = yapre.render_height - 56,
        z = 1
    }
    world_label_d:SetFontSize(4)

    world:AddEntity(time_label)
    world:AddEntity(world_label_a)
    world:AddEntity(world_label_b)
    world:AddEntity(world_label_c)
    world:AddEntity(world_label_d)

    return world
end

return world_label
local yapre = yapre
local world_flappy_duck = {}
local core = require("core")
local yecs = core.yecs

yecs.Behavior:Register("world_flappy_duck_duck_behavior", {
    OnInit = function(self)
        self.tags["duck"] = true

        self.size = {
            width = 32,
            height = 32
        }
        self:SetTextureSize(self.size.width, self.size.height)
        self:SetTexture("./image/flappy_duck/duck/up1.png")

        self:AddAnimationState("up", "./image/flappy_duck/duck/up%d.png", 1, 2, true)
        self:AddAnimationState("down", "./image/flappy_duck/duck/down%d.png", 1, 2, true)
        self:PlayAnimation("up")
        self:SetBorderEnabled(false)

        self:Born()
        self.data.y = yapre.render_height * 2
        self.position.y = self.data.y
        self.position.z = 128
        self:Die()

        self.tick:AddTick("duck_tick", function(delta_ms)
            local cs = self.world:GetEntitiesByTags({"cactus"})
            for _, c in pairs(cs) do
                if self.position.x + self.size.width - 12 < c.position.x or self.position.x + 12 > c.position.x +
                    c.size.width or self.position.y + self.size.height - 12 < c.position.y or self.position.y + 12 >
                    c.position.y + c.size.height then
                    -- nothing
                else
                    self:Die()
                end
            end

            if self.position.y > yapre.render_height or self.position.y < -self.size.height then
                self:Die()
            end

            if self.position.y > yapre.render_height * 2 and self.data.up_speed < 0 then
                return
            end

            if delta_ms > 100 then
                delta_ms = 100
            end

            local last_speed = self.data.up_speed
            self.data.y = self.data.y - delta_ms * self.data.up_speed / 1000
            self.position.y = self.data.y // 1
            self.data.up_speed = self.data.up_speed - self.data.g * delta_ms / 1000
            if last_speed * self.data.up_speed > 0 then
                return
            end
            if self.data.up_speed > 0 then
                self:PlayAnimation("up")
            else
                self:PlayAnimation("down")
            end
        end)
    end,
    Die = function(self)
        self.data.dead = true
        self.data.g = 1000
        if self.data.up_speed > 0 then
            self.data.up_speed = 0
        end

    end,
    Born = function(self)
        self.data.dead = false

        self.data.up_speed = 100
        self.data.d_up_speed = 150
        self.data.y = yapre.render_height / 2
        self.data.g = 500

        self.position.x = 32
        self.position.y = self.data.y
    end,
    Fly = function(self)
        if self.data.dead then
            return
        end
        local last_speed = self.data.up_speed
        self.data.up_speed = self.data.d_up_speed
        if last_speed <= 0 then
            self:PlayAnimation("up")
        end
    end
})

yecs.EntityFactory:Register("flappy_duck",
    {"position", "sprite", "tree", "size", "animation", "input", "tags", "data", "tick"},
    {"image", "world_flappy_duck_duck_behavior"})

yecs.Behavior:Register("world_flappy_duck_cactus_behavior", {
    OnInit = function(self)
        self.tags["cactus"] = true
        self.size = {
            width = 9,
            height = 240
        }
        for idx = 1, 30, 1 do
            self.sprite:AddSprite("cactus_" .. idx, "./image/flappy_duck/cactus.png", {
                size = {
                    width = 8,
                    height = 8
                },
                offset = {
                    x = 0,
                    y = (idx - 1) * 8,
                    z = 1
                }
            })
        end
        self.data.x = -10
        self.data.y = 0
        self.data.speed = 10
        self.position.z = 64

        self.tick:AddTick("cactus_tick", function(delta_ms)
            local duck = self.world:GetEntityByTags({"duck"})
            if duck.data.dead then
                self.data.x = -self.size.width
                self.position.x = self.data.x
                return
            end

            self.data.x = self.data.x - self.data.speed / delta_ms

            if self.data.x < -self.size.width then
                local cs = self.world:GetEntitiesByTags({"cactus"})
                local p_x = yapre.render_width
                for _, c in pairs(cs) do
                    if c.data.x + 80 > p_x then
                        p_x = c.data.x + 80
                    end
                end

                self.data.x = p_x
                local y = 50 + 140 * math.random() // 1
                if math.random() > 0.5 then
                    self.data.y = y - self.size.height
                else
                    self.data.y = y
                end
            end

            self.position.x = self.data.x // 1
            self.position.y = self.data.y // 1
        end)
    end
})

yecs.Behavior:Register("world_flappy_duck_label_behavior", {
    OnInit = function(self)
        self:AddComponent("tags")
        self:AddComponent("tick")
        self.tags["label"] = true

        self:SetText("TAP THE BUTTON \nTO START!")
        self:SetFontSize(2)
        self.position = {
            x = 128,
            y = 32,
            z = 1
        }
        self.position.z = 64

        self.tick:AddTick("label_tick", function(delta_ms)
            local duck = self.world:GetEntityByTags({"duck"})
            if duck.data.dead and duck.position.y < yapre.render_height * 2 then
                self:SetText("YOU DIED!\nTAP THE BUTTON \nTO START!")
            elseif not duck.data.dead then
                self:SetText("")
            end
        end)
    end
})

yecs.Behavior:Register("world_flappy_duck_duck_head_behavior", {
    OnInit = function(self)
        self:AddComponent("tags")
        self:AddComponent("tick")
        self.tags["duck_head"] = true

        self.position = {
            x = 16,
            y = yapre.render_height - 128,
            z = 64
        }
        self:SetTextureSize(128, 128)
        self:SetTexture("./image/flappy_duck/duck_head.png")
        self:SetBorderEnabled(false)

        self.tick:AddTick("label_tick", function(delta_ms)
            local duck = self.world:GetEntityByTags({"duck"})
            if duck.data.dead and duck.position.y < yapre.render_height * 2 then
                self.position.x = 16
            elseif not duck.data.dead then
                self.position.x = -1024
            end
        end)
    end
})

yecs.EntityFactory:Register("cactus", {"position", "sprite", "tree", "size", "tick", "tags", "data"},
    {"world_flappy_duck_cactus_behavior"})

yecs.Behavior:Register("world_flappy_duck_button_behavior", {
    OnClicked = function(self, x, y)
        local duck = self.world:GetEntityByTags({"duck"})
        if duck.data.dead then
            if duck.position.y > yapre.render_height then
                duck:Born()
            end
            return
        end
        duck:Fly()
    end,
    OnInit = function(self)
        self:AddComponent("tags")
        self.tags["button"] = true
        self:SetButtonSize(64, 64)
        self.position.y = yapre.render_height - 64 - 32
        self.position.x = yapre.render_width - 64 - 32
        self.position.z = 128
        self.input.OnKeyPressed = function(self, keycode)
            if keycode == string.byte(" ") then
                self.entity:OnClicked(0, 0)
            end
        end
    end
})

yecs.Behavior:Register("world_flappy_duck_background_behavior", {
    OnInit = function(self)
        self:AddComponent("tags")
        self:AddComponent("tick")
        self:AddComponent("data")

        self.tags["background"] = true
        self.data.tag = "background"

        self.size = {
            width = 128,
            height = 128
        }
        self:SetTextureSize(128, 128)
        self:SetBorderEnabled(false)

        self.data.x = 0
        self.data.y = 0
        self.data.z = 0
        self.data.speed = 10
        self.data.interval = 0
        self.data.y_rate = 0

        self.tick:AddTick("background_tick", function(delta_ms)
            local duck = self.world:GetEntityByTags({"duck"})
            if duck.data.dead then
                return
            end

            self.data.x = self.data.x - self.data.speed / delta_ms
            if self.data.x < -self.size.width then
                local bs = self.world:GetEntitiesByTags({self.data.tag})
                local p_x = 0 -- yapre.render_width
                for _, b in pairs(bs) do
                    if b.data.x + self.data.interval + self.size.width > p_x then
                        p_x = b.data.x + self.data.interval + self.size.width
                    end
                end
                self.data.x = p_x
            end

            self.position.x = self.data.x // 1
            self.position.y = (self.data.y + self.data.y_rate * (duck.data.y - yapre.render_height / 2)) // 1
            self.position.z = self.data.z // 1

        end)
    end
})

function world_flappy_duck:MakeBackground(world)

    local background = yecs.Entity:New({"sprite", "position"}, {})
    background.sprite:AddSprite("background", "./image/ui/blank2.png", {
        size = {
            width = yapre.render_width,
            height = yapre.render_height
        },
        color = yapre.palette.colors[1]
    })

    background.position.z = 1
    world:AddEntity(background)

    local idx = 1
    for idx = 1, 3, 1 do
        local background_stars = yecs.EntityFactory:Make("image", {"world_flappy_duck_background_behavior"})
        world:AddEntity(background_stars)

        background_stars:SetTexture("./image/flappy_duck/stars.png")
        background_stars.data.tag = "background_stars"
        background_stars.tags[background_stars.data.tag] = true
        background_stars.data.x = 16 * (idx - 1) + 128 * (idx - 1)
        background_stars.data.y = math.random(32)
        background_stars.data.z = 3
        background_stars.data.interval = 32
        background_stars.data.speed = 2
        background_stars.data.y_rate = 0.03

        background_stars.position.x = background_stars.data.x
        background_stars.position.y = background_stars.data.y
        background_stars.position.z = background_stars.data.z
    end

    for idx = 1, 4, 1 do
        local background_layer = yecs.EntityFactory:Make("image", {"world_flappy_duck_background_behavior"})
        world:AddEntity(background_layer)

        background_layer:SetTexture("./image/flappy_duck/skybg1.png")
        background_layer.data.tag = "background_layer1"
        background_layer.tags[background_layer.data.tag] = true
        background_layer.data.x = 127 * (idx - 1)
        background_layer.data.y = 160
        background_layer.data.z = 2
        background_layer.data.speed = 8
        background_layer.data.interval = -1
        background_layer.data.y_rate = -0.1

        background_layer.position.x = background_layer.data.x
        background_layer.position.y = background_layer.data.y
        background_layer.position.z = background_layer.data.z
    end

    for idx = 1, 4, 1 do
        local background_layer = yecs.EntityFactory:Make("image", {"world_flappy_duck_background_behavior"})
        world:AddEntity(background_layer)

        background_layer:SetTexture("./image/flappy_duck/skybg2.png")
        background_layer.data.tag = "background_layer2"
        background_layer.tags[background_layer.data.tag] = true
        background_layer.data.x = 127 * (idx - 1)
        background_layer.data.y = 200
        background_layer.data.z = 4
        background_layer.data.interval = -1
        background_layer.data.y_rate = -0.2

        background_layer.position.x = background_layer.data.x
        background_layer.position.y = background_layer.data.y
        background_layer.position.z = background_layer.data.z
    end
end

function world_flappy_duck:Make()
    local world = yecs.World:New("world_flappy_duck")
    world:AddSystemsByKeys({"sprite", "input", "tree", "tick"})

    local button = yecs.EntityFactory:Make("button", {"world_flappy_duck_button_behavior"})
    world:AddEntity(button)

    local label = yecs.EntityFactory:Make("label", {"world_flappy_duck_label_behavior"})
    world:AddEntity(label)

    local duck_head = yecs.EntityFactory:Make("image", {"world_flappy_duck_duck_head_behavior"})
    world:AddEntity(duck_head)

    local duck = yecs.EntityFactory:Make("flappy_duck")
    world:AddEntity(duck)

    local idx = 1
    for idx = 1, 5, 1 do
        local cactus = yecs.EntityFactory:Make("cactus")
        world:AddEntity(cactus)
    end

    self:MakeBackground(world)
    return world
end

return world_flappy_duck
local copy_module = {}

local function deep_copy(obj, seen)
    -- Handle non-tables and previously-seen tables.
    if type(obj) ~= 'table' then
        return obj
    end
    if seen and seen[obj] then
        return seen[obj]
    end

    -- New table; mark it as seen an copy recursively.
    local s = seen or {}
    local res = {}
    s[obj] = res
    for k, v in next, obj do
        res[deep_copy(k, s)] = deep_copy(v, s)
    end
    return setmetatable(res, getmetatable(obj))
end

local function copy(obj)
    if type(obj) ~= 'table' then
        return obj
    end
    local c = {}
    for k, v in next, obj do
        c[k] = v
    end
    return setmetatable(c, getmetatable(obj))
end

copy_module.deep_copy = deep_copy
copy_module.copy = copy

return copy_module
local uuid = {}
local random = math.random

local function new()
    local template = 'xxxxxxxx'
    return string.gsub(template, '[xy]', function(c)
        local v = (c == 'x') and random(0, 0xf) or random(8, 0xb)
        return string.format('%x', v)
    end)
end
uuid.new = new

return uuid
--[[
	Copyright (c) 2020 Scott Lembcke and Howling Moon Software
	
	Permission is hereby granted, free of charge, to any person obtaining a copy
	of this software and associated documentation files (the "Software"), to deal
	in the Software without restriction, including without limitation the rights
	to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
	copies of the Software, and to permit persons to whom the Software is
	furnished to do so, subject to the following conditions:
	
	The above copyright notice and this permission notice shall be included in
	all copies or substantial portions of the Software.
	
	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
	IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
	AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
	OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
	SOFTWARE.
	
	TODO:
	* Print short function arguments as part of stack location.
	* Properly handle being reentrant due to coroutines.
]] local dbg

-- Use ANSI color codes in the prompt by default.
local COLOR_GRAY = ""
local COLOR_RED = ""
local COLOR_BLUE = ""
local COLOR_YELLOW = ""
local COLOR_RESET = ""
local GREEN_CARET = " => "

local function pretty(obj, max_depth)
    if max_depth == nil then
        max_depth = dbg.pretty_depth
    end

    -- Returns true if a table has a __tostring metamethod.
    local function coerceable(tbl)
        local meta = getmetatable(tbl)
        return (meta and meta.__tostring)
    end

    local function recurse(obj, depth)
        if type(obj) == "string" then
            -- Dump the string so that escape sequences are printed.
            return string.format("%q", obj)
        elseif type(obj) == "table" and depth < max_depth and not coerceable(obj) then
            local str = "{"

            for k, v in pairs(obj) do
                local pair = pretty(k, 0) .. " = " .. recurse(v, depth + 1)
                str = str .. (str == "{" and pair or ", " .. pair)
            end

            return str .. "}"
        else
            -- tostring() can fail if there is an error in a __tostring metamethod.
            local success, value = pcall(function()
                return tostring(obj)
            end)
            return (success and value or "<!!error in __tostring metamethod!!>")
        end
    end

    return recurse(obj, 0)
end

-- The stack level that cmd_* functions use to access locals or info
-- The structure of the code very carefully ensures this.
local CMD_STACK_LEVEL = 6

-- Location of the top of the stack outside of the debugger.
-- Adjusted by some debugger entrypoints.
local stack_top = 0

-- The current stack frame index.
-- Changed using the up/down commands
local stack_inspect_offset = 0

-- LuaJIT has an off by one bug when setting local variables.
local LUA_JIT_SETLOCAL_WORKAROUND = 0

-- Default dbg.read function
local function dbg_read(prompt)
    dbg.write(prompt)
    io.flush()
    return io.read()
end

-- Default dbg.write function
local function dbg_write(str)
    io.write(str)
end

local function dbg_writeln(str, ...)
    if select("#", ...) == 0 then
        dbg.write((str or "<NULL>") .. "\n")
    else
        dbg.write(string.format(str .. "\n", ...))
    end
end

local function format_loc(file, line)
    return COLOR_BLUE .. file .. COLOR_RESET .. ":" .. COLOR_YELLOW .. line .. COLOR_RESET
end
local function format_stack_frame_info(info)
    local filename = info.source:match("@(.*)")
    local source = filename and dbg.shorten_path(filename) or info.short_src
    local namewhat = (info.namewhat == "" and "chunk at" or info.namewhat)
    local name = (info.name and "'" .. COLOR_BLUE .. info.name .. COLOR_RESET .. "'" or
                     format_loc(source, info.linedefined))
    return format_loc(source, info.currentline) .. " in " .. namewhat .. " " .. name
end

local repl

-- Return false for stack frames without source,
-- which includes C frames, Lua bytecode, and `loadstring` functions
local function frame_has_line(info)
    return info.currentline >= 0
end

local function hook_factory(repl_threshold)
    return function(offset, reason)
        return function(event, _)
            -- Skip events that don't have line information.
            if not frame_has_line(debug.getinfo(2)) then
                return
            end

            -- Tail calls are specifically ignored since they also will have tail returns to balance out.
            if event == "call" then
                offset = offset + 1
            elseif event == "return" and offset > repl_threshold then
                offset = offset - 1
            elseif event == "line" and offset <= repl_threshold then
                repl(reason)
            end
        end
    end
end

local hook_step = hook_factory(1)
local hook_next = hook_factory(0)
local hook_finish = hook_factory(-1)

-- Create a table of all the locally accessible variables.
-- Globals are not included when running the locals command, but are when running the print command.
local function local_bindings(offset, include_globals)
    local level = offset + stack_inspect_offset + CMD_STACK_LEVEL
    local func = debug.getinfo(level).func
    local bindings = {}

    -- Retrieve the upvalues
    do
        local i = 1;
        while true do
            local name, value = debug.getupvalue(func, i)
            if not name then
                break
            end
            bindings[name] = value
            i = i + 1
        end
    end

    -- Retrieve the locals (overwriting any upvalues)
    do
        local i = 1;
        while true do
            local name, value = debug.getlocal(level, i)
            if not name then
                break
            end
            bindings[name] = value
            i = i + 1
        end
    end

    -- Retrieve the varargs (works in Lua 5.2 and LuaJIT)
    local varargs = {}
    do
        local i = 1;
        while true do
            local name, value = debug.getlocal(level, -i)
            if not name then
                break
            end
            varargs[i] = value
            i = i + 1
        end
    end
    if #varargs > 0 then
        bindings["..."] = varargs
    end

    if include_globals then
        -- In Lua 5.2, you have to get the environment table from the function's locals.
        local env = (_VERSION <= "Lua 5.1" and getfenv(func) or bindings._ENV)
        return setmetatable(bindings, {
            __index = env or _G
        })
    else
        return bindings
    end
end

-- Used as a __newindex metamethod to modify variables in cmd_eval().
local function mutate_bindings(_, name, value)
    local FUNC_STACK_OFFSET = 3 -- Stack depth of this function.
    local level = stack_inspect_offset + FUNC_STACK_OFFSET + CMD_STACK_LEVEL

    -- Set a local.
    do
        local i = 1;
        repeat
            local var = debug.getlocal(level, i)
            if name == var then
                dbg_writeln(
                    COLOR_YELLOW .. "debugger.lua" .. GREEN_CARET .. "Set local variable " .. COLOR_BLUE .. name ..
                        COLOR_RESET)
                return debug.setlocal(level + LUA_JIT_SETLOCAL_WORKAROUND, i, value)
            end
            i = i + 1
        until var == nil
    end

    -- Set an upvalue.
    local func = debug.getinfo(level).func
    do
        local i = 1;
        repeat
            local var = debug.getupvalue(func, i)
            if name == var then
                dbg_writeln(COLOR_YELLOW .. "debugger.lua" .. GREEN_CARET .. "Set upvalue " .. COLOR_BLUE .. name ..
                                COLOR_RESET)
                return debug.setupvalue(func, i, value)
            end
            i = i + 1
        until var == nil
    end

    -- Set a global.
    dbg_writeln(COLOR_YELLOW .. "debugger.lua" .. GREEN_CARET .. "Set global variable " .. COLOR_BLUE .. name ..
                    COLOR_RESET)
    _G[name] = value
end

-- Compile an expression with the given variable bindings.
local function compile_chunk(block, env)
    local source = "debugger.lua REPL"
    local chunk = nil

    if _VERSION <= "Lua 5.1" then
        chunk = loadstring(block, source)
        if chunk then
            setfenv(chunk, env)
        end
    else
        -- The Lua 5.2 way is a bit cleaner
        chunk = load(block, source, "t", env)
    end

    if not chunk then
        dbg_writeln(COLOR_RED .. "Error: Could not compile block:\n" .. COLOR_RESET .. block)
    end
    return chunk
end

local SOURCE_CACHE = {}

function where(info, context_lines)
    local source = SOURCE_CACHE[info.source]
    if not source then
        source = {}
        local filename = info.source:match("@(.*)")
        if filename then
            pcall(function()
                for line in io.lines(filename) do
                    table.insert(source, line)
                end
            end)
        elseif info.source then
            for line in info.source:gmatch("(.-)\n") do
                table.insert(source, line)
            end
        end
        SOURCE_CACHE[info.source] = source
    end

    if source and source[info.currentline] then
        for i = info.currentline - context_lines, info.currentline + context_lines do
            local GREEN_CARET = (i == info.currentline and GREEN_CARET or "    ")
            local line = source[i]
            if line then
                dbg_writeln(COLOR_GRAY .. "% 4d" .. GREEN_CARET .. "%s", i, line)
            end
        end
    else
        dbg_writeln(COLOR_RED .. "Error: Source not available for " .. COLOR_BLUE .. info.short_src);
    end

    return false
end

-- Wee version differences
local unpack = unpack or table.unpack
local pack = function(...)
    return {
        n = select("#", ...),
        ...
    }
end

function cmd_step()
    stack_inspect_offset = stack_top
    return true, hook_step
end

function cmd_next()
    stack_inspect_offset = stack_top
    return true, hook_next
end

function cmd_finish()
    local offset = stack_top - stack_inspect_offset
    stack_inspect_offset = stack_top
    return true, offset < 0 and hook_factory(offset - 1) or hook_finish
end

local function cmd_print(expr)
    local env = local_bindings(1, true)
    local chunk = compile_chunk("return " .. expr, env)
    if chunk == nil then
        return false
    end

    -- Call the chunk and collect the results.
    local results = pack(pcall(chunk, unpack(rawget(env, "...") or {})))

    -- The first result is the pcall error.
    if not results[1] then
        dbg_writeln(COLOR_RED .. "Error:" .. COLOR_RESET .. " " .. results[2])
    else
        local output = ""
        for i = 2, results.n do
            output = output .. (i ~= 2 and ", " or "") .. pretty(results[i])
        end

        if output == "" then
            output = "<no result>"
        end
        dbg_writeln(COLOR_BLUE .. expr .. GREEN_CARET .. output)
    end

    return false
end

local function cmd_eval(code)
    local env = local_bindings(1, true)
    local mutable_env = setmetatable({}, {
        __index = env,
        __newindex = mutate_bindings
    })

    local chunk = compile_chunk(code, mutable_env)
    if chunk == nil then
        return false
    end

    -- Call the chunk and collect the results.
    local success, err = pcall(chunk, unpack(rawget(env, "...") or {}))
    if not success then
        dbg_writeln(COLOR_RED .. "Error:" .. COLOR_RESET .. " " .. tostring(err))
    end

    return false
end

local function cmd_down()
    local offset = stack_inspect_offset
    local info

    repeat -- Find the next frame with a file.
        offset = offset + 1
        info = debug.getinfo(offset + CMD_STACK_LEVEL)
    until not info or frame_has_line(info)

    if info then
        stack_inspect_offset = offset
        dbg_writeln("Inspecting frame: " .. format_stack_frame_info(info))
        if tonumber(dbg.auto_where) then
            where(info, dbg.auto_where)
        end
    else
        info = debug.getinfo(stack_inspect_offset + CMD_STACK_LEVEL)
        dbg_writeln("Already at the bottom of the stack.")
    end

    return false
end

local function cmd_up()
    local offset = stack_inspect_offset
    local info

    repeat -- Find the next frame with a file.
        offset = offset - 1
        if offset < stack_top then
            info = nil;
            break
        end
        info = debug.getinfo(offset + CMD_STACK_LEVEL)
    until frame_has_line(info)

    if info then
        stack_inspect_offset = offset
        dbg_writeln("Inspecting frame: " .. format_stack_frame_info(info))
        if tonumber(dbg.auto_where) then
            where(info, dbg.auto_where)
        end
    else
        info = debug.getinfo(stack_inspect_offset + CMD_STACK_LEVEL)
        dbg_writeln("Already at the top of the stack.")
    end

    return false
end

local function cmd_where(context_lines)
    local info = debug.getinfo(stack_inspect_offset + CMD_STACK_LEVEL)
    return (info and where(info, tonumber(context_lines) or 5))
end

local function cmd_trace()
    dbg_writeln("Inspecting frame %d", stack_inspect_offset - stack_top)
    local i = 0;
    while true do
        local info = debug.getinfo(stack_top + CMD_STACK_LEVEL + i)
        if not info then
            break
        end

        local is_current_frame = (i + stack_top == stack_inspect_offset)
        local GREEN_CARET = (is_current_frame and GREEN_CARET or "    ")
        dbg_writeln(COLOR_GRAY .. "% 4d" .. COLOR_RESET .. GREEN_CARET .. "%s", i, format_stack_frame_info(info))
        i = i + 1
    end

    return false
end

local function cmd_locals()
    local bindings = local_bindings(1, false)

    -- Get all the variable binding names and sort them
    local keys = {}
    for k, _ in pairs(bindings) do
        table.insert(keys, k)
    end
    table.sort(keys)

    for _, k in ipairs(keys) do
        local v = bindings[k]

        -- Skip the debugger object itself, "(*internal)" values, and Lua 5.2's _ENV object.
        if not rawequal(v, dbg) and k ~= "_ENV" and not k:match("%(.*%)") then
            dbg_writeln("  " .. COLOR_BLUE .. k .. GREEN_CARET .. pretty(v))
        end
    end

    return false
end

local function cmd_help()
    dbg.write("" .. COLOR_BLUE .. "  <return>" .. GREEN_CARET .. "re-run last command\n" .. COLOR_BLUE .. "  c" ..
                  COLOR_YELLOW .. "(ontinue)" .. GREEN_CARET .. "continue execution\n" .. COLOR_BLUE .. "  s" ..
                  COLOR_YELLOW .. "(tep)" .. GREEN_CARET .. "step forward by one line (into functions)\n" .. COLOR_BLUE ..
                  "  n" .. COLOR_YELLOW .. "(ext)" .. GREEN_CARET ..
                  "step forward by one line (skipping over functions)\n" .. COLOR_BLUE .. "  f" .. COLOR_YELLOW ..
                  "(inish)" .. GREEN_CARET .. "step forward until exiting the current function\n" .. COLOR_BLUE .. "  u" ..
                  COLOR_YELLOW .. "(p)" .. GREEN_CARET .. "move up the stack by one frame\n" .. COLOR_BLUE .. "  d" ..
                  COLOR_YELLOW .. "(own)" .. GREEN_CARET .. "move down the stack by one frame\n" .. COLOR_BLUE .. "  w" ..
                  COLOR_YELLOW .. "(here) " .. COLOR_BLUE .. "[line count]" .. GREEN_CARET ..
                  "print source code around the current line\n" .. COLOR_BLUE .. "  e" .. COLOR_YELLOW .. "(val) " ..
                  COLOR_BLUE .. "[statement]" .. GREEN_CARET .. "execute the statement\n" .. COLOR_BLUE .. "  p" ..
                  COLOR_YELLOW .. "(rint) " .. COLOR_BLUE .. "[expression]" .. GREEN_CARET ..
                  "execute the expression and print the result\n" .. COLOR_BLUE .. "  t" .. COLOR_YELLOW .. "(race)" ..
                  GREEN_CARET .. "print the stack trace\n" .. COLOR_BLUE .. "  l" .. COLOR_YELLOW .. "(ocals)" ..
                  GREEN_CARET .. "print the function arguments, locals and upvalues.\n" .. COLOR_BLUE .. "  h" ..
                  COLOR_YELLOW .. "(elp)" .. GREEN_CARET .. "print this message\n" .. COLOR_BLUE .. "  q" ..
                  COLOR_YELLOW .. "(uit)" .. GREEN_CARET .. "halt execution\n")
    return false
end

local last_cmd = false

local commands = {
    ["^c$"] = function()
        return true
    end,
    ["^s$"] = cmd_step,
    ["^n$"] = cmd_next,
    ["^f$"] = cmd_finish,
    ["^p%s+(.*)$"] = cmd_print,
    ["^e%s+(.*)$"] = cmd_eval,
    ["^u$"] = cmd_up,
    ["^d$"] = cmd_down,
    ["^w%s*(%d*)$"] = cmd_where,
    ["^t$"] = cmd_trace,
    ["^l$"] = cmd_locals,
    ["^h$"] = cmd_help,
    ["^q$"] = function()
        dbg.exit(0);
        return true
    end
}

local function match_command(line)
    for pat, func in pairs(commands) do
        -- Return the matching command and capture argument.
        if line:find(pat) then
            return func, line:match(pat)
        end
    end
end

-- Run a command line
-- Returns true if the REPL should exit and the hook function factory
local function run_command(line)
    -- GDB/LLDB exit on ctrl-d
    if line == nil then
        dbg.exit(1);
        return true
    end

    -- Re-execute the last command if you press return.
    if line == "" then
        line = last_cmd or "h"
    end

    local command, command_arg = match_command(line)
    if command then
        last_cmd = line
        -- unpack({...}) prevents tail call elimination so the stack frame indices are predictable.
        return unpack({command(command_arg)})
    elseif dbg.auto_eval then
        return unpack({cmd_eval(line)})
    else
        dbg_writeln(COLOR_RED .. "Error:" .. COLOR_RESET ..
                        " command '%s' not recognized.\nType 'h' and press return for a command list.", line)
        return false
    end
end

repl = function(reason)
    -- Skip frames without source info.
    while not frame_has_line(debug.getinfo(stack_inspect_offset + CMD_STACK_LEVEL - 3)) do
        stack_inspect_offset = stack_inspect_offset + 1
    end

    local info = debug.getinfo(stack_inspect_offset + CMD_STACK_LEVEL - 3)
    reason = reason and (COLOR_YELLOW .. "break via " .. COLOR_RED .. reason .. GREEN_CARET) or ""
    dbg_writeln(reason .. format_stack_frame_info(info))

    if tonumber(dbg.auto_where) then
        where(info, dbg.auto_where)
    end

    repeat
        local success, done, hook = pcall(run_command, dbg.read(COLOR_RED .. "debugger.lua> " .. COLOR_RESET))
        if success then
            debug.sethook(hook and hook(0), "crl")
        else
            local message = COLOR_RED .. "INTERNAL DEBUGGER.LUA ERROR. ABORTING\n:" .. COLOR_RESET .. " " .. done
            dbg_writeln(message)
            error(message)
        end
    until done
end

-- Make the debugger object callable like a function.
dbg = setmetatable({}, {
    __call = function(self, condition, top_offset, source)
        if condition then
            return
        end

        top_offset = (top_offset or 0)
        stack_inspect_offset = top_offset
        stack_top = top_offset

        debug.sethook(hook_next(1, source or "dbg()"), "crl")
        return
    end
})

-- Expose the debugger's IO functions.
dbg.read = dbg_read
dbg.write = dbg_write
dbg.shorten_path = function(path)
    return path
end
dbg.exit = function(err)
    os.exit(err)
end

dbg.writeln = dbg_writeln

dbg.pretty_depth = 3
dbg.pretty = pretty
dbg.pp = function(value, depth)
    dbg_writeln(pretty(value, depth))
end

dbg.auto_where = false
dbg.auto_eval = false

local lua_error, lua_assert = error, assert

-- Works like error(), but invokes the debugger.
function dbg.error(err, level)
    level = level or 1
    dbg_writeln(COLOR_RED .. "ERROR: " .. COLOR_RESET .. pretty(err))
    dbg(false, level, "dbg.error()")

    lua_error(err, level)
end

-- Works like assert(), but invokes the debugger on a failure.
function dbg.assert(condition, message)
    if not condition then
        dbg_writeln(COLOR_RED .. "ERROR:" .. COLOR_RESET .. message)
        dbg(false, 1, "dbg.assert()")
    end

    return lua_assert(condition, message)
end

-- Works like pcall(), but invokes the debugger on an error.
function dbg.call(f, ...)
    return xpcall(f, function(err)
        dbg_writeln(COLOR_RED .. "ERROR: " .. COLOR_RESET .. pretty(err))
        dbg(false, 1, "dbg.call()")

        return err
    end, ...)
end

-- Error message handler that can be used with lua_pcall().
function dbg.msgh(...)
    if debug.getinfo(2) then
        dbg_writeln(COLOR_RED .. "ERROR: " .. COLOR_RESET .. pretty(...))
        dbg(false, 1, "dbg.msgh()")
    else
        dbg_writeln(COLOR_RED .. "debugger.lua: " .. COLOR_RESET ..
                        "Error did not occur in Lua code. Execution will continue after dbg_pcall().")
    end

    return ...
end

-- Assume stdin/out are TTYs unless we can use LuaJIT's FFI to properly check them.
local stdin_isatty = true
local stdout_isatty = true

-- Conditionally enable the LuaJIT FFI.
local ffi = (jit and require("ffi"))
if ffi then
    ffi.cdef [[
		int isatty(int); // Unix
		int _isatty(int); // Windows
		void free(void *ptr);
		
		char *readline(const char *);
		int add_history(const char *);
	]]

    local function get_func_or_nil(sym)
        local success, func = pcall(function()
            return ffi.C[sym]
        end)
        return success and func or nil
    end

    local isatty = get_func_or_nil("isatty") or get_func_or_nil("_isatty")
    stdin_isatty = isatty(0)
    stdout_isatty = isatty(1)
end

-- Conditionally enable color support.
local color_maybe_supported = (stdout_isatty and os.getenv("TERM") and os.getenv("TERM") ~= "dumb")
if color_maybe_supported and not os.getenv("DBG_NOCOLOR") then
    COLOR_GRAY = string.char(27) .. "[90m"
    COLOR_RED = string.char(27) .. "[91m"
    COLOR_BLUE = string.char(27) .. "[94m"
    COLOR_YELLOW = string.char(27) .. "[33m"
    COLOR_RESET = string.char(27) .. "[0m"
    GREEN_CARET = string.char(27) .. "[92m => " .. COLOR_RESET
end

if stdin_isatty and not os.getenv("DBG_NOREADLINE") then
    pcall(function()
        local linenoise = require 'linenoise'

        -- Load command history from ~/.lua_history
        local hist_path = os.getenv('HOME') .. '/.lua_history'
        linenoise.historyload(hist_path)
        linenoise.historysetmaxlen(50)

        local function autocomplete(env, input, matches)
            for name, _ in pairs(env) do
                if name:match('^' .. input .. '.*') then
                    linenoise.addcompletion(matches, name)
                end
            end
        end

        -- Auto-completion for locals and globals
        linenoise.setcompletion(function(matches, input)
            -- First, check the locals and upvalues.
            local env = local_bindings(1, true)
            autocomplete(env, input, matches)

            -- Then, check the implicit environment.
            env = getmetatable(env).__index
            autocomplete(env, input, matches)
        end)

        dbg.read = function(prompt)
            local str = linenoise.linenoise(prompt)
            if str and not str:match "^%s*$" then
                linenoise.historyadd(str)
                linenoise.historysave(hist_path)
            end
            return str
        end
        dbg_writeln(COLOR_YELLOW .. "debugger.lua: " .. COLOR_RESET .. "Linenoise support enabled.")
    end)

    -- Conditionally enable LuaJIT readline support.
    pcall(function()
        if dbg.read == nil and ffi then
            local readline = ffi.load("readline")
            dbg.read = function(prompt)
                local cstr = readline.readline(prompt)
                if cstr ~= nil then
                    local str = ffi.string(cstr)
                    if string.match(str, "[^%s]+") then
                        readline.add_history(cstr)
                    end

                    ffi.C.free(cstr)
                    return str
                else
                    return nil
                end
            end
            dbg_writeln(COLOR_YELLOW .. "debugger.lua: " .. COLOR_RESET .. "Readline support enabled.")
        end
    end)
end

-- Detect Lua version.
if jit then -- LuaJIT
    LUA_JIT_SETLOCAL_WORKAROUND = -1
    dbg_writeln(COLOR_YELLOW .. "debugger.lua: " .. COLOR_RESET .. "Loaded for " .. jit.version)
elseif "Lua 5.1" <= _VERSION and _VERSION <= "Lua 5.4" then
    dbg_writeln(COLOR_YELLOW .. "debugger.lua: " .. COLOR_RESET .. "Loaded for " .. _VERSION)
else
    dbg_writeln(COLOR_YELLOW .. "debugger.lua: " .. COLOR_RESET .. "Not tested against " .. _VERSION)
    dbg_writeln("Please send me feedback!")
end

return dbg
local reload = {}

function reload.Reload(module_name)
    package.loaded[module_name] = nil
    require(module_name)
end

function reload.ReloadAll()
    local loaded_modules = {}
    for module_name, _ in pairs(package.loaded) do
        table.insert(loaded_modules, module_name)
    end
    for _, module_name in pairs(loaded_modules) do
        package.loaded[module_name] = nil
    end
    for _, module_name in pairs(loaded_modules) do
        require(module_name)
    end
end

return reload
local debug_log = {}
debug_log._print = print

function debug_log.enable()
    debug_log.log = function(...)
        debug_log._print("[debug log]", ...)
    end
    print = debug_log.log
end

function debug_log.disable()
    debug_log.log = function()
    end
    print = debug_log._print
end

debug_log.enable()

return debug_log
--[[
Save Table to File
Load Table from File
v 1.0

Lua 5.2 compatible

Only Saves Tables, Numbers and Strings
Insides Table References are saved
Does not save Userdata, Metatables, Functions and indices of these
----------------------------------------------------
table.save( table , filename )

on failure: returns an error msg

----------------------------------------------------
table.load( filename or stringtable )

Loads a table that has been saved via the table.save function

on success: returns a previously saved table
on failure: returns as second argument an error msg
----------------------------------------------------

Licensed under the same terms as Lua itself.
]] --
do
    -- declare local variables
    -- // exportstring( string )
    -- // returns a "Lua" portable version of the string
    local function exportstring(s)
        return string.format("%q", s)
    end

    -- // The Save Function
    function table.save(tbl, filename)
        local charS, charE = "   ", "\n"
        local file, err = io.open(filename, "wb")
        if err then
            return err
        end

        -- initiate variables for save procedure
        local tables, lookup = {tbl}, {
            [tbl] = 1
        }
        file:write("return {" .. charE)

        for idx, t in ipairs(tables) do
            file:write("-- Table: {" .. idx .. "}" .. charE)
            file:write("{" .. charE)
            local thandled = {}

            for i, v in ipairs(t) do
                thandled[i] = true
                local stype = type(v)
                -- only handle value
                if stype == "table" then
                    if not lookup[v] then
                        table.insert(tables, v)
                        lookup[v] = #tables
                    end
                    file:write(charS .. "{" .. lookup[v] .. "}," .. charE)
                elseif stype == "string" then
                    file:write(charS .. exportstring(v) .. "," .. charE)
                elseif stype == "number" then
                    file:write(charS .. tostring(v) .. "," .. charE)
                end
            end

            for i, v in pairs(t) do
                -- escape handled values
                if (not thandled[i]) then

                    local str = ""
                    local stype = type(i)
                    -- handle index
                    if stype == "table" then
                        if not lookup[i] then
                            table.insert(tables, i)
                            lookup[i] = #tables
                        end
                        str = charS .. "[{" .. lookup[i] .. "}]="
                    elseif stype == "string" then
                        str = charS .. "[" .. exportstring(i) .. "]="
                    elseif stype == "number" then
                        str = charS .. "[" .. tostring(i) .. "]="
                    end

                    if str ~= "" then
                        stype = type(v)
                        -- handle value
                        if stype == "table" then
                            if not lookup[v] then
                                table.insert(tables, v)
                                lookup[v] = #tables
                            end
                            file:write(str .. "{" .. lookup[v] .. "}," .. charE)
                        elseif stype == "string" then
                            file:write(str .. exportstring(v) .. "," .. charE)
                        elseif stype == "number" then
                            file:write(str .. tostring(v) .. "," .. charE)
                        elseif stype == "boolean" then
                            file:write(str .. tostring(v) .. "," .. charE)
                        end
                    end
                end
            end
            file:write("}," .. charE)
        end
        file:write("}")
        file:close()
    end

    -- // The Load Function
    function table.load(sfile)
        local ftables, err = loadfile(sfile)
        if err then
            return _, err
        end
        local tables = ftables()
        for idx = 1, #tables do
            local tolinki = {}
            for i, v in pairs(tables[idx]) do
                if type(v) == "table" then
                    tables[idx][i] = tables[v[1]]
                end
                if type(i) == "table" and tables[i[1]] then
                    table.insert(tolinki, {i, tables[i[1]]})
                end
            end
            -- link indices
            for _, v in ipairs(tolinki) do
                tables[idx][v[2]], tables[idx][v[1]] = tables[idx][v[1]], nil
            end
        end
        return tables[1]
    end
    -- close do
end

-- ChillCode
local IGNORED_WRITES = {
    Init = true,
    Deinit = true,
    Update = true
}
local IGNORED_READS = {}

-- Raises an error when an undeclared variable is read.
local function guardGlobals()
    assert(getmetatable(_G) == nil, "another global metatable exists")

    -- The detecting of undeclared vars is discussed on:
    -- http://www.lua.org/pil/14.2.html
    -- http://lua-users.org/wiki/DetectingUndefinedVariables
    setmetatable(_G, {
        __newindex = function(table, key, value)
            if not IGNORED_WRITES[key] then
                local info = debug.getinfo(2, "Sl")
                io.stderr:write(string.format("strict: %s:%s: write to undeclared variable: %s\n",
                    tostring(info.short_src), tostring(info.currentline), key))
            end
            rawset(table, key, value)
        end,
        __index = function(table, key)
            if IGNORED_READS[key] then
                return
            end
            error("attempt to read undeclared variable " .. key, 2)
        end
    })

    local origRequire = require
    function require(modname)
        IGNORED_WRITES[modname] = true
        return origRequire(modname)
    end
end

guardGlobals()
attribute vec4 vertex; 
varying vec2 TexCoords;

uniform mat4 model;
uniform mat4 projection;

void main()
{
    TexCoords = vertex.zw;
    gl_Position = projection * model * vec4(vertex.xy, 0.0, 1.0);
}


#if __VERSION__ < 110
precision mediump float;
#endif

varying vec2 TexCoords;

uniform sampler2D sprite;
uniform vec3 spriteColor;

void main()
{
    gl_FragColor = vec4(spriteColor, 1.0) * texture2D(sprite, TexCoords);
}


PNG

   IHDR           szz   sRGB    IDATXc``Q0Xvyq?.66>6EV	8-@b,&dF.\@D,0\|%6X9bb7
F(`r     IENDB`PNG

   IHDR         a   IDATxS0}~D~ qdf$.n	&	I$u6^!qXp|D@!O6+o&tYnJmHK10fU?LBTnJN p>^Q~f
!c(:+`>TNYCd!TLZ.KyB*yj	EZ!ZP! 6f([0=
9[sy    IENDB`PNG

   IHDR         a   sRGB    [IDAT8cd#$sawH~7	slY:00&"	\\|4a0<3 !y    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATx=jQo}HA"+YOgRtZM+a|hx}=_y3B!r__$ZtW;@Q-6~CH]Lys  &-yz03{3dk/74_ 72; o(Sb\1|  	o 	~<'6lP@.GJpwK z:Z.%MRh.o,9Pl=3 5=),*>7HW^;6pnE/KpLqf:jf==-^{!GAU\    IENDB`PNG

   IHDR    @   ,
   sRGB   IDATxj[g4zC/]Kl@PHMP0 Md{I?6?W;                                                                                                                                                                                                                                              eT]6{M|pq Yu  l  X  F  yut|zr/+=?^J V:  a@ 0  @    F  #      avI -_WM  |2yV]v>?. x`:  a@ 0q#U|uP]?%  [ F  #      a@ 0  @    F  (8w9\kh-'OU_}z?  @    &7__u	Au 6      a@ 0  @    F  #      aLe>m3LKb>k~_}[ F  #      a~8.xZ]  E:  a@ 0  @    F  #      aB}x;:lY]k<@ 0  @    &&V  u:  a@ 0q#Yu	  t    a@ 0  @    F   ?.[hSc<6}b>ktUG-  @    F  #    XcO&n}l  = #  1Mc]78 @ 8  @    F  .`Qui/euV F  =!^^p|z     D{ :t    aGwtm;E    &z]8 v  @    o _-[?<z>T-YO]WK  -	 @ 0  @#:'Y     qG3 0:  q@ 0  @    F  #   ];<z>x2~  <Ww]a~ 0 @  bj l  @  07x_^,  #  }_c_ :  a@ 0eu t                                                                                                                                                                                                          `rB7YA    IENDB`PNG

   IHDR         r$   sRGB    IDATc&(  = |F    IENDB`PNG

   IHDR         a   sRGB    _IDAT8c`h1bOs#^l$V7	!jF7$]XH@&d,$(	)4-(MgGMHc rRx  CqT    IENDB`PNG

   IHDR         a   sRGB    aIDAT8c`#h:YshZ"qf#`32N6	Y-<>z($Pb@NH ZiT    IENDB`PNG

   IHDR         a   sRGB    ]IDAT8c`FA?)1g` $&p=##9a"K'6]T D450r C.Zo    IENDB`PNG

   IHDR            sRGB    ~IDATcd```H* Fd7a%#aw%afL'C[	d`:l!X470tA907 7YseNb .rx/    IENDB`PNG

   IHDR         >a   sRGB   IDATx?nA5*MJH q!e4r 3;i	a?ow      @|H)z>~}=Z,Wo lu	W_}%h_&k];g6/})) 1 qjYPi:^UA}5Yw: nFG p758no?Tl7p\]$ma)u2c?r?xWEoi81g,oz 9	sM/)]^O= z q@G  q@G  q@G  q@G "> i^Vj9Y>PEE  q@G  q@G  q JvuLz_;<p8E
 9E=T 8  # ANH6 7E(;e-J[+Mq+:S9z g>SFMu hc qs)H= z q@G  q@i !4 nd%0-fhiy1(pfv[h- nCu~c
B ff];v0`&SWT]./uZ#y>#`j84G/       #    IENDB`PNG

   IHDR         >a   sRGB   IDATxMn0 azz/vyy6?03McjeY:v|kmZ37&#u0znW n>Gyf6e#?E:;54eQ?fX8(?|/_5?r_1[(cU!8qqxM5}^5Vt-	*$[j}~d>qN#[c6[G}tu7mfTadef5wdX
tzGju3s{ l6]nH7u myu7GO` 	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	  	 hNmw)    IENDB`PNG

   IHDR         >a   sRGB   IDATxR1N5<Ar;{(fTEj37d+Z C[$|x|^dVlUdviU
7dodN*x?/&%D|x#"guZ}3_	M|>I?nfK=;E%fW>^W Q3Yf/zdlB?as|Z/lU?
9&%m"ebe/9UQVlg{W}e\,V,x3xOo/.Ss3nfmO|x03kr<_xYkC{|KdvYAF,n5v~G%Ndv{fU{#Wd?FQ`m6	YQBlXW(p,~6neb}<>E|`$z${9K>PY=Yl	7e7k,.*O+ghq++z6VtOvj7bwkzWoWGl<#cUW!;fV"Vrsje=l^>_Ee>sq*{{X].ky3+H 7 h  8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8   8  A|    IENDB`PNG

   IHDR           szz   sRGB    IDATXcd#X9aodMD+ #RR5P; |QC.zQ G)A G1EJt]/67	j<
`p|  %K!1!ARI8h'NnD9f@Lt8=`kE- s6@IkybPW!0  'JAfoM    IENDB`PNG

   IHDR         a   sRGB    IDAT8c`D<0.&YZy1(71E$Pk%3)s5nmO"a7xH QDI	+0EdXbJ4@ffsldK- %Cd    IENDB`PNG

   IHDR         a   sRGB    IDAT8c`D<0.&YZy1(71E$Pk%3)s5nmO"a7xH QDVS
&yVb!(d2S!(ZeX$K2d G-OtF Gno:2A    IENDB`PNG

   IHDR         a   sRGB    IDAT8c`DXC,YU-).&OkL:
ML	;5(|lk 5nmO"a7xXH Q"TNT7a%\A AtBPl-0\\T 0BY    IENDB`PNG

   IHDR         a   sRGB    IDAT8c`DXC,YU-).&OkL:
ML	;5(|lk 5nmO"a7xXH QU0 kC= .A kn]?JJiBfsdK'C12.l 9IQ    IENDB`PNG

   IHDR            6IDATxc?`d@LPIF(M^1t 	M'V_ qBM    IENDB`PNG

   IHDR            'IDATxc?F,	 (@DY w\    IENDB`PNG

   IHDR            "IDATxcF	t LL  Z$F5    IENDB`PNG

   IHDR             IDATxcF	S &!    IENDB`PNG

   IHDR            )IDATxc`dI"+	?.,x|  Wn4$8    IENDB`PNG

   IHDR            4IDATxcF@f3000001 ,H:	FmQ
	 l    IENDB`PNG

   IHDR            0IDATxcF@f3000001 tP q(D[ qTwD    IENDB`PNG

   IHDR            IDATxcF	`SD  %    IENDB`PNG

   IHDR            AIDATxmA 1TCrBEs%
0 }U.C
ia0    IENDB`PNG

   IHDR            .IDATxc`d@LHq)	X4L'`B38     IENDB`PNG

   IHDR            ,IDATxc?>C5^*`f4	0E$ Xh#    IENDB`PNG

   IHDR            8IDATx}A
 0swr*4TC`.e]hBB+e=>9 y	I    IENDB`PNG

   IHDR            (IDATxc?>q)`$r+pJ2000  P3    IENDB`PNG

   IHDR            *IDATxcTa&( D D  _    IENDB`PNG

   IHDR            3IDATx 0/5klYU[Z lf^|p62C    IENDB`PNG

   IHDR            ,IDATxc?>?&`I	P4	h4V  L    IENDB`PNG

   IHDR            0IDATxc?>C1VC 
Xf V      IENDB`PNG

   IHDR            +IDATxc?g```d@L$U@hX' i(    IENDB`PNG

   IHDR            2IDATxc?>C1VC	XL#>7j
Q& 
    IENDB`PNG

   IHDR            +IDATxc?>]#b8u ;#q f     IENDB`PNG

   IHDR            #IDATxc?>Wv(`a``FdX W2#    IENDB`PNG

   IHDR            8IDATxu @{f?k#G$@3r@W FI	5M'%%]c`M    IENDB`PNG

   IHDR            2IDATxc?g```d@L$Lt0BT@
|  Fgv    IENDB`PNG

   IHDR            IDATxcF	`SD  %    IENDB`PNG

   IHDR            /IDATxc?`Db3@%QL 
Xu$ IV  -!V    IENDB`PNG

   IHDR            9IDATxc?`d@,PI	`L11`sN*A fe	dB*D    IENDB`PNG

   IHDR            (IDATxc?F$I1$a
  /L|    IENDB`PNG

   IHDR            0IDATxcTaA@W&KVI07X (	E    IENDB`PNG

   IHDR            4IDATxc?>C5^(`a```f4	Pda(b% \    IENDB`PNG

   IHDR            .IDATxc?`Db3@%Q.	)`$Y ZE    IENDB`PNG

   IHDR            'IDATxc?>W
p:(3000SS  j    IENDB`PNG

   IHDR            ,IDATxc?>C5^TQndPEY -Oe    IENDB`PNG

   IHDR            /IDATxcF	PS#c("

}&  )%    IENDB`PNG

   IHDR            1IDATxc`d@LH@H
I3	]d+X	d -:^    IENDB`PNG

   IHDR            .IDATxc?>K#LO07
Q  mC/    IENDB`PNG

   IHDR            %IDATxc?>W,v0bS!H]7T  )/s1    IENDB`PNG

   IHDR            +IDATxcF	F@dV 1x    IENDB`PNG

   IHDR            4IDATx1  SC(	 azNI+.]XS"{7    IENDB`PNG

   IHDR            7IDATxc?>a?4IFd$Id`	 <2    IENDB`PNG

   IHDR            7IDATxc?>`&	S 5C $0nd7 xOE    IENDB`PNG

   IHDR            *IDATxc?F,	$L^@'5/ 5gk2D    IENDB`PNG

   IHDR            9IDATxc?`Db3@%Q?I
MFVx  ;J    IENDB`PNG

   IHDR            /IDATxc?`d@LPIF(M^@41Kh+ /c*8    IENDB`PNG

   IHDR            &IDATxcF	FL
+  _$2    IENDB`PNG

   IHDR            <IDATxc?`Db3@%QT?)(
`2bS.`n@$
 j	^    IENDB`PNG

   IHDR            %IDATxcLc q#K  D  Aa    IENDB`PNG

   IHDR            :IDATx}A  :</,
!WF,scg,+ UW    IENDB`PNG

   IHDR            3IDATxc`d@,h I`5	II!MAGb V  _    IENDB`PNG

   IHDR            3IDATx}A
 0swQG5Q(d-~o7Xf`G<M	    IENDB`PNG

   IHDR            1IDATxc?`d@LPIF(MtHV  %
=H    IENDB`PNG

   IHDR            .IDATxc?g```d@L`M	x4hpf```  1V    IENDB`PNG

   IHDR            +IDATxc?>U1+.Ox!H z    IENDB`PNG

   IHDR            %IDATxcF	$LB
( H  >B    IENDB`PNG

   IHDR            &IDATxcFR 3xYA      IENDB`PNG

   IHDR            0IDATx}A @?F[c2E@(n_@5*M/*P34	$+    IENDB`PNG

   IHDR            0IDATxc?>	I"&$Ilu|0$
 (	    IENDB`PNG

   IHDR            ,IDATxcF	*  )08AD'  N;e9    IENDB`PNG

   IHDR            /IDATxc`d@LHq)	(Wavc8 IV  P    IENDB`PNG

   IHDR            9IDATxc?`Db3@%QL 
Xt$ LY1h| ZWY    IENDB`PNG

   IHDR            +IDATxc?F,	*0 / h e    IENDB`PNG

   IHDR            $IDATxcF	J'	8Q
i V'2    IENDB`PNG

   IHDR            /IDATxcF@31 LPF6$V xL  f     IENDB`PNG

   IHDR            2IDATxc?>C1NPVG22
  P	"_    IENDB`PNG

   IHDR            6IDATxI
  9P8B$ EM-=i8&.Kn6	    IENDB`PNG

   IHDR            4IDATxc`d@,$`	Jb?iL XDY P{h    IENDB`PNG

   IHDR            ,IDATxcTaA@W&OV SU7I&`M	 +~    IENDB`PNG

   IHDR            8IDATxc?>C1VC :`XM9"\0  z	AH    IENDB`PNG

   IHDR            .IDATxcTa&( DL@68'
 	7    IENDB`PNG

   IHDR            )IDATxc?F,	 a
pJm  T    IENDB`PNG

   IHDR            2IDATxc?,@  
eDY h<    IENDB`PNG

   IHDR            2IDATxcF	PS#c("h00QV  5w3    IENDB`PNG

   IHDR            2IDATxA 0`3QNIO[IAJkSRU    IENDB`PNG

   IHDR            'IDATxcF	@Hb
p(+ x12    IENDB`PNG

   IHDR            %IDATxc`dpI +?>,| [n}    IENDB`PNG

   IHDR            2IDATxc?>W#>ELP"PE8Ux  ,S!    IENDB`PNG

   IHDR            .IDATxc?>K#YN@H|6A fD    IENDB`PNG

   IHDR            4IDATxA
 0bgwa[)`P6 v(9~RkVf\X    IENDB`PNG

   IHDR            0IDATxc?>C1`J03nd+p*bAj>	 		i-    IENDB`PNG

   IHDR            0IDATxc?>	 2`A	c3"+`Ddd@@V( JI    IENDB`PNG

   IHDR            ,IDATxc?g```d@Lh)@	
:(  >U    IENDB`PNG

   IHDR            )IDATxc?>WFtx &t$A _k\    IENDB`PNG

   IHDR            2IDATxc`d@LHq)	X4L',$	nL  \{    IENDB`PNG

   IHDR            "IDATxc?>W#!h7  Z0J    IENDB`PNG

   IHDR            9IDATxI  g<i%IKad25/re*aL
    IENDB`PNG

   IHDR            5IDATxc?`d@LPIF(M^K'	0+,$	 FF-    IENDB`PNG

   IHDR            )IDATxc?>(
%+`i*SYN  b    IENDB`PNG

   IHDR            IDATxc?>W~
"+ wB/    IENDB`PNG

   IHDR            #IDATxcF	*N
N  9*?    IENDB`PNG

   IHDR            -IDATxc?>	I0G"dGt^  $J    IENDB`PNG

   IHDR            .IDATxc?>U1"+`J2K + h#XM 
t  9uq    IENDB`PNG

   IHDR            +IDATxc?> SU%$#>X%uA8' g%@    IENDB`PNG

   IHDR            1IDATxc?F,	JcDV:
p  $ `    IENDB`PNG

   IHDR            1IDATxc`d@,h1fL'N+0g) 	 qd    IENDB`PNG

   IHDR            -IDATxcF@31 Q~dI[!I X<    IENDB`PNG

   IHDR            8IDATx}A  WgjM\B?%	u AMcI(O-x^    IENDB`PNG

   IHDR            6IDATxc?>

XtG W$a$^7 '  Zr    IENDB`PNG

   IHDR            IDATxc?>Wv(  c3f    IENDB`PNG

   IHDR   @   @   iq  IDATxZ1h[G[CB@4rccCP	xp /B
k2yqB3e"hb! D<WN$uw't_\`\= $ lL07%q	#;MqpINraNi4y]$X'6]K# [Bx]=frbbB@q'!jXt nGVr@Hnv<@7)CQ	vs~o+_RMxH}e?DJ [	<4{
$XKj]o	UtFJ e}i	4 n7?X]WcmkS[m*9ZIReX\_;hwxPRP<vI[ySNFCfSHX 'Qm<S[=_/	cg/aBCO  n W|Fy< P1@G[Mc"- yr0 TU*|WA
t8N0
S|KJU`{+TXa1>d N	vF|`O}Fn?o\'PNX/1 ~By~xMS_r 9e%$1$	8U:wd|;y;	5=mj]t3+|@[#5V[gFvPt:~%/?^[Ga2ZL|r	|o
d|e3nIIpq$hh+yj#y[>Ak%S<3Q06^T`Z	RR@/vzUB-{@!JjL%!|&I0cNH~@!	XbN{D
:0agr@g<lM&H|<@Nm!0<p #Ur
A*&;B	    IENDB`PNG

   IHDR   @   @   iq  IDATxZkQjB AHH, TvC'A S7WV 2	H$r/wB p/y{].\S/4`L /]2+{Ot" x&F 	@"%@)m.p:_qD@6Q+P ^TcN ~6j<
FPtd.Tc<hTlF9#@;?px}6iHb  p0J K^/Qo2b[26Jz$hz9gko\m  Z.ZMv vovgrc* \/HR`$,fz(y"8}q|Rvd P'  /^} _% WB%Q>'NcP!D<9`g{oP`#Y u6*V
6QbGE]9 @q?1uUI Sl3Nl@[,yVqTD=qYc@OwHHSed|4-->rX_F(3=gA<~]w `R}zF%@A}ig]wkan`;G{d*i>Ivc+: ?w!/tL.(Xu +{7R4 X`]MJe[*f 	>wjL|$P{>HR|<.Op-0r v^1pU}@aLA/}^Jr8]jeh9d3_;%a@7=}Y[26|< f2[{TCyCD}v0PJDQ uY0lP	]#zpM(Z1y. EaH>2 tC b4EPI%@$M&??HD<I v!;D/2qRXa/?( nnq    IENDB`PNG

   IHDR   @   @   iq  IDATxAhUq]U]bVPjzhA<Xx=yJ!jC1
-]$xX$sIpL\=o{3fL{9x.g=L8l$6*R;LQy L!S,-A )D"nZ8(tE0=%23@.
90m;JYe	JkGHP<""7H*y. V*]1) H/Vu8\b5t=GQTWSzc >}M\1S@d@NGTq
]>g9qGq>@]+t Q'ZJX*Yp7v[]~e(wX[%d " W:wBB* 2C`H\r+=T3`qn?g) >|#w
Fh6D 2:+1_(m@u?1}(Ruf'A[;d7H	~9~?:-s0;dDK\	l5E5'DlQ6jfU2V<`P;P*Mfw}xH5W] NCXw[]@zsvrl?I^F0$)oY<CkoeWp ynY6[[]]\K
mphfkGXq0\{/ mu o~Qts|O;y(a}MP,*.hR8mPnNpPC~P~x	a2.=/ ov~tnh.0	 %Az0!".
m(kAt@^	]#d0P6@~HZUxW{|D.^4Ru@i`P#qLL%vnLA2'?Hd<@1]2/2q0Icc/-    IENDB`PNG

   IHDR   @   @   iq  IDATxZOhWvZXY)l4H.]d\D1)*xzCr4,%d8&.7oL|df}w?|!1#lO6=W1X!` [ro< /=0}G O$NPML*;PCv/eQg.'J	:;.V4 TSk^;{zzxhWN0 AuZBF=!3x{X	PYHr9*b^5/~>gwJmZ"_
G B=~a'=eDRF`-}%@YTGy8 n?EspT=x;!Jb= |"I [{ECFEvja(u|)^m^ ,LO`azB 5= UY}yl		|?m4H#

X	 @)^5kja^RU OuKg HRO`;D=)  
oj"KW$> m	!QHI~A:&NEq<dik*?dm#!n{ ""q977	6MT+ng7`|8W1@/n1$5L;:Z  u-Qd&		d":N<X	A$,=7v-]yq+"?<2/]'Pj  {~/BY+/ec `^5 u'(k})fobuCN>2|e A  Q	<S	PJe*P _=	i
HO%.jx[p= ?mV}+?%z#!uIU eT0m8n6DISL5eaDIAdoENh!n2`{TapL+?FL3J    IENDB`PNG

   IHDR   @   @   iq  IDATxZMhG}"l	TBsQs)BoA=)CIr0Cs!:BHB"AA]Dziu]k}|~s#f_m|l '@p^8vC I'5M;$J ;A v7)LL%$]0r .`.,)pwe:jTj^/ z0&:5c b Ui9(?	YBP,wz+#sT Z ++xFTl<x/+t SX-} V-`mzH|s} _u.V,  y.*qy@0dfP*]VXr(KC>F$_,9|+|zk??|~F+>DGcYM@Nhqv:Fx;,j	"HS& 'c/.vAhED	e1b<{vY1 t" ]DB J +w }He_  7m:W^M:1UPDcBq*^{o$7,RBb?oH<YgpZ rDR KH 1}V4j>QHRr(^y`J=OD1mw^|Yl{^z 5Nz (!iU
*	eDaq~ J=%ujV6. lQ5sQjB%j?4!<e'Jt`W?n7GZCB
>D!9~$>,U *U|\b;!fPMq0^W ri}u!19/t}E&V LPv] ,kXu$a`PWSyyuL"1{Df#XDcw3@"c3/BHG|g#f3/fHEp6    IENDB`PNG

   IHDR   @   @   iq  IDATxZKQm!(k[A<n*"FD]<DvH$<EKx(,"uo{;ovgy~.;oLqql SA<0SAI\f;og>	  
\38 dkA@+6 2^	Za&QmxuFQ6/}/WUKBq"C~e+EpqcyQ$@" $F`H?\ P{`<T .$gwnkF)}7CX&  '=@jzX)c#U}Tw<y SR#5u ?](=?jA;CdW`5}.`l$n	{+~C 5i\*VXlg6Tj13 ;_[T`GKh0eC{?i rJE2R M. {g,??H"xoa2N6zUa 2^JUJwa=S`Say_7F^eUv,.l]mc" yxpn+ 5" y 
;:*OkYKEv%"xy2(d(2OgwVZ4=P3/5ou9ro[r=,UE7e-Byqp GWA*S~hKdLgQqf<:5s7G*SbLG+~^%	!UO @~'#3GKm:T0^VU\m@{~ChJO$o*tW]zQYm*
LB&aI;JV@$=@ bNwBY[OF	kr`	*A: JDC*QxVy1TB	$dT2N:a >w[4:p`FU<p	#4}h&E    IENDB`PNG

   IHDR   @   @   iq  IDATxZAhA}5.BC/ *zHDQ<{< <xQKQP,SmCB@	kC7fwvg>f?u88bz q 0C068^G%$lv} 8tE`aQ!FS/g pqC	&O;B_\G 2^	dQ  ll`@m  T50*d|:W CejK$y2k:Asu7-t:*=vjfGk?~^A($j;f|_tcf|w^mLFDP4FGQ2;hu >a6
QF#p)l |f3O#)89'8:_c9Oqs SC^RreL_> %FKXJ QVV{Y4 
J0bY(mdl3rB53@tRP?lA6c6VJL|2S oe  e'oy/	=}]Wn\OH]ZoEA(6.nh:tR%!h 9e&i 7" ku#(4.x$x Vu@H^4)+WyDd;=t:![h`C_T;_X8IH[pLl,1Wt-4B+$	l:ynBn<2OUbgQONB09]@%bu \E\>n},P'(/d1uqAbVNzJ]?6e f@ 52<=L4i<r>c: 10a<wD_Z`z Ctgw?E*
/t    IENDB`PNG

   IHDR   @   @   iq  IDATxZAkAj]HziI-Xb 'E"z TE^-x(FA 5b@M]7$M3~7ogmezC	FK0s	=wKMO`3]>v0= n3h
L))rl%	 UDPOfE[!FZX"ri 0TIW6hj@, t$9bKS 	gyV<`w	v6Z1% ,n:Gg%T(v6bD+l7 <}c)P&l<1}c}c>+Z&';f&XSTo/>#'8Or~tf{FV2WTW~katfl<40Z(;Nbee24Ww9RCv6H%"i gFQ,I BJh~>1 bck9N6D9Wr$ CG]x-TAk9 pSw^} ||4;44`8SGPK`5m g>'{4;;'s(Av+8>	FV6omIYD8o'2@$Hf-P#Ee']Vu^dkhv0i{5@;Kea=?RC. 7Pl:agH.)+ P- _ng$(VCY#T,,be[2y{;DY$-J>:CycNwTwMeN( E	<Fm CA#g @u*h =("^
ahA)0L{=^	:EX7n$-E0_<AY!`BB 1s:aLR4lh!DGd	NP%>= ) R    IENDB`PNG

   IHDR   @   @   iq  IDATxZ?hQ(
tIi $ZpC2t"uWDb:Th7it`J8wy$wy*~}.?l6`{ q &Gf<D%c0@Tja b'dNTc1s) jwbM0Hu CI @h_WjXM2>kpL35`u14D:N~Z 3>kiaV5P]FZ&Gf0;5F@%Q4+g&y};NM{dEym ~<(qf '},!hE.wX<7d_a0`]f#<E/Ce)0zwoJ;7_e8Y+PV
|?w-y^gWp *k"[y?	f+M;c W>'{E6t;H]]Km rEB6S!0VtYb )hJ8ZE,X-m`!}N/MY^Lb/`D/366U!^?//7 36O M/YrRhmR<r~" H+]l.>y&LU,lMO:e$^"&VyD:d;b{x\wBq"2z|b-d&!&nZ&*2u]Yu|cF_v"HHBOd{2ZBJp.?.(/	x:T)a>UP ^},-..D>U"AWR7p~M9f aU ]`V^IepQf&o4 m19oaL<{al0{n8`JP}}2    IENDB`PNG

   IHDR   @   @   iq  IDATxZkcUj&GDEdFP,D	eU.]p]LSI#Xtdi0 7xs/M2GJA/%||}S$%ocqvNo;s Kb>x#zaYA W-qL]"OKB.[Of,
'1v(_OA -pysY @HIaZ!N*Q,nbnsFIr'8(,A W8xJa#/^ 6bI)Ot FNe?ldi;\
t5qn?>?
O96=?sN	P%^RZ'KbjkkVa( k" ^X(km8$U4pso%-X\\n",RWI|nC9"|P} P:-
)S"<x[jAf+BEhP lUX]W?W
 QW?^=\si?ktWU
tK/"D%O}di~Y=}$=Z	f%ls7N(/Z#`,L`,;8@8I DpKR'4[5/dX`'+(
vt7UU_Z"D<W _C$jLj/U9[X:;;.8	a#d mO56$K{<>kV
Us//0m&xp@QwV6u
:S0 >8IC$&`u?
bMX\]|-vWkx{DfdcX\A vSb>3OF 7 s%}8Q@JKxP'x'78
}a	(lW'/OQ    IENDB`PNG

   IHDR   @   @   iq  IDATxZkG}xI  WTi\b(*lH\rh _SO`Cs+VCS"tj 0u~ {7<qq`eM/kM	\=8nnkK+l@uJ0QHNm(%`|>"Z"Q>&HPO} XmqP:K"J 66$X13 `yH lSglV6C5C:DvLZI1q$QpE^Av
9 -;g|,F	pA>[z`^qXq~xvQF	 "2M
$aT&Cx koXhfP)8w
:j417<t1MmvuA{@sIr*|^9.U@+5C-uyvyt zsn5l;LMv
 9qS~P
OB(J+IW_92Fm&>]Jlq0b BY_&=Zh?yl}p6vKg		@[AbHSyG<@V<e%	|4l!5t=w@_lDy?QMzAXO*d
awCGa20JP,$]} pU^!gLIp)d3(+<Gy"}Jp4#B?JhP
	
F: *U7De#J<
AQ0gq_S!2v#{!_>g3^4v,&,02h?XFIU@q-F 6C(}	>L,: >w0F\) lCK%LW'?J+n    IENDB`PNG

   IHDR   @   @   iq  IDATxZ?hW\G!
vR/*8=xpl)tP.:eR!2$C@]"H&E8Ut8~O{w?$i0	 O5>*vS!d< _>D< \p=VG,"|$Yw {<3hdyXBQ~/k-%YNZFOf-^D[@:k]W"8t:Tj!sKm[u(8q_j#s Nzn}8  A=V)%wvWvW5I9?\
@Odyr NRc{KTyl;g #>NXYj?^@tIu : ziq1<[U{]<kW@E~~Fh!V"t"pV| pJm7`8u~%y 1`*z&xHtx'	]*rFh	|z8) 8r#!?}qdm)@0:*Fbc==D\
fc$7y)n8t6YF j`Qd}y:Z'5@G%;M$-.;@pMC;wcA *e^<"~~.~d
=OUkTklE~#p'Y	:GhhGAO;z!1 A Q(}i~ZmPK{|UKmEc9vr/U<7_VDZ} r@l@ AVQA??.;@@$n<h5s6_	}v3([GL.6	*U6nvmz	pVWX	)L*yGX NL&56'!H$]Z*0	C(_`Q2b0u|,    IENDB`PNG

   IHDR   @   @   iq  IDATxZAhG}V"	l*PZI0=H4q=C*
9@N:Co>894C
M >Xd/6BM?;;dfgjv=?f5gckLw4^`3';9y^P`t9@8S1O	syJ(u
8zXt~8Na  Uq `3Ovx;/u)+[p@UOcS Wl;ydu'N-_\F&`o'yy#-}U -@WgY,z\2o=u* /R!",8)J\Ha	.Wg9S \/FM 73P,qy@
1Aqk6W(S,}6HWLBF&k!P6"LKJsyrWx/[B"h6,' 'T.kFX KZ,E PN {8.mlvdL ?eD8Q&@4v/b< !s@$vqE)TOT`(k?^' "}nn %.;-Nt.dLMgC'By	{jz&L,@(QB)G&?_yxU@J*C<rkOh[s~"| &,l34ctOq4o[M~-Wl'"';pk {7['?A4&Tue$%Kpn6]z't@Q&  8S{t9Rz R.BI05=>P~"D"}V8T1 5>G1(w @4F}:<A! 1BL4:;~"F :`Q .nuanh@MQ6q8"daWb&$@$8w_x8%R1#|i\O    IENDB`PNG

   IHDR   @   @   iq  IDATxZ=hSQjy@!U+$*8TC:TpN.vP4;ehH
!Z{}i~OJAwwn3t88zqH!19:Y<ji{w9P
p}GqF@/p*T&H`$l xybSHV~pcr'7G.q$31 @z!:)CB@2Czq~nrtV+	CCB$r!8~; z!I' jD{W.9n 1lUwDh. cOz%7EB7
;/KGX'tJBnH t|33gQ1 g}
E*N  2O]7m_1 v,AJ@+K5gKo?L+sC	n0sK -%/z/\RBq)
 _ e@.un)mrJVNra!&^wN(cRZoJ>!paJ|RG1Ji++F0WV
L%xxWJ9GTpSHS(^'tE@1pC DA<@\2cS2~7K:SuuJDp< HjL{t3d$z]z>&.9}%AN*[Hym@xa'8}7/P"UFxgB$(VNh>A['Hm/qo4Ve</w'hU@1W&8xvl*t2D~6@*O|{ySN
^Uk"QR@'DPBB-pmMyf-6>.g
y^U

N"cWe@0WBwDJ}s\<v{0t8TNPGb<l:6Vd    IENDB`PNG

   IHDR   @   @   iq  uIDATxZOHQF)XP5{IB)tPB[!<DuA'nth/Q-(tiAel:LowgB?X7~6M\lm\`l 7@@^6~|ucZC%V!0X!eM:e0DC a2T[YS:
9cf6%0X)d_	-6n,7wJ>
b<zK%:[m07`E6|) X]o	m9C"#0<1,a~?pQL'2]|q5p?|Q-D 'O ~`{/pi'+>+"dDX!`9{8OI\uAD=f*2t,<iO!# !Ni?Mw|- x1_7|Bu1;1I(+wz B}@"0gHsW	^* =qy	bDX(ibS4hUbp1x`3y, l}UGl[$ *ZU9/mP!UAv+"@/MD,d:( yn{'#amR&1h(qQ'JT <|C	z@3{OFWxO ha%-
}@"T eQ
P2}31a(T ^zgW #	(u'>+@SVHe_QRRQ
+@!!JQ0blj{ ldV^V&4XrT\]j]aF@=Ld[ktC)bxDYQ@X2.k%`E	-{L
}	hpW'/
!T    IENDB`PNG

   IHDR   @   @   iq  IDATxZ?hWlGrT\*`3t+tAS.J@
!jPB]$HbMTa{z]$wOA@w{417 q%0J]4*(tY`q% 4L 5cs$N$H.[ NkMe$E\8S'@FVXala{l,*$BXTFS_$j]G]Im3 yci!#\#`W{p;Xp6P_2vrw%/9j0Rc_OwU,
@UPz`$ky|z-m;~
x	 C"`?ABG^52o>!q8~7m22LZoy=g _k&P?V;Qyxx d9T,]{ Q{
q(x(nPu|xy<1-U	=g-#+?Z/FV=om~tA+ !^z	@OY  |/6<J /L1RaH>m:F~G<w\Y<<wqzr4Kcm%a#JBy;+"h~b#|Gm_DHCw-1[l|zr$x#/DC75]`EbY8GxyvM0Q#T,ihXttGj/FG,-Xg t}>8?P _> `zrVl*<P j{il[Vj6<.|r^x'i/JTAjDH>D@Rd 7,I<HX	yYSAOO wEKo!Xo7$
F#DA_
F y  gS'I3@.)D,""IuH$&C`l&(:0u?3/>@E~gU#f>f^     IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATx;0 @Iw w\{yw9No	%}},-t+fC1 -@c Z  h4h@1 -@c Z [x3r@1 -@c Z  h4h@1 -@c Zf8'{^w9gs
!cnqv/S8D3bW5?gih@1 -@ )=*    IENDB`PNG

   IHDR   @   @   iq   sRGB   pIDATxjP:tuv	|+t8!5
=~'&A81myhQ ZFhhQ ZFhhQ ZFhhQ ZF<8<W v	hq'`F
,A& X
2?KOB=`7D 
@ {"!DGD:%D !	0GI(v7Xz?+e\of]n#3Fp\o}.UMm?[${@w]|)`f{#U 7
DhhlPY    IENDB`PNG

   IHDR   @   @   iq   sRGB   DIDATx@Ec	<=XuY=hI6 HA;&cf~Wh$@#t 	H F 4@ : h$@#t 	H F 4@Z/x\f9PO_2 S<TeHu!Kg?b"{l /_[]3<C][^e
f5d m;A: TG>,Cym_>^7 4@Fh$@#t 	| >3p    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATx0 MRDg0hVHdIYOsw%wt4Szsh@1 -@c Z  h4h@1 -@c Z  h4h@1 -@c Z  h4h@xu4StP_X"a ]?m9k0ay|c Z  h'`%ou:    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATx1j@EBZ)w05\9A"!Jc!_dl,? @@X>,*&syAe	Y`P
wx@@ t 4.  7BO_qwo9  E q hV'/WacR.O*KLt`&*U1YERI2In,PCPp<"=5MD#j&Z@[Y/WX{ [,Rg"'Tq(Tii^5U(|<	b: t 4.  @@f    IENDB`PNG

   IHDR   @   @   iq   sRGB   MIDATx@#HwU;FJ_z<pWm1d	BwvfvuQyrmk\![]{w
(Mv!x|S=nx4ct|S 9K{fP)M
0MIewn@'A A=-N{Pd=f%;TI:QRC~VWU
<
V:]sz9bPZvsb0@
YJ  :|_|Q}T(F#&k#TEUr&l@}*`B\Ce	QHYRn7r+'Di@(:Da~-Y UNQx%D`9D(Z% RsD  jvDK.%v;E}Ht_YLlI\A fpmk    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATx0 MRDg0hVHdIYOsw%wt4Szsh@1 -@c Z  h4h@1 -@c Z  h4h@1 -@c Z  h4h@xu4StP_X"a ]?m9k0ay|c Z  h'`%ou:    IENDB`PNG

   IHDR   @   @   iq   sRGB   	IDATxn@''Jd*=yOp}Cx ]scNm<|/p3m 7 p\,B?2*85`s,9
`h5u5EwY,sD`7I&Dq> SR.m%Us?E,1%xmCQXS ]$,9uk
 1)9 =];"$ ^g:]6FY_'b
r WQH r*X&#a*TnHs@ BT#o  pLsS,H!U }ViWc
!"06VMx^Yj, guwu|LJ0F<ug9Lmk`MxfUVa2ur`Z|<j&9k/.!F y&TgBG m j")$dEPMJEJ ;A/Eax` j!9@{ lA*XQ ]
C.]@t#DW{}%H;B_: @-|B~3ys,,}IF`Dej {%H|6A n6R\    IENDB`PNG

   IHDR   @   @   iq   sRGB   &IDATxZ@=YQ(HBH}+7(B?$}je))k]gcw999|]H 7OG v6G6m&k,&@%c	p *[DVE9 eiyU	Z	")Jl06D 'aseN~6GenAWg:c* <[p[Wq]qebT"		 sn+Mn j)^8
m3k <{CMN`u(Y<= 6LyD Gk^$[A`X-;Y`y>#H]MF{|C)* Q	;nsi0$zv"m0Y^XCGmNU!j:.n
i:Om}H3A9bp1/_z	6TRAX|wc]gq"I0p>w==_\JABxsS!	* !Bdp)9(C
jOA| Q\r	J*}nB4x}.yk9uyk9!3y B#kDA@d@S`N>WOx
@UH 7o^6f:
L    IENDB`PNG

   IHDR   @   @   iq   sRGB   oIDATx1j@E!P"e
>*WzUHk!T$ev2olK^}B-;: h$@S\G+mG 4@ : h$@#t 	H F 4@RoRCr=\&p&5EQpNWY@ : 68R)&6;Yyb= '7AhB  !"E6)%0,TMDf{@	q)TPc[,wx>w3Wh#zvNnY$%0N>;@B7H F 4@Ug    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATx0 MRDg0hVHdIYOsw%wt4Szsh@1 -@c Z  h4h@1 -@c Z  h4h@1 -@c Z  h4h@xu4StP_X"a ]?m9k0ay|c Z  h'`%ou:    IENDB`PNG

   IHDR   @   @   iq   sRGB   IIDATxjPF?K!OW1){@|-%55 ^3	Qs*d6-1O 4@8 -@  4@8 -@  4@8 -@  4@8 -@  4@D`o4$&B46T	 #IT0..8 -@ 7tD*=qV~wG3BI,Us\nyXZ|":;]G@/o{]"w#hh9>=    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATxZN0BUPTFT[&vJ&%RATQ$+u;5oi \,*yc=v."@8"9r\0dPulZulP[bli.}E\" "g&gX _F%T(w(*ri7x`
qj;A!\FqKfS IU!*JS'8JOWe	Skkk%.J'6,*pi#rTmHPuI1F fy<:qr^~$}bS`j? w{@%FQ0v<)P0e,}@H>@]H]u`kmHcC>f2[{]K	Hj.FnR*
!L%r JE@'TK$.FCH8h@ J!& t`A'	
`P  SqVBaxp[w'hu  8XP. [NXh@#f2@YCG> T5* hmo467~xYJ    IENDB`PNG

   IHDR   @   @   iq   sRGB   LIDATxZ=k#1}9lW\ip7\>pJ`#b\seI+>wzO3oF~}G	Eay<D{Vvuhwxt%Am"E
pb? , { p?8] <| y-
Lc?uDsYyVD:cn8vg6+A"+G  j#CYY	 kWe]9G4&C(I`w M<"sHk
t`4#gH8W.p85BAR+Ncr)<tE/xe]fM]n$)8xE7L,(UfGS_Pjp-O N@a+o$qU *?m>?DUP0V6Czxk2&y"nEtX" @I	B`ePmAueyo"3 btV|&ByB,cD%4i< 7xJtyuJ R6&voML{|[ 
y
."-J$D%R"<6,>AsC>/B/}bZLgCIFs'HdV:JY bY SRb@8Or5BCX}@X wAD :;D#6)q RCPtp R"@	EH
    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATxn0*;tDHl}H#B6`@.:q;Iw9uGO 4Y h hd@@& yva3QX:D`b" 2H!L `SBGA 6U"8KkUXEQBb'];A[$g~By{k-E`-v2Zx	p]"f}97.=l}A]7DRYLEQmQ62!A9%V"zw:pDky|Bk[ jK^QCyO{mJAbF/Wzbk4^Z3= ut=i"+1vk" c'w	:Bx:M-Bs qg `pY %:@."^ f;S9f8iP283_!)
`tD|W"  4A8S `@O{K%z"NKr h h})<}d@@PQ6=:    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATxj@C"xwk;4rhH=)jtfgugf1@'t 8DRH>3U )6h\[1+i$[/jLLf1r 7j) t1U+.
 ^p7=%PL  qH  o?T|,|gz	2<  _k>y 8<
W
iZ0MPz^o>`??o#9*>7XuD)2pppb9 O3k((Df~q2LxiB QX, &DaK	7 
hQrL?J9@k. @oDjum?+($gKkM ~uWi2YW4NFHsuSW't 8	 4="      IENDB`PNG

   IHDR   @   @   iq   sRGB   >IDATx
PF?"VqMeOW]>U7t\;i;'7gW1}Zhhq Zhhq Zhhq Zhhq Zhhq Zl^0$`{E RB  wBD`7!	 J FtQ'Ypx([+:>$YZEhZW7]!?A_i]o=?oOHisq Zh5    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATx0 MRDg0hVHdIYOsw%wt4Szsh@1 -@c Z  h4h@1 -@c Z  h4h@1 -@c Z  h4h@xu4StP_X"a ]?m9k0ay|c Z  h'`%ou:    IENDB`PNG

   IHDR   @   @   iq   sRGB   (IDATx0q1	O;0TDkwS 0Ol-@  4
@( -@  4
@( -@  4
@( -@  4
@( -@  4
@( -@ r\rp_rboLb  4(!\u^c};oq]
isVPw_6hN?1|&Ghhy(1?K)%    IENDB`PNG

   IHDR   @   @   iq   sRGB   IDATx=j@!q"wHiiu]	rw |`IV*}c4_nv<.<>_2bll  6pVNG1W318r  6*Xnr}xd`tx``qll : [ 7-Gltlq>x@5n%6a17tj@,"LPX6,0RspwuP"`Poc.a12*%<;lMR]d@H\/6Rkk(@VnPwjIg@{u-qll  6fv    IENDB`NES         x@@ @                   @  ] h  v (4 ) e 0 @      ` w
= <  `X  JJJJJJJJJJ)JJ))ii  i &         

  )e   

  )e     @ `     i  i @@	   48   i i i   HH hh   @  @P  ]      F  i   
e
A B G   G W     (     ( P h / L 	   Z       ^H [h PJ  )O  P
 L  L     ILL LW )@)
)) 
)	 0FLW) I  )
  ) w *7D L L L L Leeeeee    "     )	   	 L 
LL   P ( P h   Z  d    ^ [ /  F

 
 2  )  ;
L       0`          (        [  /Ll    	 Ll  L 
 
     d ( P h      ^ [ /  _ 2 u  ;L 



JJJJiI)  i  i  8)   ( P h    	    ^ [ /



8i ! h  i) L  ( P       ^ndJJJJ)	  2 r [ /$L! ) 	  L!  ` ^8 	 L	LL0VLLL a ^8 ^ f	 )E	 )e-`     `)     `)	     `<%I)I` JJJ)i. `!P	 D `LP )    ) iffffff) )i 
 `  `
 )}( })`iI iI`  	L ffffff)i  LLFLXLk.0Ly
L8ee
L& L )i
LM L  )i
L 8  :: ` L``JJ    8 i    ik  i ')R `ffffffff)` &&&&&ei` JJ)	  z 

q ffff )
ee  
  i i      )
)RI)

F  )eie      %% ` `  'q     q  Ln` `8did 8
i
    i i i i     ` LTLTLT
I`8e`, p, P`   `, , `` 8`` /HH [hhLC`  `  @`@ `     E%`@@@)8v `?    @   `    @ ``` @`  )?  i  i@   A   B   C    E   F   G    I   J   K    M   N   O    ?  A   )``i@Li` 	
 !"#$%&'()*+,-./0123456789:;<=>? 	
 !"#$%&'()*+,-./ 	
 	
(98))0' *9'7 0!0
8%
)
 
4
7'
)
7"   \ \  \  `  ` o@@@0 @@@@@    ?0i	 3BQ`l`o o    ?0i	  3H  hi` 	)`o0
 o\0Z A3  Q i	i* Q 3H hi0psyvL? Lm8
=H}Xqh	0 }Yr3	p? LAmG
LH}Xth	0 }YuBs? LsmV
[H}Xwh	0 }YxQ	v"? Lme)I$
)z`	y o   ip @q@r@s@t@u@v@w
@x@y@z@`


m m`  i `L|  8`@`)? L)?L|'ii  L|L|)?L|`	 i@ ``Lmn  {|} si`
mn|} {~0 `{{L}`|~i{~L }LeLp))pqrs))stuvwx)y)yz`ML t4V&[9{fR?-            ~ v p i c ^ X S O J F B > : 7                0   
L4
 ] I        (       ( h      )	      )	      JJJJJ)	         [ /Lt))
82,&)
B C F G 2p" Lt  )=)4  )   @ @		 Lt  Lt  `2```VIV V VV V		
  	V								
 V		
  												
 V		
  												
 V		
  												
 V			V								
 V	V										
 V V!  !  ! " # !  !  $ V% &VVV  	'()	*	V					V	V+ 		,												-  .		/		
 		0												123				
 		4												567		8	9
 						:								;<=	V>? 				@A	VBC			V		/	DE   !  $F VGH " # ! V!  !  $ V*PQRSS STUQT V`abcc cdead VIJKLMNOV VUV7V
VV 87&77 '  0700000 0707 ' 87&7(98  


 
  0 0  p T 00 80 G T0 i0 n0 G0 y0 ~p p 0 T Gp  p 0 0 	.QL M L M L M L M LMLMLMLML	M	L	M	LML M GJGJGJG$JGJ$GJG!JG$J!G(J$G&J(G#J&G$J$KHKHKHA?*DIDIDIDMqLMLMLMLMLMLMLMLML M L M CFCFCFCFCFCFCFCFCFKHKHKA?DIDID7Lawn Mower v1.1 30.05.11#
>BF?BFBFBFB FBFB FBFBF?BFBFBFBFBFBFBF?BFBFB F$BF#BF!B F!BFBFBF?BFBFBFBFBF#$BF&BJB JBJBJBJBJBJBJBJBJBJBJBJB JBJBJBJBJBJBJBJBJBJBJ BJBJBJBJBJBJB JBJBJBJBJBJBJBQC??QC?QC?QCQC??QC#$#O!CQC?#$&G#A?????????????????????????????????????? H ) H???????????HA?????HA?????HA?????HA?? B???HB???HA???   ???HA??B?
DEDIEDEDIDEDIEDEDID l l l l lEDIEDE>               "SLMLMLMLMLMLMLMLMLMLMLMLMLMLMLMLM "LMLMLMLMLML M L BMLML M LMLBM	L	M	LMLMBMLMBMLMLMLMLM LMLMBMBMBMLMLMLMLMLMLMLMLMLMLMLMLMLMLMLMLMLMLMLM LMLMLMLMLMLMLML M L M BMBL M LMLMBM	BLMLMBMLMBLMLMLMLMLMLM LBLBLBL? M L M BMBL M LMLMBM	BLM  LMLMLMLMLMLMLM"L?M?LP?M?QLP?QLB?LP?M?LP?M?LP?LQ  BPBPQBPBPQBPQBPQBQ BPBPQBPBPLBPBPBL? Q - QQBPBPBKA?KA? A?KAKHKAKHKAKHKA?KHKAKHKAKHKAKHKA?HKHKHKHKHKHKHKHKHKHKHKHKHKHKHKA?   KHKHKDEDE SDIDEDEDEDEDEDEDED EDEDEDIDIDE DIDIDEDIDINDIDIDIDIDEDIDEDIDIDIDIDIDIDIDIDIDED  e IDIDES                   mI3B???PJB JB JBJB JBPJBJBJB???PB???PB???PJB JB JBJB JB?PJBJBJBJBJB?PB????PJB JB JBJB JBPJ B?JPJB JB JBJB JB ?PJBJBJBJBJBJBJB?PB?PBFBFPFBFBPFB FB FBFPB FBPFBFBFPFBFBPBFBFBFBFPFBFBFPFBFBFPFBFBPFB FB FPB FBPFBFBFBFBPBPBJBJBJB JBJBFBFPFBFBPFB FB FBPB FBPFBFBFBFPFBFBPBJBJBPBJBPJBJBFBFPFBFBPFB FB FBFPB FBPFBFBFBFBFPBPBmCG?C G?CG? ZG?C??G???C???G??CIKHKHKHKHKHKHKHKHK l PHKHKHKHKHKHKHKHKHKHKHKH   4HKH3DEIEDEIE  DEIEDEI   DEIEDEIDEDIDEDEDIDEDEDIDEDEDIDED $ $ $ $ $EDIDEDEDIDI               MtW M 0  0  0  0  0  0  0 L 0  0  0  0   0  0  0  0  0  0  0  0  0  0 t 0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0 V 0  0  0  0  0  0  0  0  0  0  0  0 t 0  0  0  0  0   0  0L  0  0  0 M 0  0  0  0 t 0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0       0 VV 0  0 m-m-mM-mM- rm-m-mM-mM- 0mM-mM- 	5
 	3
	5
 	3
	5
 	3
	5
 	3
	5
 	3
	5
 	3
	5
 	3
	5
 	3
	5
 	3
	5
 	3
	5
 	3
	5
 	3
	0 ? 00 x8 00 r2 004      j ~  ' 	:
 0	0 	7 0	0 	= 0	0 	: 0	0 	< 0	0 	8 0	0 	3 0	0 	: 0	0 	7 0	0 	= 0	0 	: 0	0 	< 0	0 	8 0	0 	3 0	0 	: 0	0 	7 0	0 f	5
  00	3
 	5
  00	3
 	5
  00	3
 	5
  00	3
 	5
  00	3
 	5
  00	3
 	5
  00	3
 	5
  00	3
 	5
  00	3
 	5
  00	3
 	5
  00	3
 	5
  00	3
	0 t 0  0  0V & 0  0 : 0*  0
  0  0  0  0 z 0jZJ:*
                                        f Yf De3Df3
   0                                                          U   r rr }~ yz {|r rr rrrr  pq st rr{ rr yq rr{ _ ro  uv wxwx wx r 
!%$''&)!%'(%*$&',++,           _|:WVUWX]^[VYZX[\feghmnkfijhkl!!%'#&( "$$)!*!'+("","--")s                        G     `          D     f<L     f8|p"GGGGGGGG```````` 8p"?1xp"|<LDDDffffDDDDDDDDffffffffL$$f6 <@DDDDD<~fffff2xp$ DDDDDDD\fffffff~8<8EB??_ODDDDD\@ fffff~~ @@  8 ~fB<~@@@@PPHHogws{ymlGGGGG_  ````` Df8|@  < |@DDDDD ~~fffff8qD 8@?~    ?s9               D f     @p          G`          p     '	b!  8>H    ~ 9s?GFFDDDDDaccgffff?OGGG````  `"< @@@GGG `````Df|@DDDDD|~fffff8< BDH~<Bf~G_  p"`   p"  GGGGG `````DDDDDDDD~fffffff8| @@ `8|     GGGGG````` DDDDDX  fffff~|8|p" DDDDDX  fffff~<@GGGG_  `````                  8qb!  DDDDDFFGffffgcca8|x0?8|p DDDDffff8|p"OGGGGGGG````````            8~              vWUUuG  wuEEw  $l$$$%  tGuu  @UQQQ   HAD@            |~   8888   |      q0         |                ~~~~~~~~            |  888888                                |     00ff       |  ~~~~<<  ??~~~~~~~~~~~??~~~  ~~  ~~  ~~@ @w    @@ @ D "DJDI}~BJ)-)IRR_JbK ` 0xx>@(T}@ (@  ??A ??}A  @{  B @ @ wB  {*UDSLUHwQ"FUd0xx> ` @ (,@{  H@ ?5  P  }}  ~~~~~~8|p"8|`     U 8|       ``     c`"      "-JM8|  52OOKOOMJM00400252O00 "        W  Pp"                                                                         ?`````  ?    ```?  @           `   #.` 0        ``     ``  	     c   ' `    l     003w     $                0                     p00       $   ` &                        `t G7@! `   p ``0    ``   	       ???{{   |  8xx888  |~  |<<  >~    |    ||  |                                    @        @     >?><?0  0   |  8888||    |    |  |  8888  |  ~~|   p8   p8   `p0  `p0  `  ` `p0  `p0    B                                                                                                                       @@@                @@@                                       UUP    UUP    UUP    PP    PP    PP    UUP    UUP    UUP            ` 
UUT    UUT        UU    P    PT    P    UU        UUT    UUT    t  UUT    v    UUT    UU    PT    PT    PT    UU    UUT    v    UUT    z  UUUU@  UUUU@  UU@  UjY@  @UUY@  @UUU@  @UUY@  UjY@  UU@  UUUU@  UUUU@    UUUU@  WU]Z@  WU]Z@  WZ]U@  ZUU@  ZUU@  ZUU@  WZ]U@  WU]Z@  WU]Z@  UUUU@    UUUUUP uUWUWP UuU]UP WUUUuP UUUU UUWUP ]UUUP UuUUuP UUUuUP uUUWP UUUUUP  g UUUUUP Y YY YYP UP UUUUP YUP YYP YY  UUUUUP   WUUWUP WjVUP WjVUP WUuWUP UuUUP UuUUP UuUUP WUuWUP WjVUP WjVUP WUUWUP  s UUUUUUTeZYdeUUVYdeZYdUUPUUT}PWtUUPUUTeZYdeUUVYdeZYdUUUUUUT g UUUUUUTuVZ]UvZUTUuUU]UjuP]TnuP]TjuP]TUuUU]UUu]UTuUjU]UUUUUUT g                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           @ @w    @@ @ D "DJDI}~BJ)-)IRR_JbK`n` @(T}@ (@  ??A ??}A  @{  B @ @ wB  {*UDSLUHwQ"FUd` `n@ (,@{  H@ ?5  P  }}  ~~~~~~8|p"8|`     U 8|       ``     c`"      "-JM8|  52OOKOOMJM00400252O00 "        W  Pp"                                                                          ?````   ?      ````? @        `   #.`   0       ``     `` 	    `    `   d      077w     $               0                       p00       $  ` &                      `pt  G7  `   C0``@0   ``  	       ???{{   |  8xx888  |~  |<<  >~    |    ||  |                                    @        @     >?><?0  0   |  8888||    |    |  |  8888  |  ~~|   p8   p8   `p0  `p0  `  ` `p0  `p0    B                                                                                                                       @@@                @@@                               NES         x@@ @               W             > u t 	4 )    @     2	 J2L 	  W 	 	   2 $**)	   H  & 5h  d	iddg! 3 $  })2L   ]L 	  W 	         L2  $   	g!>  3   $  })  L `)GLG" 
  " J  ` 
e #  A B C `03 	        @  > u 	  L L +i
jjjj))jjjj))  	  * 	    ]L:   	    	  *  	  5   	 5   W   W  > u 	  L  	 W  	L Lq  	  WLb`)	   L?  JJ  L   |   5/    & 5  " G )ei 	L]ddee  u })	`)L)L)L  )) )@ )  ``ijjjj)0ijjjj)0`  )jjjj) )	`  ii	
ii`  I i "  P    Y )     ` `Vi idVi ia `  $        l"     i i `   $        i  i ``i
jjjj)iW )iW `po 
< =: ` 	     yu   )jjjj)I $ 5	
 5  L	
ILIL{ $	
 5  ` W
< =    )t )i|  fffffffff6               }   |    W`



i`)jjjj)`    e

 ffff 
i ei    	 i i   
  `)` 
L)L L+ L+L+L+`
I`   `, , `` 8`` HH hhL$`  `  @`
@L`@HHH hhh@HHH + 
 L  hhh@lod 	   .     @ > 8   )	  $    R   } ))$!)3L
   L
    L
 	 L L# 	   L
" )  	   L
L
H     	  hHH $  $ R  $  $ R hh8 `"U   )I G i@i Lee
#    #    #    L"  )S #  )S L)` )I`y)`z)y) I`)I` $  "     iW     } )!) 2)@C)V)i)L6L#
  L#	 L#  L#   L# $  z2 )0jjjj)#)jjjj)jiL $ "  L M N O    L
 i
e L#" w  )I a "   )I b L333333333333333330;3q%gA2Xg)EGV h V6(SgcQ$AbRt8aA8pCi`pBRgb5)dg(!SgV(c&A&c6WRGe   	i !      i  i            	 
   i   	  i !     i  i               i " q     $    })   L)     L)LL  	     $  $   $  $    L FL FL: 	 i !     i  i           	 
    i  `   !       )G   i@   i  L


#  b c d e #  f g h i L03   3                                                                                   L -jjjj)   ee)P ) -)  	  )# -)    	 )P ) -)  	  )# -)   	 )Si ) -)  	  )# -)   	 )Si ) -)  	  )# -)@   	 LS)`)ILK 	
i   l l  l  `  `?     `  $)-?    H  hi ii ` 8 $)-?    H  hi i@i   $ u   $ ` 	
 !"#$%&'()*+,-./0123456789:;<=>? 	
 !"#$%&'()*+,-./ 	
 	
1!2001!!   01110!!!00111!!11 `     E%`@@@)8v ` o@@@0 @@@@@  ?0i	3BQ`l` o0o   ?0i	H3H  {hih ` 	)`o0
 ov0t 0W3   {i	i* ? L+  m 3H `hi0psyvL? Lym8
=H}qh	0 }r3	p? LmG
LH}th	0 }uBs? LmV
[H}wh	0 }xQ	v"? Lme)I$
)z`	y o   Eip @q@r@s@t@u@v@w
@x@y@z@`


m m`  i `L  8`@`)? L)?L'ii  LL)?L`	 i@ ``Lvjk`@`l@)`lLl

mj mk@ @@@ @@`mn  {} 6i`
 }{~ 6mn|}`0`{{L}`|~i{~L }LeL`p))pqrs))stuvwx)y)yz`ML t4V&[9{fR?-            ~ v p i c ^ X S O J F B > : 7         =" 
		N%X 0O      0 0 V0 S0 fp p p p 0 	pp p0 sp 0 0 0 0 >0 Dsp 'sp .p 1p 4p BH	?CBJ	?BGHGHGHGHG HGHGHGHGHGHGHGHGHGHG HGHGHGHGHGHGHG HGHGHGHGHGHGHGHGHGHG HGHGHGHG!K!$!$G!!HK!#GHG!K!$!$G!!HK!#GKRKRK!R!KRKRK!R!K!HK$H?K!HKHKH@tRK@=@M]CG	?C?I	?CIJIJIJIJI JIJIJIJIJIJIJIJIJIJI JIJIJIJIJIJIJI JIJIJIJIJIJIJIJIJIJI JIJIJIJI!&+-J&+-HR$!$I-)&)-J&)-H&)R!#I@G

I!$)!$)J!$)G

I!J!I$J$GI!J!GIJIJG

I!$)!$)J!$)G

H?@@N? ?? ?? ?? ?NANANANAN?ANANAN ?ANANANAN@
ANAN
ANAN
ANAN
ANAN
ANAN
ANAN
ANAN
AN	?@7@7K?FUFUFUFUFUFUFUEU	FUFUFUFUFUFUEU	?FUFUFUFUFUFUFUEU	FUFUFUFUFUFUEU?LFLUFLUFLUFLULFLUFLUFLUELULFLUFLUFLUFLULFLUFLUELULFLUFLUFLUFLULFLUFLUFLUELULFLUFLUFLUFLULFUFUE	LFULFLFLULFULFULFLFLULFULULFULFLFLULFULFLFL@	@	ULFULFLFLULFD@?FUFUFUFUFUFUFUEU	FUFUFUFUFUFUE?                                                                                                             @              @       ft9 
		N%X 0O      0 0 0 0 p -p 4p >p D0 p D0 Kp 0 +0 0 0 0 Kp p +p +p p GHGHGHGHGHGHGHGHGHGHGHGHG H?GHGHGHGHGHGHGHGHGHGHGHGC@@BG!H!G!H!G!HGH!G!HG!H!G!H!GH!G!HGH!G!HG H!KG!$(!!H!G!H!G!HGH!G!HG!H!G!H!GH!G!HGH!K!G!$(!$(	!H!G!H!G!HGH!G!HG!H!G!H!GH!G!HGH!G!HG H!KG!$(!!H!G!H!G!HGH!G!HGKBG  HG   H G HGHGHGHGHG  HG  H G H G  HG   H G HGHGHGHGHG  HG H?I!J!I!J!IJ!IJI!J!I!J!I!J!IJ!I!JIJ!I!JI J RHI!J!I!J!IJ!IJI!J!I!J!I!J!IJ!I!JIJ!I	B	H!$(!$(I!J!I!J!IJ!IJI!J!I!J!I!J!IJ!I!JIJ!I!JI J RHI!J!I!J!IJ!IJI!J!IRAN	 ?A!!!!!!!!!!!N@$$$$fLFLFLFLFLFLFLFLFLFLFLFLFL@FLFLFLFLDLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLDt                                                                                    8oQ 
		N%X 0O      0 0 0 0 *p Ep Lp Vp \0 4p \40 c7p 0 C0 0 0 0 c7p 7p Cp Cp p GHGHGHGHGHGHGHGHGHGHGHGHK4IJIJIJIJIJIJIJIJIJIJIJIJBkAN?FD          =+ 
		N%X 0O      0 0 V0 S0 fp p p p 0 	pp p0 sp 0 0 0 0 >0 Dsp 'sp .p 1p 4p B	B			K	B	KBK	B	KB@OK	B	K?GHGH?KQKIJIJ?KGHGHGHGHGHGHGHKGHGH?@@@GHB@K@G@K@O@[@O@kGHGHGHG!HG$H!G!H$GH!GHGHGHGHG!HG$H!G!H$GH!GHGHGHGHG!HG#H!G!H#GH!GHGHGHGHG!HG#H!G!H#GH!GHGHGHGHGHG!HGH!GHGHGHGHGHGHG!HGH!GHGHGHGHGHGHG!HGH!GHGHGHGHGHGHG!HGH!GHGH@1GHGHGHGHGHGHGHGHGHGHGHGHGHGHGHGHGHGHGHGHGHGHGHGHGHGHGHGH????KG$#$HG#H#KQK@@@BBC	C			G	H	GH	GHG	HGH	GHG	HGH	G	HGH	GHG	HTSTSH	GHG	HGH	GHG	HGH	G	HGH	GHG	HGH	SG	HG	H	GH	GHG	HGH	GHG	HGH	G	HGH	GHG	HTSTSHGH	GHG	HGH	GHTSHGH	TS@AG	H	GH	GHG	HGH	GHG	HGH	G	HGH	GHG	HTSTSHGH	GHG	HGH	GHTSGH	GHG	HGH	GHG	H	G	RGRH	RGHRG	RH	G	RGH	GRHRG	RH	G	RHRGHGHG	H	G	IJIJGH	G	H	G	RGRH	RGHRG	RH	G	RGH	GRHRG	RH	G	RGRH	RGHG	H	G	RGRH	RGH	GRHGRHRGHGHRGRHGRGHGRHRGRHGRHRGRHGHGHGHGHGHGHGRGRHRGHRGRHGRGHGRHRGRHGRHRGHI$J$I#J$IJ#I$J$I$JI#J$IJ#@@@_@I!J!C	@<@7@<@A@@A@ ?J????!?$?!??!$!!$!IJIJ!I#J!!#IJ!IJIJIJI!JI#J!I!J#IJ!IJIJIJIJIJI!JIJ!IJIJIJIJIJIJI!JIJ!IJIJIJIJIJIJI!JIJ!IJIJIJIJIJIJI!JIJ!IJIJI!J!I$J!I(J$I-J(I0J-I-J0I(J-I$J(I!J$I$J!I(J$I-J(I0J-I-J0I(J-I$J(I!J$I$J!I(J$I-J(I/J-I-J/I(J-I$J(I!J$I$J!I(J$I-J(I/J-I-J/I(J-I$J(IJIJIJIJIJIJIJIJIJIJIJIJIJIJIJIJ????????B	RHRHB		GHGHIJGIJIJBRHRHBGHBGHGHGHGHGHGHGHGH@$@F@@?C	1A															N	?A	!			M!NP!N?A	!			!MN	?A	!			M!N?A&PAP!M@7N	?A	!			M!N?A&NA&MN	?A	N	?A	NM?N	?A	N	?A	N	?A	N	?A	NM?N	?A	N	?A	N?AN?ANM?N?AN?AN?AN?ANM?N?AN?AN@	@	@9@i?A		O@@@7@k@7@A																		 PN	 A@	?A	N	?A	NM?N	?A	N	?A	N?@9?AN?ANM?N?AN?A@@Y@9@N?E?DB?FB
?E	FDF	B	?F
E?DB?FB
?E?DB	?FLDLDLDLDLDLDLDLDLDLDLDLDLDLDLDLDLDLDLDLDLDLDLDLDLDLB?L@@@@@@@@%@F@j@@@MF				@E	FEFDFDF	B	F	?DLF
LFLF
LF	LF
LFLF
LDLF
LFLF
LF	LF
LFLF
LD@&@&@&@&@&@&@                      @                 @      @@@@. @@@@@@    @s                                     @          @@@@@XTD4p$`P@|0l \L <x,h                        '                            2  f                       <	                          V!  f                      $                          V!  f                   p   $	  P   '                      f              $    )     ,                      -f              $  X  %	    ,                      (f                  $    8x                      #f            K  B <H   q  N                   -f                   p   t  p                           f              <    }    <                     (f                   H  	    `                   V!(f              <  S2 ,I   $C                 Af                  K  X                   J#f                  3!7AX    0              2g                iS  r                   -f             ,  (  \u                       (f                  I2% PL(@X1% 0m                   2(f             ,   ^  K 8<  ,               7f               '  @   l
   lI  p               <f              <	  X      <                   <f              %y  X  C    %K                Uf      '    a@H @y I  '             JzAg     `-r@ 	0I 2 	 x$$8     @pdf     ix x= >&n x= ix          @f_f           i[= \U9 :           +\_f              LHXaIb )I                  R_f         $ I   IB  $  L   <IB           2HAf              I  R%T I$0I                  >Kf            K  %  @~/ K   $	          @4FU$dN& I$LI&IB	I !$ $IA0I$a0 @L *Uf          2! / / ! @6- O H              V Af         I 4I    U|     	 2              ifL $$&$0, < AH<-dP)9yA2 @f          p  } k ] [ }  p               @Zf     =   e(Q%7$`, H  <          @f    <`y S0%=`|`-<          f             my|q{                  Uf              0YI29 -6= e %              Vnf     0dC  $ y_@ M[ $ 9_ @ 0dC          fO$I&I0`&a!$A H0!&L$a0	$A2aa0L$I$I 2f          K  %  } K $  K         %g     L@$ $ @  - P @ $L  $     VUf    /Oxix{8so`:,7ox     f     mnmW ;{%l&m?     +f8<Vi,!UHH_-l*U6l2R8<     g     6d`Q![m@	)8    f     &!?a} `$>L[} O`R2)    +f          &}   K  h \m )             
vfR-W[MiBg U~5 o 2 4doJlDL&%<y[>y_ym>|y! bfZUvm_UUUUUUUUUUUTJJJ)RTjUZUVZUZVRUU                                               
G5/>X+ByU:=WSUUUU*RJVRJUZUkZJKJ**UVZURJJJUeVUZjjUUUTTRUUjUUUU*UTRUUjUUTU                               T5 
FUUUUU^[=/4]X^/=A~J3,SGZ\2MF5k4;[RTc:avQNt.t\Hp!)FTyqmkfJJVuc)ST2URMVfdEr*V3JV*J2Yf6ZjfJjVTRMjUjU                   
                          6Tl}    F F jFjF    V V u6 8t:<0(pr+u= ;t970*  	5

 
+
 0	0, 	5

 +
 0	0  5 5j j  22  66j 22  77j 22  88j 22  00 :4 j 2 6 2 0 :4 ?j 22 64 22 0812121!0 	  )     @)$    @1 V 2 !, >?   	 L`   	 L W 	LP?   `HHH L  L  i )G L&) eL G 0,$ 8eL,0JJ V!      1 V)LiJJJ)i@ %LzJE )     i    i@i       , p, P2    )	      IIhhh@      
 U !,                      W W_WW#	
WcWWWW	Wc !"#$d%&'!"($)*W+,Wc-#.#/012.#34c5W6789:;e<=>8;?6W*@WWABCDEFW WtG HIJKI W:LMNO W;PQRS W;TUVS W@ WUW W0 W3 W WW C	" P U U U U U U  	 
	               !!,,++,,8970                                                                                         Lan Master v1.09 14.06.11                                           ????       ?       00000000       ?       ?               ?????????????????                ?????     000000p?   ?0777   0''''??????  ?0000070 7700 0   ''      0 ??            ?                  ??>><<             0?    0    '?            ????????                     ??     <                  < ?????                3UU5s        u        '                        ?        ~~        888888        |                ||        ||                ~~        ~~        ~        |         >>>>                 |~                ||        8x888||        |~~        <>        >~                ||        88        |||        |~~|            8|     8|  |8     |8                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ~~~~~~|8|8||||||8888||||8888||888888888888                                          ?              ?        =}        ~~~~~~~~ =}    ?~~~~~@=}       ~~~~~~       ?        ~=}        ~~~~~~~=}      ?      ? =}=}                                               ~~~~~|x         `~~~~|x          ~~~~|x                   =}=}      ?~~~~=}    ?~~~~~?  ?00004?  00077  00000  ?000?P?00004=  00000~~  ?00707?  007  000  ?007?W?00707=  000~~            <0<         @>~~|x         ~~~|x 0?     0     0?  0    x 0?     0                  <<0                                        8     ?07777?  0  0  ?077?P?07777=  0~~~~                                                                                                                                 `````  ?                     ````````        `````      ?                  |~|~||||||||   ||      ||    0f  0f 8|||8 888|||8 88|888|888~~~~  ?00000?  000000?     0       ?03743?  000l8l8                                                                     ????       ?       00000000       ?       ?               ?????????????????                ?????     000000p?   ?0000   0000'??????  ?0777700  ' '00   '      0 ??            ?                  ??>><<             0?    0    '?            ????????                     ??     <                  < ?????                3UU5s        u        '                        ?        ~~        888888        |                ||        ||                ~~        ~~        ~        |         >>>>                 |~                ||        8x888||        |~~        <>        >~                ||        88        |||        |~~|            8|     8|  |8     |8                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ~~~~~~|8|8||||||8888||||8888||888888888888                                          ?              ?        =}        ~~~~~~~~ =}    ?~~~~~@=}       ~~~~~~       ?        ~=}        ~~~~~~~=}      ?      ? =}=}                                               ~~~~~|x         `~~~~|x          ~~~~|x                   =}=}      ?~~~~=}    ?~~~~~?  ?00000?  00077  00000  ?000?P?00000=  00000~~  ?07070?  007  000  ?070?P?07070=  000~~            <0<         @>~~|x         ~~~|x 0?     0     0?  0    x 0?     0                  <<0                                        8     ?07777?  0  0  ?077?W?07777=  0~~~~                                                                                                                                 `````  ?                     ````````        `````      ?                  |~|~||||||||   ||      ||    0f  0f 8|||8 888|||8 88|888|888~~~~  ?03743?  0000?     0       ?00000?  00000l8l8                              ;;;; Taken from https://safiire.github.io/blog/2015/03/29/creating-sound-on-the-nes/
;  Create an iNES header
.ines {"prog": 1, "char": 0, "mapper": 0, "mirror": 0}


;;;;
;  Include all the symbols in the nes library
.inc <nes.sym>


;;;;
;  Open the prog section bank 0
.segment prog 0


;;;;
;  Structure to keep track of input
.org $0000
.scope controller_state
  .space b 1
  .space a 1
.


;;;;
;  Setup the interrupt vectors
.org $FFFA
.dw vblank
.dw reset
.dw irq


;;;;
;  Here is our code entry point
.org $C000
.scope reset
  sei                   ; SEt Interrupt (Disables them)
  cld                   ; CLear Decimal Mode

  ldx #$ff              
  txs                   ; Set the stack pointer

  ldx #$00
  stx nes.ppu.control
  stx nes.ppu.mask      ; Disable Vblank & Rendering

  jsr zero_apu          ; Zero all APU registers

  ;  We need to wait for at least 2 Vblanks to happen
  ;  before we know the PPU has stabilized at startup
  ;  Here we wait for the first one.
  wait_vblank1:
    bit nes.ppu.status
    bpl wait_vblank1

  ;  Before we wait for the second vblank, lets
  ;  zero all of the working RAM $0 to $800
  ;  The $200s are sprite OAM, and should be set to $ff
  clear_ram:
    lda #$00
    sta $00, x
    sta $100, x
    sta $300, x
    sta $400, x
    sta $500, x
    sta $600, x
    sta $700, x
    lda #$ff
    sta $200, x
    inx
    bne clear_ram

  ;  Now wait for the second vblank
  wait_vblank2:
    bit nes.ppu.status
    bpl wait_vblank2

  jsr initialize

  forever:
    jmp forever
  rti
.


;;;;
;  Initialize everything
.scope initialize
  ;  Enable pulse1 and pulse2 in the APU
  lda #%00000011
  sta nes.apu.channel_enable

  ;  Initialize the controller states
  lda #$00
  sta controller_state.a zp
  sta controller_state.b zp

  ;  Reenable interrupts, Turn Vblank back on
  lda #%10000000
  sta nes.ppu.control
  cli
  rts
.


;;;;
;  VBlank is called 60 times per second
.scope vblank
  jsr read_input
  rti
.


;;;;
;  IRQ, we are not using
.scope irq
  rti
.


;;;;
;  Zero all the APU registers
.scope zero_apu
  lda #$00
  ldx #$00
  loop:
    sta $4000, x
    inx
    cpx $18
    bne loop
  rts
.


;;;;
;  Read input from controller 1
.scope read_input
  lda #$01                ; strobe joypad
  sta nes.controller1
  lda #$00
  sta nes.controller1

  ;  Handle Button A
  lda nes.controller1
  and #$01
  beq update_a_state

  ;  A is pressed, but did it just change to being pressed now?
  ldx controller_state.a zp
  bne update_a_state

  ;  do the thing A does
  jsr play_a440

  update_a_state:
    sta controller_state.a zp

  ;  Handle Button B
  lda nes.controller1
  and #$01
  beq update_b_state

  ;  B is pressed, but did it just change to being pressed now?
  ldx controller_state.b zp
  bne update_b_state

  ;  Do the thing B does
  jsr play_a220

  update_b_state:
    sta controller_state.b zp

  rts
.


;;;;
;;  This will play an A 220hz note
;;  On the pulse1 generator
.scope play_a220
  pha
  
;DDLC VVVV 	Duty (D), envelope loop / length counter halt (L), constant volume (C), volume/envelope (V) 
  lda #%10001111
  sta nes.apu.pulse1.control

;TTTT TTTT 	Timer low (T)
  lda #%11111011
  sta nes.apu.pulse1.ft

;LLLL LTTT 	Length counter load (L), timer high (T) 
  lda #%11111001
  sta nes.apu.pulse1.ct

  pla
  rts
.


;;;;
;;  This will play an A 220hz note
;;  On the pulse2 generator
.scope play_a440
  pha
;DDLC VVVV 	Duty (D), envelope loop / length counter halt (L), constant volume (C), volume/envelope (V) 
  lda #%10011111
  sta nes.apu.pulse2.control

;TTTT TTTT 	Timer low (T)
  lda #%11111101
  sta nes.apu.pulse2.ft

;LLLL LTTT 	Length counter load (L), timer high (T) 
  lda #%11111000
  sta nes.apu.pulse2.ct

  pla
  rts
.

NES         x  Y  &(
*HELLO, WORLD!   
  LC   L    L  M  M   C -?     $q 	  iL!     $q 	  iL C C I H -L  `    ` `    ` `e `      `  ` L1L1I8e  `                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     >>><<  6~~~    $ll     ~~~~lllll ~~||| ?.J 8||x{0HP Rz        <88<000 8<<800 >>Z<<Z    ~     pppp`   `` @          ~         ppp     `` 8p @ ~~|| <<>>8< ~<|0 ~~|| >~<l ~| ~~||  ~~||| ~~|~|                                                                                                                 <<~~88ll  ~~||    ~|v  >>>><< |x  pppw````f   ~~||  ~|v  ~~||| >>~Z< ~| ~~<<ll88 ~~|l ~<<~l88l www>>>fff<< <0f       8p @   ?w<ff                  88     00      >w? <f>ff> pp~ww~``|fff|  >wpw> <f``f< ?ww?>fff>  >w> <f~`f< >><8<0  ?w> >ff>f< pp~wwww``|ffff   ||8 X0 pw~|~w`flxxlf >><     ~wwwwww |fffff  >www> <ffff<  ~ww~p |fff|`  ?ww? >fff>  ~~~xppp l|p```  >>> <f0f< >><  wwwww? fffff>  www>> fff<<  ~f lD  w>>w f<<f  www><8 fff<0  ? ~f6~ <<0  8<<800    s    b                  0~ "|t  p ` >>~><< |8 >><g< ~(F 6v$"|d <>o8($JJ0 f~>~~@< 88  nD  ~`? | @> >c~>~<B@< `````f~<@@@@@D8 <<( ffnn~>DDDL@< >>0><   `o@@N >c?>~ <B<  > < 808   xp`?P @@> 6~~8$B8L0 `@^ 3"|V `{wg@RbFF >f<RD Z 8xgf~<0`FDD8 8<v0 T  0x   P  ?|>X ~~~~|~~||xt 6l$$~H 06~ $b\ 3~"|T ~~~~3?| | " ln~o>0HD|B,  x~P\<~;8L2 <~s \bB ffv6DD$ >>><<B f~vcDTdDB >>>c<<B `sf@\bBD ~~~~|~>|0\(@< 00p`  @@  0~|  $xh   p  `  <<|~>< 8 x8  <<~~<~n 8 |(L  <~| (8dh   <><  88  x|n|0 PHDH   x| PX  ~~8 |0     xx    PP                                                                                                                          80  ||h ><8  ~~ | >$ ?f~*D ~~|~ ??3sc>""B `<8@~D0   ~~ fffn<8DDDD0  ?sc~"B ``gf~>@@BD@< g<8B0 ??;o>"2N ><<<0(  {{{{>< RRR8 ~~<8| 0 ```x~n``@@@pL@@ xp`  ~~    |     ~~><<~f|((D <~~>8|< |xp nfgccDDBBB ~ |xp  0x   P  ~8T0 g~<D( x~~~x~pp p 00<~f  (DD 7>s$b ~~00>|     ``gv00@@BD    ~~ | ??~>~ ~~><| 8 ffffDDD xx{{PPRR ``ccgn|x@@BBDHp  ><8 ><~8   ><8p` (0 @  8xx 0P  0<8  0   ||00  x     < (   ~~~<8  TT0  ``~<0 @@D(    ||  x   ~~>>~~  |<|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 NES         x    
 @p@    tx	 LW AAL4<DTh| @x)x)~  y)ty	y)     @sZ m  s  sy   \  vJ%GG#	 ) )E 8~" )@vJ #  )@? @ xH  vJ  h	  @p8r1ww`)v)+wvI	v)v`N(  ye  ii`p 1 , `r gaE s   L  k`LJ@FN6zIz %Lk)k ? 0_  D pr"t`
  ]dWpj r `_f `g`"I$$  z
$`ABAA , $Z (0  00 8T
?` r  M 1Lr a4LN 5m4`5 4hihi   o55h`IH	?_	4L+S_	&isIiIi r` _ `\r_ Wp`)@Z H`PPPPPABDEH12458 ,`,+Z@JJJJ)4 ,"
	 i
`< RZC2I   p2LDHVH VD hVhDLENsLE 	
""""'"0'"7'Ds<  SV   DN? i `3sLE  LE 5  s_(\ i LEY
 YL<LEp3"R*Ni    t` LN<`t <s`pJ       :LLp    %<` ;r` C
 R $$ h $$.)##!$$)$$$$!K	 $$($"G$#!
"$!
"	
$% $$ 
$#+&%$&-$&5$'F'E $$    ''FNYannH
z R hI#Zi

	_\`zS	pIJ`

 ,L?  <`&)@ !B AC )
**

)I
e DEJ&&&L0JFFFFL0FF    A@!!)! I L!)8) I)	# JJi @ AiBDCJA@s`'''?  	)Q 1J  N

   i  `EEGGGGGGWXYZ$$$$&&&&AN s` m`   XQ
]R  i
L? 

 $)
 i 
&
&ei e9:;<	i   
 `d$$$$''''$$$56%7%$8$$$00&&&4&$1$23&$34&&&&&&&$$$$`daebfcg`daebfcghhii&&jjKLMNMOMOMNPQkp,-lqmrnsotii&&ii$$$$$/$=$$$$$$$>?[\$$$$$GGGG''GGGG''GGGG''''''RRRRuvEGEGGGGGEGEGEGEGEGEGEGEGEGEGEGEGGGGGGGGGGGGGGGGGGGGG$$$$$$$$]^]^$$**@@$$$$$G$G$G$G$/$=$$$56%7%$8$$$$9$:$;$<$$$A&A&&&&&wywySUTVSUTVWYXZ{}|~?  %:0'"'0'0'0 ?  )60!''0'0'6 ?  )	<0!''60'< ?  0 0 0 ' '60' 0 ? "0  ? 0  ? "' ?0' %H
$"$
+ %H
$"$+ %$$$$&
$
+ %"$$$ % $$"$
$ $ &J$$ &$$
$  
hhl  x	) $ -    $ @  ?@L@J@ jH@ J Jh*H)0=Jh)`hJ`    
Hx	) h
	JJ  8e   e?          `  x`bbmmz$   JJJJi)DH
   "h 8  `p 4y0
 3`3	8
3Lu 8`0H`x$(,#Xo  K ! [RQ%( 8 )$ !



012 "j_\[tr`WTZa t Yi(Nx)j.x 8HX   "r` `` p#R
NC`(8(   P           mp
3  [NR% W-JWX    #N `V@epf@f@f@f`ep  t "Z rp`_
\)\JJJJJ) [ Ldr $g7 <"tr` t)9 _ 
rp` TW GVrp`8z!a0SISZHaZha``  j` &&)&%)` 0`    QRS                QRSABC                                             
 	M  NNN ii     EGGGGG             iTRb    (  BB%08



ym&&H)8 
e hJJJJ  A N_bLC '
 C
  )  $ NT     )
**  i`Q ),K0F
++*))@+)*+Ln(*% Lq) 000)(`,, +`00-)  .S")@c)KE)?L')p)L p
)   L)pJJJJ 0B*%,)(!`( ()`,)JJJJ&,-  e @.>PYCy|Whko	+++E-H)@hH)'h)0JJJJB`h)D A`_N  #I#`   `  0  `3 Lxi 00%&LLLL 0J6L06,OPL LBAC  0` EEE  HGF EIIIEGGJGGGGKGGIIIIIGJGJGGKGKGGGGGGJGJGJKGKGK  H0h%60*"# H Jh%n1`R` 0kl` 
  `  !   0   ` 9 H`_+0& J! i%i n  hL  )0` ` L,H h`,,	H h cL mL$% a 8% s00` LHD h @LNLD Ls L   Liaab"QRRNC)LDN%H  hLN)L_N%H hL d0e0f j w%k q j` 	
 	444aL  J' %n X2gh`]6 ]L 8L.  8 NeH LH 8 `    -N(j 8q% k



w jN?5TP5` 008`-))`&



`



i ` HJJJJh)y`6222
&@ P)`
***N`_m``P 	P)OmON(mO,N H)D AhH)8JJJh)***H)'hH)0JJJJBh)***C 3ii ` 
 %)&`()'b$5 c")A,a*1&b.#-`3)'d02!e p
Y~<Q{|5`3`q Ek7H2;z[~5yovLV]6I]0Lx-(V6H
*[x-KLw_u}[=&Z+, {\L;x-(;ekp{x-('Kh)w`Kx-e8m>+^eeNeN{[x-(Ei)$({($F$$W{+.f k 3C>~B
;7BD[P[ K4@[ 8[   kc#K [7;7+v+Wh(($6[x@H{CP 7w7+ +{8wB I{[`8;@8{ 0B+g
(*1Bzx$%%K$$	e$$%v(%e$$($)X))+8B;{<[{+;K8; k{ N+;kR+[B
B[KgE+ {

$J#8K;+ 8 k<[ k8;9`''+&&%'/`:;Bhp%,'&&'';4%k
.('.3@.0$D"j.#	Ah*.#.2;f''1#;.%+.%KN%kGGzx8G	hG;G:V.e234Qst
~
 

.NT

4~

G
`

~>~
C	B][234^
hddd~cccc.^d5rKh1~
1c30ba?D3c11??K.~
C	B]234 'e2u
q 1dW;
':s
{

:;
$. >@8do  C
c.fBjBy
 dd.~
DC	B]2349
\

. 
NZ2c
i
~2	
2	
B~

.^

>^
ARQRC	B][234
'2FaUb^h<t:}K^}K~ba1K41>
d2u
{a3>d2x266KDX2c>0aKK.^~>^~
C	B][234^
9s9{MK3w9stKIt
.gz19s^vE
H=F~J9{N
C	B]&(eAJT@BGBqA$@Ud@@@,/I@@A@@Kx}B &)~B@(NB.Ws%'#3 \wcba`BNi~B@b@cc37'Cs>B
^@rB@9N i```11mB R! n@X @A@#'xCGtCGtC,LcG W!\|r9Lb8J_&T!&"7s  s19qYqs7G|q139qq#'Iquurgq r13 9qs(9yq!   !_2 zca"trw1s9Xrwsrsdefgg&R1 nf6f "g{ 93'W#WclQca!w!*#"S c"!"35cg sw       gw"be8&P!G$W cwqhs\" l"GW g "a!o3cba`Occba`9! 9_8m&&*B
@6PA+$A CgSA)BGAcceeJggB &n2bb?dCCds@@@@@dH\9@A@dH\9d7eL$c eB2dSEHd*<GVCbdd1E1<xd83a(a9`]J>Bo R1 n@  O4"'9as\W lsGSc"ss3C!\r#w9sr"&bC$!ii&8&@=&r8r4b  ,Hb	7cGW!y19oee}& L OBCOR ZMQ&3BBwDJiBs 6@54B`Ba@G9|@T(=^B &+WA[iFq |A/PBQXFC{II/CKwJA}B R! nDL54 72CN!S |!B_cAIXavdef""hB4!&*$6 5NU!w "!L4gJAQL BB)cbBiBD78(zhzzjjm1 n@7s < l  s(r@s&{A9#"7   < !$\|  )Ar'sLft?5A,6@|@a9AA9| a c e gg&U&3RB$B%#3axz3,FdUeeetGSc!bA"A9c&g'7"$A#q cd fgg&P& \ eetfggsL / ,L  .J LY7G!:g vw`9 q, L{9 o4 dgg&R nE9!I|s!0' Ir#'&zr9	c$g$b(*V!py !5/=&L O $O56 SF  4sIt     .YBM1&`wB baNPa
Cr8_&H^ s9aXbwccbbuR@PRC!R@ Q>^gRwR~C#3TF@G!V^TRP#CEE$F$Qxs9RR_c $f oG-G(zhzzmH^,ARNg%h$i$B,,qgw  !'.r vHzv rybsb ns w#  
9qrs2 &I')3D|GMhzmH Z>EFGFSDJM Z.7(:HFGJM Z3SCQF@GPSU@VPbCd@ePqAsQQ@PP@PQ@PSJM Z.6G7R:IG%RJM Z>DQSDTDU$T!JMA4RQGleIlb5cSASQ&'3cCd3`a	}}GARA'BJBQ1'd,8Bvdb#21QRYBcSg161S)a0b<B7Y@jB@ac9XRg1BB#Cg44QCG30ab	}GI9s^n.>E	Gr gqS Jr` $  M   1   u u    U O  	JJJ Lg 
 s= 0= = @ `m#YUPRM0GUpum==m?i ) x) x 8L  u    
 ) 84 m6 W ` ii ` 1i3Ei}R+ 0nPL PiLX  (``2 
 H3JRX`<N )
)))
  )T	 W
E   1   f@)0;# YC00
` X R`XLRL    NLe` Rt r"`W)W `GLU s`G#LTIT`G3L G`G	JJ) ) ` s)``0 L`##c #	  #JFF F+\\_H]` W [` T) P Zvm` 3  `
	L
)%8
	 	3  (	LR  m3  ee --' 3J}m}mI3``00-88
	444   0    # -)M3J0J`

)%LL  3 
"}$	+
932 LT  	 3NE
)@  '
 L^
@PCV G3E.`   ) )E L 3E W`- WI#0JmWmWV0#VWL 8WWPPW Ii `VC
)@3%/)$%  $   N  8  `L$
c$^'imi t3^$i`     B  5 ) L $` BL),? 3Jemi iM,8K,  `P@ pOIE?:&@#9 _LV 2Y`#%#LN7}G/qywki 8qmk08m`wJ qe ki  	J,8 m8m L9Jimi m }JL0V1+("ii8LKP4 ,  Y R`  GE@)LXy
)	%@	  Y  B`/v n  `0`hN	JJ	F Y   <)   &`NoQ9Dk>} }LG,}knqw8J	3L23 B  8`G>.)@ K0F6X i(P(	)  h   Y K SL `))* * 8``Gc*) 4i#    L- ) Fd* in i z 8
   O > ` vz 	  Lq z 



	 i    *  H`* `*V
 L**muzi z*0& *LiP J  * O  > `9S _^^d ^Z@8S _S  $`.vs8#9
VJ9 `#]
#GC97  kL } L	)##X#
*F# Y  K  S B`HT& k  T%& X] #h Ty)& L I`i)mi v` $ `< 1	 === ,,9LN #`_`UVWXYZ[\]^` $ F9 ,`8  M V``b <>vxi`&])Hi	3  i   `  Zh0Hh   `  )h &`! a ` `>W



WJJJJ	    e  *Hje memhe ` G	 L= L L| L  ` ,X  L ,H)	 
h `H}3 ue3e 3i 03	 3h+I383 3	3`H
hL)Lh) `		
@@@@m8m%8%88*8* ;+9:,`E^&Y0T_q%|# _#_  9  E L,9L)
)?.`i0)i 9
;;:);)?:99;L:n)n)iLVnA



L)@m)?7?1j ,I`	/  r`L!JJJJJ_P)QLa9)999 ;`i $.Hq{{PCbbbb_EK	Q]Oe#` LLJJLL`jXL` `P X,Lb L X	0uXF 4`F	` L)X4`  CLL&,28 "$&<8 +0    `, n n  8) 4W)I LX 0F`0C0C0    { X8UZ4iini nL0@0PPp @p@h
#(",` H L)  )  W
He  )) heXFW )XIiXF)ymi LB8m n` {h cifF dJe` 	 nn    `p4	h -1 i 8)i i nL% 8n n i) 4 J` 0``  `@p@`0G  1 80Hn   y hy7 i n=JX` @@0P `p
oNWf _) ),)L  Lr  `	 87HHjh)p hJ-nii   rLdXJ48	L8 C`   `FX` w F wL. XL.@IiuX iN` QLN ]L14Lf4  w`  yqnytn``  ;]MMMMMMMMkkkkkkkSS-P`  YL   Y  K  5 SG LB }}}}}}<:PPx+}:`   Y K SLB BLB  Y T } Y m LB  Y { GG  Y LB8$  %` 	4)	L0  ) L<-<)j 		L^L^ 7)>  0p  )	 =	<	)@X K0
XF )@
0) [)$0 h )@.LXHyX hX`	)FjX` hL	 ` L4		)`XLzLu K l	)	)@ e `	)XJ
X``X`XH)XIiXF  hX`) M9JE KF 84 FuXni n`8Xn n`L)7	)HJh4i4X`h484X`	J`i `) LXL@) L8
L8 n n IXeei L8  84IiX`  	 	   !%'( 	!',/0 '.378 $-5;>@ (2;BFH -8BJNP "1>IQVX  	$-6?HQZc )tG
 )i Y           `FIim	8L8YFIim  HGpiT	i8Iii8Ii#y@L8F  H -h hi`H)	Ii 4ehHi)	Ii 4ehJJJ0` )  L0@) Lh   4X)
XIiXFL  K
 Ii  << XX@ )<JJ  W$uWuW   8`Xh-)@
rL9 LCdDdcIc"i   ii i@LC!A1)  ` GLcLd dcIc	)F KFe >	)8f))meF8fIie( _		) ))L	 i_'" cIc0 8 FJu i  FF H- h j`j 
 KLS000Pggg)g`G0p 8 n n}4 YQ 	)    i JHhJHhJHhJ `XX YX ` 8L    TUVW F, j F`	)#9 _9S _S



	L;rL-806 Y} "}` -F` -`VQ#X0 K	 Ii  !5XIiX4X 	JGuX 	 @ `4XeXi `X8X `L` FL- iLyL`  i LyH4i i 0  Lo yLo h8y  0 # 4w  p HH 	  0L$ hI 	 h	
L$	
  i
 `H iiHn i h)JJJ hi 
*H*)	 )

h)e    ) `  F i 4`H ph p0 #`4	)LX L 0 #` M l0e m 0i L m #`0  #`  0X ` #L #L9G}4u` `Ui8H  iHi n 0 n0012 `$V
S	JN

iH) 40$+&

i /	$ >h` - Y)-k--b iX_6 		362.i #)	  `	J6G.

i$ -dIidL- `   9$#@`V#V LG`V	  J`8	J C#)  T -	)`.L L
)YN~z3BrNm
4),%	 OXm `0le\W>LFL%V#V 
Gu`W 3
g FH 7hF  iX`	)   i QXL	m j`FL- L- KF`0,`@ 	JNnjfa T0[HLFB>9

i /  )='' L=.h` ) 3.' 

   %i %`   %i %` "XIXFIF`G)0%$ a C V H -h `G7 C/  T)"  -ii `880 +, ` 8 	 S` y,8   3`	`

i)` .($
`TTd; 6 U-' N L&N`  H  h I L <08L ,#E LS %  3   ( 	k 	  ` a L6 W JL >39l1	 ) ` S`+ $HL rpW LM "Ph
`$%9A3#3 J1L&
  W833



y,	y.m`_`` p	J`gh8`)\ VP( 9)

`_P Q`\R]W` W 
 0(Ln W  eme mI-`a `$m ```)
**`)  c%LkL.t L #d   	
))	N K3FX`8r)@W
L  W`"FX	) KF , W) `)`8
	@L F  `	
	  L=L88 nm` i)	`i>D` ci   WL # `) WL	` L&
_``!  0::)` :`$`   	       0  
 ii	 LH DLZ 8n0 -L i L

` 

H

}}}}h `ii m00` ` *B:5`*"`
`8`HihLiLi   `         , Humi )JjJJJ y)8 hL3)` 0 y: i!
	@  8 d  ` i`        G*) 	JJ)} }}})	 * `PPii i
~	i
H I ) `  N[Cu   
H h
Hh
Hh
Hh
Hh

 `	J iL`abc* i	J) `vwxyvwxyi9H

  h/+ 	J) 
	@	@Lkijklpqrsnnoommoooonnoommz{}|}| T<HH$H! 	F
X0`)5 3	  20	j	) G	)IbGj0c) 	LRc)) 8LM$
0L) 	L>Z~rfT) $)]HN<FL073/+ _	9})Gi) 	   Lk	=	 	iHHhhjLkHB;j6)
	@	
	
	@6	!)	A0)
&)	A
	@JJJH hJH  hJJH hJH hJ 	 `E FL}L} Q`J   N$ NJ	@	)
H)h) ` u  	



)   8 8e i 8e i M
  ` 	JJH)IdhJJ	`hgf$$J)J 8 i8iB
` $`[  iiH  hi H) hH)h)` ) t` ( @PXx` 	
 !"#$%&'	()*+,-	
0,-	
./,-	()*+\]	
^_	XYZZ	()*+23456789:7;<=>?@2ABC23DE23DG23HI23:7:7OO LMNN LMJJKK1F	J@G<1 + ;	)!3JT	` LL LL  % W JJJJ iF  8`X ` &	@"`U3  `R>Q" L/W 
E%3  ` Li Lo Lt 

LLv  iHi  h`Ti`         	)
 T


y`i
	`P$)?)?	@)?)?	@`  LI LI   x` LILl	 l	 e  x`8`  L  L L Ly`L	 e H 



  h ` JJJJ L@? 8m 0	8 t `    >8; 0<	  t2 `JJJ)e`JJ @
  iii`p@`@@]#f @@*D$	d * @    } h   )0@`@ @`  @ 	@`@@` @b %& (%_ )H  
 @` 0FFF,FJFFF0JJJJ<JgJJH`&  @@%( 	@ @ @@`/JJ)	D LXTVNDLRLH>6>60(JPJd<2<2,$:d:4,",""$$&&((**,,. .0"025B 0N@. ^6J]  @@`)@e 0>FFjFjFFFF<0'JJ]JZJJJJ&`L-Li8Z0J @ J@ `Ln
	 J,@@@	@ `
FFJJ`@JL;,`  r @0)  2J @@_=/@))_ @ @@`LL    ) @@Z2 @@ 4)>   )  @@LA @, )n)
)@)QL )>$0 )
X@@@`j***)emf`))}(`)`)}``YTdY<1Ki^FO66Kiiouo{ouo{iis' .@ =! ?    b$FSphRL$-J pvD
-X?!&zLTu+s-,,,,,,,******* &0&0",",!1 ,"&*(&"4:@6:4,0* ]UM-+'Y"" ,4604,&*":8624$&,&,0 +",,,:8624ddd +7E",NNN"20, $(,""!1 ,,,,04,&" %%),,,,04 %%c$"444,4: !!!+:"111q1 4,"$&66& ']- ",,,*@@@:64,&" '"*"",,"*66640,  hjlE1"""&*,"Q1 "("&"$"&"("*"("&"("&"$"&"("*"("& & $ & ( & ( & $ & $ & ( & ( & $(0(2(0(.(0(.(,(.(0(2(0(.(0(.(,(. pnlnprpnpnlnprpnnlnpnpnlnlnpnpnlvxvtvtrtvxvtvtrt (&,"&*&$($" "000222 44466 FdHfJhjD+*BBB,ddd.FFF""","`$,$(00d 4 "4,$2,(6000,,b&(,b&(^`^` (&$b  "&(*****"424"&*,04264"0.0"&*,.0"64"::::@:6666:64&*6444*, PP XXXD\D##jjk^""","*",",","*",","* ("*"*"*"*",","4"0"."4&6&6&6"6\"4"",",",.$.$.2("2("2666: \TL\TL\\\\\^VN^VN^^^^^bZPbZPb""b+("("((((,,,0b""& #ut1-&""  +  rO.t_K9'             | n t h N \ X R J B > 6 1 '   b @00$0$$		 $&f    ??    ` `p? ?|  g/7~p76\  ?pp8$pp8                  @`   0 30?? ~>  @???7'#   p   xxx~~` xx~~ $&     ??     ` f`0??? // |  ` 0???????///   p?		(\ 0p&0  >?800 :x~~<??!   ???p?? ?              $      ? &&`x?? ~!z\l` (0@ ?        30??	 ~0     @   ? 0              ???>|x@    ?><8  8><8 
       <    >!0!    ?  <@@ x   ??|p8  `p8|  ~      `p`  ?1 ??@ 0  819_~< S|<       ''>???O>P8p@ qK  ???&000&        ?0  x  ?>|0@  ```    sp`?~||<<    <<`p?;{|  <<<|@ <<|?<<:80 <        "UUUUUw"         ?v      @  <  @@@AAOG@@?>>08         8CFD@@@@@<9;?    @     x8    108|??ww~> H<|x8<              > >                  <~n <~v <<<<           88888<~w_  <  \.?{w~<  < O??z  
/ /<                    `|>~q?_>
Q               ??Q  @`ps' @cw|8      ??D(?ww'{xx    >~|           $$   AAa3<<~~<??cA  x    G   @?=?  ?   <r_ N                 ? |8)mE ?b_}"         ////P                 >|8*wt(      _hN|?\9; #WOW'!  0pp an@  ?}=?<{?0#d` ??? ``  0      @        937 6,`???`  0   GgwwCgw{x      <~038?~88p`0p`   Ggw Cgw{        w~px38~88<<0<
 ??=?  39:8    LNNFo8<tvv~} ??O_  
4*Q ggcp8>|Gpp9Q
yp9pX80    fffb <zzz~  ?O_   
4*Qw?}?73;:xp Q
9|>X80>?;?                >; 8x0 ?;?                  ~8|    xx ?55?t   ps!  x    8|~? _?? ?@`` 008<<0 " %%~:AA8|?~\@>???}}DC@!}_;<? ?><@>??}}     `be? #3??p<<     zZ  ~}?ssspNwxf9}9        8300 '??x<s80@fl>|@`~x<|$? z
   ~?pp>|<` x$   #bd<O??=mO ??  p?G ?>|xx  ?\9; #WOW/!        a?#?x> 04      ??  ??x|~??	     | ??x qy==        ??60?#'?@?  ,?? $ $   7666A  D  ~v:8|;  8    3{   8@       ?_??'WOW'!8080  ``p  8L$~~> B
@ p{  @
      &.>       /#!     y}=?Ym5;>>   ( >>>> 
 y}=?Ym5;|   c|  |     0   p`     0000??>                   "e%%%%wr        b%E        '"                bUeb         PPPPPp                         ffffg         ^YYY^      |8       8Ld8         8~         |<x         ~<|         <l         |         <`|         000         |||         |~x         8l                  <ff<                                    >`f>                  ~~         |                  ``````~                           ||                  |z                  x||         ~         |         |8                  |8|         fff<         8p                                            ~~             D((D         <<<          >>  8|||||8   @?     8     ?          @ nd`` `@???y   F 
A!H
;   $	   ~ @?b=<@|8 <`  `       ?      >>   $@& 8^ gg          ??`@~<B<       |     ||     ~<B<   xsss ?qq~~~~          8|9|8   (((((    ~~~~~ gg 					       W/W/W??						      /W/W/W<<<<<<<<########\\\\DDDD @@??        ~< ?`        ?s!Swwwwwwww    w       wwww    wwwww x !!AAAAA ~8!   !!  @   ;
pp?xXXP~oC]??p` 1n??9{        <#        WWW UU U   T\<W#????   ~||x                               ?     HHl    

:
pppppp                SSs?          `00  00`@ ?              ? @@@?DC@!AAxA"xaaaq^aa~?Oqaa  ?   @@    0??@@@ 08
PPPP0P A""   >>>>    ???? pp  |{vuuwgo;{??pc?<xz>_vvvp}|Fooo?      ~<<~~B <BB<        ??????????        ~~~~~    ~~????    ~||x    ?????~~~~~~~<<   C[S1{{ "gY T& T& T&!T& D TH I F J 
 
 
!
&!&&&!FBBBBB&BBBB&!fF!l&&!C&&!B&!_xz!	$"K$
"$
"$
"$
"(" #VU## NES         x @  , ,             @  , ,   }  !     4 )  LHHHLy  @?                                                 hhh@() 
()H(` Lt`    `  L L )`  ` 8 `   )L]i`  LF LF    `   `   `   `  `

     )?` 

   #ee LJJ`   `   w  n n  n  ``
) w))`)


)`)



)` w    w  `L/LL) L -  / / /E%`@@@)8v` `
I`` `  ` `  `)  ` w w  L
 ` o@@@0 @@@@@  ?0i	3BQ`l` o0o	  ?0i		H3H  shih ` 	)`HHo0
 o_0] 0@3   si	i m 	3H Xhi	0psyvL? Lkm8
=H}qh	0 }r3	p? LmG
LH}th	0 }uBs? LmV
[H}wh	0 }xQ	v"? Lme)I$
)z`	y o  
 i
p @q@r@s@t@u@v@w
@x@y@z@hh`


m m`	  i	 `L  8`@`)? L)?L'ii 		 L		L)?L`	 i@ ``Lnmn  {} i`
 }{~ mn|}`0`{{L/}`|~i{~L/ }L/	e		L p))pqrs))stuvwx)y)yz`ML t4V&[9{fR?-            ~ v p i c ^ X S O J F B > : 7          L  )   g   tiL&   ) #iL[`     80  0
&0m(0mi) (L     80  0
&0m0mm(m)(8m() (m() (m m     R}S  hei(i)S ( HEm"# i(i)S( " iiS(i)(LmLni)L   8(  0
&0m0mm(m) (m mSTm()i (i)
  L  L 5  i   :  56  i   ; Lp  J    9 [  $   J8LY)LY       9 $  9& g   niL& g   niL   w   [  $     -Hh   ww J2g LWi    )A ))2    L8iLL (X        5t  i L   5  i L&   J)L)@ ))+HiLHih) 'H8LH8h) )L   L 
i (i)(( L Y Lw      9  k  $   J)8L2 LY   g    9g $  9' g   niL'( g   niL   w     ) g t2:	8:B	idl	8lt	i 5 8  A   5   A   P)i)@i 5 8     5  i   ) L   w J)   8i)L  Y Lwi Z  }  g n n  r n n#A g n n	  r
 n n }  g n  r n  g n  r n  } P) `L)()e((m)("i(i)(""i (i)(""i!(i)("HhA"miHi h gi n P)im iL" mLL  
i0
&0i(0i)((   `
      
i(i)((    9 5        i   i$ 
i (i)((  01 RRHiRhiS( i) (RHiRhiS(i)(RHiRhiS(i)(0L  L(m)(LL !&""#$L


 L"BL02:m0()


 (0B0Hi0hiJ( i) (Lii RHiRhiS( i) (RHiRhiS(i)(RHiRhiS(i)L(i$%i$i(%i) (iLfmLZ  iL i S ]  0L2:BJ!"#d$`L ) 5 8 i    5  i  i[L ) 5 8 i    5  i  i iL  #$%#&'( )*
i(i)5(- ./2 
(i)5(  (  4 m   L  ) <i  ) -,8LF80)2%('%%/J/8//5)!L'      L 
)Lr 5 8 % ' <  5  %i ' =  PL )i)@i 5 8   >  5  i L 5      <  5      =  5      >  5      ?   )RASSm"#)(( "i)mL L 5     i0 Pm"#() ((e( "m"#()(8"iL88L8LL )L)LQLQ     (  4 m     (     (     m  [K=m() (8(LiLiL   5 )L6        J)UD)    )     iL    LD (     (     5       (  4 m       L)%&
   %&
   %&*Li$ i DLi8(& 8 D8L$ i DL!i8(& 8 D8LR$ i DL~i8(& 8 D8L $  i D Li8 (&  8 D8L /LLL L    y)L^%*L#L    y+  i  y,*o+)"           y)"       L)z*xd    y)6 8    L  *
/L	  **L+) L,) +)#$1)% )@O 8   y)5#$ ).L  .I.,) )O i   y)5#$ ).Ll  .I.,) +)?)8  8  y)#$ )%  +),),) %,)#$ )%  #)2	)i)#L#5UZL8  ) i%'(Li  )i%A'(L8Li



)@	'$8$$ #i)L*Li!i"  0L2:BJ"!!"#d$`L ) 5 8 i    5  i  i[L ) 5 8 i    5  i  i !-"#,$FL:m"#() (H8L:LuBm"#() (H8LBm"#() (Hi"hiL1811L 0L:B2!b"#L$LL 8 i  y) 8   y)L!2JL i i  y) i   y)W"2BJL  8  y)1*$L  i  y)1#2iL1 )   i L Lw      ]   ZHihiS( i)  (HihiS(i)iJ(HihiS(i)(iL' S ]  +Sm()ij (miL   (  4 m    ;S ~C  )	< SmL);SiL 	Lt [    2>  )L'      iL   ]LY LY   e  ]KGL
i
		i _L
8 L
() *+f0 (*)+0`He  !h`0
&0
&0
&0
&00`0f0j0`0f0jf0j0`0f0jf0jf0j0`0f0jf0jf0jf0j0` Lt` 8 `!` 8 `!` 8 `!` "#   !  !8#	"i	`PI	` !`    ` !`   `!`H # "hL      `!  `  H 8 ! h `0F0jF0jF0j0` 8I q HIq hL ./  "#` )#"&#*&)H.)/)h.H"h(`"&#*.."(`KKK0 NK0 SKKp ]KK ]KK0 hKK0 sKK0 ~KK0 ]K0 SKp sKK KK K 	K K0 +K0 SKp KK0 ^K @K KK JK TK KKp KK ShK nK KKp Kp Kp 6K uK              KKIB??I?MBI?L$@BIBD%" E%F" G%"VFSF^FRSVFSF^FS^RSOGN	A	NANANANANAN	ANANANANAN	AN	ANANAN	A	NANANANANAN	ANANANANANANANANANANAB??FH
FH
FH
FH
FH
FH
FH
FH
FH
FH
FH
FH
FH
FH
FH
FH
FH
FH
FH
FH
FH
FXQ 	
?7K
B? !?IBJ!"# IBL?9O P$Q0P#Q/P!Q+PQ*?P"Q.P!Q-PQ)PQ(?PQ+P!Q-PQ$PQ&PQ(PQ+PQPQ!PQ$?I$B$? EP!B&I&A!B$I$AB"L"?/?)?#??CDEF!GDEF!GDEF!GDEF!GCDEFGD!EF!GDEFGD!EF!GCRSK(L(?RSK&L&?UVRS? NUVROL?????##???A$$	
$$	
N
A
NANANANANANANANANAT&2&2 NANANANANA!N!ANANANL?FGHGFGHGFGHGFHGHGFGHGFGHGFGHGFHGH      FGHGFGHGFGHGHGH7P&K
?FEFEFEFEFEFEFEY??R?FEFEFEFEFEFEFE|XFEXFEXFEXFEXFEXFEXFEXXDXDXDXDX	DXDXDXDXDXDXDX	DXDXDXBXBXBXBX	BXBXBXBXBXBXBXBX	BXBXFEXFEXFEXFEXFEXFEXFEXlT**++--++**++--&(*B&%&%&%&\&B$#$&\&?B(+*&\&?B$#$&\&?B&%&%&%&\&B$#$&\&?B(+*]-?B*\*B(\(?B(&$&(?'&$&'?&$#$&\&?B$&$#!]&B&\&?B(&$&(?'&$&'?&$#$&\&?B$(+/+($T!]!B!&\&?T++--++B!\!?T++--&(*A EH
EA EA H
EA EH
EA EA H

A H
A EH
EA EA H
EA EH
EA EA H
EH
E00A EH
EA EA H
EA EH


A EH
EA EA H
EA EH
EA EA H

A H
?5_KRORUOR[]"\$["\"?[ "][\[\?M']"["$\$?L$R ? ? SZT$ZTZT!ZTZTZTZTZTZT&ZTZT".ZT"ZT+ZTZT'ZT5Me}ZR ZR?ZR ZR?ZR"ZR?ZR"ZR?ZRZRSZ5N?TA?TAN?TA?TAN?TA?TAN?TA?TA,@N
?T
A

?T

AN
?T
A

?T

AN?TA?TAdxN
?T
A

?T
N?TA?TA GH
GA GH
GA GH
GA GH
GH
A GH
GA H
GH
GH


G
F
E
D
_S^lK[???][\?P[?]#[#\'?PML/?[??]!B![\BG]!B![&\&I&G]([&!]!B&?]&[&-(\(B*?])[$+&\&B*(?--[-+&"!]\?ND?ND?ND?FN?FS^SFN ??FRFRFR^OT!-!SAN?ATAN?ATAN?ATAN?ATANATATATAN?ATAN?ATBIBIBA?TAN?ATBIBIBA?TAN?ATAN?ATAN?ATAN?ATAN?ATAT?BL?T!-!D		TFH
FTFH
FTFH
TFTH
FTFH
FTFH
FTFH
TFTFH
FTFH
FTFH
FTFH
TFTH
FTFH
FTFH
FTFH
TF@@^TFH
FT^lx9KD$!E$!F$!G$!DE$!DED&#E&#F&#P!L!E!F!P!#L#E#P$L$P#L#PLL#E#P&L&PLPLD!($E!($F!($G!($D!E($DE!D&#E&#F&#L#E#P(L(P&L&P$L$['&$T-+G-T)G+T$G)T!G$TG!TGTGTGTGTGTGT/-G/T+G-T&G+T#G&T!G#TG!TGTGTGTGTGZxUT!!!!####!!!!XO][\OX!;[B]\[GGFED#&#NANANANANANANANANANANANANANANAZ?BN?ATN?TAT&N?AT!N?TAT!-N?ATN'7HA FH
FA H
FA FH
FA H
A  FH
FA H
FOA FA TFA FA FTF	xx9bK\+L+?T#%,(#,(!#*&#*&\#!L?\*L*?G!!RT%%**&%#B?}KX"!!"&$"![\?[] \"[!\?[]\?[!"]&\([&"!\!?L$$\????"?R_RS^VRB?TB??TB?TB??TB?TB??TB?TB??TB?TB??TB?TB??TB?TB??TB?TB?LN?AN??AN?AN??AN?AN??AN?AN??AN?AN	?	?A	N?AN??AN?AN	?	?A	N?AN??AcDEFDFDEFDFDEFDFDEFDF0TFH
FTFH
FTFH
FTFH
FTFH
FTFH
FTFH
FTFH
F0&& 8PNd ? j 4 j 1 j 0 ?j 2j 0- 	?
 


	4



	2



	0 ?4 0 24  0 ?? 0  2? 0 z 0	 v t0	 r r0	 q 	 0 x    z"$& x(*, r.02 0  V 0VVV V 0VVV	?

	0	8

	0 :  : 	4
 	0	:
	0	4
	0	:
	0	:
	0	8

	0 ? 8 ?? 8 ? 8 ?  8? ?  8 ?  8 ? 8 ?p 8 ?jp = :j 8p 6 4jp 2 1 k }{ lmkn  &~ l ko kl okl | .lkn zl nl | 3kk nk k  _              ,-  ---    - -,  - ,  , ,  ,-  , -, - - ,-,-,-,-,   -, - ,   -, , ,- -    , ,- , -- - ,-,-,-,-, ( (.(. ( (.(. .  %&.(%&%&(  .(.( . .( (. (  .  ( . (.(.  .(.(.(.(.  .( ( (. ( (  . .( .  
   %&.(%&%&(                NOaDbb  bc@ac _qTrr  rsPqs @PHUTDUTUQf w @T]__W  RGDKKN fNaKC WT[[^ v^q[S N, , , - ,  -   
 ,  - -  -, 	   	   - , - - 	            !       (  PP jf"uu!""
   TOaNLDM@CD _q^\T]PST       	 	    !            
 
-  "  -, 	    7   VZ~^"f~ZZ^"fnZ^2"
   PAaNJDM AaHCFD Qq^ZT] QqXSVT      " 	,        
 	-  	, 
     "      	  Hz""Hy
   OOG@McNL OHgDKb _WP]s^\ _XwT[r    
              !!           &     "e"H_Z^[V_"
   N@MNcGDa OG@McNL P]^sWTq _WP]s^\ C - ,   -  -   F!   "        -,  -,  -  
    h  @1^[^[2^[v^[2"
   RbJdKKb K@Ha rZt[[r [PXq C8    9 9 : : ; 8   " < "   8 ; 8989:89898:98:8<898;898;8; 9  ;:88 	< ; :  
< : 8  < <   " 8 :  8:898;:8<:898:898;8;:98 ; 8 	< :88;  : : 	<   8 8 ! <  <  ; ;  89;8:8:889<:889;8;:8;  8 : :98; < : 8:  < 	8; ;8 
<   ;:  :8:  ;8;  @D^[ZV^[D^[YVZ[D~[YY^_zY1


   R@Aa@B@C@Aa@ PQqPRPSPQqP <  ! 9 :8;89<8;8:98:889 9 : 98 < :8 ; 8  89 < 8:  9 ;  :; <  "  <  98  8 : 8:  8898898<  89  8 8 ;8 <  8: 9 9 :9 <  98  ; :  8;   <  ;8  8 8 988:898:8988:98:  9 :   :8898:88:8:98:   8        (;:8 8:8 &   ZZYZ"YVfw#YZVVw2[^"
   KeDacHB@K HKKdbHNMb uTqsXRP[ X[[trX^]r " 898:98:98:89 ;:8:  ;988    O   <  <  	8;9:898  <8;:9<  898;898 :88: < :8 < :9 
  <  <  < < 898:898: P ""^[]W^[2]W"
   VLHaaNab \Xqq^qr  < !    <8;8:9:89898: < :988 ;98 <   !   <  898:98:8;98< 98:9 <   < < <  <   ;:98:8<  ! < 89;:98:8  ;898:8<    
:988 :898:8 	   &  PP fZ[[2^^V"VZZ""
   T OHgDKb  _XwT[r 8: :8 :8 ;: ;9 
< 	 :8 
<;8:98  9: 	<   8; ;:  < !" <  :9 8:9:8:98:98<:98:898:89;: 8; < ;::8 	 <    < 89;98:8;8<:8;:98 8:8: 8:   ,  P vZHVUuw#ee""
   NODaEDBc aDEKDBc _TqUTRs qTU[TRs f)  !  )     ) ! 
%&)(%&%&)(%&%&%&%&)(%&%&%& )  *+*) *+* * + ) *+ 	) ) ) ) )      ) ) %&%&%&%&%&'  )  * +  )  %&)%& %&)%& ) 	  ) (( ) ) ) "       "  ) %&%&%&%&%&%&%&%&%&%&%&%& 	+* * *+ *  + +* F  ` e!L]Wf""
   UHBDK@MCb XRT[P]Sr e)   ) )(' (') )%&   %&) )*%&' (%&+) ) (%&  	 %&' ) ) %&%&' 	(%&%& ) ) (%&%& ! ! %&%&' ) ) %&%&%&%&%&%&%&%&%&%& ) ) (%&%& 	%&%&' ) ) '* +' 	(*  ( ) ) *      $ + ) ) # %&%& ) ) 	%& 	) %&%&%&%&%&%&%&%&%&%&%&%&%& *%&%&%&%&%&%&%&%&%&%&%&%&* *+**  * * **+* + *  + %  p U~U"UU^[UU"{e"UUU!
   ULHCMHFGc \XS]XVWs l) ) %&')%&%&%&%&%&%&) (' ) $ (') %& ) 	%&) (' ) # #  (') %&%&%&%&%&%&%&%&) *+** * ) ) "  ) ! ) 
%&%&)(%&%& %&%&%&%& ** ) *+ 	* +* ) )    
%&%&%&%&%&%&%&%&%&%&%&%& %&%&%&%&%&%&%&%&%&%&%& *  *+** +* * *+ '  ` Uu"""eeUU"
   QKNMDKh bJdKK [^]T[x rZt[[   %&%& ) %&(%&% )%& 
'   (' %&%& )  ('   ( (%& (%&' )  %&' ' (' %&%& )  (' ( 
%&  ) (%&' )  %& * ' (') %&%&(' ( (   %&  ) *%&* %&   ' '('  )  * ('( ( %&  )  ! %& ' + ('%&%&(' ( +** ' + *  zZz"DVUfDUgg"
   OL@CD HM GD@eDM \PST X] WTPuT] D(  %&  %&%&%&%&%&%&  %&  ' '%&  (%&%&%&%&%&'  %&( ( (  %&%&%&%&%&%&  ( ' '  ' %&%&%&%&%& ' ( ( ( +* *  +* ( ' '  )' '  ( (%&)( "  %&%&' )%&'(%& ** %& %& +* + =) %&%&%& # )'' ' %& %& ( ( %& %& ' ' %& %&   ( (%&%&' ' %&%& ( ( %&%& ' ' %&%& ( @p`PPDWfUg!HZvDf
	


   SdMCDaf@cDa t]STqvPsTq E>?= >? ==>? >?=>?==>?>?= >?==>?== ?=>?=>?==>?=>?==>? >?=>?=>? =>?=>?>?= =>?>?=    >?>?=>? =>? >?=   =  / /  / /  = ?  />? /=>?/ =/  >   /= />?=/ /     />?=>?==/   >?/= =>?=>? >?/>? =  /          /  =   / /     / /   ?! / !  " / "= =>?=>?=>?==>?=>?=>?=>? >?==>?>?>?=>?=>?=>?= PP HUZUUZUDDwW]D   SidO@OHgDKb yt_P_XwT[r   "  >?== >?==>?=>? =>?=>? >? >?>?=>? =>? 
=      
 #  # =  =        
>?=>?=>?  >?=>?=>? ==>?=>?  =  =>?=>? 
      =    $  = 	       =  
=>?==>?==>?>?=>?=>? =>?>?=>?>?==>?=>?=        Z[Z"vgv""^Y[[Y["
   RbJdKKNODCH@ rZt[[^_TSXP C?=>?=>?>?=>? >?=>?==>?>? =     =  	   $  = #  =  	        /    "   =>?==>?=>?/>?=>?>?=>? =>?>?=>? / =>?=>?=>?      / =  = /  	> / = $  = /   #  /  	   / =      = >?==>?=>?=>?>?>?>?=>?=> >?>?=>? =>?=>?=>?       @P De"D_^W[_wZW__
   P@EcDa cGD f@a PUsTq sWT vPq f   / >?/>? =  / = !  /   	  /  =>?=>?=/>? / =>?=>? /  = /     /   / / / /  # / /   / =/>? / "   / = /   >?==>?==  /  >?=>? >?>?>?= / >?= 
  /     =>?=>?=>? " =>?  >? =>?=>?=>? 	   =>?>?  j^~""ZZn^"^^kZ["
   NeHadb Je@acHadb uXqtr ZuPqsXqtr O>?= / / >? / />?/ >? = >?/ >? / = /   >?  = /  = 	/   /      /    /  = / =  !  /  = 
/ >? / >?=>? / >?  / = / =  /  = 	/   /        / =  /  "  =  	/ >? / =>?>?     / = /  = = 	/   /    	/  = / =    # # / >? / >?=>?>?>? / = / =  =   >?=>?=>?==>?>?==>?= >?==>?=>?=>?==>?>?= 	    ` wwu"wwg"wwg"HWWUUZZ

   SMDeDabJdKK ]TuTqrZt[[ N1203 3124 5    4012    5 	5120120035 	537  745 	54    " !    05 	50 012012 012012 35 	53 45 	540305 	512435 	5012312031212312031245 	5120401240120401240125 	57  77   77  75 	5 5 0 5 5 3 3 5   5 4 41203121201230120301230120 70124012012041212412041207 7         7 p U}U"UU"UuuU"DYZV   TNKC cNfDa ^[S s^vTq C0123124312041234012031212312 1204012401212341201240120430 0312  4120  1241 340 
03 012 40 # 34$ 30 12 40 	43 03  	04 34     5  12 43 0120120 01212 50123 04 7 7 12  7 57 34 12 $ 	30 5  41 23 5   43 $ 5  12 04   1250120 04 5  30 12   7 5 7 12 5  43 20 5 03 5  04 12  5 34  5  12 03 012120 40 012 5  01 24 7 7 12 7 7  5  12 03 03 0123120 34 34 1204012 @PDD^[_YDV[DjW]
	   TE@JD f@KK UPZT vP[[ 5  "   ! 12501231203  31203120312 0512040124  4312401240 	75 1203 40127 
5 66  3412  00 5 66  4003  00 5 66033400  5 	0121231244012121250 7 43120120 57 0403 5 1234 5 0340 5 
   3412   5 	12012403012312031203012 	012012412040124012412 
7  7  VZ[^ZZ"efwg"ee"ZWZZ]V"   Q@KLNbc cGDaD P[\^rs sWTqT 0 0 5 0 5 5 5 5 5 5 5 5 5 5  "" 5 "" 5  	012012031201203012312123 120121240120124120401204 7  5  5  5  7 5 5 5    5 5 5 012 5  5$ 5  7  120 5 012 7 5  7 0120  j"v"uu"]f]"

	

   OEHM@K BG@LADa UX]P[ RWP\QTq D00 00 00 00 77 77 77 77 % 5  " 5  050050 7 57 75 7 5 	5 !  5 5    5 5 " 120351212312123012351203 012450120401204120450124 7  5  5  7 5 5 5 # #  5   5 #   # 5  0120122123012312030120121230 1201231204123401241203012041 044034 30 12 40 	430303 043434 @`HvZU__UV"g"uuu1


    ,-, ,-  ,- -,- -  , ,-, - -, ,-  , , , ,- -, ,-, , ,- - - - - -,- -, - - -,-  ,- ,- -, ,-  ,  -,- -          {DU5 U   ?312121201241212331212120124121234012301230123124401230123012312401204120412040120120412041204012 C= >? >?=>? = =  = =   =>? >?=  = = >? = = >? >? =  >?>? =>?>? =>?>? (=>?= >?=  =>?=  =>?>? = >? = = = >? >?  =    = =>? 	  = = =   >? =>?  >? = ==>? D124121233121212012412123312121203012312440123012301231244012301241204012012041204120401201204120 '@KK KDeDKb BKD@a P[[ [TuT[r R[TPq U PU !'8&!10'8!1$)0 20)9$)0!1'$,0)9"1$!10&75$)00!20$)(8&7&!1Alter Ego v1.021 27.07.11                                 	        @@             k    l  n    (   k  l m   (k 0m   l  {0 8 @  JK KD Le MD NK PB QK RD S@ Ta j[ kT lu mT n[ pR q[ rT sP tqCstUkk*kkpk{m{{{B{Kmn] `                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }yee]~~    U         U        U      & <<<<<<<<<<<<<<><<<<<<<   U         U        U       L4$4$4$ 0xxxxxx4$4$4$4$xxxxxxxx4$4$4$|xxxxxxx PV^6^>|vzt @ @    2(?U }zt@  *,ZP     t      t$"  Y      {I     coccocB^BBB^BB   	   `@ P   P`P`ph     <$<             <$<     <$< \?   ?    :0`@    @   n       n      xx}(U                                                                                 tiV    R @     uiW   ~V*R   *~6v| |V     X     X"  ~.,  2*
>T |||xt@  *,4(P ThP`@@   ~vjR"~   4 ,@@@~~@@WA 0@@@@8TDDT8;; 0t8  ||88  T1s   Z 3 tjV. (,zthP 4( 85+    ?:4    |~2>?2 ~  ? PV^6| |  x.? @ T @                                        pD,(((  xx0000                            !c         |       `      !c   ((((`< 0000xx     !c      !c   !c       `                 w                S&  |8      }	&  8   c   }   o(((( 00000     U- f6  ~ !c   }         M% v>  1c   P!c |  }}A? ~~  L p   c   K6Xc l8l  }}? ~  6l 8p  p   PPPp ````  c         |      `      c   x,(((x< x0000x     c      c   c      `     <~~~<   B ( B   <~~~<   B ( B   <~~~<   B ( B   <~~~<   B ( B   <~~~<   B ( B   <~~~<   B   B   <~~~<   B  $B   \@BB   >@BBB   .@B@   ^B@BB   VB@@   nBB@   jB@   vBB@              pH((((  pp0000                      A $$  <<<<     @ F@  <<<<     @ ,   <<<<     @   <<<<     @ $  <<<<     @ (   <<<<      $$  <<<<    "8$   $F < $  $F 4   f$8$$  $$($  $$$4$   d$$  $d$,$  |~}@ xzx  nn||l$ HHxHH  ((((`< 0000xx                           ||     <~      ||     <~     ||\    <~     ||\    <~     0xx     |     0xx     |     0xx     |     0xx     | @       @                                                                                                             \Z0     v8 8  \Z0     v88   Z0      v88    Z0      v8 8   08 0    l8(   pp0   v&xP   08 0    l8(   X\0   v<                                                                                                                                      <$<           <$<            <$<              <$<               <$<              <<               <              <<             <$<     <$<   <$<     <$<    <$<     <$<      <$<     <$<       <$<     <$<      <<      <<       <       <      <<      <<                                                                     P(P(    P P   |   `0000p8 `    p  x<| x  ||<| x  8\| 8H  ||   |   |   |   ||< x                     p((((x< p0000x  ~= ~  == >  >]} >f  }      }      }}? ~   0(((((  000000( 0( 00  00  
           XP                            08<"&, 08<<80                  }yee]~~    U         U        U      & <<<<<<<<<<<<<<><<<<<<<   U         U        U       L4$4$4$ 0xxxxxx4$4$4$4$xxxxxxxx4$4$4$|xxxxxxx PV^6^>|vzt @ @    2(?U }zt@  *,ZP     t      t$"  Y      {I     coccocB^BBB^BB   	   `@ P   P`P`ph     <$<             <$<     <$< \?   ?    :0`@    @   n       n      (}x(U                                                                                 tiV    R @     uiW   ~V*R   *~6v| |V     X     X"  ~.,  2*
>T |||xt@  *,4(P ThP`@@   ~vjR"~   4 ,@@@~~@@WA 0@@@@8TDDT8;; 0t8  ||88  T1s   Z 3 tjV. (,zthP 4( 85+    ?:4    |~2>?2 ~  ? PV^6| |  x.? @ T @                                        pD,(((  xx0000                            !c         |       `      !c   ((((`< 0000xx     !c      !c   !c       `                 w                S&  |8      }	&  8   c   }   o(((( 00000     U- f6  ~ !c   }         M% v>  1c   P!c |  }}A? ~~  L p   c   K6Xc l8l  }}? ~  6l 8p  p   PPPp ````  c         |      `      c   x,(((x< x0000x     c      c   c      `     <~~~<   B ( B   <~~~<   B ( B   <~~~<   B ( B   <~~~<   B ( B   <~~~<   B ( B   <~~~<   B   B   <~~~<   B  $B   \@BB   >@BBB   .@B@   ^B@BB   VB@@   nBB@   jB@   vBB@              pH((((  pp0000                      A $$  <<<<     @ F@  <<<<     @ ,   <<<<     @   <<<<     @ $  <<<<     @ (   <<<<      $$  <<<<    "8$   $F < $  $F 4   f$8$$  $$($  $$$4$   d$$  $d$,$  |~}@ xzx  nn||l$ HHxHH  ((((`< 0000xx                           ||     <~      ||     <~     ||\    <~     ||\    <~     0xx     |     0xx     |     0xx     |     0xx     | @                                                                                                                   \Z0     v8 8  \Z0     v88   Z0      v88    Z0      v8 8   08 0    l8(   pp0   v&xP   08 0    l8(   X\0   v<                                                                                                                                      <$<           <$<            <$<              <$<               <$<              <<               <              <<             <$<     <$<   <$<     <$<    <$<     <$<      <$<     <$<       <$<     <$<      <<      <<       <       <      <<      <<                                                                     P(P(    P P   |   `0000p8 `    p  x<| x  ||<| x  8\| 8H  ||   |   |   |   ||< x                     p((((x< p0000x  ~= ~  == >  >]} >f  }      }      }}? ~   0(((((  000000( 0( 00  00  
           XP                            08<"&, 08<<80 NES           x     V,          ,  ?L;@@    X` c@@   @`@ @@) @)   `H @@@h`H@@@h`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Q UNES                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         H 0  Sh(`HLHLHhLH h(` HJJJJ DhH) Dh`
ii0LS
 H Sh`H  Sh`H
 Sh`hh  l HH  O hh``	 zHh3	Hh1*	Hh+$H h H h H hL8L$ E8`
d/did J8/
i
 J	0LOH Oh`J J ` `H hi` `H  hi```0L`L `$00HEFffjIIII h` I 0LH8y h `h` LL Q l
Passed  L LS Q l
Done  L   d  d Q LH 1 h` d L LHHH    \hhh`L H          @ hL%HHH 
 "'0 \hhLHHH
 "'0 \hhLH?    h   `
  e`H      Lii` `H         h`**   `  ` 7``a``` ``#H h#` ;Lw`xLx uH J hL     P  `   L R     ] a 4H  (@`xH @   hH hL L d %` lFailed
 ` lFailed #  $ d` l
Internal error L         `  ``H   h` $  w@ ` $       `, ?        `, , 0 $`,$0, , ``x       L^` 7L   `  % LL
 " @@@% *+* *+  0" 0  O `"# " @ *+ ;- 0 0  O @ 0  O HHL"#$L"   % LSH!  L
h@ !  `   !`(  lERROR
   lMysteriously Landed at $ hh 0 0  l
Program flow did not follow
the planned path, for a number
of different possible reasons.
 H JchL
H
@HHH  ;hh`L 'Nu  0@P` # pX@(    d,X  [0;33m [1;34m [0;37m   lTEST: test_cpu_exec_space_apu
   lThis program verifies that the
CPU can execute code from any
possible location that it can
address, including I/O space.

In this test, it is also
verified that not only all
write-only APU I/O ports
return the open bus, but
also the unallocated I/O
space in $4018..$40FF.

  `Failure To Obey Predetermined Execution Path The following code is used by devcart. It is never executed by test ROM.  
C@? z zel  ,@N@*`IZ                    lll     lll      llll  llll >`<| >`<| bf0fF bf0fF 68kf; 68kf;             `00` `00`  f<<f   f<<f   ~   ~       00`     00`   ~       ~         ``      `` 0`@ 0`@ 8Ld8 8Ld8 8~ 8~ |<x |<x ~<| ~<| <l <l | | <`| <`| 000 000 xx| xx| |~x |~x            `   ` 0`0   0`0    ~  ~    ~  ~        |0 0 |0 0 <fnjn`> <fnjn`> 8l 8l   <ff< <ff<       >`f> >`f>   << << | |   ``````~ ``````~     || ||   |v |v   ||| ||| 000000 000000 | | |8 |8   |8| |8| fff< fff< 8p 8p   @`0 @`0 << << 8l    8l                  `0     `0       x|v   x|v     xx   xx || ||   xx   xx 00x000 00x000   ||x  ||x   0 0000  0 0000   p  p  0000000 0000000               <fff<   <fff<       ||  ||        xx   xx  0|000  0|000   l   l   x0   x0   l   l   x0x   x0x   |x  |x  0`   0` 0 0   pp pp `    `                                                      lll              llll         >`<|         bf0fF         68kf;                               `00`          f<<f           ~               00`           ~                 ``         0`@         8Ld8         8~         |<x         ~<|         <l         |         <`|         000         xx|         |~x                        `         0`0            ~  ~                     |0 0         <fnjn`>         8l                  <ff<                                    >`f>                  <<         |                  ``````~                           ||                  |v                  |||         000000         |         |8                  |8|         fff<         8p                  @`0         <<         8l                           `0               x|v                    xx         ||           xx         00x000           ||x                  0 0000           p                 0000000                                 <fff<                     ||                     xx          0|000           l           x0           l           x0x           |x          0`         0                  pp         `                                              lll              llll         >`<|         bf0fF         68kf;                               `00`          f<<f           ~               00`           ~                 ``         0`@         8Ld8         8~         |<x         ~<|         <l         |         <`|         000         xx|         |~x                        `         0`0            ~  ~                     |0 0         <fnjn`>         8l                  <ff<                                    >`f>                  <<         |                  ``````~                           ||                  |v                  |||         000000         |         |8                  |8|         fff<         8p                  @`0         <<         8l                           `0               x|v                    xx         ||           xx         00x000           ||x                  0 0000           p                 0000000                                 <fff<                     ||                     xx          0|000           l           x0           l           x0x           |x          0`         0                  pp         `                            NES          	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                  	   ! ) 1 9 A I Q Y a i q y                 H 0  Sh(`HLHLHhLH h(` HJJJJ DhH) Dh`
ii0LS
 H Sh`H  Sh`H
 Sh`hh  l HH  O hh``	 zSHZh3	aHkh1*	uHh+$H ZhS H kha H huL8L$ E8`
d/did J8/
i
 J	0LOH Oh`J J ` `H hi` `H  hi```0L`L `$00HEFffjIIII h` I 0LH8y h `h` LL Q l
Passed  L LS Q l
Done  L   d  d Q LH 1 h` d L LHHH    \hhh`L H          @ hL%HHH 
 "'0 \hhLHHH
 "'0 \hhLH?    h   `
  e`H      Lii` `H         h`**   `  ` 7``a``` ``#H h#` ;Lw`xLx uH J hL     P  `   L R     ] a 4H  (@`xH @   hH hL L d %` lFailed
 ` lFailed #  $ d` l
Internal error L         `  ``H   h` $  w@ ` $       `, ?        `, , 0 $`,$0, , ``x       L^` 7L   `  % *LL
 !  H Jh  z$   U    $       U   %H Jh  M   z$   $ ` H Jh  H Jh   H  %hU 0H JHhL
 lJSR+RTS TEST OK
   z$   $ `  pH Jh   H  %hU/ 0H	 JhL
H JhL  lJMP+RTS TEST OK
   z$   $ `  H Jh   H  %hU3 0H J{hL
H
 Jh H H` lRTS+RTS TEST OK
   z$   $ @ H JhHSHL H Jh   H  %hU 0H J\hL
 lJMP+RTI TEST OK
   z$   $   !H JhL H Jh   H  %hU 0H JhL
 lJMP+BRK TEST OK
  * % LS!@!H J7hL
LH"  L
h@ "  `   "`HH * lERROR
   lMysteriously Landed at $ h 0h 0 d  lCPU thinks we are at:  $ hh 0 0H JMhL
H@HHH  ;hh`L 'Nu  0@P` # pX@(    d,X  [0;33m [1;34m [0;37m PPU  memory  access  through  $2007 does not work properly. (Use other tests to determine the exact problem.) PPU open bus  implementation  is missing  or incomplete:  A write to $2003, followed by a read from $2001 should return the same value as was written. The RTS  at  $2001 was  never executed. An RTS opcode should still do a dummy  fetch  of  the  next opcode.   (The same  goes for all one-byte opcodes, really.) I have no idea what happened, but the  test did not work as supposed to. In any case, the problem is in the PPU. Okay,  the test  passed  when JSR was  used,  but NOT  when the opcode was JMP.   How can an emulator possibly get this result? You may congratulate  yourself  now,  for  finding  something that  is even more  unconventional than this test. Your  PPU  is  broken in mind-defyingly random ways. The RTS  at  $2001 was  never executed. The test passed  when JSR was used, and when  JMP was used, but  NOT  when RTS was  used. Caught ya! Paranoia wins. Your PPU gave up  reason at  the last moment. RTS to $2001 never returned. JMP to $2001 never returned. An RTI opcode should still do a dummy  fetch  of  the  next opcode.   (The same  goes for all one-byte opcodes, really.) An RTI  opcode  should  not  destroy the PPU. Somehow that still appears to be the case  here. JSR to $2001 never returned. The  BRK  instruction  should issue  an automatic fetch of  the byte that follows  right after the BRK.  (The same goes for all one-byte opcodes, but with BRK  it should be  a bit more obvious than with others.) A  BRK  opcode  should  not  destroy the PPU. Somehow that still appears to be the case  here.  * lTEST:test_cpu_exec_space_ppuio
   lThis program verifies that the
CPU can execute code from any
possible location that it can
address, including I/O space.

In addition, it will be tested
that an RTS instruction does a
dummy read of the byte that
immediately follows the
instructions.

  *`IRQ occurred uncalled A jump to $2001 should  never execute code  from  anywhere  else than $2001 The following code is used by devcart. It is never executed by test ROM.  
C@? z zel  ,@N@*`IhZD                    lll     lll      llll  llll >`<| >`<| bf0fF bf0fF 68kf; 68kf;             `00` `00`  f<<f   f<<f   ~   ~       00`     00`   ~       ~         ``      `` 0`@ 0`@ 8Ld8 8Ld8 8~ 8~ |<x |<x ~<| ~<| <l <l | | <`| <`| 000 000 xx| xx| |~x |~x            `   ` 0`0   0`0    ~  ~    ~  ~        |0 0 |0 0 <fnjn`> <fnjn`> 8l 8l   <ff< <ff<       >`f> >`f>   << << | |   ``````~ ``````~     || ||   |v |v   ||| ||| 000000 000000 | | |8 |8   |8| |8| fff< fff< 8p 8p   @`0 @`0 << << 8l    8l                  `0     `0       x|v   x|v     xx   xx || ||   xx   xx 00x000 00x000   ||x  ||x   0 0000  0 0000   p  p  0000000 0000000               <fff<   <fff<       ||  ||        xx   xx  0|000  0|000   l   l   x0   x0   l   l   x0x   x0x   |x  |x  0`   0` 0 0   pp pp `    `                                                      lll              llll         >`<|         bf0fF         68kf;                               `00`          f<<f           ~               00`           ~                 ``         0`@         8Ld8         8~         |<x         ~<|         <l         |         <`|         000         xx|         |~x                        `         0`0            ~  ~                     |0 0         <fnjn`>         8l                  <ff<                                    >`f>                  <<         |                  ``````~                           ||                  |v                  |||         000000         |         |8                  |8|         fff<         8p                  @`0         <<         8l                           `0               x|v                    xx         ||           xx         00x000           ||x                  0 0000           p                 0000000                                 <fff<                     ||                     xx          0|000           l           x0           l           x0x           |x          0`         0                  pp         `                                              lll              llll         >`<|         bf0fF         68kf;                               `00`          f<<f           ~               00`           ~                 ``         0`@         8Ld8         8~         |<x         ~<|         <l         |         <`|         000         xx|         |~x                        `         0`0            ~  ~                     |0 0         <fnjn`>         8l                  <ff<                                    >`f>                  <<         |                  ``````~                           ||                  |v                  |||         000000         |         |8                  |8|         fff<         8p                  @`0         <<         8l                           `0               x|v                    xx         ||           xx         00x000           ||x                  0 0000           p                 0000000                                 <fff<                     ||                     xx          0|000           l           x0           l           x0x           |x          0`         0                  pp         `                            NES          L`x                ?    x  @ @x       aJJJJJ'JLL& o o   L     L

 HH  l --tJ    aJJJJJ'JL5Lr o
 o   L5     L5
 HH  l =fF      LL  i
&
&
&
&
&H	  h	  &JJJJQ  )Q LO K LE r L0123456789ABCDEFi      *   L`       `                 `       `    -- Run all tests    -- Branch tests    -- Flag tests    -- Immediate tests    -- Implied tests    -- Stack tests    -- Accumulator tests    -- (Indirect,X) tests    -- Zeropage tests    -- Absolute tests    -- (Indirect),Y tests    -- Absolute,Y tests    -- Zeropage,X tests    -- Absolute,X tests    Up/Down: select test      Start: run test     Select: Invalid ops!     -- Run all tests    -- NOP tests    -- LAX tests    -- SAX tests    -- SBC test (opcode 0EBh)    -- DCP tests    -- ISB tests    -- SLO tests    -- RLA tests    -- SRE tests    -- RRA tests    Up/Down: select test      Start: run test     Select: Normal ops HH   @        	@@@J&E%hh@@   -       t        J     =     f     F  o Ln `@ @@@ @`@?@@@ @`N  `H4HU(DdHH4TtH:ZzH<\|HhU
h L(h)  `8 L@ 8LK    @Lh @  L} $p	 $PL
  $P $pL   L 0  0L `$ 8xh)o @$h)d $ 8h)/ H(	PL5 H(	0pLI $ Hh	0PLg  $8H h	pL `$U		PL 8 	 	p0L $U)	P0L 8)	pL $_I	PL  8pIp	p0L $ ii0	ipL/ 8$ii0	kpLI 8i	PLb  $i	pL{! 8i	0pL" 8	pL# $ 	0PL# $@@0	PL$ ?	0pL% AL&  L' 0L( L%) 0L5* $@@	0PLK+ ?	0pL^, ALn-  L. 0L/ L0 0L1 $@@	0PL2 ?	0pL3 AL4  L5 0L6 L7 0L+8 8	pL?9 $ 	0PLT: 8	pLh; $ 	0PL}< U3U#3U3V4L= q 1@ 7 G? L \A b r  v  `DUfV!eXcWdDL> 8i$=0;9P7 300.,P* #!ppiLb? 8i$=0;9P7 300.,P* #!ppiL@ 4$.,P*($4  8p0 4 LA 4$.,P*($  8p0  L.B 4$.,P*($4  8p0 4 LmC 4$.,P*0(4$4  8p0  LD 3i$20.P,(i$3 8 0piLE `3HiH~ hih33
iL3F  =L[~hh  NhMhL_G HfH`wi$ f$" Piw8  f	0pLH HHeHU@05P31/U+'#HHHU@pULI `Ui$8J0P J0	pUL J $8
0P 8U
	pLKK $8jPUj0	p*LvL $8*0PU*	pLM `     Z [ \]  Z[\ ]ZX     Y     Z     !   !  A 
p  A i  )a / =a C  Qa V  da j xa }@   H? h  HA h H  h  H h H h H h @  1 7?  G LA  \ b   r v   `Ux$# x0U
#Pv F$x
PxFw Ux$# x0U
#Px F$x
PxFy $Ux# x0U
#Pz F$x
PxF{ x3$xP3| x$x0p} ~x x  x x x %x x %x x Ex 
px Ex ix )ex / =ex Cx Qex Vx dex j xex }@x x H?xh x HAxhx H xh x Hxhx Hxhx Hxhx @x 1x 7?x Gx LAx \x b x rx vx x @x x ?x x Axx  x x xx xx xx @x x ?x x Axx  x x 	xx xx xx ' xFxx xFxx  xxx xxx  xfxx xfxx  
x&xx x&xx !x$8x0
Px  xx
px  x$8x
Px xx0
px xx `Ux$# x0U
#P F$x	PxF Ux$# x0U
#P F$x	PxF $Ux# x0U
#P F$x	PxF x3,xP3 x,x0p x x  x x x -x x -x x Mx 
px Mx ix )mx / =mx Cx Qmx Vx dmx j xmx }@x x H?xh x HAxhx H xh x Hxhx Hxhx Hxhx @x 1x 7?x Gx LAx \x b x rx vx x @x x ?x x Axx  x x xx xx xx @x x ?x x Axx  x x 	xx xx xx ' xNxx xNxx  xxx xxx  xnxx xnxx  
x.xx x.xx !x$8x0P	x  xxp	x  x$8xP	x xx0p	x xx `3 Ee  8 
pe $4  HF hHh  34 $ U3p 8 3p0 $U13P 8 13P $ _Q3p 8p Q3p $i  q30iP 8$ q30jP 8 q3p $ q3P 8 q30p $@ 30p  30P   30   3   30  30   3 ` 34 $@ 830
p  8@ 3
0p @8$  3
p   3 8 3P  3  ~ l     U` `  `l3 f$8 3Pf  f pf	 $8D 33DPP
 xx    x   x 5  x 5  x U  
px U  ix )u  / =u  Cx Qu  Vx du  j xu  }@x   H?xh   HAxh  H xh   Hxh  Hxh  Hxh  @x 1  7?x G  LAx \  b x r  vx   3 f$8 3Pf " f pf# $8D 33DPP$ %x  V    V              v    v    
 6    6   ! $8 0
P  -   
p .   $8 
P /   0
p 0   1 3xDx 8$ P03xD2 G pG3  Gip0i
Gi4 OGO$ 8 P0 OGO5 ` 3Ee 8  
pe6 $47 FF8 9$ U  p 8  p0 $U9 P 8 9 P $ _Y p 8p Y p $i  y 0iP 8$ y 0jP 8 y p $ y P 8 y 0p $@  0p   0P    0        0   0     $@ 8 0
p  8@  
0p @8$   
p     8  P     `3 f$8 3Pf Q f pfR Sxx    x   x =  x =  x ]  
px ]  ix )}  / =}  Cx Q}  Vx d}  j x}  }@x   H?xh   HAxh  H xh   Hxh  Hxh  Hxh  @x 1  7?x G  LAx \  b x r  vx   3 f$8 3Pf j f pfk $8D 33DPPl mm  ^    ^              ~    ~    
 >    >   ! $8 0P	  u   p	 v   $8 P	 w   0p	 x   y 3xDx 8$ P03xDz G pG{ `U2CD2EFw$8 @0PUUw| 3 @p3} g2hW$8 gPW~ S h0p22S w2xW$8 wPW S x0p22S CD2EFU2$8 C0PUU   Ep  g2hW$8 PW  i0p22 20$8 WP0 @ H0p22@ ` `aD>$IP>D Dzf8p0fDzb IDU$IPUD
I   VXf8Vp0fX
Vf I$IPI  VX8VpXV IU$JPU
I   Vf8Pp0f
Vf ` 1@ 7 G? L \A b r  v  `GGHG 1E 7G  G BE GG 7G TE YG6 G 1G 7G  G BG GG 7G TG YG6 G 1G 7G  G BG GG 7G TG YG6 GHEF 1EHh( 7G  G BEHh( GG 7G TEHh( YG6 G 1H 7G  G BH GG 7G TH YG6 G 1HHh( 7G  G BHHh( GG 7G THHh( YG6 G 1H 7G  G BH GG 7G TH YG6 `GGHG E G G E G  7G E G8 G G G G G G  7G G G8 G G G G G G  7G G G8 GHEF EHh( G G EHh( G  7G EHh( G8 G H G G H G  7G H G8 G HHh( G G HHh( G  7G HHh( G8 G H G G H G  7G H G8 `GGHG {E GJ )G E GR 7G E Gn G {G GJ )G G GR 7G G Gn G {G GJ )G G GR 7G G Gn GHEF {EHh( GJ )G EHh( GR 7G EHh( Gn G {H GJ )G H GR 7G H Gn G {HHh( GJ )G HHh( GR 7G HHh( Gn G {H GJ )G H GR 7G H Gn `GGHG S#E YGJ )G d#E iGR 7G h#E nGo G S'G YGJ )G d'G iGR 7G h'G nGo G S/G YGJ )G d/G iGR 7G h/G nGo GHEF S3EHh( YGJ )G d3EHh( iGR 7G h3EHh( nGo G S7H YGJ )G d7H iGR 7G h7H nGo G S;HHh( YGJ )G d;HHh( iGR 7G h;HHh( nGo G S?H YGJ )G d?H iGR 7G h?H nGo `GGHG CE #GR )G .CE 3G 7G @CE FG G GG #GR )G .GG 3G 7G @GG FG G OG #GR )G .OG 3G 7G @OG FG GHEF SEHh( #GR )G .SEHh( 3G 7G @SEHh( FG G WH #GR )G .WH 3G 7G @WH FG G [HHh( #GR )G .[HHh( 3G 7G @[HHh( FG G _H #GR )G ._H 3G 7G @_H FG `GGHG cE GR )G cE G 7G 
cE G G gG GR )G gG G 7G 
gG G G oG GR )G oG G 7G 
oG G GHEF sEH
h( GR )G sEHh( G 7G 
sEHh( G G wH GR )G wH G 7G 
wH G G {HHh( GR )G {HHh( G 7G 
{HHh( G G H GR )G H G 7G 
H G `$U`	P` `8 `p0` `$U`P0` `8`	p` `$_`	P` `8p`p0` `$ `0	ip` `8$ `0	jp` `8`	P` `$`	p` `8`0p` `$@`0P` ``0p` `` ``` `0` `` `0` `$@`0P` ``0p` `` ``` `0` `` `0` `$@8`0	p ` `8@`0	p` `@8$`	p` ``` `8`P` `U$8`0P `	0pU` `$8`0P U8`	p` `$8`PU`	0p*` $8`0PU`	p` `$@`P,*0(@$`8`p0`$`P
 `$8u`Pvt0rpel`$`Pca_[``pSQOMI`$8`P@>0<:~6`$@`p-+0)S%`8`p`$8`p
 `$`p*(0&"`B`p0W`$8u`p	0` $`PPNLH`B`p@>0<:V6`$8u`P-+0)'n#`$`P0`B`p
0B `                                     | |        ||   x000  p <<    |  0                                                                              33f     fffff >`<| bf0fF <f<8gf?      000 00  f<<f   ~       0   n;          0` >cgksc> ? >cc8c >cccc> & c`~c> >c`~cc> c< >cc>cc> >cc?c>        00`0   ~ ~   pp ~c || 6cccc nsc~cc~ 3```3 lvcccf| 10<01 10<00x 3`gc7 cccccc << f< fflxlgc x0``cc~ cwkccc cs{ogcc 6ccc6 nsc~``` 6ckg6 nsc~lgc >c`>c> ~Z< s3cccv< s3ccf< s3ckwc cc66cc 3cc6xp c3c~ <00000< @`0 <<  <~      00       ?ccg; ``nscc>   >c`c> ;gcc>   >a`> <<   >`cc= ``nscfg      ?f<``fn|gc    nkbg   nscfg   >ccc>   >csn``  >cg;  nsc~c   >qG> ?   s3cg;   s3cf<   ckwc   c66c   3cc?>  8 <BB<                                33383:333383:3                                                                                                                                                                            | | | |               || ||    x000  x000   p p << <<       |  |  0 0                                                                                                                                                           33f     33f     fffff fffff >`<| >`<| bf0fF bf0fF <f<8gf? <f<8gf?           000 000 00 00  f<<f   f<<f   ~   ~       0     0   n;      n;                0`  0` >cgksc> >cgksc> ? ? >cc8c >cc8c >cccc> >cccc> & & c`~c> c`~c> >c`~cc> >c`~cc> c< c< >cc>cc> >cc>cc> >cc?c> >cc?c>            0   00`0 0`0   ~ ~     ~ ~   pp pp ~c ~c || || 6cccc 6cccc nsc~cc~ nsc~cc~ 3```3 3```3 lvcccf| lvcccf| 10<01 10<01 10<00x 10<00x 3`gc7 3`gc7 cccccc cccccc << << f< f< fflxlgc fflxlgc x0``cc~ x0``cc~ cwkccc cwkccc cs{ogcc cs{ogcc 6ccc6 6ccc6 nsc~``` nsc~``` 6ckg6 6ckg6 nsc~lgc nsc~lgc >c`>c> >c`>c> ~Z< ~Z< s3cccv< s3cccv< s3ccf< s3ccf< s3ckwc s3ckwc cc66cc cc66cc 3cc6xp 3cc6xp c3c~ c3c~ <00000< <00000< @`0 @`0 << <<  <~ <~            00     00       ?ccg;   ?ccg; ``nscc> ``nscc>   >c`c>   >c`c> ;gcc> ;gcc>   >a`>   >a`> << <<   >`cc=   >`cc= ``nscfg ``nscfg         ?f<  ?f<``fn|gc ``fn|gc     nkbg   nkbg   nscfg   nscfg   >ccc>   >ccc>   >csn``  >csn``  >cg;  >cg;  nsc~c   nsc~c   >qG>   >qG> ? ?   s3cg;   s3cg;   s3cf<   s3cf<   ckwc   ckwc   c66c   c66c   3cc?>  3cc?>  8   8 <BB<<BB<                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                NES         x  Y  &(
*HELLO, WORLD!   
  LC   L    L  M  M   C -?     $q 	  iL!     $q 	  iL C C I H -L  `    ` `    ` `e `      `  ` L1L1I8e  `                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     >>><<  6~~~    $ll     ~~~~lllll ~~||| ?.J 8||x{0HP Rz        <88<000 8<<800 >>Z<<Z    ~     pppp`   `` @          ~         ppp     `` 8p @ ~~|| <<>>8< ~<|0 ~~|| >~<l ~| ~~||  ~~||| ~~|~|                                                                                                                 <<~~88ll  ~~||    ~|v  >>>><< |x  pppw````f   ~~||  ~|v  ~~||| >>~Z< ~| ~~<<ll88 ~~|l ~<<~l88l www>>>fff<< <0f       8p @   ?w<ff                  88     00      >w? <f>ff> pp~ww~``|fff|  >wpw> <f``f< ?ww?>fff>  >w> <f~`f< >><8<0  ?w> >ff>f< pp~wwww``|ffff   ||8 X0 pw~|~w`flxxlf >><     ~wwwwww |fffff  >www> <ffff<  ~ww~p |fff|`  ?ww? >fff>  ~~~xppp l|p```  >>> <f0f< >><  wwwww? fffff>  www>> fff<<  ~f lD  w>>w f<<f  www><8 fff<0  ? ~f6~ <<0  8<<800    s    b                  0~ "|t  p ` >>~><< |8 >><g< ~(F 6v$"|d <>o8($JJ0 f~>~~@< 88  nD  ~`? | @> >c~>~<B@< `````f~<@@@@@D8 <<( ffnn~>DDDL@< >>0><   `o@@N >c?>~ <B<  > < 808   xp`?P @@> 6~~8$B8L0 `@^ 3"|V `{wg@RbFF >f<RD Z 8xgf~<0`FDD8 8<v0 T  0x   P  ?|>X ~~~~|~~||xt 6l$$~H 06~ $b\ 3~"|T ~~~~3?| | " ln~o>0HD|B,  x~P\<~;8L2 <~s \bB ffv6DD$ >>><<B f~vcDTdDB >>>c<<B `sf@\bBD ~~~~|~>|0\(@< 00p`  @@  0~|  $xh   p  `  <<|~>< 8 x8  <<~~<~n 8 |(L  <~| (8dh   <><  88  x|n|0 PHDH   x| PX  ~~8 |0     xx    PP                                                                                                                          80  ||h ><8  ~~ | >$ ?f~*D ~~|~ ??3sc>""B `<8@~D0   ~~ fffn<8DDDD0  ?sc~"B ``gf~>@@BD@< g<8B0 ??;o>"2N ><<<0(  {{{{>< RRR8 ~~<8| 0 ```x~n``@@@pL@@ xp`  ~~    |     ~~><<~f|((D <~~>8|< |xp nfgccDDBBB ~ |xp  0x   P  ~8T0 g~<D( x~~~x~pp p 00<~f  (DD 7>s$b ~~00>|     ``gv00@@BD    ~~ | ??~>~ ~~><| 8 ffffDDD xx{{PPRR ``ccgn|x@@BBDHp  ><8 ><~8   ><8p` (0 @  8xx 0P  0<8  0   ||00  x     < (   ~~~<8  TT0  ``~<0 @@D(    ||  x   ~~>>~~  |<|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 